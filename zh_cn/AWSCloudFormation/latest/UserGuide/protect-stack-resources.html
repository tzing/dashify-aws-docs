<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>防止更新堆栈资源 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="protect-stack-resources" /><meta name="default_state" content="protect-stack-resources" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" /><meta name="description" content="使用 AWS CloudFormation 堆栈策略可防止堆栈资源在堆栈更新过程中被意外更新或删除。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="用户指南" /><meta name="abstract" content="根据此用户指南，使用 AWS CloudFormation 以可预见方式反复创建和管理 AWS 基础设施部署。" /><meta name="guide-locale" content="zh_cn" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="用户指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="用户指南" /><meta id="panorama-serviceConsolePage" value="防止更新堆栈资源" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>防止更新堆栈资源 - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,资源预置,资源配置,基础设施管理,CloudFormer,CloudFormation 堆栈,CloudFormation 堆栈集,CloudFormation 模板,更改集" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "用户指南",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "使用 堆栈",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacks.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "AWS CloudFormation 堆栈更新",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "防止更新堆栈资源",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文档</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">用户指南</a></div><div id="page-toc-src"><a href="#stack-policy-intro-example">示例堆栈策略</a><a href="#stack-policy-reference">定义堆栈策略</a><a href="#protect-stack-resources-protecting">设置堆栈策略</a><a href="#protect-stack-resources-updating">更新受保护资源</a><a href="#protect-stack-resources-modifying">修改堆栈策略 </a><a href="#stack-policy-samples">更多示例堆栈策略</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="protect-stack-resources">防止更新堆栈资源</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>在创建堆栈时，允许对所有资源执行所有更新操作。默认情况下，具有堆栈更新权限的任何人均可更新堆栈中的所有资源。在更新期间，一些资源可能需要中断或可能已完全替换，这会生成新的物理 ID 或全新的存储。使用堆栈策略可以防止<a href="./aws-template-resource-type-ref.html">堆栈资源</a>在堆栈更新过程中被意外更新或删除。堆栈策略是一个 JSON 文档，该文档定义可对指定资源执行的更新操作。</p><p>设置堆栈策略后，默认情况下将保护堆栈中的所有资源。要允许对特定资源进行更新，您可在堆栈策略中为这些资源指定明确的 <code class="code">Allow</code> 语句。您只能为每个堆栈定义一个堆栈策略，但在一个策略中可以保护多个资源。堆栈策略适用于所有尝试更新堆栈的 AWS CloudFormation 用户。您不能将不同的堆栈策略与不同的用户关联。</p><p>堆栈策略仅在堆栈更新过程中适用。与 AWS Identity and Access Management（IAM）策略不同，它不提供访问控制。仅将堆栈策略用作故障保护功能来防止意外更新特定堆栈资源。要控制对 AWS 资源或操作的访问，请使用 IAM。</p><div class="highlights" id="inline-topiclist"><h6>主题</h6><ul><li><a href="#stack-policy-intro-example">示例堆栈策略</a></li><li><a href="#stack-policy-reference">定义堆栈策略</a></li><li><a href="#protect-stack-resources-protecting">设置堆栈策略</a></li><li><a href="#protect-stack-resources-updating">更新受保护资源</a></li><li><a href="#protect-stack-resources-modifying">修改堆栈策略 </a></li><li><a href="#stack-policy-samples">更多示例堆栈策略</a></li></ul></div>
   <h2 id="stack-policy-intro-example">示例堆栈策略</h2>
    <p>下面的示例堆栈策略阻止更新 <code class="code">ProductionDatabase</code> 资源：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    },
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "LogicalResourceId/ProductionDatabase"
    }
  ]
}</code></pre>
    <p>当您设置堆栈策略时，将默认保护所有资源。为了允许对所有资源进行更新，我们添加了一个 <code class="code">Allow</code> 语句来允许对所有资源执行的所有操作。虽然 <code class="code">Allow</code> 语句指定所有资源，但显式 <code class="code">Deny</code> 语句将为具有 <code class="code">ProductionDatabase</code> 逻辑 ID 的资源覆盖前者。此 <code class="code">Deny</code> 语句阻止对 <code class="code">ProductionDatabase</code> 资源进行的所有更新操作，例如替换或删除。</p>
    <p>需要 <code class="code">Principal</code> 元素，但仅支持通配符 (<code class="code">*</code>)，这意味着语句适用于所有<a href="https://docs.aws.amazon.com/glossary/latest/reference/glos-chap.html#principal">委托人</a>。</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>在堆栈更新期间，AWS CloudFormation 自动更新依赖其他更新的资源的资源。例如，AWS CloudFormation 更新引用更新资源的资源。AWS CloudFormation 不会对自动更新的资源进行任何物理更改（如资源的 ID），但如果这些资源与堆栈策略关联，您必须具有权限才能更新它们。</p></div></div>
   
   <h2 id="stack-policy-reference">定义堆栈策略</h2>
    <p>在创建堆栈时，未设置堆栈策略，因此允许对所有资源执行所有更新操作。要阻止对堆栈资源执行更新操作，可定义一个堆栈策略，然后对堆栈设置该策略。堆栈策略是一个 JSON 文档，它定义 AWS CloudFormation 用户可以执行的 AWS CloudFormation 堆栈更新操作以及这些操作应用到的资源。在创建堆栈时，可通过指定一个包含堆栈策略的文本文件或键入该策略来设置堆栈策略。在堆栈上设置堆栈策略时，默认情况下会拒绝未显式允许的任何更新。</p>
    <p>您可定义一个带 5 个元素的堆栈策略：<code class="code">Effect</code>、<code class="code">Action</code>、<code class="code">Principal</code>、<code class="code">Resource</code> 和 <code class="code">Condition</code>。下面的伪代码显示了堆栈策略语法。</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "<code class="replaceable">Deny_or_Allow</code>",
      "Action" : "<code class="replaceable">update_actions</code>",
      "Principal" : "*",
      "Resource" : "LogicalResourceId/<code class="replaceable">resource_logical_ID</code>",
      "Condition" : <span>{</span>
        "<code class="replaceable">StringEquals_or_StringLike</code>" : <span>{</span>
          "ResourceType" : [<code class="replaceable">resource_type, ...</code>]
        }
      }
    }
  ]
}</code></pre>
    <div class="variablelist">
       
       
       
       
       
    <dl>
        <dt><span class="term"><code class="code">Effect</code></span></dt>
        <dd>
          <p>确定是拒绝还是允许对指定资源执行指定的操作。您只能指定 <code class="code">Deny</code> 或 <code class="code">Allow</code>，例如：</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Effect" : "Deny"</code></pre>
          <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>如果堆栈策略包含重叠语句 (同时允许和拒绝对资源进行更新)，则 <code class="code">Deny</code> 语句始终将覆盖 <code class="code">Allow</code> 语句。要确保某一资源受到保护，请对该资源使用 <code class="code">Deny</code> 语句。</p></div></div>
        </dd>
       
        <dt><span class="term">操作</span></dt>
        <dd>
          <p>指定拒绝或允许的更新操作：</p><div class="variablelist">
               
               
               
               
            <dl>
                <dt><span class="term">更新:修改</span></dt>
                <dd>
                  <p>指定在对资源应用更改期间不会中断或有某些中断的更新操作。所有资源都保持其物理 ID。</p>
                </dd>
               
                <dt><span class="term">更新:替换</span></dt>
                <dd>
                  <p>指定重新创建资源的更新操作。AWS CloudFormation 使用指定的更新创建新资源，然后删除旧资源。由于资源是重新创建的，因此新资源的物理 ID 可能不相同。</p>
                </dd>
               
                <dt><span class="term">更新:删除</span></dt>
                <dd>
                  <p>指定删除资源的更新操作。从堆栈模板中完全删除资源的更新都需要此操作。</p>
                </dd>
               
                <dt><span class="term">更新:*</span></dt>
                <dd>
                  <p>指定所有更新操作。星号是通配符，代表所有更新操作。</p>
                </dd>
              </dl></div>
          <p>以下示例说明如何只指定替换和删除操作：</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Action" : ["Update:Replace", "Update:Delete"]</code></pre>
          <p>要允许除某个更新操作之外的所有更新操作，请使用 <code class="code">NotAction</code>。例如，要允许除 <code class="code">Update:Delete</code> 之外的所有更新操作，请使用 <code class="code">NotAction</code>，如本示例中所示：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "NotAction" : "Update:Delete",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
          <p>有关堆栈更新的更多信息，请参阅<a href="./using-cfn-updating-stacks.html">AWS CloudFormation 堆栈更新</a>。</p>
        </dd>
       
        <dt><span class="term">主体</span></dt>
        <dd>
          <p><code class="code">Principal</code> 元素指定策略应用于的实体。需要此元素，但仅支持通配符 (<code class="code">*</code>)，这意味着策略应用于所有<a href="https://docs.aws.amazon.com/glossary/latest/reference/glos-chap.html#principal">主体</a>。</p>
        </dd>
       
        <dt><span class="term">资源</span></dt>
        <dd>
          <p>指定将应用策略的资源的逻辑 ID。要指定<a href="./aws-template-resource-type-ref.html">资源类型</a>，请使用 <code class="code">Condition</code> 元素。</p>
          <p>要指定一个资源，请使用其逻辑 ID。例如：</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Resource" : ["LogicalResourceId/myEC2instance"]</code></pre>
          <p>您可以对逻辑 ID 使用通配符。例如，如果您对所有相关资源使用一个通用逻辑 ID 前缀，则可使用通配符指定所有资源：</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Resource" : ["LogicalResourceId/CriticalResource*"]</code></pre>
          <p>您还可以对资源使用 <code class="code">Not</code> 元素。例如，要允许对所有资源执行除某个更新之外的所有更新，请使用 <code class="code">NotResource</code> 元素保护该资源：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "NotResource" : "LogicalResourceId/ProductionDatabase"
    }
  ]
}</code></pre>
          <p>设置堆栈策略时，会拒绝未显式允许的任何更新。通过允许更新 <code class="code">ProductionDatabase</code> 资源之外的所有资源，会拒绝更新 <code class="code">ProductionDatabase</code> 资源。</p>
        </dd>
       
        <dt><span class="term">Conditions</span></dt>
        <dd>
          <p>指定应用策略的<a href="./aws-template-resource-type-ref.html">资源类型</a>。要指定特定资源的逻辑 ID，请使用 <code class="code">Resource</code> 元素。</p>
          <p>您可以指定资源类型（如所有 EC2 和 RDS 数据库实例），如以下示例所示：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
  <span>{</span>
    "Effect" : "Deny",
    "Principal" : "*",
    "Action" : "Update:*",
    "Resource" : "*",
    "Condition" : <span>{</span>
      "StringEquals" : <span>{</span>
        "ResourceType" : ["AWS::EC2::Instance", "AWS::RDS::DBInstance"]
      }
    }
  },
  <span>{</span>
    "Effect" : "Allow",
    "Principal" : "*",
    "Action" : "Update:*",
    "Resource" : "*"
  }
  ]
}</code></pre>
          <p><code class="code">Allow</code> 语句授予对所有资源的更新权限，而 <code class="code">Deny</code> 语句拒绝对 EC2 和 RDS 数据库实例的更新。<code class="code">Deny</code> 语句始终覆盖允许操作。</p>
          <p>您可以对资源类型使用通配符。例如，您可以使用通配符拒绝所有 Amazon EC2 资源（如实例、安全组和子网）的更新权限，如以下示例所示：</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Condition" : <span>{</span>
  "StringLike" : <span>{</span>
    "ResourceType" : ["AWS::EC2::*"]
  }
}</code></pre>
          <p>使用通配符时，必须使用 <code class="code">StringLike</code> 条件。</p>
        </dd>
      </dl></div>
   
   <h2 id="protect-stack-resources-protecting">设置堆栈策略</h2>
    <p>您可以使用控制台或 AWS CLI 在创建堆栈时应用堆栈策略。您也可以使用 AWS CLI 将堆栈策略应用于现有堆栈。应用堆栈策略后，无法将其从堆栈中删除，但您可以使用 AWS CLI 修改该策略。</p>
    <p>堆栈策略适用于所有尝试更新堆栈的 AWS CloudFormation 用户。您不能将不同的堆栈策略与不同的用户关联。</p>
    <p>有关如何编写堆栈策略的信息，请参阅<a href="#stack-policy-reference">定义堆栈策略</a>。</p>
    <div class="procedure"><h6>在创建堆栈时设置堆栈策略（控制台）</h6><ol><li><p>打开 AWS CloudFormation 控制台，地址：<a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。</p></li><li>
        <p>在 <b>CloudFormation Stacks (CloudFormation 堆栈)</b> 页上，选择 <b>Create stack (创建堆栈)</b>。</p>
      </li><li>
        <p>在“创建堆栈”向导的 <b>Configure stack options (配置堆栈选项)</b> 页面上，展开<b>高级</b>部分，然后选择 <b>Stack policy (堆栈策略)</b>。</p>
      </li><li>
        <p>指定堆栈策略：</p>
        <div class="itemizedlist">
           
           
        <ul class="itemizedlist"><li class="listitem"><p>要在控制台中直接编写策略，请选择 <b>Enter stack policy (输入堆栈策略)</b>，然后在文本字段中直接键入堆栈策略。</p></li><li class="listitem"><p>要使用在单独的文件中定义的策略，请依次选择 <b>Upload a file (上传文件)</b>、<b>Choose file (选择文件)</b>，以选择包含堆栈策略的文件。</p></li></ul></div>
      </li></ol></div>
    <div class="procedure"><h6>在创建堆栈时设置堆栈策略（AWS CLI）</h6><ul><li>
        <p>将 <code class="code"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/create-stack.html">aws cloudformation create-stack</a></code> 命令与 <code class="code">--stack-policy-body</code> 选项结合使用可键入修改的策略，或将此命令与 <code class="code">--stack-policy-url</code> 选项结合使用可指定包含策略的文件。</p>
      </li></ul></div>
    <div class="procedure"><h6>在现有堆栈上设置堆栈策略（仅限 AWS CLI）</h6><ul><li>
        <p>将 <code class="code"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/set-stack-policy.html">aws cloudformation set-stack-policy</a></code> 命令与 <code class="code">--stack-policy-body</code> 选项结合使用可键入修改的策略，或将此命令与 <code class="code">--stack-policy-url</code> 选项结合使用可指定包含策略的文件。</p>
        <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>要将策略添加到现有堆栈中，您必须有权执行 AWS CloudFormation <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_SetStackPolicy.html">SetStackPolicy</a></code> 操作。</p></div></div>
      </li></ul></div>
   
   <h2 id="protect-stack-resources-updating">更新受保护资源</h2>
    <p>要更新受保护的资源，可创建一个覆盖堆栈策略并允许对这些资源进行更新的临时策略。在更新堆栈时指定覆盖策略。覆盖策略不会永久更改堆栈策略。</p>
    <p>要更新保护的资源，您必须有权使用 AWS CloudFormation <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_SetStackPolicy.html">SetStackPolicy</a></code> 操作。有关设置 AWS CloudFormation 权限的信息，请参阅<a href="./using-iam-template.html">使用 AWS Identity and Access Management 控制访问权限</a>。</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>在堆栈更新期间，AWS CloudFormation 自动更新依赖其他更新的资源的资源。例如，AWS CloudFormation 更新引用更新的资源的资源。AWS CloudFormation 不会对自动更新的资源进行任何物理更改（如资源的 ID），但如果这些资源与堆栈策略关联，您必须具有权限才能更新它们。</p></div></div>
    <div class="procedure"><h6>更新受保护的资源（控制台）</h6><ol><li><p>打开 AWS CloudFormation 控制台，地址：<a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。</p></li><li>
        <p>选择要更新的堆栈，然后依次选择 <b>Stack actions (堆栈操作)</b> 和 <b>Update Stack (更新堆栈)</b>。</p>
      </li><li>
        <p>如果您<em>尚未</em>修改堆栈模板，请选择 <b>Use current template (使用当前模板)</b>，然后单击 <b>Next (下一步)</b>。如果您已修改模板，请选择 <b>Replace current template (替换当前模板)</b>，然后指定在 <b>Specify template (指定模板)</b> 中指定更新模板的位置：</p>
        <div class="itemizedlist">
           
           
        <ul class="itemizedlist"><li class="listitem">
            <p>对于在计算机本地存储的模板，选择 <b>Upload a template file (上传模板文件)</b>。选择 <b>Choose File</b> 以导航到文件并选中它，然后单击 <b>Next</b>。</p>
          </li><li class="listitem">
            <p>对于存储在 Amazon S3 存储桶中的模板，请选择 <b>Amazon S3 URL</b>。输入或粘贴模板的 URL，然后单击 <b>Next (下一步)</b>。</p>
            <p>如果您的模板存储在启用了版本控制的存储桶中，则您可以指定模板的具体版本，例如：<code class="code">https://s3.amazonaws.com/templates/myTemplate.template?versionId=123ab1cdeKdOW5IH4GAcYbEngcpTJTDW</code>。有关更多信息，请参阅《Amazon Simple Storage Service 用户指南》中的<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/managing-objects-versioned-bucket.html">在启用了版本控制的桶中管理对象</a>。</p>
          </li></ul></div>
      </li><li>
        <p>如果您的模板包含参数，则在 <b>Specify stack details (指定堆栈详细信息)</b> 页上，输入或修改参数值，然后选择 <b>Next (下一步)</b>。</p>
        <p>AWS CloudFormation 使用当前在堆栈中设置的值填充每个参数，使用 <code class="code">NoEcho</code> 属性声明的参数除外。可以选择<b>使用现有值</b>来对这些参数使用当前值。</p>
        <p>有关使用 <code class="code">NoEcho</code> 来遮蔽敏感信息以及使用动态参数管理密钥的更多信息，请参阅<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html#creds">请勿将凭证嵌入您的模板</a>最佳实践。</p>
      </li><li>
        <p>指定覆盖堆栈策略。</p>
        <ol><li><p>在 <b>Configure stack options (配置堆栈选项)</b> 页上的<b>高级选项</b>部分中，选择 <b>Stack policy (堆栈策略)</b>。</p></li><li><p>选择 <b>Upload a file (上传文件)</b>。</p></li><li><p>单击 <b>Choose file (选择文件)</b>，然后导航到包含覆盖堆栈策略的文件或键入策略。</p></li><li><p>选择<b>下一步</b>。</p></li></ol>
        
        <p>覆盖策略必须为您要更新的受保护资源指定 <code class="code">Allow</code> 语句。例如，要更新所有受保护资源，可以指定允许所有更新的临时覆盖策略：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
        <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>AWS CloudFormation 仅在此更新期间应用覆盖策略。覆盖策略不会永久更改堆栈策略。要修改堆栈策略，请参阅<a href="#protect-stack-resources-modifying">修改堆栈策略 </a>。</p></div></div>
      </li><li>
        <p>审查提交的堆栈信息和更改。</p>
        <p>检查您是否已提交正确的信息，例如正确的参数值或模板 URL。如果模板包含 IAM 资源，请选择 <b>I acknowledge that this template may create IAM resources (我确认该模板可能会创建 IAM 资源)</b> 以指定您要在模板中使用 IAM 资源。有关在模板中使用 IAM 资源的更多信息，请参阅 <a href="./using-iam-template.html">使用 AWS Identity and Access Management 控制访问权限</a>。</p>
        <p>在<b>预览您的更改</b>部分中，检查 AWS CloudFormation 是否进行所需的所有更改。例如，检查 AWS CloudFormation 是否添加、删除和修改您要添加、删除或修改的资源。AWS CloudFormation 为堆栈创建更改集以生成该预览。有关更多信息，请参阅<a href="./using-cfn-updating-stacks-changesets.html">使用更改集更新堆栈</a>。</p>
      </li><li>
        <p>如果您对所做更改感到满意，请单击 <b>Update (更新)</b>。</p>
        <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>此时，您还可以选择查看更改集以更全面地查看建议的更新。要执行此操作，请单击 <b>View change set</b>（查看更改集）而不是 <b>Update</b>（更新）。CloudFormation 会显示根据您的更新生成的更改集。准备好执行堆栈更新后，请单击 <b>Execute (执行)</b>。</p></div></div>
        <p>CloudFormation 会显示您的堆栈的 <b>Stack details (堆栈详细信息)</b> 页面。您的堆栈此时的状态为 <b>UPDATE_IN_PROGRESS</b>。CloudFormation 成功完成堆栈更新后，会将堆栈状态设置为 <b>UPDATE_COMPLETE</b>。</p>
        <p>如果堆栈更新失败，CloudFormation 会自动回滚更改，并将状态设置为 <b>UPDATE_ROLLBACK_COMPLETE</b>。</p>
      </li></ol></div>
    <div class="procedure"><h6>更新受保护资源（AWS CLI）</h6><ul><li>
        <p>将 <code class="code"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html">aws cloudformation update-stack</a></code> 命令与 <code class="code">--stack-policy-during-update-body</code> 选项结合使用可键入修改的策略，或将此命令与 <code class="code">--stack-policy-during-update-url</code> 选项结合使用可指定包含策略的文件。</p>
        <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>AWS CloudFormation 仅在此更新期间应用覆盖策略。覆盖策略不会永久更改堆栈策略。要修改堆栈策略，请参阅<a href="#protect-stack-resources-modifying">修改堆栈策略 </a>。</p></div></div>
      </li></ul></div>
   
   <h2 id="protect-stack-resources-modifying">修改堆栈策略 </h2>
    <p>要保护其他资源或从资源中删除保护，请修改堆栈策略。例如，当您将要保护的数据库添加到堆栈时，会将该数据库的 <code class="code">Deny</code> 语句添加到堆栈策略。要修改策略，您必须有权使用 <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_SetStackPolicy.html">SetStackPolicy</a></code> 操作。</p>
    <p>使用 AWS CLI 修改堆栈策略。</p>
    <div class="procedure"><h6>修改堆栈策略（AWS CLI）</h6><ul><li>
        <p>将 <code class="code"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/set-stack-policy.html">aws cloudformation set-stack-policy</a></code> 命令与 <code class="code">--stack-policy-body</code> 选项结合使用可键入修改的策略，或将此命令与 <code class="code">--stack-policy-url</code> 选项结合使用可指定包含策略的文件。</p>
      </li></ul></div>
    <p>您无法删除堆栈策略。要从所有资源删除全部保护，您可修改策略以明确允许对所有资源执行全部操作。以下策略允许对所有资源进行全部更新：</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
   
   <h2 id="stack-policy-samples">更多示例堆栈策略</h2>
    <p>以下示例策略说明如何阻止对所有堆栈资源和特定资源进行更新，并阻止特定类型的更新。</p>
     
     <h3 id="w9aac25c17c29c21b5">阻止对所有堆栈资源的更新</h3>
      <p>要阻止对所有堆栈资源的更新，以下策略为所有资源的所有更新操作指定 <code class="code">Deny</code> 语句。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
     
     
     <h3 id="w9aac25c17c29c21b7">阻止对单个资源的更新</h3>
      <p>以下策略拒绝对带 <code class="code">MyDatabase</code> 逻辑 ID 的数据库执行的所有更新操作。它使用 <code class="code">Allow</code> 语句允许对所有其他堆栈资源进行全部更新操作。<code class="code">Allow</code> 语句不应用于 <code class="code">MyDatabase</code> 资源，因为 <code class="code">Deny</code> 语句始终覆盖允许操作。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "LogicalResourceId/MyDatabase"
    },
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
      <p>您可以使用默认拒绝来获得与上一示例相同的结果。设置堆栈策略时，AWS CloudFormation 会拒绝未显式允许的任何更新。以下策略允许对除 <code class="code">ProductionDatabase</code> 资源 (默认情况下，拒绝更新此资源) 之外的所有资源进行的更新。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "NotResource" : "LogicalResourceId/ProductionDatabase"
    }
  ]
}</code></pre>
      <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>使用默认拒绝存在风险。如果您策略中的其他位置具有 <code class="code">Allow</code> 语句 (例如，使用通配符的 <code class="code">Allow</code> 语句)，则可能意外授予 (原本不打算授予) 对资源的更新权限。由于显式拒绝将覆盖任何允许操作，因此可以使用 <code class="code">Deny</code> 语句确保保护资源。</p></div></div>
     
     
     <h3 id="w9aac25c17c29c21b9">阻止对资源类型的所有实例进行更新</h3>
      <p>以下策略拒绝针对 RDS 数据库实例资源类型的所有更新操作。它使用 <code class="code">Allow</code> 语句允许对所有其他堆栈资源进行全部更新操作。<code class="code">Allow</code> 语句不应用于 RDS 数据库实例资源，因为 <code class="code">Deny</code> 语句始终覆盖允许操作。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*",
      "Condition" : <span>{</span>
        "StringEquals" : <span>{</span>
          "ResourceType" : ["AWS::RDS::DBInstance"]
        }
      }
    },
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
     
     
     <h3 id="w9aac25c17c29c21c11">阻止针对实例的替换更新</h3>
      <p>以下策略拒绝会导致替换具有 <code class="code">MyInstance</code> 逻辑 ID 的实例的更新。它使用 <code class="code">Allow</code> 语句允许对所有其他堆栈资源进行全部更新操作。<code class="code">Allow</code> 语句不应用于 <code class="code">MyInstance</code> 资源，因为 <code class="code">Deny</code> 语句始终覆盖允许操作。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:Replace",
      "Principal": "*",
      "Resource" : "LogicalResourceId/MyInstance"
    },
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
     
     
     <h3 id="w9aac25c17c29c21c13">阻止对嵌套堆栈进行更新</h3>
      <p>以下策略拒绝针对 AWS CloudFormation 堆栈资源类型 (嵌套堆栈) 的所有更新操作。它使用 <code class="code">Allow</code> 语句允许对所有其他堆栈资源进行全部更新操作。<code class="code">Allow</code> 语句不会应用于 AWS CloudFormation 堆栈资源，因为 <code class="code">Deny</code> 语句始终覆盖 allow 操作。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Statement" : [
    <span>{</span>
      "Effect" : "Deny",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*",
      "Condition" : <span>{</span>
        "StringEquals" : <span>{</span>
          "ResourceType" : ["AWS::CloudFormation::Stack"]
        }
      }
    },
    <span>{</span>
      "Effect" : "Allow",
      "Action" : "Update:*",
      "Principal": "*",
      "Resource" : "*"
    }
  ]
}</code></pre>
     
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>Javascript 在您的浏览器中被禁用或不可用。</strong></p><p>要使用 Amazon Web Services 文档，必须启用 Javascript。请参阅浏览器的帮助页面以了解相关说明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文档惯例</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./using-cfn--stack-update-cancel.html">取消堆栈更新</div><div id="next" class="next-link" accesskey="n" href="./using-cfn-updating-stacks-continueupdaterollback.html">继续回滚更新</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此页面对您有帮助吗？- 是</div><div class="content"><p>感谢您对我们工作的肯定！</p><p>如果不耽误您的时间，请告诉我们做得好的地方，让我们做得更好。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此页面对您有帮助吗？- 否</div><div class="content"><p>感谢您告诉我们本页内容还需要完善。很抱歉让您失望了。</p><p>如果不耽误您的时间，请告诉我们如何改进文档。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>