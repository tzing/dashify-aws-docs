<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>授予自行管理的权限 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="stacksets-prereqs-self-managed" /><meta name="default_state" content="stacksets-prereqs-self-managed" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="description" content="使用自行管理权限时，您将创建 StackSets 需要的 AWS Identity and Access Management（IAM）角色来跨账户和 AWS 区域 进行部署。对于在您管理堆栈集所用的账户与您将堆栈部署到的账户之间建立信任关系，这些角色是必需的。使用此权限模型，StackSets 可以部署到您有权创建 IAM 角色的任何 AWS 账户 中。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="用户指南" /><meta name="abstract" content="根据此用户指南，使用 AWS CloudFormation 以可预见方式反复创建和管理 AWS 基础设施部署。" /><meta name="guide-locale" content="zh_cn" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="用户指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="用户指南" /><meta id="panorama-serviceConsolePage" value="授予自行管理的权限" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>授予自行管理的权限 - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,资源预置,资源配置,基础设施管理,CloudFormer,CloudFormation 堆栈,CloudFormation 堆栈集,CloudFormation 模板,更改集" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "用户指南",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "使用 AWS CloudFormation StackSets",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/what-is-cfnstacksets.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "堆栈集操作的先决条件",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "授予自行管理的权限",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文档</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">用户指南</a></div><div id="page-toc-src"><a href="#prereqs-self-managed-permissions">自行管理权限</a><a href="#stacksets-prereqs-accountsetup">为堆栈集操作设置基本权限</a><a href="#stacksets-prereqs-advanced-perms">为堆栈集操作设置高级权限选项</a><a href="#confused-deputy-mitigation">混淆代理问题防范</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="stacksets-prereqs-self-managed">授予自行管理的权限</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>使用自行管理权限时，您将创建 StackSets 需要的 AWS Identity and Access Management（IAM）角色来跨账户和 AWS 区域 进行部署。对于在您管理堆栈集所用的账户与您将堆栈部署到的账户之间建立信任关系，这些角色是必需的。使用此权限模型，StackSets 可以部署到您有权创建 IAM 角色的任何 AWS 账户 中。</p><div class="highlights" id="inline-topiclist"><h6>主题</h6><ul><li><a href="#prereqs-self-managed-permissions">自行管理权限</a></li><li><a href="#stacksets-prereqs-accountsetup">为堆栈集操作设置基本权限</a></li><li><a href="#stacksets-prereqs-advanced-perms">为堆栈集操作设置高级权限选项</a></li><li><a href="#confused-deputy-mitigation">设置全局键以缓解混淆代理问题</a></li></ul></div>
            <h2 id="prereqs-self-managed-permissions">自行管理权限</h2>
            <p>要为创建具有<b>服务托管</b>的堆栈集设置必要的权限，请参阅 <a href="./stacksets-orgs-activate-trusted-access.html">激活 AWS Organizations 的可信访问权限</a>。</p>
            <p>您需要先通过在各个账户中创建 IAM 角色以在管理员和目标账户之间建立信任关系，然后才能创建具有<b>自行管理的</b>权限的堆栈集。</p>
            <div class="orderedlist">
                 
                 
                 
            <ol><li>
                    <p>确定哪个 AWS 账户是<em>管理员账户</em>。</p>
                    <p>堆栈集是在该管理员账户中创建的。<em>目标账户</em> 是在其中创建属于堆栈集的各个堆栈的账户。</p>
                </li><li>
                    <p>确定您要如何为堆栈集构建权限。</p>
                    <p>利用最简单的（也是最宽松的）权限配置，您可以允许管理员账户中的<em>所有</em> 用户和组创建和更新通过该账户管理的<em>所有</em> 堆栈集。如果您需要更精细的控制，则可设置权限以指定：</p>
                    <div class="itemizedlist">
                         
                         
                         
                    <ul class="itemizedlist"><li class="listitem">
                            <p>哪些用户和组可在哪些目标账户中执行堆栈集操作。</p>
                        </li><li class="listitem">
                            <p>用户和组可将哪些资源包含在其堆栈集中。</p>
                        </li><li class="listitem">
                            <p>特定用户和组可执行哪些堆栈集操作。</p>
                        </li></ul></div>
                </li><li>
                    <p>在管理员账户和目标账户中创建所需的 IAM 服务角色以定义所需的权限。</p>
                </li></ol></div>
         
            <h2 id="stacksets-prereqs-accountsetup">为堆栈集操作设置基本权限</h2>
            <p>利用最简单的（也是最宽松的）权限配置，您可以允许管理员账户中的<em>所有</em> 用户和组创建和更新通过该账户管理的<em>所有</em> 堆栈集。为此，您可以为管理员和所有目标账户创建 IAM 服务角色。具有管理员账户权限的任何用户有权创建、更新或删除任何目标账户中的任何堆栈。</p>
            <p>您的管理员账户和目标账户必须已配置服务角色 (在账户之间创建信任关系并授予目标账户对模板中所述资源的创建和管理权限)。</p>
            <p>如果您以这种方式构建权限，则用户在创建或更新堆栈集时不会传递管理员角色。</p>
            <div class="mediaobject">
                 
                    <img src="images/stacksets_perms_master_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                    在管理员账户和目标账户之间建立信任关系。然后，管理员账户中的任何用户可以创建任何堆栈集。&#xA;                " style="max-width:100%" />
                 
                 
            </div>
            <div class="procedure"><h6>为管理员账户的所有用户设置权限以在所有目标账户中执行堆栈集操作</h6><ol><li>
                    <p>在管理员账户中，创建一个名为 <b>AWSCloudFormationStackSetAdministrationRole</b> 的 IAM 角色。为此，您可以通过以下 AWS CloudFormation 模板创建堆栈，网址为 <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。此模板创建的角色将在您的管理员账户上启用以下策略。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                    <p>以下信任关系是由上述模板创建的。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>请注意，要将堆栈实例部署到驻留在默认情况下禁用的区域中的目标账户，还需要包含该区域的区域服务主体。默认情况下禁用的每个区域都有自己的区域服务主体。</p>
                    <p>有关区域端点的更多信息（包括端点列表），请参阅《AWS 一般参考指南》中的<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">区域端点</a>。</p>
                    <p>以下示例包括亚太地区（香港）区域的区域服务主体（<code class="code">cloudformation.ap-east-1.amazonaws.com</code>），该区域在默认情况下禁用。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "cloudformation.ap-east-1.amazonaws.com"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>有关更多信息，请参阅<a href="./stacksets-prereqs.html#stacksets-opt-in-regions">执行涉及默认情况下禁用的区域的堆栈集操作</a>。</p>
                </li><li>
                    <p>在每个目标账户中，创建一个信任管理员账户的名为 <b>AWSCloudFormationStackSetExecutionRole</b> 的服务角色。该角色必须具有该确切名称。为此，您可以通过以下 AWS CloudFormation 模板创建堆栈，网址为 <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。当您使用此模板时，系统将提示您提供目标账户必须与其具有信任关系的管理员账户的名称。</p>
                    <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>请注意，此模板将向管理员授予访问权限。在您使用此模板创建目标账户执行角色之后，您必须将策略声明中的权限的范围限定为您正使用堆栈集创建的资源的类型。</p></div></div>
                    <p>目标账户服务角色需要权限才能执行 AWS CloudFormation 模板中指定的任何操作。例如，如果您的模板正在创建 S3 存储桶，则您需要权限才能为 S3 创建新对象。您的目标账户始终需要完整的 AWS CloudFormation 权限，其中包含创建、更新、删除和描述堆栈的权限。此模板创建的角色将在目标账户上启用以下策略。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": "*",
      "Resource": "*"
    }
  ]
}</code></pre>
                    <p>您必须将 S3 服务操作和资源添加到每个目标账户的 <code class="code">AWSCloudFormationStackSetExecutionRole</code> 策略语句，以便 StackSets 正常运行。StackSets 使用这些权限来通知目标账户和管理员账户中的堆栈实例状态。</p>
                    <p>要在使用 CloudFormation 以外的服务中的资源的目标账户中创建堆栈，您必须将这些服务操作和资源添加到每个目标账户的 <code class="code">AWSCloudFormationStackSetExecutionRole</code> 策略语句中。以下示例显示具有 StackSets 所需权限的策略语句。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
         "cloudformation:*",
         "s3:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                    <p>以下信任关系是由此模板创建的。管理员账户的 ID 显示为 <code class="replaceable">admin_account_id</code>。</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:root"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>您可以配置现有目标账户执行角色的信任关系以信任管理员账户中的特定角色。如果您在管理员账户中删除此角色并创建一个新角色来替代它，则您必须使用新的管理员账户角色 (由上一示例中的 <code class="replaceable">admin_account_id</code> 表示) 配置您的目标账户信任关系。</p>
                </li></ol></div>
         
            <h2 id="stacksets-prereqs-advanced-perms">为堆栈集操作设置高级权限选项</h2>
            <p>如果您需要更精细地控制用户和组通过单个管理员账户创建的堆栈集，您可以使用 IAM 角色指定：</p>
            <div class="itemizedlist">
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p>哪些用户和组可在哪些目标账户中执行堆栈集操作。</p>
                </li><li class="listitem">
                    <p>用户和组可将哪些资源包含在其堆栈集中。</p>
                </li><li class="listitem">
                    <p>特定用户和组可执行哪些堆栈集操作。</p>
                </li></ul></div>
             
                <h3 id="stacksets-prereqs-multiadmin">设置权限以控制目标账户访问</h3>
                <p>使用自定义的管理员角色来控制哪些用户和组可以在哪些目标账户中执行堆栈集操作。您可能希望控制管理员账户的哪些用户可以在哪些目标账户中执行堆栈集操作。为此，您可以在每个目标账户和特定的自定义管理角色之间创建信任关系，而不是在管理员账户中创建 <b>AWSCloudFormationStackSetAdministrationRole</b> 服务角色。然后，激活特定用户和组以在特定目标账户中执行堆栈集操作时使用自定义管理角色。</p>
                <p>例如，您可以在管理员账户中创建角色 A 和角色 B。您可以授予角色 A 访问目标账户 1 至账户 8 的权限。您可以授予角色 B 访问目标账户 9 至账户 16 的权限。</p>
                <div class="mediaobject">
                     
                        <img src="images/stacksets_perms_admin_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                         在自定义的管理员角色和目标账户之间建立信任关系。然后，用户在创建堆栈集时传递该角色。&#xA;                    " style="max-width:100%" />
                     
                     
                </div>
                <p>设置必要的权限包括定义自定义的管理员角色、为目标账户创建服务角色并授予用户在执行堆栈集操作时传递自定义的管理员角色的权限。</p>
                <p>一般而言，下面是您具有必要的权限后的工作原理：在创建堆栈集时，用户必须指定自定义管理员。用户必须具有将角色传递到 AWS CloudFormation 的权限。此外，自定义的管理员角色还必须与为堆栈集指定的目标账户之间具有信任关系。AWS CloudFormation 创建堆栈集并将其与自定义的管理员角色相关联。在更新堆栈集时，用户必须显式指定自定义管理员角色，即使它与之前用于此堆栈集的自定义管理员角色相同也是如此。AWS CloudFormation 根据上述要求使用该角色来更新堆栈。</p>
                <div class="procedure"><h6>为可在特定目标账户中执行堆栈集操作的用户和组设置权限</h6><ol><li>
                        <p>对于每个堆栈集，创建一个自定义的管理员角色，该角色具有在目标账户中担任 <b>AWSCloudFormationStackSetExecutionRole</b> 服务角色的权限。</p>
                        <p>使用以下权限策略，创建具有自定义名称的 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html">IAM 服务角色</a>：</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::<code class="replaceable">target_account_id</code>:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                        <p>或者，如果您要指定所有目标账户，请使用以下权限策略：</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::<code class="replaceable">*</code>:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                        <p>在创建角色以定义信任关系时，您必须提供以下信任策略：</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span> 
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
        "Service": "cloudformation.amazonaws.com" 
      }, 
      "Action": "sts:AssumeRole" 
    } 
  ] 
}</code></pre>
                        <p>请注意，要将堆栈实例部署到驻留在默认情况下禁用的区域中的目标账户，还需要包含该区域的区域服务主体。默认情况下，不可用的每个区域都有自己的区域服务主体。</p>
                        <p>有关区域端点的更多信息（包括端点列表），请参阅《AWS 一般参考指南》中的<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">区域端点</a>。</p>
                        <p>以下示例包括亚太地区（香港）区域的区域服务主体（<code class="code">cloudformation.ap-east-1.amazonaws.com</code>），该区域在默认情况下禁用。</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "cloudformation.ap-east-1.amazonaws.com"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                        <p>有关更多信息，请参阅<a href="./stacksets-prereqs.html#stacksets-opt-in-regions">执行涉及默认情况下禁用的区域的堆栈集操作</a>。</p>
                    </li><li>
                        <p>在每个目标账户中，创建一个名为 <b>AWSCloudFormationStackSetExecutionRole</b> 的服务角色，该角色信任要用于此账户的自定义管理角色。</p>
                        <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>您必须将策略声明中的权限的范围限定为您正使用堆栈集创建的资源的类型。</p></div></div>
                        <p>目标账户服务角色需要权限才能执行 AWS CloudFormation 模板中指定的任何操作。例如，如果您的模板正在创建 S3 存储桶，则您需要在 S3 中创建新对象的权限。您的目标账户始终需要完整的 AWS CloudFormation 权限，其中包含创建、更新、删除和描述堆栈的权限。</p>
                        <p>以下示例显示了一个包含让堆栈集运行所需的<em>最低</em> 权限的策略声明。要在使用 AWS CloudFormation 以外的服务中的资源的目标账户中创建堆栈，您必须将这些服务操作和资源添加到每个目标账户的 <b>AWSCloudFormationStackSetExecutionRole</b> 权限策略声明中。</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*",
        "s3:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                        <p>在创建角色以定义信任关系时，您必须提供以下信任策略：</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre>
                    </li><li>
                        <p>允许用户在执行堆栈集操作时传递自定义的管理员角色。</p>
                        <p>向用户或组附加 IAM 权限策略，该策略允许他们在创建或更新特定堆栈集时传递相应的自定义管理员角色。有关更多信息，请参阅<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html">向用户授予将角色传递给 AWS 服务的权限</a>。在以下示例中，<code class="replaceable">customized_admin_role</code> 是指用户需要传递的管理员角色。</p>

                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "iam:GetRole",
        "iam:PassRole"
      ],
      "Resource": "arn:aws:iam::*:role/<code class="replaceable">customized_admin_role</code>"
    }
  ]
}</code></pre>
                    </li></ol></div>
             
             
                <h3 id="stacksets-prereqs-executionrole">设置权限以控制堆栈资源包含</h3>
                <p>使用自定义执行角色可以控制用户和组可将哪些堆栈资源包含在其堆栈集中。例如，您可能希望设置一个组，该组只能将与 Amazon S3 相关的资源包含在他们创建的堆栈集中，而另一个团队只能包含 DynamoDB 资源。为此，您可以在每个组的自定义的管理员角色与每组资源的自定义执行角色之间创建信任关系。自定义执行角色定义可将哪些堆栈资源包含在堆栈集中。自定义的管理员角色位于管理员账户中，而自定义的执行角色位于每个目标账户（要在其中使用定义的资源创建堆栈集）中。然后，激活特定用户和组以在执行堆栈集操作时使用自定义管理角色。</p>
                <p>例如，您可以在管理员账户中创建自定义的管理员角色 A、B 和 C。有权使用角色 A 的用户和组可以创建相应的堆栈集，这些堆栈集包含自定义执行角色 X 中专门列出的堆栈资源，而不包含角色 Y 或 Z 中的堆栈资源或任何执行角色中未包含的资源。</p>
                <div class="mediaobject">
                     
                        <img src="images/stacksets_perms_admin_execution.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                        在自定义的管理员角色与目标账户中的自定义执行角色之间建立信任关系。然后，用户在创建堆栈集时传递这些角色。&#xA;                    " style="max-width:100%" />
                     
                     
                </div>
                <p>在更新堆栈集时，用户必须显式指定自定义管理员角色，即使它与之前用于此堆栈集的自定义管理员角色相同也是如此。AWS CloudFormation 使用指定的自定义管理员角色执行更新，前提是用户具有对该堆栈集执行操作的权限。</p>
                <p>同样，用户还可以指定自定义的执行角色。如果他们指定了自定义的执行角色，则 AWS CloudFormation 将根据上述要求使用该角色来更新堆栈。如果用户未指定自定义的执行角色，则 AWS CloudFormation 将使用以前与堆栈集关联的自定义的执行角色来执行更新，只要用户具有对该堆栈集执行操作的权限。</p>
                <div class="procedure"><h6>为用户和组可包含在特定堆栈集中的资源设置权限</h6><ol><li>
                        <p>在要在其中创建堆栈集的目标账户中，创建一个自定义的执行角色，该角色授予对您希望用户和组能够将其包含在堆栈集中的服务和资源的权限。</p>
                        <p>以下示例提供了堆栈集的最小权限以及创建 Amazon DynamoDB 表的权限。</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*",
        "s3:*",
      ],
      "Resource": "*"
    },
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "dynamoDb:createTable"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                        <p>在创建角色以定义信任关系时，您必须提供以下信任策略：</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre>
                    </li><li>
                        <p>在您的管理员账户中创建自定义的管理员角色，如<a href="#stacksets-prereqs-multiadmin">设置权限以控制目标账户访问</a>中所述。包含自定义的管理员角色和希望该角色使用的自定义的执行角色之间的信任关系。</p>
                        <p>以下示例包含针对为目标账户定义的 <b>AWSCloudFormationStackSetExecutionRole</b> 以及自定义的执行角色的 <code class="code">sts::AssumeRole</code> 策略。</p>
                    </li></ol></div>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
   "Statement": [
    <span>{</span>
      "Sid": "Stmt1487980684000",
      "Effect": "Allow",
      "Action": [
        "sts:AssumeRole" 
      ],
      "Resource": [ 
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole",
        "arn:aws:iam::*:role/<code class="replaceable">custom_execution_role</code>" 
      ]
    } 
  ]
}</code></pre>
             
             
                <h3 id="stacksets-prereqs-iam-actions">为特定堆栈集操作设置权限</h3>
                <p>此外，您可以为能够执行特定的堆栈集操作（例如，创建、更新或删除堆栈集或堆栈实例）的用户和组设置权限。有关更多信息，请参阅《IAM 用户指南》中的 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscloudformation.html">AWS CloudFormation 的操作、资源和条件键</a>。</p>
             
         
            <h2 id="confused-deputy-mitigation">设置全局键以缓解混淆代理问题</h2>
            <p>混淆代理问题是一个安全性问题，即不具有操作执行权限的实体可能会迫使具有更高权限的实体执行该操作。在 AWS 中，跨服务模拟可能会导致混淆代理问题。一个服务（<em>呼叫服务</em>) 调用另一项服务（<em>所谓的服务</em>)时，可能会发生跨服务模拟。可以操纵调用服务以使用其权限对另一个客户的资源进行操作，否则该服务不应有访问权限。为了防止这种情况，AWS 提供可帮助您保护所有服务的服务委托人数据的工具，这些服务委托人有权限访问账户中的资源。</p>
            <p>建议在资源策略中使用 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn"><code class="code">aws:SourceArn</code></a> 和 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount"><code class="code">aws:SourceAccount</code></a> 全局条件上下文键，以限制 AWS CloudFormation StackSets 为其他服务提供的资源访问权限。如果使用两个全局条件上下文键，在同一策略语句中使用时，<code class="code">aws:SourceAccount</code> 值和 <code class="code">aws:SourceArn</code> 值中的账户必须使用相同的账户 ID。</p>

            <p>防范混淆代理问题最有效的方法是使用 <code class="code">aws:SourceArn</code> 全局条件上下文键和资源的完整 ARN。如果不知道资源的完整 ARN，或者正在指定多个资源，请针对 ARN 未知部分使用带有通配符 (<code class="code">*</code>) 的 <code class="code">aws:SourceArn</code> 全局上下文条件键。例如，<code class="code">arn:aws:<code class="replaceable">cloudformation</code>::<code class="replaceable">123456789012</code>:*</code>。请尽可能使用 <code class="code">aws:SourceArn</code>，因为它更具体。仅当无法确定正确的 ARN 或 ARN 模式时使用 <code class="code">aws:SourceAccount</code>。</p>


            <p>当 StackSets 在<b>管理员</b>账户中担任<b>管理</b>角色时，StackSets 会填充<b>管理员</b>账户 ID 和 StackSets Amazon 资源名称（ARN）。因此，您可以在信任关系中为<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount">全局键</a> <code class="code">aws:SourceAccount</code> 和 <code class="code">aws:SourceArn</code> 定义条件，以防止<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html">混淆代理问题</a>。以下示例演示如何使用 StackSets 中的 <code class="code">aws:SourceArn</code> 和 <code class="code">aws:SourceAccount</code> 全局条件上下文键来防范混淆代理问题。</p>
            <div class="example"><h6>例 <code class="code">aws:SourceAccount</code> 和 <code class="code">aws:SourceArn</code> 的全局键示例</h6><div class="example-contents"><p>使用 StackSets 时，请在 <code class="code">AWSCloudFormationStackSetAdministrationRole</code> 信任策略中定义全局键 <code class="code">aws:SourceAccount</code> 和 <code class="code">aws:SourceArn</code> 以防止混淆代理问题。</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>"
        },
        "StringLike": <span>{</span>
          "aws:SourceArn": "arn:aws:cloudformation:*:<code class="replaceable">111122223333</code>:stackset/*"
        }
      }
    }
  ]
}</code></pre></div></div>
            <div class="example"><h6>例 StackSets ARN</h6><div class="example-contents"><p>指定关联的 StackSets ARN 以进行更精细的控制。</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>",
          "aws:SourceArn": [
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-1</code>",
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-2</code>",
          ]
        }
      }
    }
  ]
}</code></pre></div></div>
        <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>Javascript 在您的浏览器中被禁用或不可用。</strong></p><p>要使用 Amazon Web Services 文档，必须启用 Javascript。请参阅浏览器的帮助页面以了解相关说明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文档惯例</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./stacksets-prereqs.html">堆栈集操作的先决条件</div><div id="next" class="next-link" accesskey="n" href="./stacksets-orgs-activate-trusted-access.html">激活 AWS Organizations 的可信访问权限</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此页面对您有帮助吗？- 是</div><div class="content"><p>感谢您对我们工作的肯定！</p><p>如果不耽误您的时间，请告诉我们做得好的地方，让我们做得更好。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此页面对您有帮助吗？- 否</div><div class="content"><p>感谢您告诉我们本页内容还需要完善。很抱歉让您失望了。</p><p>如果不耽误您的时间，请告诉我们如何改进文档。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>