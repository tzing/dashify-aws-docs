<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>使用 AWS CloudFormation 宏对模板执行自定义处理 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="template-macros" /><meta name="default_state" content="template-macros" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="description" content="使用宏来对模板执行自定义处理，从查找并替换操作等简单操作到整个模板的大量转换。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="用户指南" /><meta name="abstract" content="根据此用户指南，使用 AWS CloudFormation 以可预见方式反复创建和管理 AWS 基础设施部署。" /><meta name="guide-locale" content="zh_cn" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="用户指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="用户指南" /><meta id="panorama-serviceConsolePage" value="使用 AWS CloudFormation 宏对模板执行自定义处理" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>使用 AWS CloudFormation 宏对模板执行自定义处理 - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,资源预置,资源配置,基础设施管理,CloudFormer,CloudFormation 堆栈,CloudFormation 堆栈集,CloudFormation 模板,更改集" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "用户指南",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "使用 AWS CloudFormation 模板",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "使用 AWS CloudFormation 宏对模板执行自定义处理",
        "item" : "https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-guide.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文档</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">用户指南</a></div><div id="page-toc-src"><a href="#template-macros-overview">AWS CloudFormation 宏的工作原理</a><a href="#template-macros-author">创建 AWS CloudFormation 宏定义</a><a href="#template-macros-use">在模板中使用 AWS CloudFormation 宏</a><a href="#template-macros-examples-list">宏示例</a><a href="#template-macros-seealso">另请参阅</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="template-macros">使用 AWS CloudFormation 宏对模板执行自定义处理</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>通过使用宏，您可以对模板执行自定义处理，包括查找并替换操作等简单操作以及整个模板的大型转换。</p><p>要了解可能性的广度，请考虑 <code class="code">AWS::Include</code> 和 <code class="code">AWS::Serverless</code> 转换，它们是由 AWS CloudFormation 托管的宏：</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p><code class="code"><a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include 转换</a></code> 可让您将样板文件模板代码段插入您的模板中。</p>
        </li><li class="listitem">
            <p><code class="code"><a href="./transform-aws-serverless.html">AWS::Serverless 转换</a></code> 获取用 AWS Serverless Application Model（AWS SAM）语法编写的整个模板，并将其转换并扩展为符合 AWS CloudFormation 的模板。（有关无服务器应用程序和 AWS SAM 的更多信息，请参阅《AWS Lambda 开发人员指南》中的<a href="https://docs.aws.amazon.com/lambda/latest/dg/deploying-lambda-apps.html">部署基于 Lambda 的应用程序</a>。）</p>
        </li></ul></div><h2 id="template-macros-overview">AWS CloudFormation 宏的工作原理</h2><p>使用宏处理模板有两个主要步骤：<em>创建</em>宏本身，然后<em>使用</em>宏来对模板执行处理。</p><p>要创建宏定义，您需要创建以下内容：</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p>一个执行模板处理的 AWS Lambda 函数。此 Lambda 函数接受一个代码段或整个模板，以及您定义的任何其他参数。它返回已处理的模板代码段或整个模板作为响应。</p>
        </li><li class="listitem">
            <p>类型为 <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></code> 的资源，它使用户能够从 AWS CloudFormation 模板内调用 Lambda 函数。此资源指定要为此宏调用的 Lambda函数的 ARN，以及辅助调试的其他可选属性。要在账户中创建此资源，请创建一个模板（其中包含 <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></code> 资源），然后从该模板创建具有自行管理权限的堆栈或堆栈集。AWSCloudFormation StackSets 目前不支持通过引用宏的模板创建或更新具有服务托管权限的堆栈集。</p>
        </li></ul></div><p>要使用宏，请在您的模板中引用宏：</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p>要处理模板的一个部分或<em>代码段</em>，请在 <code class="code"><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></code> 函数中引用宏（位置是相对于要转换的模板内容而言的）。当使用 <code class="code">Fn::Transform</code> 时，您还可以传递它需要的任何指定参数。</p>
        </li><li class="listitem">
            <p>要处理整个模板，请在模板的 <a href="./transform-section-structure.html">转换</a> 部分中引用宏。</p>
        </li></ul></div><p>接下来，您通常会创建一个更改集，然后执行它。（处理宏可添加您可能不知道的多个资源。为确保您了解宏所引入的所有更改，我们强烈建议您使用更改集。）AWS CloudFormation 将指定的模板内容以及任何其他指定的参数一并传递给在宏资源中指定的 Lambda 函数。Lambda 函数返回已处理的模板内容，无论是代码段还是整个模板。</p><p>在调用模板中的所有宏之后，AWS CloudFormation 会生成包含已处理模板内容的更改集。检查更改集后，执行它来应用更改。</p><div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>如果堆栈集模板引用了一个或多个宏，则必须直接从处理过的模板创建堆栈集，而无需先查看更改集中生成的更改。要直接创建或更新堆栈集，必须使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。在通过直接引用宏的模板创建或更新堆栈集之前，请确保您知道宏执行的处理操作。</p></div></div><div class="mediaobject">
         
            
            <img src="images/template-macro-use.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;            使用 Fn::Transform 内部函数或模板的 Transform 部分，将模板内容和关联参数传递给宏的底层 Lambda 函数，该函数返回处理的模板内容。&#xA;        " style="max-width:100%" />
         
         
    </div><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>如果您喜欢直接从处理的模板来创建或更新堆栈，则无需先查看更改集中提议的更改，而是可以在 <code class="code">CreateStack</code> 或 <code class="code">UpdateStack</code> 请求期间指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能来直接实现。仅当您知道宏执行的处理操作时，才应直接通过引用宏的模板创建堆栈。</p><p>有关更多信息，请参阅《AWS CloudFormation API 参考》中的 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html">CreateStack</a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html">UpdateStack</a>。</p></div></div><h2 id="template-macros-author">创建 AWS CloudFormation 宏定义</h2>
        <p>当您创建宏定义时，该宏定义使底层 Lambda 函数在指定的账户中可用，以便 AWS CloudFormation 可以调用它来处理模板。</p>
        
        <h3 id="template-macros-lambda-interface">AWS CloudFormation 宏函数接口</h3>
            <p>对于宏，AWS CloudFormation 使用以下事件映射调用底层 Lambda 函数。AWS CloudFormation 以 JSON 格式发送请求，并且它希望函数响应也被格式化为 JSON。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "region" : "<code class="replaceable">us-east-1</code>",
    "accountId" : "<code class="replaceable">$ACCOUNT_ID</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> },
    "transformId" : "<code class="replaceable">$TRANSFORM_ID</code>",
    "params" : <span>{</span> <code class="replaceable">...</code> },
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "templateParameterValues" : <span>{</span> <code class="replaceable">...</code> }
}</code></pre>

            <div class="itemizedlist">
                 
                 
                 
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><b>区域</b></p>
                    <p>宏所在的区域。</p>
                </li><li class="listitem"><p><b>accountId</b></p>
                    <p>宏从中调用 Lambda 函数的账户的账户 ID。</p>
                </li><li class="listitem"><p><b>fragment</b></p>
                    <p>可用于自定义处理的模板内容，采用 JSON 格式。</p>
                    <div class="itemizedlist">
                         
                         
                    <ul class="itemizedlist"><li class="listitem"><p>对于 <code class="code">Transform</code> 模板部分中包含的宏，这是整个模板，除 <code class="code">Transform</code> 部分外。</p></li><li class="listitem"><p>对于在 <code class="code">Fn::Transform</code> 内部函数调用中包含的宏，这包括基于内部函数在模板中的位置的所有同级节点（及其子节点），除 <code class="code">Fn::Transform</code> 函数外。有关更多信息，请参阅<a href="#template-macros-scope">AWS CloudFormation 宏范围</a>。</p></li></ul></div>
                </li><li class="listitem"><p><b>transformId</b></p>
                    <p>调用此函数的宏的名称。</p>
                </li><li class="listitem"><p><b>params</b></p>
                    <p>对于 <code class="code">Fn::Transform</code> 函数调用，是函数的任何指定参数。AWS CloudFormation 在将这些参数传递给函数之前不会对它们进行评估。</p>
                    <p>对于在 <code class="code">Transform</code> 模板部分中包含的宏，此部分为空。</p>
                </li><li class="listitem"><p><b>requestId</b></p>
                    <p>调用此函数的请求的 ID。</p>
                </li><li class="listitem"><p><b>templateParameterValues</b></p>
                    <p>在模板的 <a href="./parameters-section-structure.html">参数</a> 部分中指定的任何参数。AWS CloudFormation 在将这些参数传递给函数之前对其进行评估。</p>
                </li></ul></div>
            <p>AWS CloudFormation 预计底层函数以以下 JSON 格式返回响应：</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "status" : "<code class="replaceable">$STATUS</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> }
    "errorMessage": "optional error message for failures"
}</code></pre>
            <div class="itemizedlist">
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><b>requestId</b></p>
                    <p>调用此函数的请求的 ID。这必须在调用函数时与 AWS CloudFormation 提供的请求 ID 匹配。</p>
                </li><li class="listitem"><p><b>状态</b></p>
                    <p>请求的状态（不区分大小写）。应设置为 <code class="code">success</code>。AWS CloudFormation 会将任何其他响应都视为失败。</p>
                </li><li class="listitem"><p><b>fragment</b></p>
                    <p>要在已处理模板中包含的已处理 AWS CloudFormation 模板内容，包括同级内容。AWS CloudFormation 会将传递给 Lambda 函数的模板内容替换为它在 Lambda 响应中接收的模板片段。</p>
                    <p>已处理模板内容必须是有效的 JSON，并且其在已处理模板中的包含必须生成有效的模板。</p>
                    <p>如果您的函数实际上没有更改 AWS CloudFormation 传递给它的模板内容，但您仍需要将该内容包含在已处理模板中，则您的函数需要将该模板内容返回到其响应中的 AWS CloudFormation。</p>
                </li><li class="listitem">
                    <p><b>errorMessage</b></p>
                    <p>解释转换失败原因的错误消息。CloudFormation 将在堆栈的 <b>Stack details</b>（堆栈详细信息）页面的 <b>Events</b>（事件）窗格中显示此错误消息。</p>
                    <p>例如，“Error creating change set: Transform <code class="replaceable">AWS 账户 account number</code>::<code class="replaceable">macro name</code> failed with: <code class="replaceable">error message string</code>”。</p>
                </li></ul></div>
            <p>有关在创建宏时的其他注意事项的信息，请参阅<a href="#template-macros-considerations">创建 AWS CloudFormation 宏定义时的注意事项</a>。</p>
         
        
        <h3 id="template-macros-permissions">AWS CloudFormation 宏账户范围和权限</h3>
            <p>您只能在创建宏的账户中将宏用作资源。宏的名称在给定账户中必须是唯一的。但是，您可以通过在底层 Lambda 函数上启用跨账户访问，然后创建宏定义以在多个账户中引用该函数，从而在多个账户中提供相同的功能。在下面的示例中，三个账户包含宏定义，每个宏定义都指向相同的 Lambda 函数。</p>
            <div class="mediaobject">
                 
                    <img src="images/template-macro-accounts.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                    通过允许对 Lambda 函数进行跨账户存取，AWS 能让您在引用该函数的多个账户中创建宏。&#xA;                " style="max-width:100%" />
                 
                 
            </div>
            <p>有关更多信息，请参阅《AWS Lambda 开发人员指南》中的<a href="https://docs.aws.amazon.com/lambda/latest/dg/access-control-overview.html">管理您的 AWS Lambda 资源的访问权限概述</a>。</p>
            <p>要创建宏定义，用户必须具有在指定账户中创建堆栈或堆栈集的权限。</p>
            <p>为了使 AWS CloudFormation 成功运行模板中包含的宏，用户必须对底层 Lambda 函数具有 <code class="code">Invoke</code> 权限。为了防止可能的权限升级，AWS CloudFormation 会在运行宏时模拟用户。有关更多信息，请参阅《AWS Lambda 开发人员指南》中的 <a href="https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html">Lambda 权限模型</a>和《IAM 用户指南》中的 <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_lambda.html">AWS Lambda 的操作和条件上下文键</a>。</p>
            <p><a href="./transform-aws-serverless.html">AWS::Serverless 转换</a> 和 <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include 转换</a> 转换是由 AWS CloudFormation 托管的宏。使用它们不需要特殊权限，并且可以从 AWS CloudFormation 内的任何账户中获得它们。</p>
          
        <h3 id="template-macros-debug">调试 AWS CloudFormation 宏</h3>
            <p>为了帮助调试，您还可以在为宏创建 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a> 资源类型时指定 <code class="code">LogGroupName</code> 和 <code class="code">LogRoleArn</code> 属性。通过这些属性，您可以指定 AWS CloudFormation 在调用宏的底层 AWS Lambda 函数时向其发送错误日志记录信息的 CloudWatch 日志组，以及 AWS CloudFormation 在将日志条目发送到这些日志时应该担任的角色。</p>
          
        <h3 id="template-macros-billing">Billing</h3>
            <p>当宏运行时，将对 Lambda 函数的所有者收取与执行该函数相关的任何费用。</p>
            <p><a href="./transform-aws-serverless.html">AWS::Serverless 转换</a> 和 <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include 转换</a> 转换是由 AWS CloudFormation 托管的宏。使用它们不产生任何费用。</p>
         
        <h3 id="template-macros-considerations">创建 AWS CloudFormation 宏定义时的注意事项</h3>
            <p>在创建宏定义时，请记住以下几点：</p>
            <div class="itemizedlist">
                 
                 
                 
                 
                
                 
                 
                 
                
                 
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p>只有在提供 AWS Lambda 的 AWS 区域 才支持宏。有关提供 Lambda 的区域的列表，请参阅 <a href="https://docs.aws.amazon.com/general/latest/gr/lambda-service.html">AWS Lambda 端点和配额</a>。</p></li><li class="listitem"><p>任何已处理模板代码段都必须是有效的 JSON。</p></li><li class="listitem"><p>任何已处理的模板代码段都必须通过创建堆栈、更新堆栈、创建堆栈集或更新堆栈集等操作的验证检查。</p></li><li class="listitem"><p>AWS CloudFormation 先解析宏，然后再处理模板。生成的模板必须是有效的 JSON，并且不得超出模板大小限制。</p></li><li class="listitem"><p>由于 CloudFormation 处理模板中元素的顺序，宏无法在其返回给 CloudFormation 的已处理模板内容中包含模块。有关模块的更多信息，请参阅《CloudFormationCLI 用户指南》中的<a href="https://docs.aws.amazon.com/cloudformation-cli/latest/userguide/modules.html">开发模块</a>。</p></li><li class="listitem"><p>使用更新回滚功能时，AWS CloudFormation 会使用原始模板的副本。即使包含的代码段发生更改，它也会回滚到原始模板。</p></li><li class="listitem"><p>在宏中包含宏是行不通的，因为我们不迭代处理宏。</p></li><li class="listitem"><p>目前在宏中不支持 <code class="code">Fn::ImportValue</code> 内部函数。</p></li><li class="listitem"><p>模板中包含的内部函数会在任何宏之后被评估。因此，宏返回的已处理模板内容可以包括对内部函数的调用，并且像往常一样对其进行评估。</p></li><li class="listitem"><p>StackSets 目前不支持通过引用 AWS CloudFormation 宏的模板创建或更新具有服务托管权限的堆栈集。</p></li><li class="listitem"><p>如果堆栈集模板引用了一个或多个宏，则您必须直接通过处理过的模板创建或更新堆栈集，而无需先查看更改集中生成的更改。要直接创建或更新堆栈集，请使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。处理宏可添加您可能不知道的多个资源。在通过直接引用宏的模板创建或更新堆栈集之前，请确保您知道宏执行的处理操作。</p></li><li class="listitem">
                    
                    <p>目前，更改集不支持嵌套堆栈。如果要使用引用宏<em>和</em>包含嵌套堆栈的模板创建或更新堆栈，您必须直接创建或更新堆栈。要执行此操作，请使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html"><code class="code">CreateStack</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html"><code class="code">UpdateStack</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。</p>
                </li></ul></div>
         
        <div class="procedure"><h6>创建 AWS CloudFormation 宏定义：</h6><ol><li>
                <p><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-app.html"> 构建一个 AWS Lambda 函数</a>，用于处理 AWS CloudFormation 模板。</p>
                <p>您构建的 Lambda 函数执行模板内容的处理。您的函数可以处理模板的任何部分，甚至是整个模板。有关函数必须遵循的事件映射的信息，请参阅<a href="#template-macros-lambda-interface">AWS CloudFormation 宏函数接口</a>。有关在创建宏时的其他注意事项的信息，请参阅<a href="#template-macros-considerations">创建 AWS CloudFormation 宏定义时的注意事项</a>。</p>
            </li><li>
                <p><a href="./template-guide.html">创建模板</a>，在其中包含 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a> 资源类型。</p>
                <div class="itemizedlist">
                     
                     
                <ul class="itemizedlist"><li class="listitem"><p>您必须指定 <code class="code">Name</code> 和 <code class="code">FunctionName</code> 属性。<code class="code">FunctionName</code> 属性指定在 AWS CloudFormation 运行宏时调用的 Lambda 函数的 ARN。</p></li><li class="listitem"><p>为了帮助调试，您还可以指定 <code class="code">LogGroupName</code> 和 <code class="code">LogRoleArn</code> 属性。</p></li></ul></div>
            </li><li>
                <p>通过在所需账户中包含宏的模板<a href="./cfn-console-create-stack.html">创建堆栈</a>，或通过在管理员账户中引用宏的模板<a href="./stacksets-getting-started-create.html#stacksets-getting-started-create-self-managed">创建具有自行管理权限的堆栈集</a>，然后在所需目标账户中创建堆栈实例。</p>
                <p>在 AWS CloudFormation 成功创建包含宏定义的堆栈之后，该宏便可这些账户中使用。</p>
            </li></ol></div>


    <h2 id="template-macros-use">在模板中使用 AWS CloudFormation 宏</h2>
        <p>在 AWS CloudFormation 成功创建包含宏定义的堆栈之后，该宏便可在这些账户中使用。您可以通过在模板中，在与要处理的模板内容相关的适当位置引用宏来使用宏。</p>
        <h3 id="template-macros-order">AWS CloudFormation 宏评估顺序</h3>
            <p>您可以在给定模板中引用多个宏，包括由 AWS CloudFormation 托管的转换，例如 <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include 转换</a> 和 <a href="./transform-aws-serverless.html">AWS::Serverless 转换</a>。</p>
            <p>将会根据宏在模板中的位置，从嵌套最深的宏向外直到最一般的宏，按顺序评估宏。对于模板中相同位置的宏，将会根据列出的顺序按顺序进行评估。</p>
            <p>诸如 <code class="code">AWS::Include</code> 和 <code class="code">AWS::Transform</code> 之类的转换在操作顺序和范围方面被视为与任何其他宏相同。</p>
            <p>例如，在下面的模板示例中，AWS CloudFormation 首先评估 <code class="code">PolicyAdder</code> 宏，因为它是模板中嵌套最深的宏。然后，AWS CloudFormation 在评估 <code class="code">AWS::Serverless</code> 之前评估 <code class="code">MyMacro</code>，因为它在 <code class="code">Transform</code> 部分中在 <code class="code">AWS::Serverless</code> 之前列出。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
 Transform: [MyMacro, AWS::Serverless]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: MyBucket
        Tags: [<span>{</span>"key":"value"}]
        'Fn::Transform':
          - Name: PolicyAdder
        CorsConfiguration:[]
    MyEc2Instance:
      Type: 'AWS::EC2::Instance'
      Properties:
        ImageID: "ami-123"</code></pre>
          
        
        <h3 id="template-macros-scope">AWS CloudFormation 宏范围</h3>
            <p>在模板的 <code class="code">Transform</code> 部分中引用的宏可以处理该模板的全部内容。</p>
            <p>在 <code class="code">Fn::Transform</code> 函数中引用的宏可以处理模板中该 <code class="code">Fn::Transform</code> 函数的任何同级元素（包括子元素）的内容。</p>
            <p>例如，在下面的模板示例中，<code class="code">AWS::Include</code> 可以根据包含它的 <code class="code">Fn::Transform</code> 函数的位置处理 <code class="code">MyBucket</code> 属性。<code class="code">MyMacro</code> 可以处理整个模板的内容，因为它包含在 <code class="code">Transform</code> 部分中。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="复制"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">
// Start of processable content for MyMacro
AWSTemplateFormatVersion: 2010-09-09 
 Transform: [MyMacro]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: 'AWS::S3::Bucket'  //Start of processable content for AWS::Include
      Properties:
        BucketName: MyBucket 
        Tags: [<span>{</span>"key":"value"}] 
        'Fn::Transform':
          - Name: 'AWS::Include'
              Parameters:
                Location: s3://<code class="replaceable">DOC-EXAMPLE-BUCKET</code>/MyFileName.yaml
        CorsConfiguration:[]   //End of processable content for AWS::Include
    MyEc2Instance:
      Type: 'AWS::EC2::Instance' 
      Properties:
        ImageID: "ami-123"
// End of processable content for MyMacro         </code></pre>
          
        
         
         <h3 id="template-macros-change-sets">更改集和 AWS CloudFormation 宏</h3>
            <p>要使用引用宏的模板创建或更新堆栈，通常需要创建一个更改集，然后执行它。更改集描述 CloudFormation 将基于处理后的模板执行的操作。处理宏可添加您可能不知道的多个资源。为确保您已了解宏所引入的所有更改，我们强烈建议您使用更改集。在查看更改集后，您可以执行它来实际应用更改。</p>
            <p>宏可以将 IAM 资源添加到您的模板中。对于这些资源，AWS CloudFormation 要求您<a href="./using-iam-template.html#using-iam-capabilities">确认其功能</a>。由于 AWS CloudFormation 无法在处理模板前了解所添加的资源，因此您可能需要在创建更改集时确认 IAM 功能，具体取决于引用的宏是否包含 IAM 资源。这样一来，当您运行更改集时，AWS CloudFormation 会具有创建 IAM 资源所需的功能。</p>
            <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>如果堆栈集模板引用了一个或多个宏，则必须直接从处理过的模板创建堆栈集，而无需先查看更改集中生成的更改。要直接创建或更新堆栈集，必须使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。在通过直接引用宏的模板创建或更新堆栈集之前，请确保您知道宏执行的处理操作。</p></div></div>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>如果您喜欢直接从处理的模板来创建或更新堆栈，则无需先查看更改集中提议的更改，而是可以在 <code class="code">CreateStack</code> 或 <code class="code">UpdateStack</code> 请求期间指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能来直接实现。仅当您知道宏在处理什么时，才应直接从包含宏的堆栈模板创建堆栈。您不能将更改集与堆栈集宏一起使用，必须直接更新堆栈集。</p><p>有关更多信息，请参阅《AWS CloudFormation API 参考》<em></em> 中的 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html"><code class="code">CreateStack</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html"><code class="code">UpdateStack</code></a>。</p></div></div>
            <p>如果您使用 AWS CLI，则可使用 <code class="code">package</code> 和 <code class="code">deploy</code> 命令减少从引用宏的模板启动堆栈的步骤数。有关更多信息，请参阅《AWS Lambda 开发人员指南》中的<a href="https://docs.aws.amazon.com/lambda/latest/dg/deploying-lambda-apps.html">部署基于 Lambda 的应用程序</a>。</p>
         
   
        <h3 id="template-macros-template-stage">模板阶段和 CloudFormation 宏</h3>
            <p>模板的<em>阶段</em>指示模板是原始用户提交的模板还是 AWS CloudFormation 已在其中处理宏的模板。</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><code class="code">Original</code>：用户最初提交的用于创建或更新堆栈或堆栈集的模板。</p></li><li class="listitem"><p><code class="code">Processed</code>：模板 AWS CloudFormation 用于在处理任何引用的宏之后创建或更新堆栈或堆栈集。即使原始模板格式化为 YAML，已处理模板也会格式化为 JSON。</p></li></ul></div>
            <p>使用处理后的模板可解决堆栈问题。如果模板不引用宏，则原始模板和已处理模板是相同的。</p>
            <p>您可以使用 AWS CloudFormation <a href="./cfn-console-view-stack-data-resources.html">控制台</a>或 <a href="./using-cfn-get-template.html">AWS CLI</a> 查看堆栈模板的阶段。</p>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>当处理的堆栈模板直接传递到 <code class="code">CreateStack</code>、<code class="code">UpdateStack</code> 或 <code class="code">ValidateTemplate</code> 请求时，其最大大小为 51200 字节；或者当使用 Amazon S3 模板 URL 作为 S3 对象传递时，为 1MB。但是，在处理期间，CloudFormation 会更新模板的临时状态，因为它连续处理模板中包含的宏。因此，<em>在处理期间</em>，模板的大小可能会临时超出完全处理的模板所允许的大小。CloudFormation 允许为这些处理中的模板留出一些缓冲。但是，在设计模板和宏时，要始终考虑处理的堆栈模板所允许的最大大小。</p><p>如果在处理模板期间 CloudFormation 返回一个 <code class="code">Transformation data limit exceeded</code> 错误，则说明您的模板超出了 CloudFormation 所允许的处理期间模板的最大大小。</p><p>要解决这一问题，可执行下列操作：</p><div class="itemizedlist">
                     
                     
                <ul class="itemizedlist"><li class="listitem"><p>将您的模板分成多个模板，以避免超出为处理中的模板规定的最大大小。例如：</p>
                        <div class="itemizedlist">
                             
                             
                        <ul class="itemizedlist"><li class="listitem"><p>使用嵌套堆栈模板来封装模板的不同部分。有关更多信息，请参阅<a href="./using-cfn-nested-stacks.html">使用嵌套堆栈</a>。</p></li><li class="listitem"><p>创建多个堆栈，并使用跨堆栈引用来相互交换信息。有关更多信息，请参阅<a href="./walkthrough-crossstackref.html">演练：引用另一个 AWS CloudFormation 堆栈中的资源输出</a>。</p></li></ul></div>
                    </li><li class="listitem"><p>减小给定宏返回的模板片段大小。CloudFormation 不会篡改宏返回的片段内容。</p></li></ul></div></div></div>
         
        
        <div class="procedure"><h6>在模板中使用 AWS CloudFormation 宏</h6><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>为了使 AWS CloudFormation 成功运行模板中引用的宏，用户必须对底层 Lambda 函数具有 <code class="code">Invoke</code> 权限。有关更多信息，请参阅《AWS Lambda 开发人员指南》中的<a href="https://docs.aws.amazon.com/lambda/latest/dg/access-control-overview.html">管理您的 AWS Lambda 资源的访问权限概述</a>。</p></div></div><ol><li>
                <p>在模板中包含对宏的引用。</p>
                <div class="itemizedlist">
                     
                      
                <ul class="itemizedlist"><li class="listitem">
                        <p>要处理模板代码段，请在 <code class="code"><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></code> 函数中引用宏（位置是相对于要处理的模板内容而言的）。</p>
                    </li><li class="listitem">
                        <p>要处理整个模板，请在模板的 <a href="./transform-section-structure.html">转换</a> 部分中引用宏。</p>
                    </li></ul></div>
            </li><li>
                <p>使用模板<a href="./using-cfn-updating-stacks-changesets-create.html">创建更改集</a>。</p>
                <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>如果堆栈集模板引用了一个或多个宏，则必须直接从处理过的模板创建堆栈集，而无需先查看更改集中生成的更改。要直接创建或更新堆栈集，必须使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。在通过直接引用宏的模板创建或更新堆栈集之前，请确保您知道宏执行的处理操作。</p></div></div>
            </li><li>
                <p>审核并<a href="./using-cfn-updating-stacks-changesets-execute.html">运行更改集</a>。</p>
                <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>重要</h6></div><div class="awsdocs-note-text"><p>如果堆栈集模板引用了一个或多个宏，则必须直接从处理过的模板创建堆栈集，而无需先查看更改集中生成的更改。要直接创建或更新堆栈集，必须使用 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> 或 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> 操作并指定 <code class="code">CAPABILITY_AUTO_EXPAND</code> 功能。在通过直接引用宏的模板创建或更新堆栈集之前，请确保您知道宏执行的处理操作。</p></div></div>
            </li></ol></div>

     
        <h2 id="template-macros-examples-list">宏示例</h2>
        <p>除了本指南中的 <a href="./macros-example.html">宏示例：创建和使用宏</a> 演练之外，您还可以在 GitHub 上的 <a href="https://github.com/awslabs" rel="noopener noreferrer" target="_blank"><span>Amazon Web Services - Labs</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>（亚马逊云科技 - 实验室）存储库的 <a href="https://github.com/awslabs/aws-cloudformation-templates/tree/master/aws/services/CloudFormation/MacrosExamples/" rel="noopener noreferrer" target="_blank"><span>Macros Examples</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>（宏示例）部分中找到示例宏，包括源代码和模板。这些示例按“原样”提供，用于教学目的。</p>
    <h2 id="template-macros-seealso">另请参阅</h2>
        <p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></p>

        <p><a href="./transform-section-structure.html">转换</a></p>
        <p><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></p>
        
        <p><a href="./transform-aws-serverless.html">AWS::Serverless 转换</a></p>
        <p><a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include 转换</a></p>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>Javascript 在您的浏览器中被禁用或不可用。</strong></p><p>要使用 Amazon Web Services 文档，必须启用 Javascript。请参阅浏览器的帮助页面以了解相关说明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文档惯例</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./crpg-ref-requesttypes-update.html">更新</div><div id="next" class="next-link" accesskey="n" href="./macros-example.html">宏示例：创建和使用宏</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此页面对您有帮助吗？- 是</div><div class="content"><p>感谢您对我们工作的肯定！</p><p>如果不耽误您的时间，请告诉我们做得好的地方，让我们做得更好。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此页面对您有帮助吗？- 否</div><div class="content"><p>感谢您告诉我们本页内容还需要完善。很抱歉让您失望了。</p><p>如果不耽误您的时间，请告诉我们如何改进文档。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="反馈" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>