<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>透過使用執行 ECS 藍/綠部署 CodeDeploy AWS CloudFormation - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="blue-green" /><meta name="default_state" content="blue-green" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="description" content="使用 AWS CloudFormation 範本透過 AWS CodeDeploy 管理 ECS 藍/綠部署。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="使用者指南" /><meta name="abstract" content="使 AWS CloudFormation 用本使用者指南可預測並重複地建立和管理 AWS 基礎架構部署。" /><meta name="guide-locale" content="zh_tw" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="使用者指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="使用者指南" /><meta id="panorama-serviceConsolePage" value="透過使用執行 ECS 藍/綠部署 CodeDeploy AWS CloudFormation" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>透過使用執行 ECS 藍/綠部署 CodeDeploy AWS CloudFormation - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,資源佈建,資源組態,基礎設施管理,CloudFormer,CloudFormation 堆疊,CloudFormation 堆疊集,CloudFormation 範本,變更集合" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "使用者指南",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "使用 AWS CloudFormation 範本",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "透過使用執行 ECS 藍/綠部署 CodeDeploy AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-guide.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文件</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">使用者指南</a></div><div id="page-toc-src"><a href="#blue-green-required">使用  CloudFormation  資源建模您的藍色/綠色部署</a><a href="#blue-green-resources">觸發綠色部署的資源更新</a><a href="#blue-green-considerations">使用管理ECS 藍/綠部署時的考量事項  CloudFormation</a><a href="#blue-green-setup">準備範本以執行 ECS 藍/綠部署</a><a href="#blue-green-changesets">檢閱藍/綠部署的變更集</a><a href="#blue-green-events">檢視藍/綠部署的堆疊事件</a><a href="#blue-green-template-reference">範本參考</a><a href="#blue-green-iam">藍/綠部署所需的 IAM 許可</a><a href="#blue-green-template-example">範本範例</a></div><div id="page-filters" style="display:none"><filter label="All" id="All"></filter><filter label="JSON" id="JSON"></filter><filter label="YAML" id="YAML"></filter></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><awsui-alert class="awsdocs-page-banner awsui-util-mb-l"><p>本文為英文版的機器翻譯版本，如內容有任何歧義或不一致之處，概以英文版為準。</p></awsui-alert><h1 class="topictitle" id="blue-green">透過使用執行 ECS 藍/綠部署  CodeDeploy  AWS CloudFormation</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>您可以使用透 CloudFormation 過執行 ECS 藍/綠部署。AWS CodeDeploy藍/綠部署是一種安全的部署策略，可將變更應用程式版本所造成的中斷降至最低。 CodeDeploy 這可以透過建立新的應用程式環境 (稱為<em>綠色</em>)，以及目前為即時流量提供服務的應用程式 (稱為<em>藍色</em>) 來完成。這可讓您先監控和測試一段時間內的綠色環境，之後您的即時流量會從藍色路由傳送到綠色，然後關閉藍色資源。</p><p>使用執 CloudFormation 行 ECS 藍/綠部署時，您首先要建立堆疊範本，以定義藍色和綠色應用程式環境的資源，包括指定要使用的流量路由和穩定設定。接下來，您可以從該範本建立堆疊；這會產生您的藍色 (目前) 應用程式。 CloudFormation 只會在堆疊建立期間建立藍色資源。綠色部署的資源必須等到有需要時才會建立。</p><p>然後，如果在 future 的堆疊更新中，您更新藍色應用程式中的任務定義或作業集資源，請 CloudFormation 執行下列動作：</p><div class="itemizedlist">
         
         
         
    <ul class="itemizedlist"><li class="listitem"><p>產生所有必要的綠色應用程式環境資源</p></li><li class="listitem"><p>根據指定的流量路由參數轉移流量</p></li><li class="listitem"><p>刪除藍色資源</p></li></ul></div><p>如果在綠色部署成功並完成之前的任何時間點發生錯誤， CloudFormation  會將堆疊復原為起始整個綠色部署之前的狀態。</p><p>若 CloudFormation 要啟用在堆疊上執行藍/綠部署，請在其堆疊範本中包含下列資訊：</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem"><p>範本中叫用 <code class="code">AWS::CodeDeployBlueGreen</code> 轉換的 <code class="code">Transform</code> 區段，以及叫用 <code class="code">AWS::CodeDeploy::BlueGreen</code> 掛接的 <code class="code">Hook</code> 區段。</p></li><li class="listitem"><p>至少有一個 ECS 資源會觸發藍/綠部署 (若在堆疊更新期間取代)。目前，這些資源是 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> 和 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a>。</p></li></ul></div><p>然後，如果您啟動堆疊更新，更新上述資源的任何屬性需 CloudFormation 要取代資源，請依照上述方式 CloudFormation 執行藍/綠部署。如需資源更新行為的詳細資訊，請參閱 <a href="./using-cfn-updating-stacks-update-behaviors.html">更新堆疊資源的行為</a>。</p><p>在某些情況下，您需要在建立堆疊<em>之前</em>設定堆疊範本以啟用藍/綠部署。不過，您也可以新增將藍/綠部署 CloudFormation 執行至現有堆疊的功能。若要這樣做，請將必要的資訊新增至堆疊的現有範本。</p><p>此外，我們建議您在啟動堆疊更新之前，先為綠色部署 CloudFormation 產生變更集。這可讓您檢閱將對堆疊進行的實際變更。如需詳細資訊，請參閱 <a href="./using-cfn-updating-stacks-changesets.html">透過變更集更新堆疊</a>。</p>
        <h2 id="blue-green-required">使用  CloudFormation  資源建模您的藍色/綠色部署</h2>
        <p>若要使用 CodeDeploy 貫穿執行 ECS 藍/綠部署 CloudFormation，您的範本需要包含模型化部署的資源，例如 Amazon ECS 服務和負載平衡器。如需有關這些資源所代表內容的詳細資訊，請見《AWS CodeDeploy 使用者指南》<em></em>中<a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployment-steps-ecs.html#deployment-steps-prerequisites-ecs">在開始 Amazon ECS 部署之前</a>。</p>
        <div class="table-container"><div class="table-contents"><table id="w1348aac17c33c25b5"><thead>
                    <tr>
                        <th>需求</th>
                        <th>資源</th>
                        <th>必要/選用</th>
                        <th>在取代時觸發藍/綠部署</th>
                    </tr>
                </thead>
                    <tr>
                        <td tabindex="-1">Amazon ECS 叢集</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-cluster.html"><code class="code">AWS::ECS::Cluster</code></a></td>
                        <td tabindex="-1">選用。可以使用預設叢集。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Amazon ECS 服務</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html"><code class="code">AWS::ECS::Service</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">應用程式或 Network Load Balancer</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-service-loadbalancer.html"><code class="code">AWS::ECS::Service
       LoadBalancer</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">生產接聽程式</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">測試接聽程式 </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">選用。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">兩個目標群組</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html"><code class="code">AWS::ElasticLoadBalancingV2::TargetGroup</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Amazon ECS 任務定義 </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">是</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Amazon ECS 應用程式的容器</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-containerdefinitions.html#cfn-ecs-taskdefinition-containerdefinition-name.html"><code class="code">AWS::ECS::TaskDefinition ContainerDefinition Name</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">取代任務集的連接埠</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-portmapping.html#cfn-ecs-taskdefinition-portmapping-containerport"><code class="code">AWS::ECS::TaskDefinition PortMapping ContainerPort</code></a></td>
                        <td tabindex="-1">必要。</td>
                        <td tabindex="-1">否</td>
                    </tr>
                </table></div></div>
     
        <h2 id="blue-green-resources">觸發綠色部署的資源更新</h2>
        <p>如果您執行的堆疊更新會更新需要<a href="./using-cfn-updating-stacks-update-behaviors.html">取代</a>下列 ECS 資源的任何內容， CloudFormation 會起始綠色部署：</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></p></li><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a> </p></li></ul></div>
        
        <p>更新這些不需要資源取代的資源內容並不會觸發綠色部署。</p>
        <p>您無法在同一堆疊更新中包含上述資源的更新與其他資源的更新。如果您需要更新上述清單中的資源以及相同堆疊中的其他資源，請執行下列其中一項操作：</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p>執行兩個獨立的堆疊更新操作：一個只包含上述資源的更新，另一個包含任何其他資源變更的單獨堆疊更新。</p></li><li class="listitem"><p>從範本中移除 <code class="code">Transform</code> 和 <code class="code">Hook</code> 區段，然後執行堆疊更新。在這種情況下， CloudFormation 將不會執行綠色部署。</p></li></ul></div>
     
        <h2 id="blue-green-considerations">使用管理ECS 藍/綠部署時的考量事項  CloudFormation</h2>
        <p>使用  CloudFormation 定義藍色/綠色部署時，您應該考慮以下事項：</p>
        <div class="itemizedlist">
             
             
             
             
             
             
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>如中所述，只有對某些資源的更新才會起始綠色部署<a href="#blue-green-resources">觸發綠色部署的資源更新</a>。</p></li><li class="listitem"><p>您無法在同一堆疊更新中包含對起始綠色部署和其他資源更新的資源的更新，如中所述<a href="#blue-green-resources">觸發綠色部署的資源更新</a>。</p></li><li class="listitem"><p>您只能指定單一 ECS 服務作為部署目標。</p></li><li class="listitem"><p>在綠色部署期間， CodeDeploy 服務 CloudFormation 無法更新其值被模糊處理的參數，而且會導致錯誤和堆疊更新失敗。其中包含：</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p>使用 <code class="code">NoEcho</code> 屬性定義的參數。</p></li><li class="listitem"><p>使用動態參照從外部服務擷取其值的參數。如需詳細資訊，請參閱 <a href="./dynamic-references.html">使用動態參考來指定範本值</a>。</p></li></ul></div>
            </li><li class="listitem"><p>若要取消仍在進行中的綠色部署，請取消 (而非  CodeDeploy  ECS)  CloudFormation 中的堆疊更新。如需詳細資訊，請參閱 <a href="./using-cfn--stack-update-cancel.html">取消堆疊更新</a>。(更新完成之後無法取消。但是，您可以使用任何之前的設定重新更新堆疊。)</p></li><li class="listitem"><p>定義藍/綠 ECS 部署的範本目前不支援宣告<a href="./outputs-section-structure.html">輸出</a>或使<a href="./intrinsic-function-reference-importvalue.html">Fn::ImportValue</a>用從其他堆疊匯入值。</p></li><li class="listitem"><p><a href="./resource-import.html">將現有資源納入 CloudFormation 管理</a>定義藍/綠 ECS 部署的範本目前不支援。</p></li><li class="listitem"><p>您無法在包含巢狀堆疊資源的範本中使用 <code class="code">AWS::CodeDeploy::BlueGreen</code> 掛接。</p></li><li class="listitem"><p>您無法在<a href="./using-cfn-nested-stacks.html">巢狀堆疊</a>中使用 <code class="code">AWS::CodeDeploy::BlueGreen</code> 掛接。</p></li></ul></div>
        <p><em>如需使用如何透過使用 CloudFormation 僅使用的標準 Amazon ECS 部署執行 ECS 藍/綠部署的相關資訊 CodeDeploy，請參閱使用者指南中的 <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployments-create-prerequisites.html">Amazon ECS 藍/綠部署 CodeDeploy  CloudFormation與標準 Amazon ECS 部署之間的差異</a>。AWS CodeDeploy</em></p>
     
        <h2 id="blue-green-setup">準備範本以執行 ECS 藍/綠部署</h2>
        <p>若要在堆疊上啟用藍/綠部署，請在執行堆疊更新之前，在堆疊範本中包含下列區段。</p>
        <div class="itemizedlist">
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>將對 <code class="code">AWS::CodeDeployBlueGreen</code> 轉換的參考新增到您的範本中：</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],</code></pre>
</li><li class="listitem"><p>加入可叫用 <code class="code">AWS::CodeDeploy::BlueGreen</code> 掛接的 <code class="code">Hook</code> 區段，並指定部署的內容。使用下面的範本參考作為指南。</p></li><li class="listitem"><p>在 <code class="code">Resources</code> 區段中定義了您部署的藍色和綠色資源。</p></li></ul></div>
        <p>您可以在第一次建立範本時 (也就是在建立堆疊本身之前) 加入這些區段，也可以在執行堆疊更新之前將這些區段加入至現有範本。如果您為新堆疊指定藍/綠部署，則 CloudFormation 只會在堆疊建立期間建立藍色資源-綠色部署的資源在堆疊更新期間需要之前，才會建立綠色部署的資源。</p>

     
        <h2 id="blue-green-changesets">檢閱藍/綠部署的變更集</h2>
        <p>強烈建議您在執行將起始綠色部署的堆疊更新之前建立變更集。這可讓您在執行堆疊更新前，查看將對堆疊所做的實際變更。請注意，資源變更可能不會以堆疊更新期間執行的順序列出。如需詳細資訊，請參閱 <a href="./using-cfn-updating-stacks-changesets.html">透過變更集更新堆疊</a>。</p>
     
        <h2 id="blue-green-events">檢視藍/綠部署的堆疊事件</h2>
        <p>您可以使用 AWS CLI，在 <b>Stack</b> (堆疊) 頁面的 <b>Events</b> (事件) 索引標籤上檢視 ECS 部署每個步驟所產生的堆疊事件。如需詳細資訊，請參閱 <a href="./using-cfn-updating-stacks-monitor-stack.html">監控堆疊更新的進度</a>。</p>
     
        <h2 id="blue-green-template-reference">範本參考</h2>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Hooks": <span>{</span>
  "Logical ID": <span>{</span>
    "Properties": <span>{</span>
      "TrafficRoutingConfig": <span>{</span>
        "Type": "Traffic routing type",
        "TimeBasedCanary": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        },
        "TimeBasedLinear": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        }
      },
      "AdditionalOptions": <span>{</span>"TerminationWaitTimeInMinutes": Integer},
      "LifecycleEventHooks": <span>{</span>
        "BeforeInstall": "FunctionName",
        "AfterInstall": "FunctionName",
        "AfterAllowTestTraffic": "FunctionName",
        "BeforeAllowTraffic": "FunctionName",
        "AfterAllowTraffic": "FunctionName"
      },
      "ServiceRole": "CodeDeployServiceRoleName",
      "Applications": [
        <span>{</span>
          "Target": <span>{</span>
            "Type": "AWS::ECS::Service",
            "LogicalID": "Resource Logical ID"
          },
          "ECSAttributes": <span>{</span>
            "TaskDefinitions": [
              "AWS::ECS::TaskDefinition Resource Logical ID (Blue)",
              "AWS::ECS::TaskDefinition Resource Logical ID (Green)"
            ],
            "TaskSets": [
              "AWS::ECS::TaskSet Resource Logical ID (Blue)",
              "AWS::ECS::TaskSet Resource Logical ID (Green)"
            ],
            "TrafficRouting": <span>{</span>
              "ProdTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Production)"
              },
              "TestTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Test)"
              },
              "TargetGroups": [
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Blue)",
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Green)"
              ]
            }
          }
        }
      ]
    },
    "Type": "AWS::CodeDeploy::BlueGreen"
  }
}</code></pre>
         
            <h3 id="blue-green-template-reference-props">屬性</h3>
            <div class="variablelist">
                 
                 
            <dl>
                    <dt><span class="term"><code class="code">Logical ID</code></span></dt>
                    <dd>
                        <p>邏輯 ID 必須是英數字元 (A-Za-z0-9)，而且在範本內必須是唯一的。</p>
                        <p><em>必要</em>：是</p>
                        <div class="variablelist">
                             
                        <dl>
                                <dt><span class="term"><code class="code">Properties</code></span></dt>
                                <dd>
                                    <p>掛接的屬性。</p>
                                    <p><em>必要</em>：是</p>
                                    <div class="variablelist">
                                         
                                         
                                         
                                         
                                         
                                    <dl>
                                            <dt><span class="term"><code class="code">TrafficRoutingConfig</code></span></dt>
                                            <dd>
                                                <p>流量路由組態設定。</p>
                                                <p><em>必要</em>：否</p>
                                                <p>預設組態是以時間為基礎的 Canary 流量轉移，具有 15% 步驟百分比和 5 分鐘的封裝時間。</p>
                                                <div class="variablelist">
                                                    
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Type</code></span></dt>
                                                        <dd>
                                                            <p>部署組態所使用的流量轉移類型。</p>
                                                            <p>有效值： AllAtOnce |  TimeBasedCanary  |  TimeBasedLinear</p>
                                                            <p><em>必要</em>：是</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TimeBasedCanary</code></span></dt>
                                                                    <dd>
                                                                        <p>指定將流量以兩個增量為單位，從一個版本的部署轉移到另一個版本的規劃。</p>
                                                                        <p><em>必要</em>：有條件：如果您將 <code class="code">TimeBasedCanary</code> 指定為流量路由類型，則必須包含 <code class="code">TimeBasedCanary</code> 參數。</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>在 <code class="code">TimeBasedCanary</code> 部署的第一個增量中，要轉移的流量百分比。步驟百分比必須是 14% 或更大。</p>
                                                                                    <p><em>必要</em>：否</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p><code class="code">TimeBasedCanary</code> 部署第一次和第二次流量轉移之間的分鐘數。</p>
                                                                                    <p><em>必要</em>：否</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TimeBasedLinear</code></span></dt>
                                                                    <dd>
                                                                        <p>指定將流量從一個版本的部署轉移到另一個版本的組態，每個增量之間的分鐘數相等。</p>
                                                                        <p><em>必要</em>：有條件：如果您將 <code class="code">TimeBasedLinear</code> 指定為流量路由類型，則必須包含 <code class="code">TimeBasedLinear</code> 參數。</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>每個 <code class="code">TimeBasedLinear</code> 部署增量開始時移動的流量百分比。步驟百分比必須是 14% 或更大。</p>
                                                                                    <p><em>必要</em>：否</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p><code class="code">TimeBasedLinear</code> 部署的每個遞增流量轉移之間的分鐘數。</p>
                                                                                    <p><em>必要</em>：否</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">AdditionalOptions</code></span></dt>
                                            <dd>
                                                <p>藍/綠部署的其他選項。</p>
                                                <p><em>必要</em>：否</p>
                                                <div class="variablelist">
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">TerminationWaitTimeInMinutes</code></span></dt>
                                                        <dd>
                                                            <p>指定終止藍色資源之前的等待時間 (以分鐘為單位)。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">LifecycleEventHooks</code></span></dt>
                                            <dd>
                                                <p>使用生命週期事件掛接來指定 CodeDeploy 可呼叫以驗證部署的 Lambda 函數。針對部署生命週期事件，您可以使用相同的函數或不同的函數。完成驗證測試後，Lambda  AfterAllowTraffic  函數會回呼 CodeDeploy 並提供<code class="code">Succeeded</code>或的結果<code class="code">Failed</code>。</p>
                                                <p>若要取得更多資訊，請參閱AppSpec <em>《使用指南<a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html">》中的AWS CodeDeploy〈hook〉一節</a>。</em></p>
                                                <p><em>必要</em>：否</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                     
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">BeforeInstall</code></span></dt>
                                                        <dd>
                                                            <p>在建立替換任務之前，用來執行任務的函數。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterInstall</code></span></dt>
                                                        <dd>
                                                            <p>建立替代任務集後，用來執行任務，且與其中一個目標群組相關的函數。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTestTraffic</code></span></dt>
                                                        <dd>
                                                            <p>在測試接聽程式將流量轉發至替換任務集後，用來執行任務的函數。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">BeforeAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>在第二個目標群組與替換任務集建立關聯後，但在流量轉移到替換任務集前，用來執行任務的函數。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>在第二個目標群組將流量轉發至替換任務集後，用來執行任務的函數。</p>
                                                            <p><em>必要</em>：否</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">ServiceRole</code></span></dt>
                                            <dd>
                                                <p>用於 CloudFormation 執行藍綠色部署的執行角色。如需必要權限的清單，請參閱<a href="#blue-green-iam">藍/綠部署所需的 IAM 許可</a>。</p>
                                                <p><em>必要</em>：是</p>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">Applications</code></span></dt>
                                            <dd>
                                                <p>指定 Amazon ECS 應用程式的屬性。</p>
                                                <p><em>必要</em>：是</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Target</code></span></dt>
                                                        <dd>
                                                            <p></p>
                                                            <p><em>必要</em>：是</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                    <dd>
                                                                        <p>資源的類型。</p>
                                                                        <p><em>必要</em>：是</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                    <dd>
                                                                        <p>資源的邏輯 ID。</p>
                                                                        <p><em>必要</em>：是</p>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">ECSAttributes</code></span></dt>
                                                        <dd>
                                                            <p>代表 Amazon ECS 應用程式部署各種需求的資源。</p>
                                                            <p><em>必要</em>：是</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TaskDefinitions</code></span></dt>
                                                                    <dd>
                                                                        <p>執行包含 Amazon ECS 應用程式 Docker 容器的 <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> 資源邏輯 ID。</p>
                                                                        <p><em>必要</em>：是</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TaskSets</code></span></dt>
                                                                    <dd>
                                                                        <p>用作應用程式任務集的 <code class="code">AWS::ECS::TaskSet</code> 資源邏輯 ID。</p>
                                                                        <p><em>必要</em>：是</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TrafficRouting</code></span></dt>
                                                                    <dd>
                                                                        <p>指定用於流量路由的資源。</p>
                                                                        <p><em>必要</em>：是</p>
                                                                        <div class="variablelist">
                                                                             
                                                                             
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">ProdTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>供負載平衡器用來將流量導向到您目標群組的接聽程式。</p>
                                                                                    <p><em>必要</em>：是</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>資源的類型。<code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>必要</em>：是</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>資源的邏輯 ID。</p>
                                                                                                <p><em>必要</em>：是</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TestTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>供負載平衡器用來將流量導向到您目標群組的接聽程式。</p>
                                                                                    <p><em>必要</em>：是</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>資源的類型。<code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>必要</em>：是</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>資源的邏輯 ID。</p>
                                                                                                <p><em>必要</em>：否</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TargetGroups</code></span></dt>
                                                                                <dd>
                                                                                    <p>用作目標群組的資源邏輯 ID，以將流量路由至已登記的目標。</p>
                                                                                    <p><em>必要</em>：是</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                        </dl></div>
                                </dd>
                            </dl></div>
                    </dd>
                    
                 
                    <dt><span class="term"><code class="code">Type</code></span></dt>
                    <dd>
                        <p>掛接的類型。<code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                        <p><em>必要</em>：是</p>
                    </dd>
                </dl></div>
         
     
        <h2 id="blue-green-iam">藍/綠部署所需的 IAM 許可</h2>
        <p> CloudFormation 若要成功執行藍綠色部署，您必須具備下列 CodeDeploy 權限：</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><code class="code">codedeploy:Get*</code></p></li><li class="listitem"><p><code class="code">codedeploy:CreateCloudFormationDeployment</code></p></li></ul></div>
        <p>如需詳細<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html">資訊，請參閱 <em>AWSIdentity and Access Management 使用指南 CodeDeploy中的動作、資源和</em>條件金鑰</a>。</p>
     
        <h2 id="blue-green-template-example">範本範例</h2>
        <p>下列範例透過設定 ECS 藍/綠部署 CodeDeploy，流量路由進度為每個步驟 15%，每個步驟之間的穩定期間為 5 分鐘。使用範本建立堆疊會佈建部署的初始組態。</p>
        <p>如果您之後對需要取代該<code class="code">"BlueTaskSet"</code>資源的資源內容進行了任何變更，則 CloudFormation 會在堆疊更新過程中起始綠色部署。</p>
        <div id="JSON" name="JSON" class="section langfilter">
            <h3 id="blue-green-template-example.json">JSON</h3>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "Parameters": <span>{</span>
        "Vpc": <span>{</span>
            "Type": "AWS::EC2::VPC::Id"
        },
        "Subnet1": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        },
        "Subnet2": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        }
    },
    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],
    "Hooks": <span>{</span>
        "CodeDeployBlueGreenHook": <span>{</span>
            "Properties": <span>{</span>
                "TrafficRoutingConfig": <span>{</span>
                    "Type": "TimeBasedCanary",
                    "TimeBasedCanary": <span>{</span>
                        "StepPercentage": 15,
                        "BakeTimeMins": 5
                    }
                },
                "Applications": [
                    <span>{</span>
                        "Target": <span>{</span>
                            "Type": "AWS::ECS::Service",
                            "LogicalID": "ECSDemoService"
                        },
                        "ECSAttributes": <span>{</span>
                            "TaskDefinitions": [
                                "BlueTaskDefinition",
                                "GreenTaskDefinition"
                            ],
                            "TaskSets": [
                                "BlueTaskSet",
                                "GreenTaskSet"
                            ],
                            "TrafficRouting": <span>{</span>
                                "ProdTrafficRoute": <span>{</span>
                                    "Type": "AWS::ElasticLoadBalancingV2::Listener",
                                    "LogicalID": "ALBListenerProdTraffic"
                                },
                                "TargetGroups": [
                                    "ALBTargetGroupBlue",
                                    "ALBTargetGroupGreen"
                                ]
                            }
                        }
                    }
                ]
            },
            "Type": "AWS::CodeDeploy::BlueGreen"
        }
    },
    "Resources": <span>{</span>
        "ExampleSecurityGroup": <span>{</span>
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": <span>{</span>
                "GroupDescription": "Security group for ec2 access",
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 8080,
                        "ToPort": 8080,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "ALBTargetGroupBlue": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ALBTargetGroupGreen": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ExampleALB": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": <span>{</span>
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    <span>{</span>
                        "Ref": "ExampleSecurityGroup"
                    }
                ],
                "Subnets": [
                    <span>{</span>
                        "Ref": "Subnet1"
                    },
                    <span>{</span>
                        "Ref": "Subnet2"
                    }
                ],
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "Type": "application",
                "IpAddressType": "ipv4"
            }
        },
        "ALBListenerProdTraffic": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": <span>{</span>
                "DefaultActions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "LoadBalancerArn": <span>{</span>
                    "Ref": "ExampleALB"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ALBListenerProdRule": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": <span>{</span>
                "Actions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "Conditions": [
                    <span>{</span>
                        "Field": "http-header",
                        "HttpHeaderConfig": <span>{</span>
                            "HttpHeaderName": "User-Agent",
                            "Values": [
                                "Mozilla"
                            ]
                        }
                    }
                ],
                "ListenerArn": <span>{</span>
                    "Ref": "ALBListenerProdTraffic"
                },
                "Priority": 1
            }
        },
        "ECSTaskExecutionRole": <span>{</span>
            "Type": "AWS::IAM::Role",
            "Properties": <span>{</span>
                "AssumeRolePolicyDocument": <span>{</span>
                    "Version": "2012-10-17",
                    "Statement": [
                        <span>{</span>
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": <span>{</span>
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ]
            }
        },
        "BlueTaskDefinition": <span>{</span>
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": <span>{</span>
                "ExecutionRoleArn": <span>{</span>
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    <span>{</span>
                        "Name": "DemoApp",
                        "Image": "nginxdemos/hello:latest",
                        "Essential": true,
                        "PortMappings": [
                            <span>{</span>
                                "HostPort": 80,
                                "Protocol": "tcp",
                                "ContainerPort": 80
                            }
                        ]
                    }
                ],
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "NetworkMode": "awsvpc",
                "Cpu": "256",
                "Memory": "512",
                "Family": "ecs-demo"
            }
        },
        "ECSDemoCluster": <span>{</span>
            "Type": "AWS::ECS::Cluster",
            "Properties": <span>{</span>}
        },
        "ECSDemoService": <span>{</span>
            "Type": "AWS::ECS::Service",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "DesiredCount": 1,
                "DeploymentController": <span>{</span>
                    "Type": "EXTERNAL"
                }
            }
        },
        "BlueTaskSet": <span>{</span>
            "Type": "AWS::ECS::TaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "LaunchType": "FARGATE",
                "NetworkConfiguration": <span>{</span>
                    "AwsVpcConfiguration": <span>{</span>
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": [
                            <span>{</span>
                                "Ref": "ExampleSecurityGroup"
                            }
                        ],
                        "Subnets": [
                            <span>{</span>
                                "Ref": "Subnet1"
                            },
                            <span>{</span>
                                "Ref": "Subnet2"
                            }
                        ]
                    }
                },
                "PlatformVersion": "1.4.0",
                "Scale": <span>{</span>
                    "Unit": "PERCENT",
                    "Value": 100
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskDefinition": <span>{</span>
                    "Ref": "BlueTaskDefinition"
                },
                "LoadBalancers": [
                    <span>{</span>
                        "ContainerName": "DemoApp",
                        "ContainerPort": 80,
                        "TargetGroupArn": <span>{</span>
                            "Ref": "ALBTargetGroupBlue"
                        }
                    }
                ]
            }
        },
        "PrimaryTaskSet": <span>{</span>
            "Type": "AWS::ECS::PrimaryTaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskSetId": <span>{</span>
                    "Fn::GetAtt": [
                        "BlueTaskSet",
                        "Id"
                    ]
                }
            }
        }
    }
}</code></pre>

        </div>
        <div id="YAML" name="YAML" class="section langfilter">
            <h3 id="blue-green-template-example.yaml">YAML</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">Parameters:
  Vpc:
    Type: 'AWS::EC2::VPC::Id'
  Subnet1:
    Type: 'AWS::EC2::Subnet::Id'
  Subnet2:
    Type: 'AWS::EC2::Subnet::Id'
Transform:
  - 'AWS::CodeDeployBlueGreen'
Hooks:
  CodeDeployBlueGreenHook:
    Properties:
      TrafficRoutingConfig:
        Type: TimeBasedCanary
        TimeBasedCanary:
          StepPercentage: 15
          BakeTimeMins: 5
      Applications:
        - Target:
            Type: 'AWS::ECS::Service'
            LogicalID: ECSDemoService
          ECSAttributes:
            TaskDefinitions:
              - BlueTaskDefinition
              - GreenTaskDefinition
            TaskSets:
              - BlueTaskSet
              - GreenTaskSet
            TrafficRouting:
              ProdTrafficRoute:
                Type: 'AWS::ElasticLoadBalancingV2::Listener'
                LogicalID: ALBListenerProdTraffic
              TargetGroups:
                - ALBTargetGroupBlue
                - ALBTargetGroupGreen
    Type: 'AWS::CodeDeploy::BlueGreen'
Resources:
  ExampleSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Security group for ec2 access
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  ALBTargetGroupBlue:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ALBTargetGroupGreen:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ExampleALB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ExampleSecurityGroup
      Subnets:
        - !Ref Subnet1
        - !Ref Subnet2
      Tags:
        - Key: Group
          Value: Example
      Type: application
      IpAddressType: ipv4
  ALBListenerProdTraffic:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      LoadBalancerArn: !Ref ExampleALB
      Port: 80
      Protocol: HTTP
  ALBListenerProdRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Properties:
      Actions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: User-Agent
            Values:
              - Mozilla
      ListenerArn: !Ref ALBListenerProdTraffic
      Priority: 1
  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
  BlueTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ExecutionRoleArn: !GetAtt 
        - ECSTaskExecutionRole
        - Arn
      ContainerDefinitions:
        - Name: DemoApp
          Image: 'nginxdemos/hello:latest'
          Essential: true
          PortMappings:
            - HostPort: 80
              Protocol: tcp
              ContainerPort: 80
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: '256'
      Memory: '512'
      Family: ecs-demo
  ECSDemoCluster:
    Type: 'AWS::ECS::Cluster'
    Properties: <span>{</span>}
  ECSDemoService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref ECSDemoCluster
      DesiredCount: 1
      DeploymentController:
        Type: EXTERNAL
  BlueTaskSet:
    Type: 'AWS::ECS::TaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsVpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref ExampleSecurityGroup
          Subnets:
            - !Ref Subnet1
            - !Ref Subnet2
      PlatformVersion: 1.4.0
      Scale:
        Unit: PERCENT
        Value: 100
      Service: !Ref ECSDemoService
      TaskDefinition: !Ref BlueTaskDefinition
      LoadBalancers:
        - ContainerName: DemoApp
          ContainerPort: 80
          TargetGroupArn: !Ref ALBTargetGroupBlue
  PrimaryTaskSet:
    Type: 'AWS::ECS::PrimaryTaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      Service: !Ref ECSDemoService
      TaskSetId: !GetAtt 
        - BlueTaskSet
        - Id</code></pre>
        </div>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>您的瀏覽器已停用或無法使用 Javascript。</strong></p><p>您必須啟用 Javascript，才能使用 AWS 文件。請參閱您的瀏覽器說明頁以取得說明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文件慣用形式</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./modules.html">使用模組</div><div id="next" class="next-link" accesskey="n" href="./cfn-regexes.html">使用常規表達式</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此頁面是否有幫助？ - 是</div><div class="content"><p>感謝您，讓我們知道我們做得很好！</p><p>若您有空，歡迎您告知我們值得讚許的地方，這樣才能保持良好服務。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此頁面是否有幫助？ - 否</div><div class="content"><p>感謝讓我們知道此頁面仍須改善。很抱歉，讓您失望。</p><p>若您有空，歡迎您提供改善文件的方式。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>