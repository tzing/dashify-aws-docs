<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>演練：查詢 Amazon 機器映像 ID - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><meta name="default_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="description" content="AWS Lambda 屬於一種自訂資源，可協助您動態查詢 AMI ID。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="使用者指南" /><meta name="abstract" content="使 AWS CloudFormation 用本使用者指南可預測並重複地建立和管理 AWS 基礎架構部署。" /><meta name="guide-locale" content="zh_tw" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="使用者指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="使用者指南" /><meta id="panorama-serviceConsolePage" value="演練：查詢 Amazon 機器映像 ID" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>演練：查詢 Amazon 機器映像 ID - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,資源佈建,資源組態,基礎設施管理,CloudFormer,CloudFormation 堆疊,CloudFormation 堆疊集,CloudFormation 範本,變更集合" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "使用者指南",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "使用 AWS CloudFormation 範本",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "自訂資源",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-custom-resources.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "AWS Lambda 後端自訂資源",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "演練：查詢 Amazon 機器映像 ID",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文件</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">使用者指南</a></div><div id="page-toc-src"><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">步驟 1：下載並儲存 Amazon S3 中的範例套件</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">步驟 2：建立堆疊</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">步驟 3：清除資源</a><a href="#w9aac23c26c16b7c29">相關資訊</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><awsui-alert class="awsdocs-page-banner awsui-util-mb-l"><p>本文為英文版的機器翻譯版本，如內容有任何歧義或不一致之處，概以英文版為準。</p></awsui-alert><h1 class="topictitle" id="walkthrough-custom-resources-lambda-lookup-amiids">演練：查詢 Amazon 機器映像 ID</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>宣告 Amazon Elastic Compute Cloud (Amazon EC2) 執行個體的 AWS CloudFormation 範本亦必須指定 Amazon Machine Image (AMI) ID，該 ID 內含作業系統、其他軟體以及用來啟動執行個體的組態資訊。而 AMI ID 是否正確將取決於啟動堆疊的執行個體類型與區域。此外，在透過軟體更新進行 AMI 更新等情況下，ID 可能會定期變更。</p><p>一般而言，您可能會將 AMI ID 對應至特定的執行個體類型與區域。因此，您需要在每個範本中手動變更 ID，才能更新這些 ID。您可以利用自訂資源與 AWS Lambda (Lambda) 來建立函數，藉此獲取使用中區域和執行個體類型的最新 AMI ID，便不需維護映射。</p><p>本演練會說明如何建立自訂資源，並將該資源與 Lambda 函數建立關聯，以便查詢 AMI ID。請注意，我們在此演練中會假設您已掌握使用自訂資源與 Lambda 的方法。如需詳細資訊，請參閱 <a href="./template-custom-resources.html">自訂資源</a> 或《<a href="https://docs.aws.amazon.com/lambda/latest/dg/">AWS Lambda 開發人員指南</a>》。</p><p>逐步解說概觀</p><p>在本演練中，您將透過自訂資源、Lambda 函數與 EC2 執行個體來建立堆疊。建立堆疊時，您可以善用本演練所提供的範本程式碼與範例範本。</p><p>範例範本會採用自訂資源類型來呼叫輸入值，並將該值傳送至 Lambda 函數。AWS CloudFormation 會在您使用範本時叫用函數，進而將請求類型、輸入資料與預先簽章的 Amazon Simple Storage Service (Amazon S3) URL 等資訊傳送至該函數。接著，此函數便會使用這些資訊來查詢 AMI ID，並將回應傳送至預先簽章的 URL。</p><p>AWS CloudFormation 在預先簽章的 URL 位置中取得回應之後，便會繼續建立堆疊。在建立執行個體時，AWS CloudFormation 會透過 Lambda 函數的回應來指定該執行個體的 AMI ID。</p><p>下列清單會摘要說明整個程序。您需要擁有 AWS Identity and Access Management (IAM) 許可，才能使用所有對應的服務 (如 Lambda、Amazon EC2 與 AWS CloudFormation)。</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注意</h6></div><div class="awsdocs-note-text"><p>儘管 AWS CloudFormation 屬於免費服務，您仍需依照目前費率，為堆疊中所含的 Lambda 函數及 EC2 執行個體等 AWS 資源支付費用。如需有關 AWS 定價的詳細資訊，請參閱 <a href="https://aws.amazon.com/" rel="noopener noreferrer" target="_blank"><span>http://aws.amazon.com</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> 上各項產品的詳細資訊頁面。</p></div></div><div class="orderedlist">
     
     
     
  <ol><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">在 Amazon Simple Storage Service (Amazon S3) 儲存貯體中儲存 Lambda 範例套件。</a></p>
      <p>範例套件中會包含建立 Lambda 函數所需的一切內容；您必須將該套件儲存在儲存貯體中，且該儲存貯體需位於建立堆疊的所在區域。</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">使用範例範本建立堆疊。</a></p>
      <p>堆疊會示範建立 Lambda 函數與自訂資源間關聯的方法，以及如何使用該函數所產生的結果來指定 AMI ID。不僅如此，堆疊還會建立 IAM 角色 (意即執行角色)，以供 Lambda 呼叫 Amazon EC2。</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">刪除堆疊</a></p>
      <p>您可以刪除堆疊以清除建立的所有堆疊資源，便無需為不必要的資源支付費用。</p>
    </li></ol></div><h2 id="walkthrough-custom-resources-lambda-lookup-amiids-savesample">步驟 1：下載並儲存 Amazon S3 中的範例套件</h2>
    
    <p>當您使用 Lambda 函數建立堆疊時，必須指定包含函數原始程式碼的 Amazon S3 儲存貯體位置。且該儲存貯體需位於建立堆疊的所在區域。</p>
    <p>本演練會提供建立 Lambda 函數所需的範例套件 (<code>.zip</code> 檔案)。該 Lambda 套件內含函數的原始程式碼與必備程式庫。在本演練中，函數並不需使用額外的程式庫。</p>
    <p>該函數會從 AWS CloudFormation 自訂資源請求中擷取執行個體的架構和區域作為輸入項，然後將最新的 AMI ID 傳回預先簽章的 Amazon S3 URL。</p>
    <div class="procedure"><h6>下載並儲存 Amazon S3 中的套件</h6><ol><li>
        <p>從 Amazon S3 下載範例套件。儲存檔案時，請務必使用與範例相同的檔案名稱，例如 <code>amilookup.zip</code> 或 <code>amilookup-win.zip</code>。</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">查詢 Linux AMI ID</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          
            <dt><b><span class="term">查詢 Windows AMI ID</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          </dl></div>
      </li><li>
        <p>前往 <a href="https://console.aws.amazon.com/s3/home" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/s3/home</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>，開啟 Amazon S3 主控台。</p>
      </li><li>
        <p>選擇或建立儲存貯體，該儲存貯體需位於建立 AWS CloudFormation 堆疊的所在區域。接著，記錄儲存貯體的名稱。</p>
        <p>您必須在此儲存貯體中儲存範例套件。如需有關建立儲存貯體的詳細資訊，請參閱《Amazon Simple Storage Service 使用者指南》中的<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/CreatingaBucket.html">建立儲存貯體</a>。</p>
      </li><li>
        <p>將範例套件上傳至所選或建立的儲存貯體。</p>
        <p>如需有關上傳物件的詳細資訊，請參閱《Amazon Simple Storage Service 使用者指南》中的<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/UploadingObjectsintoAmazonS3.html">上傳物件</a>。</p>
      </li></ol></div>
    <p>將套件上傳至 Amazon S3 後，即可在 AWS CloudFormation 範本的 Lambda 資源宣告中指定該套件的位置。下一個步驟將示範透過自訂資源宣告並呼叫函數的方法。此外，您亦能了解如何使用函數所產生的結果來指定 EC2 執行個體的 AMI ID。</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">步驟 2：建立堆疊</h2>
    
    <p>如需建立 Amazon EC2 範例堆疊，則使用的範本便需要包含 Lambda 函數、IAM 執行角色、能呼叫函數的自訂資源，以及可以使用函數結果的 EC2 執行個體。</p>
    <p>堆疊建立期間，自訂資源會呼叫 Lambda 函數，並等候該函數將回應傳送至預先簽章的 Amazon S3 URL。在此回應中，該函數所傳回的最新 AMI ID 會對應至 EC2 執行個體類型，以及建立執行個體的區域。系統會將該函數回應中的資料存放為自訂資源的屬性，藉此指定 EC2 執行個體的 AMI ID。</p>
    <p>以下程式碼片段將說明範例範本的相關部分，協助您了解如何建立 Lambda 函數與自訂資源間的關聯，亦可掌握函數回應的使用方法。</p>
    <p>如需檢視整個範例範本，請參閱：</p>
    <div class="variablelist">
       
       
    <dl>
        <dt><b><span class="term">Linux 範本</span></b></dt>
        <dd>
          <p>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMI <a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>LookupSample。模板。</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      
        <dt><b><span class="term">Windows 範本</span></b></dt>
        <dd>
          <p>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMI <a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>。贏LookupSample的模板。</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      </dl></div>
    <p>堆疊範本程式碼片段</p>
    <p>如需建立 Lambda 函數，則請宣告 <code class="code">AWS::Lambda::Function</code> 資源；此操作需具備函數原始程式碼、處理常式名稱、執行時間環境與執行角色 ARN。</p>
    <div class="example"><h6>範例 JSON 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfoFunction": <span>{</span>
  "Type": "AWS::Lambda::Function",
  "Properties": <span>{</span>
    "Code": <span>{</span>
      "S3Bucket": <span>{</span> "Ref": "S3Bucket" },
      "S3Key": <span>{</span> "Ref": "S3Key" }
    },
    "Handler": <span>{</span> "Fn::Join" : [ "", [<span>{</span> "Ref": "ModuleName" },".handler"] ] },
    "Runtime": "nodejs18.x",
    "Timeout": "30",
    "Role": <span>{</span> "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] }
  }
}</code></pre></div></div>
    <div class="example"><h6>範例 YAML 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfoFunction:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      S3Bucket: !Ref S3Bucket
      S3Key: !Ref S3Key
    Handler: !Sub "$<span>{</span>ModuleName}.handler"
    Runtime: nodejs18.x
    Timeout: 30
    Role: !GetAtt LambdaExecutionRole.Arn</code></pre></div></div>
    <p><code class="code">Code</code> 屬性會指定儲存範例套件的 Amazon S3 位置 (儲存貯體名稱和檔案名稱)。為了讓您可以在建立堆疊時指定名稱，範例範本會使用 <code class="code">"Ref":
        "S3Bucket"</code> 和 <code class="code">"Ref": "S3Key"</code> 這兩個輸入參數來設定儲存貯體及檔案的名稱。同樣地，對應於<code>.zip</code>封裝中來源檔案 (檔案) 名稱的 JavaScript 處理常式名稱也會使用 input 參數 (<code class="code">"Ref":
        "ModuleName"</code>)。因為來源檔案是 JavaScript 程式碼，所以執行階段會指定為<code class="code">nodejs18.x</code>。</p>
    <p>在本演練中，函數的執行時間會超出預設值 <code class="code">3</code> 秒，所以系統會將逾時期間設為 <code class="code">30</code> 秒。若您指定的逾時期間不夠長，則 Lambda 可能會在函數完成前發生逾時，導致堆疊建立失敗。</p>
    <p>除此之外，系統會利用 <code class="code">Fn::GetAtt</code> 屬性中的 <code class="code">Role</code> 內部函數指定執行角色，然後在範本中其他位置宣告此角色。該執行角色會授與 Lambda 函數相關許可，進而將日誌傳送至 AWS 並呼叫 EC2 <code class="code">DescribeImages</code> API。以下程式碼片段會顯示授與適當許可的角色與政策：</p>
    <div class="example"><h6>範例 JSON 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"LambdaExecutionRole": <span>{</span>
  "Type": "AWS::IAM::Role",
  "Properties": <span>{</span>
    "AssumeRolePolicyDocument": <span>{</span>
      "Version": "2012-10-17",
      "Statement": [<span>{</span>
        "Effect": "Allow",
        "Principal": <span>{</span>"Service": ["lambda.amazonaws.com"]},
        "Action": ["sts:AssumeRole"]
      }]
    },
    "Path": "/",
    "Policies": [<span>{</span>
      "PolicyName": "root",
      "PolicyDocument": <span>{</span>
        "Version": "2012-10-17",
        "Statement": [<span>{</span>
          "Effect": "Allow",
          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
          "Resource": "arn:aws:logs:*:*:*"
        },
        <span>{</span>
          "Effect": "Allow",
          "Action": ["ec2:DescribeImages"],
          "Resource": "*"
        }]
      }
    }]
  }
}</code></pre></div></div>
    <div class="example"><h6>範例 YAML 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
      - Effect: Allow
        Principal:
          Service:
          - lambda.amazonaws.com
        Action:
        - sts:AssumeRole
    Path: "/"
    Policies:
    - PolicyName: root
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - ec2:DescribeImages
          Resource: "*"</code></pre></div></div>
    <p>在 Linux 和 Windows 範本中，自訂資源將呼叫與其相關聯的 Lambda 函數。若要建立函數與自訂資源間的關聯，則請使用 <code class="code">Fn::GetAtt</code> 內部函數，為 <code class="code">ServiceToken</code> 屬性指定函數的 Amazon Resource Name (ARN)。AWS CloudFormation 會將自訂資源宣告內含的 <code class="code">Region</code> 和 <code class="code">Architecture</code> 等其他屬性傳送至 Lambda 函數，並作為輸入項。Lambda 函數則負責判斷這些輸入屬性的正確名稱與數值。</p>
    <div class="example"><h6>範例 JSON 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "Architecture": <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>範例 YAML 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    Architecture:
      Fn::FindInMap:
      - AWSInstanceType2Arch
      - !Ref InstanceType
      - Arch</code></pre></div></div>
    <p>在 Windows 作業系統中，自訂資源會提供 Windows 版本給 Lambda 函數，而非執行個體的架構。</p>
    <div class="example"><h6>範例 JSON 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "OSName": <span>{</span> "Ref": "WindowsVersion" }
  }
}</code></pre></div></div>
    <div class="example"><h6>範例 YAML 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    OSName: !Ref "WindowsVersion"</code></pre></div></div>
    <p>當 AWS CloudFormation 叫用 Lambda 函數時，該函數即會呼叫 EC2 <code class="code">DescribeImages</code> API，進而使用區域和執行個體架構，或是作業系統名稱來篩選影像清單。接著，函數將按日期排序該影像清單，並傳回最新的 AMI ID。</p>
    <p>在回傳最新的 AMI ID 期間，該函數會在<a href="./crpg-ref-responses.html">回應物件</a>的 <code class="code">Data</code> 屬性中，將 ID 傳送至預先簽章的 URL。資料的結構為名稱/值組，如以下範例所示：</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Data": <span>{</span> 
  "Id": "ami-43795473"
}</code></pre>
    <p>以下程式碼片段會說明從 Lambda 函數取得資料的方法，其會透過 <code class="code">Fn::GetAtt</code> 內部函數，進而提供欲獲取的自訂資源名稱與數值屬性名稱。在本演練中，自訂資源名稱為 <code class="code">AMIInfo</code>，屬性名稱則為 <code class="code">Id</code>。</p>
    <div class="example"><h6>範例 JSON 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"SampleInstance": <span>{</span>  
  "Type": "AWS::EC2::Instance",
  "Properties": <span>{</span>
    "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
    "ImageId": <span>{</span> "Fn::GetAtt": [ "AMIInfo", "Id" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>範例 YAML 語法</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">SampleInstance:
  Type: AWS::EC2::Instance
  Properties:
    InstanceType: !Ref InstanceType
    ImageId: !GetAtt AMIInfo.Id</code></pre></div></div>
    <p>現在，您已經掌握範本的功能，即可透過範例範本來建立堆疊。</p>
    <div class="procedure"><h6>建立堆疊</h6><ol><li>
        <p><a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>請在以下位置開啟AWS CloudFormation主控台。</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> https://console.aws.amazon.com/cloudformation/</p>
      </li><li>
        <p>選擇 <b>Create Stack</b> (建立堆疊)。</p>
      </li><li>
        <p>在 <b>Template (範本)</b> 區段中，選擇 <b>Specify an Amazon S3 template URL (指定 Amazon S3 範本 URL)</b>，然後複製以下 URL 並貼到文字方塊中：</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Linux 範本</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          
            <dt><b><span class="term">Windows 範本</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          </dl></div>
      </li><li>
        <p>選擇<b>下一步</b>。</p>
      </li><li>
        <p>在 <b>Stack name (堆疊名稱)</b> 欄位中，輸入 <code class="userinput">SampleEC2Instance</code>。</p>
      </li><li>
        <p>在 <b>Parameters (參數)</b> 區段中，指定您所建的 Amazon S3 儲存貯體名稱，接著選擇 <b>Next (下一步)</b>。</p>
        <p>其他參數的預設值會與範例 <code>.zip</code> 套件所使用的名稱相同。</p>
      </li><li>
        <p>在此逐步解說中，您不需要新增標籤或指定進階設定，因此請選擇 <b>Next (下一步)</b>。</p>
      </li><li>
        <p>確認堆疊名稱和範本 URL 無誤，接著選擇 <b>Create (建立)</b>。</p>
      </li></ol></div>
    <p>AWS CloudFormation 可能需要幾分鐘的時間來建立您的堆疊。若要監控進度，請檢視堆疊事件。如需詳細資訊，請參閱 <a href="./cfn-console-view-stack-data-resources.html">檢視 AWS CloudFormation 堆疊資料和資源 AWS Management Console</a>。</p>
    <p>若堆疊建立成功，則系統會一併建立堆疊中所有資源 (如 Lambda 函數、自訂資源與 EC2 執行個體)。您已成功透過 Lambda 函數及自訂資源指定 EC2 執行個體的 AMI ID，所以無需在此範本中建立並維護 AMI ID 的映射。</p>
    <p>請檢視堆疊輸出，即可查看 AWS CloudFormation 建立 EC2 執行個體時所使用的 AMI ID。</p>
   <p>如果 Lambda 函數傳回錯誤，請在 Amazon 日誌<a href="https://console.aws.amazon.com/cloudwatch/home#logs:" rel="noopener noreferrer" target="_blank"><span>主控台</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>中檢視函數的 CloudWatch 日誌。日誌串流名稱即為自訂資源的實體 ID，您能夠檢視堆疊資源以查詢該名稱。如需詳細資訊，請參<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#ViewingLogData">閱 <em>Amazon  CloudWatch  使用者指南</em>中的檢視日誌資料</a>。</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">步驟 3：清除資源</h2>
    
    <p>為了避免您因不需要的服務而支付費用，請刪除堆疊。</p>
    <div class="procedure"><h6>刪除堆疊</h6><ol><li>
        <p>從 AWS CloudFormation 主控台選擇 <b>SampleEC2Instance</b> 堆疊。</p>
      </li><li>
        <p>選擇 <b>Actions (動作)</b>，然後選擇 <b>Delete Stack (刪除堆疊)</b>。</p>
      </li><li>
        <p>在確認訊息中，選擇 <b>Yes, Delete (是，刪除)</b>。</p>
      </li></ol></div>
    <p>系統將刪除您建立的所有資源。</p>
    <p>現在，您已經了解如何透過 AWS CloudFormation 建立並使用 Lambda 函數，即可善用本演練的範例範本和程式碼來建置其他堆疊及函數。</p>
  <h2 id="w9aac23c26c16b7c29">相關資訊</h2>
    
    <div class="itemizedlist">
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="./crpg-ref.html">AWS CloudFormation 自訂資源參考</a></p>
      </li></ul></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>您的瀏覽器已停用或無法使用 Javascript。</strong></p><p>您必須啟用 Javascript，才能使用 AWS 文件。請參閱您的瀏覽器說明頁以取得說明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文件慣用形式</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-custom-resources-lambda.html">AWS Lambda 後端自訂資源</div><div id="next" class="next-link" accesskey="n" href="./cfn-lambda-function-code-cfnresponsemodule.html">cfn-response 模組</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此頁面是否有幫助？ - 是</div><div class="content"><p>感謝您，讓我們知道我們做得很好！</p><p>若您有空，歡迎您告知我們值得讚許的地方，這樣才能保持良好服務。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此頁面是否有幫助？ - 否</div><div class="content"><p>感謝讓我們知道此頁面仍須改善。很抱歉，讓您失望。</p><p>若您有空，歡迎您提供改善文件的方式。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>