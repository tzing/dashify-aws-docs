<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>演練：更新堆疊 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="updating.stacks.walkthrough" /><meta name="default_state" content="updating.stacks.walkthrough" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="description" content="您可以使用 AWS CloudFormation，逐步完成更新運作中堆疊的簡易程序。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="使用者指南" /><meta name="abstract" content="使 AWS CloudFormation 用本使用者指南可預測並重複地建立和管理 AWS 基礎架構部署。" /><meta name="guide-locale" content="zh_tw" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="使用者指南" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="使用者指南" /><meta id="panorama-serviceConsolePage" value="演練：更新堆疊" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>演練：更新堆疊 - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,資源佈建,資源組態,基礎設施管理,CloudFormer,CloudFormation 堆疊,CloudFormation 堆疊集,CloudFormation 範本,變更集合" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "使用者指南",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "AWS CloudFormation 入門",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/GettingStarted.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "演練：更新堆疊",
        "item" : "https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/GettingStarted.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">文件</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">使用者指南</a></div><div id="page-toc-src"><a href="#updating.simple.application">簡易的應用程式</a><a href="#updating.create.initial.stack">建立初始堆疊</a><a href="#update.application">更新應用程式</a><a href="#update.walkthrough.changing.resource.properties">變更資源屬性</a><a href="#update.walkthrough.adding.properties">新增資源屬性</a><a href="#update.walkthrough.change.resources">變更堆疊的資源</a><a href="#update.walkthrough.impact">可用性與影響考量事項</a><a href="#update.walkthrough.related">相關資源</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><awsui-alert class="awsdocs-page-banner awsui-util-mb-l"><p>本文為英文版的機器翻譯版本，如內容有任何歧義或不一致之處，概以英文版為準。</p></awsui-alert><h1 class="topictitle" id="updating.stacks.walkthrough">演練：更新堆疊</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>透過 AWS CloudFormation，即可在現有堆疊中更新資源的屬性。這些變更的範圍包括簡單的組態變更 (例如更新警示上的 CloudWatch 警示閾值) 到更複雜的變更 (例如更新 Amazon EC2 執行個體上執行的 Amazon Machine Image (AMI)。範本中有許多 AWS 資源皆可進行更新，而我們亦會持續新增更多資源的支援。</p><p>本節會逐步講解更新運作中堆疊的簡易程序，並說明如何透過範本來善用 AWS 基礎設施的組態版本控制系統，如同使用運作中軟體的版本控制一般。我們將逐步解說以下步驟：</p><div class="orderedlist">
     
     
     
     
     
     
  <ol><li>
      <p><a href="#updating.create.initial.stack">建立初始堆疊</a> – 使用基本的 Amazon Linux AMI，並透過 AWS CloudFormation 協助程式指令碼來安裝 Apache Web 伺服器與簡易的 PHP 應用程式，藉此建立堆疊。</p>
    </li><li>
      <p><a href="#update.application">更新應用程式</a>— 更新應用程序中的文件之一，並使用部署軟件 CloudFormation.</p>
    </li><li>
      <p> <a href="#update.walkthrough.instance.type">更新執行個體類型</a> – 變更基礎 Amazon EC2 執行個體的執行個體類型。</p>
    </li><li>
      <p> <a href="#update.walkthrough.ami">更新 Amazon EC2 執行個體上的 AMI</a> – 變更堆疊中 Amazon EC2 執行個體的 Amazon Machine Image (AMI)。</p>
    </li><li>
      <p><a href="#update.walkthrough.security.group">將金鑰對新增至執行個體</a> – 將 Amazon EC2 金鑰對新增至執行個體，接著更新安全群組以允許 SSH 存取該執行個體。</p>
    </li><li>
      <p><a href="#update.walkthrough.change.resources">變更堆疊的資源</a> – 從堆疊中新增與移除資源，並更新範本以將其轉換成可自動調整規模、負載平衡的應用程式。</p>
    </li></ol></div>
    <h2 id="updating.simple.application">簡易的應用程式</h2>

    <p>我們將開始建立堆疊，而本節其餘的部分皆可使用此堆疊。我們所提供的簡易範本能啟動 Apache Web 伺服器上託管的單一執行個體 PHP Web 應用程式，並在 Amazon Linux AMI 上執行該應用程式。</p>
    <p>Amazon Linux AMI 會預設安裝  CloudFormation  協助程式指令碼，進而透過該指令碼來安裝 Apache Web 伺服器、PHP 與簡易的 PHP 應用程式。下列範本程式碼片段所顯示的中繼資料會說明要安裝的套件與檔案，此處將以來自 Amazon Linux AMI Yum 儲存庫的 Apache Web 伺服器與 PHP 基礎設施為例。而藉由出現在該程式碼片段中的 Services 區段，可確保系統正在執行 Apache Web 伺服器。在 Amazon EC2 執行個體定義的「屬性」區段中， UserData 屬性包含呼叫 cfn-init 以安裝套件和 CloudInit 檔案的指令碼。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
  "WebServerInstance": <span>{</span>
    "Type" : "AWS::EC2::Instance",
    "Metadata" : <span>{</span>
      "AWS::CloudFormation::Init" : <span>{</span>
        "config" : <span>{</span>
          "packages" : <span>{</span>
            "yum" : <span>{</span>
              "httpd"             : [],
              "php"               : []
            }
          },

          "files" : <span>{</span>

            "/var/www/html/index.php" : <span>{</span>
              "content" : <span>{</span> "Fn::Join" : ["", [
                "&lt;?php\n",
                "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                "echo '&lt;p&gt;", <span>{</span> "Ref" : "WelcomeMessage" }, "&lt;/p&gt;';\n",
                "?&gt;\n"
              ]]},
              "mode"    : "000644",
              "owner"   : "apache",
              "group"   : "apache"
            },
          },

          :

          "services" : <span>{</span>
            "sysvinit" : <span>{</span>
              "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" }
            }
          }
        }
      }
    },

    "Properties": <span>{</span>
      :
      "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
        "#!/bin/bash\n",
        "yum install -y aws-cfn-bootstrap\n",

        :

        "# Install the files and packages from the metadata\n",
        "/opt/aws/bin/cfn-init -v ",
        "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
        "         --resource WebServerInstance ",
        "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n", 
        :
      ]]}}
    }
  },     </code></pre>
    <p>應用程式本身會採用兩行字 "Hello, World" 作為範例，且範本會完整定義此範例。對於真實世界的應用程式，檔案可以存放在 Amazon S3 或其他儲存庫中 GitHub，並從範本中參考。  CloudFormation 可以下載套件 (例如 RPM 或 RubyGems)，並參照個別檔案並擴展<code>.zip</code>和檔案，以在 Amazon EC2 執行個體上建立應用程式構<code>.tar</code>件。</p>
    <p>範本會啟用並設定 cfn-hup 常駐程式，以便偵聽 Amazon EC2 執行個體中繼資料內針對組態所定義的變更。透過 cfn-hup 協助程式，即可更新應用程式軟體 (如 Apache 或 PHP 的版本)，亦可從 AWS CloudFormation 更新 PHP 應用程式檔案本身。範本中相同的 Amazon EC2 資源會提供下列程式碼片段，藉此說明設定 cfn-hup 以呼叫 cfn-init 更新軟體的必要部分，進而因應系統所偵測到的任何中繼資料變更：</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
  "WebServerInstance": <span>{</span>
    "Type" : "AWS::EC2::Instance",
    "Metadata" : <span>{</span>
      "AWS::CloudFormation::Init" : <span>{</span>
        "config" : <span>{</span>

            :

          "files" : <span>{</span>

            :

            "/etc/cfn/cfn-hup.conf" : <span>{</span>
              "content" : <span>{</span> "Fn::Join" : ["", [
                "[main]\n",
                "stack=", <span>{</span> "Ref" : "AWS::StackName" }, "\n",
                "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
              ]]},
              "mode"    : "000400",
              "owner"   : "root",
              "group"   : "root"
            },

            "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
              "content": <span>{</span> "Fn::Join" : ["", [
                "[cfn-auto-reloader-hook]\n",
                "triggers=post.update\n",
                "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r WebServerInstance ",
                " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",  
                "runas=root\n"
              ]]}
            }
          },
          :
    },

    "Properties": <span>{</span>

         :

      "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [

        :

        "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
        "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

        :
      ]]}}
    }
  },     </code></pre>
    <p>範本會建立 Amazon EC2 安全群組，以便完成堆疊建立作業。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Sample Template: Sample template that can be used to test EC2 updates. **WARNING** This template creates an Amazon Ec2 Instance. You will be billed for the AWS resources used if you create a stack from this template.",
  
  "Parameters" : <span>{</span>
          
    "InstanceType" : <span>{</span>
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small",
      "AllowedValues" : [ 
        "t1.micro", 
        "t2.nano", 
        "t2.micro", 
        "t2.small", 
        "t2.medium", 
        "t2.large", 
        "m1.small", 
        "m1.medium", 
        "m1.large", 
        "m1.xlarge", 
        "m2.xlarge", 
        "m2.2xlarge", 
        "m2.4xlarge", 
        "m3.medium", 
        "m3.large", 
        "m3.xlarge", 
        "m3.2xlarge", 
        "m4.large", 
        "m4.xlarge", 
        "m4.2xlarge", 
        "m4.4xlarge", 
        "m4.10xlarge", 
        "c1.medium", 
        "c1.xlarge", 
        "c3.large", 
        "c3.xlarge", 
        "c3.2xlarge", 
        "c3.4xlarge", 
        "c3.8xlarge", 
        "c4.large", 
        "c4.xlarge", 
        "c4.2xlarge", 
        "c4.4xlarge", 
        "c4.8xlarge", 
        "g2.2xlarge", 
        "g2.8xlarge", 
        "r3.large", 
        "r3.xlarge", 
        "r3.2xlarge", 
        "r3.4xlarge", 
        "r3.8xlarge", 
        "i2.xlarge", 
        "i2.2xlarge", 
        "i2.4xlarge", 
        "i2.8xlarge", 
        "d2.xlarge", 
        "d2.2xlarge", 
        "d2.4xlarge", 
        "d2.8xlarge", 
        "hi1.4xlarge", 
        "hs1.8xlarge", 
        "cr1.8xlarge", 
        "cc2.8xlarge", 
        "cg1.4xlarge"
      ],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    }
  },
    
  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },

    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }
  },
    
  "Resources" : <span>{</span>   

    "WebServerInstance": <span>{</span>  
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []
              }
            },

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },


              "/etc/cfn/cfn-hup.conf" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", <span>{</span> "Ref" : "AWS::StackId" }, "\n",
                  "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
                "content": <span>{</span> "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r WebServerInstance ",
                                                   " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]}
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
        "ImageId" : <span>{</span> "Fn::FindInMap" : [ "AWSRegionArch2AMI", <span>{</span> "Ref" : "AWS::Region" },
                          <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] } ] },
        "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
        "SecurityGroups" : [ <span>{</span>"Ref" : "WebServerSecurityGroup"} ],
        "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
             "#!/bin/bash -xe\n",
             "yum install -y aws-cfn-bootstrap\n",

             "# Install the files and packages from the metadata\n",
             "/opt/aws/bin/cfn-init -v ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerInstance ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n",

             "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
             "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerInstance ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"
        ]]}}        
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT5M"
        }
      }
    },

    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"}
        ]
      }      
    }          
  },
  
  "Outputs" : <span>{</span>
    "WebsiteURL" : <span>{</span>
      "Description" : "Application URL",
      "Value" : <span>{</span> "Fn::Join" : ["", ["http://", <span>{</span> "Fn::GetAtt" : [ "WebServerInstance", "PublicDnsName" ]}]] }
    }
  }
}</code></pre>
    <p>此處是以單一 Amazon EC2 執行個體為例，但您可以在較複雜的解決方案上使用相同機制；而這些解決方案會透過 Elastic Load Balancer 與 Amazon EC2 Auto Scaling 群組來管理應用程式伺服器集合。不過，使用 Auto Scaling 群組時需注意部分特殊考量。如需詳細資訊，請參閱 <a href="#updating.autoscaling">更新 Auto Scaling 群組</a>。</p>
   
    <h2 id="updating.create.initial.stack">建立初始堆疊</h2>
    

    <p>為了配合本範例，我們將使用 AWS Management Console 來建立範例範本的初始堆疊。</p>
    <div class="awsdocs-note awsdocs-warning"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>警告</h6></div><div class="awsdocs-note-text"><p>完成本程序時，系統會部署即時的 AWS 服務。只要持續執行這些服務，您便必須按照標準使用費率付費。</p></div></div>
    <div class="procedure"><h6>從 AWS Management Console建立堆疊</h6><ol><li>
        <p>複製先前的範本，並在本機系統上將該範本儲存為文字檔案。請記下檔案位置，因為後續步驟仍需使用到該檔案。</p>
      </li><li>
        <p>請在 <a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> 登入 CloudFormation 主控台。</p>
      </li><li>
        <p>選擇 <b>Create new stack (建立新堆疊)</b>。</p>
      </li><li>
        <p>在 <b>Create New Stack (建立新堆疊)</b> 精靈的 <b>Select Template (選取範本)</b> 畫面上，將 <code class="userinput">UpdateTutorial</code> 輸入至 <b>Name (名稱)</b> 欄位。在相同的頁面上，選取 <b>Upload a template to Amazon S3</b> (將範本上傳到 Amazon S3)，並瀏覽至您在第一個步驟中下載的檔案，然後選擇 <b>Next</b> (下一步)。</p>
      </li><li>
        <p>在 <b>Specify Parameters (指定參數)</b> 畫面的 <b>Instance Type (執行個體類型)</b> 方塊中，輸入 <code class="userinput">t1.micro</code>。然後選擇<b>下一步</b>。</p>
      </li><li>
        <p>在 <b>Options</b> (選項) 畫面上，選擇 <b>Next</b> (下一步)。</p>
      </li><li>
        <p>確認 <b>Review</b> (檢閱) 畫面上的所有設定皆符合需求，接著選擇 <b>Create</b> (建立)。</p>
      </li></ol></div>
    <p>堆疊狀態變成 CREATE_COMPLETE 之後，輸出標籤將顯示網站的 URL。選擇 WebsiteURL 的輸出值，即可看見新的 PHP 應用程式開始運作。</p>
   
    <h2 id="update.application">更新應用程式</h2>
    

    <p>既然我們已經將堆疊部署完成，接下來便要更新應用程式。我們會簡單地更改應用程式所印出的文字。若要執行此作業，便需要將 echo 命令新增至 index.php 檔案，如下列範本程式碼片段所示：</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"WebServerInstance": <span>{</span>
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
              :

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  <code class="replaceable">"echo '&lt;p&gt;Updated version via UpdateStack&lt;/p&gt;';\n ",</code>
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },

              :

      }
    },</code></pre>
    <p>透過文字編輯器，即可手動編輯儲存在本機上的範本檔案。</p>
    <p>現在，我們將更新堆疊。</p>
    
    <div class="procedure"><h6>從 AWS Management Console更新堆疊</h6><ol><li>
        <p>登入 AWS CloudFormation 主控台，網址為：<a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。</p>
      </li><li>
        <p>在 AWS CloudFormation 儀表板上，選擇您先前建立的堆疊，然後選擇 <b>Update Stack (更新堆疊)</b>。</p>
      </li><li>
        <p>在 <b>Update Stack</b> (更新堆疊) 精靈的 <b>Select Template</b> (選取範本) 畫面上，選取 <b>Upload a template to Amazon S3</b> (將範本上傳到 Amazon S3) 並選擇修改後的範本，然後選擇 <b>Next</b> (下一步)。</p>
      </li><li>
        <p>在 <b>Options</b> (選項) 畫面上，選擇 <b>Next</b> (下一步)。</p>
      </li><li>
        <p>堆疊沒有堆疊政策，因此請選擇 <b>Next</b> (下一步)。在沒有覆寫政策的情況下，所有資源皆可進行更新。</p>
      </li><li>
        <p>確認 <b>Review</b> (檢閱) 畫面上的所有設定皆符合需求，接著選擇 <b>Update</b> (更新)。</p>
      </li></ol></div>
    <p>如果您是從 AWS Management Console更新堆疊，則會發現系統在 <b>Update Stack</b> (更新堆疊) 精靈的 <b>Parameters</b> (參數) 頁面上，已經預先填入要用來建立初始堆疊的參數。如果您是使用 <code class="code">aws cloudformation update-stack</code> 命令，輸入的值請務必與原先用來建立堆疊的參數相同。</p>
    <p>當堆疊的狀態變成 UPDATE_COMPLETE 時，即可再選擇 WebsiteURL 輸出值，藉此確認應用程式的變更已經生效。在預設情況下，系統每 15 分鐘會執行 cfn-hup 常駐程式一次；因此堆疊更新後，應用程式最多可能需要 15 分鐘才能完成變更。</p>
    <p>前往 AWS CloudFormation 主控台，即可查看更新後的資源集。您可以在 <b>Events</b> (事件) 標籤上檢視堆疊事件。在此特定情況下，Amazon EC2 執行個體的中繼資料 WebServerInstance 已更新，因AWS CloudFormation此也會重新評估其他資源 (<code class="code">WebServerSecurityGroup</code>) 以確保沒有其他變更。系統並不會修改其他堆疊資源。唯有堆疊中的資源受到任何堆疊變更影響時，AWS CloudFormation 才會更新這些資源。這些變更可以是直接的，例如屬性或中繼資料變更，也可能是由於相依性或資料流經 Ref  GetAtt、或其他內建範本函數所致。</p>
    <p>此處透過這項簡單的更新來說明程序；然而，您還可以針對部署至 Amazon EC2 執行個體的檔案和套件進行更加複雜的變更。例如，您可能會認為需要將 MySQL 與 MySQL 的 PHP 支援新增至執行個體。若要執行此作業，只需將其他套件、檔案與任何其他服務一併新增至組態，接著更新堆疊，即可部署變更。在下列範本程式碼片段中，變更內容會用紅色醒目提示：</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerInstance": <span>{</span>
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []<code class="replaceable">,
                "php-mysql"         : [],
                "mysql-server"      : [],
                "mysql-libs"        : [],
                "mysql"             : []</code>
              }
            },

            :

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]},
                <code class="replaceable">"mysqld"   : <span>{</span> "enabled" : "true", "ensureRunning" : "true" }</code>
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
           :
      }
    }</code></pre>
    <p>您可以更新中 CloudFormation 繼資料，以更新為應用程式所使用的套件的新版本。在先前的範例中，每個套件的版本屬性均為空白，這表示 cfn-init 應該安裝最新版本的套件。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">     "packages" : <span>{</span>
       "yum" : <span>{</span>
         "httpd"             : [],
         "php"               : []
      }</code></pre>
    <p>您可以選擇指定套件的版本字串；若您在後續的更新堆疊呼叫中更改該版本字串，則系統將部署新版本的套件。以下是使用 RubyGems 套件版本號碼的範例。而支援版本控制的任何套件皆可擁有特定版本。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "packages" : <span>{</span>
    "rubygems" : <span>{</span>
      "mysql"           : [],
      "rubygems-update" : ["1.6.2"],
      "rake"            : ["0.8.7"],
      "rails"           : ["2.3.11"]
    }
    }</code></pre>
     
      <h3 id="updating.autoscaling">更新 Auto Scaling 群組</h3>

      <p>即便您在範本中是使用 Auto Scaling 群組，而不是 Amazon EC2 執行個體資源，系統仍會以完全相同的方式來更新應用程式。但是，AWS CloudFormation 並不會為 Auto Scaling 群組中的 Amazon EC2 執行個體提供任何同步或序列化功能。每部主機上的 cfn-hup 常駐程式均會獨立運作，並按照自身排程來更新應用程式。當您藉由 cfn-hup 來更新執行個體上的組態時，每個執行個體皆會依照自身排程執行 cfn-hup 勾點；而堆疊中的執行個體之間沒有協調性。因此，您應該考量下列事項：</p>
      <div class="itemizedlist">
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p>如果 Auto Scaling 群組中的所有 Amazon EC2 執行個體同時執行 cfn-hup 變更，更新期間可能無法使用服務。</p>
        </li><li class="listitem">
          <p>如果系統在不同時間執行 cfn-hup 變更，舊版本與新版本的軟體可能會同時運作。</p>
        </li></ul></div>
      <p>請考慮強制輪流更新 Auto Scaling 群組中的執行個體，以避免上述問題。如需詳細資訊，請參閱 <a href="./aws-attribute-updatepolicy.html">UpdatePolicy 屬性</a>。</p>
     
   
    <h2 id="update.walkthrough.changing.resource.properties">變更資源屬性</h2>
    

    <p>您可以使用 AWS CloudFormation 來變更堆疊中現有資源的屬性。下列小節會說明能解決特定問題的各種更新作業；但您仍可根據自身需求，在堆疊中針對支援更新的任何資源修改任何屬性。</p>
     
      <h3 id="update.walkthrough.instance.type">更新執行個體類型</h3>

      <p>到目前為止，我們所建置的堆疊是採用 t1.micro Amazon EC2 執行個體。假設新建立網站所接收的流量超過 t1.micro 執行個體的處理範圍，而現在您想移至 m1.small Amazon EC2 執行個體類型。一旦執行個體類型的架構有所變更，系統將會使用不同的 AMI 來建立執行個體。當您查看範本中的映射時，則會發現 t1.micro 與 m1.small 的架構別無二致，亦採用相同的 Amazon Linux AMI。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },
    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }</code></pre>
      <p>現在，讓我們使用先前一節所修改的範本來變更執行個體類型。因為 InstanceType 是範本的輸入參數，所以我們不需要修改範本；我們可以在 [堆疊更新] 精靈的 [指定參數] 頁面上變更參數的值。</p>
      <div class="procedure"><h6>從 AWS Management Console更新堆疊</h6><ol><li>
          <p>登入 AWS CloudFormation 主控台，網址為：<a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>。</p>
        </li><li>
          <p>在 CloudFormation 儀表板上，選擇您先前建立的堆疊，然後選擇 [<b>更新堆疊</b>]。</p>
        </li><li>
          <p>在 <b>Update Stack</b> (更新堆疊) 精靈的 <b>Select Template</b> (選取範本) 畫面上，選取 <b>Use current template</b> (使用目前的範本)，然後選擇 <b>Next</b> (下一步)。</p>
          <p>Specify Details (指定詳細資訊) 頁面即會顯示，其中 <b>Specify Parameters</b> (指定參數) 區段會預先填入要用來建立初始堆疊的參數。</p>
        </li><li>
          <p>將<b>InstanceType</b>文字方塊的值從變更<code class="code">t1.micro</code>為<code class="code">m1.small</code>。然後選擇<b>下一步</b>。</p>
        </li><li>
          <p>在 <b>Options</b> (選項) 畫面上，選擇 <b>Next</b> (下一步)。</p>
        </li><li>
          <p>堆疊沒有堆疊政策，因此請選擇 <b>Next</b> (下一步)。在沒有覆寫政策的情況下，所有資源皆可進行更新。</p>
        </li><li>
          <p>確認 <b>Review</b> (檢閱) 畫面上的所有設定皆符合需求，接著選擇 <b>Update</b> (更新)。</p>
        </li></ol></div>
      <p>透過啟動和停用執行個體，即可動態變更 EBS 支援的 Amazon EC2 執行個體的執行個體類型。AWS CloudFormation 會更新執行個體類型並重新啟動該執行個體，藉此嘗試將變更內容最佳化，讓執行個體 ID 不會因而改變。然而，重新啟動執行個體時，該執行個體的公有 IP 地址會隨之變更。為了確保彈性 IP 地址在變更後仍能正確繫結，AWS CloudFormation 將一併更新彈性 IP 地址。您可以在 AWS CloudFormation 主控台的 Events (事件) 標籤上查看變更內容。</p>
      <p>請開啟 Amazon EC2 主控台並尋找執行個體，從 AWS Management Console 查看執行個體類型。</p>
     
     
      <h3 id="update.walkthrough.ami">更新 Amazon EC2 執行個體上的 AMI</h3>

      <p>現在，讓我們看看如何變更執行個體上所執行的 Amazon Machine Image (AMI)。我們會更新堆疊以啟動 AMI 變更作業，藉此使用新的 Amazon EC2 執行個體類型，例如屬於 HVM64 執行個體類型的 t2.medium。</p>
      <p>如先前一節所述，我們將透過現有的範本來變更範例堆疊所使用的執行個體類型。請在 Stack Update (更新堆疊) 精靈的 Specify Parameters (指定參數) 頁面上，變更執行個體類型的值。</p>
      <p>在此案例中，我們無法直接藉由啟動和停用執行個體來修改 AMI，因為 AWS CloudFormation 將此更改內容視為不可變的資源屬性。AWS CloudFormation 必須啟動替代資源，才能更改不可變屬性；此處將以新的 Amazon EC2 執行個體執行新的 AMI 為例。</p>
      <p>新的執行個體開始運作後，AWS CloudFormation 即會更新堆疊中的其他資源，進而指向新資源。系統會進行稱為 UPDATE_CLEANUP 的程序，藉此建立新資源、刪除舊資源。此時，堆疊中執行個體的執行個體 ID 與應用程式 URL，皆會因更新作業而有所變更。另外，Event (事件) 資料表的事件會涵蓋說明：「Requested update has a change to an immutable property and hence creating a new physical resource」(請求的更新已變更不可變屬性，因此系統建立了新的實體資源)，表示該資源已遭取代。</p>
      <p>如果您有將應用程式碼寫入待更新的 AMI，則可透過相同的堆疊更新機制來更新該 AMI，藉此載入新的應用程式。</p>
      <div class="procedure"><h6>更新堆疊上執行個體的 AMI</h6><ol><li>
          <p>建立新的 AMI，其包含應用程式或作業系統變更內容。如需詳細資訊，請參閱《Amazon EC2 Linux 執行個體使用者指南》中的<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami.html">建立自己的 AMI</a>。</p>
        </li><li>
          <p>更新範本，以便採納新的 AMI ID。</p>
        </li><li>
          <p>從 AWS Management Console (如 <a href="#update.application">更新應用程式</a> 所述) 或使用 AWS 命令 <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html"><code class="code">aws cloudformation update-stack</code></a> 來更新堆疊。</p>
        </li></ol></div>
      <p>當您更新堆棧時， CloudFormation 檢測 AMI ID 是否已更改，然後以與我們啟動上述內容相同的方式觸發堆棧更新。</p>
     
     
      <h3 id="update.walkthrough.launch.config">更新 Auto Scaling 群組的 Amazon EC2 啟動組態</h3>

      <p>如果您是使用 Auto Scaling 群組，而非 Amazon EC2 執行個體，則更新執行中的執行個體的程序會稍有不同。您可以透過 Auto Scaling 資源，將 Amazon EC2 執行個體的組態 (如執行個體類型或 AMI ID) 封裝在 Auto Scaling 啟動組態中。您可以採用先前各節所示的 Amazon EC2 執行個體資源變更方式，以便變更啟動組態。不過，變更啟動組態並不會影響 Auto Scaling 群組中任何正在運作的 Amazon EC2 執行個體；而更新的啟動組態僅適用於更新後所建立的新執行個體。</p>
      <p>透過更新屬性，即可將變更傳播至 Auto Scaling 群組中所有執行個體的啟動組態。如需詳細資訊，請參閱 <a href="./aws-attribute-updatepolicy.html">UpdatePolicy 屬性</a>。</p>
     
   
    <h2 id="update.walkthrough.adding.properties">新增資源屬性</h2>
    

    <p>到目前為止，我們已經了解範本中資源現有屬性的變更方式。除此之外，您還可以在範本中新增原本沒有指定的屬性。為了說明這項操作，我們會將 Amazon EC2 金鑰對新增至現有的 EC2 執行個體，接著在 Amazon EC2 安全群組中開啟連接埠 22，即可使用 Secure Shell (SSH) 來存取該執行個體。</p>
     
      <h3 id="update.walkthrough.security.group">將金鑰對新增至執行個體</h3>

      <div class="procedure"><h6>在現有的 Amazon EC2 執行個體中新增 SSH 存取</h6><ol><li>
          <p>將兩個額外參數新增至範本，藉此傳遞現有的 Amazon EC2 金鑰對名稱與 SSH 位置。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "Parameters" : <span>{</span>

    "KeyName" : <span>{</span>
      "Description" : "Name of an existing Amazon EC2 key pair for SSH access",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "SSHLocation" : <span>{</span>
      "Description" : " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})/(\\d<span>{</span>1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    }  
    :
  },
</code></pre>
        </li><li>
          <p>將 KeyName 屬性新增至亞馬遜 EC2 執行個體。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">          "WebServerInstance": <span>{</span>
          "Type" : "AWS::EC2::Instance",
          :
          "Properties": <span>{</span>
          :
         <code class="replaceable"> "KeyName" : <span>{</span> "Ref" : "KeyName" },</code>
          :
          }
          },
</code></pre>
        </li><li>
          <p>將連接埠 22 與 SSH 位置新增至 Amazon EC2 安全群組的輸入規則。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP and SSH",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" :  "0.0.0.0/0"}
        ]
      }
    },    </code></pre>
        </li><li>
          <p>從 AWS Management Console (如 <a href="#update.application">更新應用程式</a> 所述) 或使用 AWS 命令 <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html"><code class="code">aws cloudformation update-stack</code></a> 來更新堆疊。</p>
        </li></ol></div>
     
   
    <h2 id="update.walkthrough.change.resources">變更堆疊的資源</h2>
    

    <p>應用程式需求會隨著時間有所改變，AWS CloudFormation 可讓您針對組成堆疊的資源集進行變更。我們會從<a href="#update.walkthrough.adding.properties">新增資源屬性</a>取得單一執行個體應用程式，接著更新堆疊以將其轉換成可自動調整規模、負載平衡的應用程式，藉此說明這項操作。</p>
    <p>此操作會使用彈性 IP 地址來建立簡易的單一執行個體 PHP 應用程式。我們現在會在更新期間變更該應用程式的資源，進而將其轉換為具備高可用性、可自動調整規模且負載平衡的應用程式。</p>
    <div class="procedure"><ol><li>
        <p>新增 Elastic Load Balancer 資源。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "ElasticLoadBalancer" : <span>{</span>
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : <span>{</span>
        "CrossZone" : "true",
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LBCookieStickinessPolicy" : [ <span>{</span>
          "PolicyName" : "CookieBasedPolicy",
          "CookieExpirationPeriod" : "30"
        } ],
        "Listeners" : [ <span>{</span>
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP",
          "PolicyNames" : [ "CookieBasedPolicy" ]
        } ],
        "HealthCheck" : <span>{</span>
          "Target" : "HTTP:80/",
          "HealthyThreshold" : "2",
          "UnhealthyThreshold" : "5",
          "Interval" : "10",
          "Timeout" : "5"
        }
      }
    }</code></pre>
      </li><li>
        <p>將範本中的 EC2 執行個體轉換成 Auto Scaling 啟動組態。兩者屬性完全相同，因此僅需變更類型名稱，從：</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
<code class="replaceable">"WebServerInstance"</code>: <span>{</span>
  "Type" : <code class="replaceable">"AWS::EC2::Instance"</code>,</code></pre>
        <p>至:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
<code class="replaceable">"LaunchConfig"</code>: <span>{</span>
  "Type" : <code class="replaceable">"AWS::AutoScaling::LaunchConfiguration"</code>,</code></pre>
        <p>為了清楚模板，我們將資源的名稱從<em>WebServerInstance</em>更改為 <em>LaunchConfig</em>，因此您需要更新 cfn-init 和 cfn-hup 引用的資源名稱（只需搜索 WebServerInstance 並替換它 LaunchConfig，除了 cfn-signal）。對於 cfn-signal，您需要向 Auto Scaling 組（WebServerGroup）而不是實例發出信號，如以下代碼片段所示：</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="text ">             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource <code class="replaceable">WebServerGroup</code> ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"</code></pre>
      </li><li>
        <p>新增 Auto Scaling 群組資源。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerGroup" : <span>{</span>
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : <span>{</span>
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LaunchConfigurationName" : <span>{</span> "Ref" : "LaunchConfig" },
        "MinSize" : "1",
        "DesiredCapacity" : "1",
        "MaxSize" : "5",
        "LoadBalancerNames" : [ <span>{</span> "Ref" : "ElasticLoadBalancer" } ]
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT15M"
        }
      },
      "UpdatePolicy": <span>{</span>
        "AutoScalingRollingUpdate": <span>{</span>
          "MinInstancesInService": "1",
          "MaxBatchSize": "1",
          "PauseTime" : "PT15M",
          "WaitOnResourceSignals": "true"
        }
      }
    }</code></pre>
      </li><li>
        <p>更新安全群組定義，藉此鎖定負載平衡器傳入執行個體的流量。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80 locked down to the ELB and SSH access",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "SourceSecurityGroupOwnerId" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.OwnerAlias"]},
"SourceSecurityGroupName" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.GroupName"]}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}}
        ]
      }
    }</code></pre>
      </li><li>
        <p>更新 Outputs，進而傳回 Elastic Load Balancer 的 DNS 名稱，並將該名稱作為應用程式的位置；從：</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
"WebsiteURL" : <span>{</span>
  "Value" : <span>{</span> "Fn::Join" : ["", ["http://", 
      <span>{</span> "Fn::GetAtt" : [ "<code class="replaceable">WebServerInstance</code>", "<code class="replaceable">PublicDnsName</code>" ]}]]},
  "Description" : "Application URL"
}              </code></pre>
        <p>至:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
"WebsiteURL" : <span>{</span>
  "Value" : <span>{</span> "Fn::Join" : ["", ["http://", 
      <span>{</span> "Fn::GetAtt" : [ "<code class="replaceable">ElasticLoadBalancer</code>", "<code class="replaceable">DNSName</code>" ]}]]},
  "Description" : "Application URL"
}              </code></pre>
      </li></ol></div>
    <p>下列範例顯示完整範本，以供參考。若您使用此範本更新堆疊，則可將簡易的單一執行個體應用程式轉換為具備高可用性、支援多個可用區域、可自動調整規模且負載平衡的應用程式。系統僅會修改需要更新的資源，所以此應用程式所存放的任何資料將不會受到影響。您可以立即使用 AWS CloudFormation 來擴充或改善堆疊，藉此因應需求有所不同的情況。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="複製"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Sample Template: Sample template that can be used to test EC2 updates. **WARNING** This template creates an Amazon Ec2 Instance. You will be billed for the AWS resources used if you create a stack from this template.",
  
  "Parameters" : <span>{</span>
  
    "KeyName": <span>{</span>
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
    },

    "SSHLocation" : <span>{</span>
      "Description" : " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})/(\\d<span>{</span>1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    
    "InstanceType" : <span>{</span>
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small",
      "AllowedValues" : [ 
        "t1.micro", 
        "t2.nano", 
        "t2.micro", 
        "t2.small", 
        "t2.medium", 
        "t2.large", 
        "m1.small", 
        "m1.medium", 
        "m1.large", 
        "m1.xlarge", 
        "m2.xlarge", 
        "m2.2xlarge", 
        "m2.4xlarge", 
        "m3.medium", 
        "m3.large", 
        "m3.xlarge", 
        "m3.2xlarge", 
        "m4.large", 
        "m4.xlarge", 
        "m4.2xlarge", 
        "m4.4xlarge", 
        "m4.10xlarge", 
        "c1.medium", 
        "c1.xlarge", 
        "c3.large", 
        "c3.xlarge", 
        "c3.2xlarge", 
        "c3.4xlarge", 
        "c3.8xlarge", 
        "c4.large", 
        "c4.xlarge", 
        "c4.2xlarge", 
        "c4.4xlarge", 
        "c4.8xlarge", 
        "g2.2xlarge", 
        "g2.8xlarge", 
        "r3.large", 
        "r3.xlarge", 
        "r3.2xlarge", 
        "r3.4xlarge", 
        "r3.8xlarge", 
        "i2.xlarge", 
        "i2.2xlarge", 
        "i2.4xlarge", 
        "i2.8xlarge", 
        "d2.xlarge", 
        "d2.2xlarge", 
        "d2.4xlarge", 
        "d2.8xlarge", 
        "hi1.4xlarge", 
        "hs1.8xlarge", 
        "cr1.8xlarge", 
        "cc2.8xlarge", 
        "cg1.4xlarge"
      ],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    }
  },
  
  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },
    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }
  },
    
  "Resources" : <span>{</span>   
  
    "ElasticLoadBalancer" : <span>{</span>
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : <span>{</span>
        "CrossZone" : "true",
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LBCookieStickinessPolicy" : [ <span>{</span>
          "PolicyName" : "CookieBasedPolicy",
          "CookieExpirationPeriod" : "30"
        } ],
        "Listeners" : [ <span>{</span>
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP",
          "PolicyNames" : [ "CookieBasedPolicy" ]
        } ],
        "HealthCheck" : <span>{</span>
          "Target" : "HTTP:80/",
          "HealthyThreshold" : "2",
          "UnhealthyThreshold" : "5",
          "Interval" : "10",
          "Timeout" : "5"
        }
      }
    },
    
    "WebServerGroup" : <span>{</span>
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : <span>{</span>
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LaunchConfigurationName" : <span>{</span> "Ref" : "LaunchConfig" },
        "MinSize" : "1",
        "DesiredCapacity" : "1",
        "MaxSize" : "5",
        "LoadBalancerNames" : [ <span>{</span> "Ref" : "ElasticLoadBalancer" } ]
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT15M"
        }
      },
      "UpdatePolicy": <span>{</span>
        "AutoScalingRollingUpdate": <span>{</span>
          "MinInstancesInService": "1",
          "MaxBatchSize": "1",
          "PauseTime" : "PT15M",
          "WaitOnResourceSignals": "true"
        }
      }
    },
    
    "LaunchConfig": <span>{</span>  
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []
              }
            },

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  "echo 'Updated version via UpdateStack';\n ",
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },


              "/etc/cfn/cfn-hup.conf" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", <span>{</span> "Ref" : "AWS::StackId" }, "\n",
                  "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
                "content": <span>{</span> "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r LaunchConfig ",
                                                   " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]}
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
        "ImageId" : <span>{</span> "Fn::FindInMap" : [ "AWSRegionArch2AMI", <span>{</span> "Ref" : "AWS::Region" },
                          <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] } ] },
        "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
        "KeyName"        : <span>{</span> "Ref" : "KeyName" },
        "SecurityGroups" : [ <span>{</span>"Ref" : "WebServerSecurityGroup"} ],
        "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
             "#!/bin/bash -xe\n",
             "yum install -y aws-cfn-bootstrap\n",

             "# Install the files and packages from the metadata\n",
             "/opt/aws/bin/cfn-init -v ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource LaunchConfig ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
             
             "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
             "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerGroup ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"
        ]]}}        
      }
    },

    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80 locked down to the ELB and SSH access",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "SourceSecurityGroupOwnerId" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.OwnerAlias"]},"SourceSecurityGroupName" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.GroupName"]}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}}
        ]
      }
    }          
  },
  
  "Outputs" : <span>{</span>
    "WebsiteURL" : <span>{</span>
      "Description" : "Application URL",
      "Value" : <span>{</span> "Fn::Join" : ["", ["http://", <span>{</span> "Fn::GetAtt" : [ "ElasticLoadBalancer", "DNSName" ]}]] }
    }
  }
}</code></pre>
   
    <h2 id="update.walkthrough.impact">可用性與影響考量事項</h2>

    <p>不同屬性會對堆疊中的資源造成不同影響。您可以善用  CloudFormation  來更新任何屬性；但進行任何變更之前，應考量下列問題：</p>
    <div class="orderedlist">
       
       
    <ol><li>
        <p>更新作業對資源本身有何影響？ 舉例來說，更新警示閾值會導致警示在更新期間處於非作用中狀態。正如我們所見，您需要停用並重新啟動執行個體，才能變更執行個體類型。AWS CloudFormation 會透過基礎資源的 Update (更新) 或 Modify (修改) 動作來更改資源。如需了解更新造成的影響，請查閱特定資源的文件。</p>
      </li><li>
        <p>更改內容屬於可變或不可變項目？ 基礎服務並不支援部分資源屬性變更操作，例如：更改 Amazon EC2 執行個體上的 AMI。在可變更的情況下， CloudFormation 將針對基礎資源使用更新或修改類型 API。對於不可變的屬性更改， CloudFormation 將創建具有更新屬性的新資源，然後在刪除舊資源之前將它們鏈接到堆棧。雖然 CloudFormation 試圖減少堆疊資源的停機時間，但取代資源是一個多步驟的程序，而且需要一些時間。重新設定堆疊期間，應用程式將無法完全正常運作。例如，應用程式可能無法處理請求或存取資料庫；</p>
      </li></ol></div>
   
    <h2 id="update.walkthrough.related">相關資源</h2>

    <p>如需有關使用啟動應用程式 CloudFormation 以及與其他組態和部署服務 (例如 Puppet 和 Opscode Chef) 整合的詳細資訊，請參閱下列白皮書：</p>
    <div class="itemizedlist">
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/BoostrappingApplicationsWithAWSCloudFormation.pdf" rel="noopener noreferrer" target="_blank"><span>透過 AWS CloudFormation Bootstrapping (引導) 應用程式</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/IntegratingAWSCloudFormationWithOpscodeChef.pdf" rel="noopener noreferrer" target="_blank"><span>整合 AWS CloudFormation 與 Opscode Chef</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/IntegratingAWSCloudFormationWithPuppet.pdf" rel="noopener noreferrer" target="_blank"><span>整合 AWS CloudFormation 與 Puppet</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li></ul></div>
    <p>本節中所使用的範本為 "Hello World" PHP 應用程式。範本程式庫也有一個 Amazon  ElastiCache  範例範本，顯示如何整合 PHP 應用程式，並 ElasticCache 使用 cfn-hup 和 cfn-init 來回應 Amazon  ElastiCache  快取叢集組態中的變更，所有這些變更都可由更新堆疊執行。</p>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>您的瀏覽器已停用或無法使用 Javascript。</strong></p><p>您必須啟用 Javascript，才能使用 AWS 文件。請參閱您的瀏覽器說明頁以取得說明。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">文件慣用形式</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./gettingstarted.templatebasics.html">了解範本的基本知識</div><div id="next" class="next-link" accesskey="n" href="./security.html">安全性</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">此頁面是否有幫助？ - 是</div><div class="content"><p>感謝您，讓我們知道我們做得很好！</p><p>若您有空，歡迎您告知我們值得讚許的地方，這樣才能保持良好服務。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">此頁面是否有幫助？ - 否</div><div class="content"><p>感謝讓我們知道此頁面仍須改善。很抱歉，讓您失望。</p><p>若您有空，歡迎您提供改善文件的方式。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="意見回饋" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>