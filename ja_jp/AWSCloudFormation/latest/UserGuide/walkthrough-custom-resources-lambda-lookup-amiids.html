<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="ja-JP"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>チュートリアル: Amazon マシンイメージ ID を参照する - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><meta name="default_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="description" content="AWS Lambda とカスタムリソースを使用して、AMI ID を動的に参照します。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="ユーザーガイド" /><meta name="abstract" content="このユーザーガイドでは、AWS CloudFormation を使用して、予測かつ再現可能な方法で、AWS インフラストラクチャのデプロイを作成して管理します。" /><meta name="guide-locale" content="ja_jp" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="ユーザーガイド" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="ユーザーガイド" /><meta id="panorama-serviceConsolePage" value="チュートリアル: Amazon マシンイメージ ID を参照する" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>チュートリアル: Amazon マシンイメージ ID を参照する - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,リソースのプロビジョニング,リソース構成,インフラストラクチャ管理,CloudFormer,CloudFormation スタック,CloudFormation StackSet,CloudFormation テンプレート,変更セット" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "ユーザーガイド",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "AWS CloudFormation テンプレートの使用",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "カスタムリソース",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-custom-resources.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "AWS Lambda-backed カスタムリソース",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "チュートリアル: Amazon マシンイメージ ID を参照する",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">ドキュメント</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">ユーザーガイド</a></div><div id="page-toc-src"><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">ステップ 1: サンプルパッケージをダウンロードして Amazon S3 に保存する</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">ステップ 2: スタックを作成する</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">ステップ 3: リソースをクリーンアップする</a><a href="#w9aac23c26c16b7c29">関連情報</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="walkthrough-custom-resources-lambda-lookup-amiids">チュートリアル: Amazon マシンイメージ ID を参照する</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Amazon Elastic Compute Cloud (Amazon EC2) インスタンスを宣言する AWS CloudFormation テンプレートでは、インスタンスの起動に使用される、オペレーティングシステムまたはその他のソフトウェアと構成情報が含まれた Amazon マシンイメージ (AMI) の ID も指定する必要があります。適切な AMI ID は、スタックを起動するインスタンスタイプおよびリージョンによって異なる場合があります。ID は定期的に変更される可能性があります (AMI が更新されてソフトウェアアップデートが追加されたときなど)。</p><p>通常は、特定のインスタンスタイプとリージョンに AMI ID をマップできます。ID を更新するには、各テンプレートで手動で更新します。カスタムリソースと AWS Lambda (Lambda) を使用すると、使用するリージョンとインスタンスタイプの最新 AMI の ID を取得する関数を作成でき、マッピングを維持する必要がなくなります。</p><p>このチュートリアルでは、カスタムリソースを作成して Lambda 関数を関連付け、AMI ID を参照する方法を示します。また、カスタムリソースと Lambda の使用方法を理解していることが前提です。詳細については、「<a href="./template-custom-resources.html">カスタムリソース</a>」または「AWS Lambda デベロッパーガイド」を参照してください。</p><p>チュートリアルの概要</p><p>このチュートリアルでは、カスタム リソース、Lambda 関数、および EC2 インスタンスを伴うスタックを作成します。チュートリアルでは、スタックの作成に使用するサンプルコードとサンプルテンプレートを提供します。</p><p>サンプルテンプレートは、カスタムリソースタイプを使用し、Lambda 関数を呼び出して入力値を渡します。テンプレートを使用すると、AWS CloudFormation によってこの関数が呼び出され、リクエストタイプ、入力データ、署名付き Amazon Simple Storage Service (Amazon S3) URL などの情報が渡されます。この関数は、その情報を使用して AMI ID を参照し、署名付き URL に応答を送信します。</p><p>AWS CloudFormation は、署名付き URL の場所で応答を取得した後、スタックの作成処理に進みます。AWS CloudFormation はインスタンスを作成すると、Lambda 関数の応答を使用してインスタンスの AMI ID を指定します。</p><p>次のリストは、プロセスをまとめたものです。対応するサービス (Lambda、Amazon EC2、AWS CloudFormation など) をすべて使用するには、AWS Identity and Access Management (IAM) 権限が必要です。</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注記</h6></div><div class="awsdocs-note-text"><p>AWS CloudFormation は無料サービスです。ただし、スタックに追加する AWS リソース (Lambda 関数や EC2 インスタンスなど) にはそれぞれ、現在の料金が課金されます。AWS 料金に関する詳細については、<a href="https://aws.amazon.com/" rel="noopener noreferrer" target="_blank"><span>http://aws.amazon.com</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> で各製品の詳細ページを参照してください。</p></div></div><div class="orderedlist">
     
     
     
  <ol><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Amazon Simple Storage Service (Amazon S3) バケットに、サンプルの Lambda パッケージを保存します。</a></p>
      <p>サンプル パッケージには、Lambda 関数を作成するために必要なものがすべてが含まれています。パッケージは、スタックを作成するリージョンと同じリージョンにあるバケットに保存する必要があります。</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">サンプルテンプレートを使用してスタックを作成します。</a></p>
      <p>スタックは、Lambda 関数とカスタムリソースを関連付ける方法と、関数からの結果を使用して AMI ID を指定する方法を示しています。また、スタックによって IAM ロール (実行ロール) が作成されます。このロールは、Lambda が Amazon EC2 を呼び出すために使用されます。</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">スタックを削除します。</a></p>
      <p>不要なリソースに対して課金されないよう、作成したすべてのスタックリソースをクリーンアップするために、スタックを削除します。</p>
    </li></ol></div><h2 id="walkthrough-custom-resources-lambda-lookup-amiids-savesample">ステップ 1: サンプルパッケージをダウンロードして Amazon S3 に保存する</h2>
    
    <p>Lambda 関数を使用してスタックを作成する際は、関数のソースコードが格納されている Amazon S3 バケットの場所を指定する必要があります。バケットは、スタックを作成するリージョンと同じリージョンに存在する必要があります。</p>
    <p>このチュートリアルでは、Lambda 関数を作成するために必要なサンプルパッケージ (<code>.zip</code> ファイル) が提供されます。Lambda パッケージには、関数のソースコードおよび必要なライブラリが含まれています。このチュートリアルでは、関数に追加のライブラリは必要ありません。</p>
    <p>この関数は、AWS CloudFormation カスタムリソースリクエストからインスタンスのアーキテクチャおよびリージョンを入力として取得し、最新の AMI ID を署名済みの Amazon S3 URL に返します。</p>
    <div class="procedure"><h6>パッケージをダウンロードして Amazon S3 に保存するには</h6><ol><li>
        <p>サンプルパッケージを Amazon S3 からダウンロードします。ファイルを保存する際には、サンプルと同じファイル名の <code>amilookup.zip</code> もしくは <code>amilookup-win.zip</code> を使用してください。</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Linux AMI の ID の検索</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          
            <dt><b><span class="term">Windows AMI の ID の検索</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          </dl></div>
      </li><li>
        <p><a href="https://console.aws.amazon.com/s3/home" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/s3/home</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> にある Amazon S3 コンソールを開きます。</p>
      </li><li>
        <p>AWS CloudFormation スタックを作成するリージョンと同じリージョンにあるバケットを選択するか、新しく作成します。バケット名をメモしておきます。</p>
        <p>このバケットにサンプルパッケージを保存します。バケットの作成の詳細については、「Amazon Simple Storage Service ユーザーガイド」の「<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/CreatingaBucket.html">Creating a bucket</a>」(バケットの作成) を参照してください。</p>
      </li><li>
        <p>選択または作成したバケットに、サンプルパッケージをアップロードします。</p>
        <p>オブジェクトのアップロードの詳細については、「Amazon Simple Storage Service ユーザーガイド」の「<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/UploadingObjectsintoAmazonS3.html">Uploading objects</a>」(オブジェクトのアップロード) を参照してください。</p>
      </li></ol></div>
    <p>パッケージを Amazon S3 に保存したら、AWS CloudFormation テンプレートの Lambda リソース宣言で、場所を指定できます。次のステップでは、関数を宣言し、カスタムリソースを使用して呼び出す方法を示します。関数の結果を使用して、EC2 インスタンスの AMI ID を指定する方法についても説明します。</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">ステップ 2: スタックを作成する</h2>
    
    <p>Amazon EC2 のサンプルスタックを作成するには、Lambda 関数が含まれるサンプルテンプレート、IAM 実行ロール、関数を呼び出すカスタムリソース、関数からの結果を使用する EC2 インスタンスを使用します。</p>
    <p>スタックの作成時、カスタムリソースは Lambda 関数を呼び出し、この関数によって応答が署名済み Amazon S3 の URL に送信されるまで待ちます。応答では、EC2 インスタンスタイプと、インスタンスを作成するリージョンに対応する最新の AMI ID が返されます。関数の応答からのデータは、カスタムリソースの属性として保存されます。この属性は、EC2 インスタンスの AMI ID を指定するために使用されます。</p>
    <p>次のスニペットは、Lambda 関数をカスタムリソースと関連付ける方法や、その関数の応答を使用する方法について理解するのに役立つサンプルテンプレートの関連する部分について説明しています。</p>
    <p>サンプルテンプレート全体を確認するには、以下を参照してください。</p>
    <div class="variablelist">
       
       
    <dl>
        <dt><b><span class="term">Linux のテンプレート</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      
        <dt><b><span class="term">Windows のテンプレート</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      </dl></div>
    <p>スタックテンプレートのスニペット</p>
    <p>Lambda 関数を作成するには、<code class="code">AWS::Lambda::Function</code> リソースを宣言します。これには、関数のソースコード、ハンドラー名、ランタイム環境、実行ロールの ARN が必要です。</p>
    <div class="example"><h6>例 JSON 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfoFunction": <span>{</span>
  "Type": "AWS::Lambda::Function",
  "Properties": <span>{</span>
    "Code": <span>{</span>
      "S3Bucket": <span>{</span> "Ref": "S3Bucket" },
      "S3Key": <span>{</span> "Ref": "S3Key" }
    },
    "Handler": <span>{</span> "Fn::Join" : [ "", [<span>{</span> "Ref": "ModuleName" },".handler"] ] },
    "Runtime": "nodejs18.x",
    "Timeout": "30",
    "Role": <span>{</span> "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] }
  }
}</code></pre></div></div>
    <div class="example"><h6>例 YAML 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfoFunction:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      S3Bucket: !Ref S3Bucket
      S3Key: !Ref S3Key
    Handler: !Sub "$<span>{</span>ModuleName}.handler"
    Runtime: nodejs18.x
    Timeout: 30
    Role: !GetAtt LambdaExecutionRole.Arn</code></pre></div></div>
    <p><code class="code">Code</code> プロパティでは、サンプルパッケージをアップロードした Amazon S3 の場所 (バケット名とファイル名) を指定します。サンプルテンプレートでは、スタックの作成時に名前を指定できるように、バケット名とファイル名の設定には入力パラメーター (<code class="code">"Ref":
        "S3Bucket"</code> および <code class="code">"Ref": "S3Key"</code>) が使用されます。同様に、<code>.zip</code> パッケージに含まれているソースファイル (JavaScript ファイル) の名前に対応するハンドラー名にも、入力パラメーター (<code class="code">"Ref":
        "ModuleName"</code>) が使用されます。ソースファイルは JavaScript であるため、ランタイムは <code class="code">nodejs18.x</code> として指定されます。</p>
    <p>このチュートリアルでは、関数の実行時間がデフォルト値の <code class="code">3</code> 秒を超えるため、タイムアウトは <code class="code">30</code> 秒に設定されています。十分な長さのタイムアウトを指定しなかった場合、関数が完了する前に Lambda でタイムアウトが発生し、スタックの作成に失敗することがあります。</p>
    <p>テンプレートの他の箇所で宣言される実行ロールは、<code class="code">Fn::GetAtt</code> 組み込み関数を使用して <code class="code">Role</code> プロパティで指定されます。実行ロールは Lambda 関数に、AWS にログを送信して EC2 <code class="code">DescribeImages</code> API を呼び出すためのアクセス権限を付与します。次のスニペットは、適切なアクセス権限を付与するロールとポリシーを示しています。</p>
    <div class="example"><h6>例 JSON 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"LambdaExecutionRole": <span>{</span>
  "Type": "AWS::IAM::Role",
  "Properties": <span>{</span>
    "AssumeRolePolicyDocument": <span>{</span>
      "Version": "2012-10-17",
      "Statement": [<span>{</span>
        "Effect": "Allow",
        "Principal": <span>{</span>"Service": ["lambda.amazonaws.com"]},
        "Action": ["sts:AssumeRole"]
      }]
    },
    "Path": "/",
    "Policies": [<span>{</span>
      "PolicyName": "root",
      "PolicyDocument": <span>{</span>
        "Version": "2012-10-17",
        "Statement": [<span>{</span>
          "Effect": "Allow",
          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
          "Resource": "arn:aws:logs:*:*:*"
        },
        <span>{</span>
          "Effect": "Allow",
          "Action": ["ec2:DescribeImages"],
          "Resource": "*"
        }]
      }
    }]
  }
}</code></pre></div></div>
    <div class="example"><h6>例 YAML 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
      - Effect: Allow
        Principal:
          Service:
          - lambda.amazonaws.com
        Action:
        - sts:AssumeRole
    Path: "/"
    Policies:
    - PolicyName: root
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - ec2:DescribeImages
          Resource: "*"</code></pre></div></div>
    <p>Linux および Windows のテンプレートのどちらも、カスタムリソースは関連付けられた Lambda 関数を起動します。関数をカスタムリソースと関連付けるには、<code class="code">Fn::GetAtt</code> 組み込み関数を使用して、<code class="code">ServiceToken</code> プロパティ用に関数の Amazon リソースネーム (ARN) を指定します。AWS CloudFormation は、カスタムリソースの宣言に含まれている追加のプロパティ (<code class="code">Region</code> や <code class="code">Architecture</code> など) を入力として Lambda 関数に送信します。Lambda 関数は、これらの入力プロパティの正しい名前と値を判断します。</p>
    <div class="example"><h6>例 JSON 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "Architecture": <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>例 YAML 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    Architecture:
      Fn::FindInMap:
      - AWSInstanceType2Arch
      - !Ref InstanceType
      - Arch</code></pre></div></div>
    <p>Windows の場合、カスタムリソースはインスタンスのアーキテクチャではなく Windows バージョンのバージョンを Lambda 関数に提供します。</p>
    <div class="example"><h6>例 JSON 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "OSName": <span>{</span> "Ref": "WindowsVersion" }
  }
}</code></pre></div></div>
    <div class="example"><h6>例 YAML 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    OSName: !Ref "WindowsVersion"</code></pre></div></div>
    <p>AWS CloudFormation によって Lambda 関数が呼び出されると、この関数はリージョンとインスタンスのアーキテクチャまたは OS 名を使用してイメージのリストをフィルタし、EC2 <code class="code">DescribeImages</code> API を呼び出します。さらに、日付によってイメージのリストをソートし、最新 AMI の ID を返します。</p>
    <p>関数では、最新 AMI の ID を返す際に、この ID を<a href="./crpg-ref-responses.html">応答オブジェクト</a>の <code class="code">Data</code> プロパティで署名付き URL に送信します。データは、次の例に示すように、名前と値のペアとして構造化されます。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Data": <span>{</span> 
  "Id": "ami-43795473"
}</code></pre>
    <p>次のスニペットは、Lambda 関数からのデータの取得方法を示しています。<code class="code">Fn::GetAtt</code> 組み込み関数を使用して、取得するカスタムリソースの名前と使用する値の属性名を指定します。このチュートリアルでは、カスタムリソース名は <code class="code">AMIInfo</code>、属性名は <code class="code">Id</code> です。</p>
    <div class="example"><h6>例 JSON 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"SampleInstance": <span>{</span>  
  "Type": "AWS::EC2::Instance",
  "Properties": <span>{</span>
    "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
    "ImageId": <span>{</span> "Fn::GetAtt": [ "AMIInfo", "Id" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>例 YAML 構文</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">SampleInstance:
  Type: AWS::EC2::Instance
  Properties:
    InstanceType: !Ref InstanceType
    ImageId: !GetAtt AMIInfo.Id</code></pre></div></div>
    <p>テンプレートの機能を理解できたところで、サンプルテンプレートを使用してスタックを作成しましょう。</p>
    <div class="procedure"><h6> スタックを作成するには</h6><ol><li>
        <p><a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation/ で AWS CloudFormation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> コンソール を開きます。</p>
      </li><li>
        <p><b>[Create Stack]</b> (スタックの作成) を選択します。</p>
      </li><li>
        <p>[<b>テンプレート</b>] セクションで、[<b>Amazon S3 テンプレート URL の指定)</b>] を選択し、次の URL をコピーしてテキストボックスに貼り付けます。</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Linux のテンプレート</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          
            <dt><b><span class="term">Windows のテンプレート</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          </dl></div>
      </li><li>
        <p>[<b>Next</b>] を選択します。</p>
      </li><li>
        <p>[<b>スタックの名前</b>] フィールドに <code class="userinput">SampleEC2Instance</code> と入力します。</p>
      </li><li>
        <p>[<b>パラメータ</b>] セクションで、作成した Amazon S3 バケットの名前を指定し、[<b>次へ</b>] を選択します。</p>
        <p>他のパラメーターのデフォルト値は、サンプルの <code>.zip</code> パッケージで使用されている名前と同じです。</p>
      </li><li>
        <p>このチュートリアルでは、タグの追加も詳細設定の指定も不要です。[<b>次へ</b>] を選択します。</p>
      </li><li>
        <p>スタック名とテンプレート URL が正しいことを確認し、[<b>作成</b>] を選択します。</p>
      </li></ol></div>
    <p>AWS CloudFormation によってスタックが作成されるまでに数分かかることもあります。進捗状況を監視するには、スタックイベントを確認します。詳細については、「<a href="./cfn-console-view-stack-data-resources.html">AWS Management Console での AWS CloudFormation スタックデータとリソースの表示</a>」を参照してください。</p>
    <p>スタックの作成に成功した場合は、スタック内のすべてのリソース (Lambda 関数、カスタムリソース、EC2 インスタンスなど) も作成されています。Lambda 関数とカスタムリソースを正常に使用して EC2 インスタンスの AMI ID を指定できています。このテンプレートで AMI ID のマッピングを作成および維持する必要はありません。</p>
    <p>どの AMI ID を使用して AWS CloudFormation で EC2 インスタンスが作成されたか確認するには、スタック出力を確認します。</p>
   <p>Lambda 関数からエラーが返される場合は、Amazon CloudWatch Logs <a href="https://console.aws.amazon.com/cloudwatch/home#logs:" rel="noopener noreferrer" target="_blank"><span>コンソール</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>で関数のログを確認します。ログストリームの名前は、カスタムリソースの物理 ID です。これは、スタックのリソースを表示して確認できます。詳細については、「Amazon CloudWatch ユーザーガイド」の「<a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#ViewingLogData">Viewing log data</a>」(ログデータの表示) を参照してください。</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">ステップ 3: リソースをクリーンアップする</h2>
    
    <p>不要なサービスに対して課金されないように、スタックを削除します。</p>
    <div class="procedure"><h6>スタックを削除するには</h6><ol><li>
        <p>AWS CloudFormation コンソールから、[<b>SampleEC2Instance</b>] スタックを選択します。</p>
      </li><li>
        <p>[<b>アクション</b>] を選択し、[<b>スタックの削除</b>] を選択します。</p>
      </li><li>
        <p>確認メッセージで、[<b>はい、削除する</b>] を選択します。</p>
      </li></ol></div>
    <p>作成したすべてのリソースが削除されます。</p>
    <p>これで、AWS CloudFormation によって Lambda 関数を作成して使用する方法を理解できました。このチュートリアルのサンプルテンプレートおよびコードを使用して、他のスタックおよび関数を作成することができます。</p>
  <h2 id="w9aac23c26c16b7c29">関連情報</h2>
    
    <div class="itemizedlist">
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="./crpg-ref.html">AWS CloudFormation カスタムリソースリファレンス</a></p>
      </li></ul></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>ブラウザで JavaScript が無効になっているか、使用できません。</strong></p><p>AWS ドキュメントを使用するには、JavaScript を有効にする必要があります。手順については、使用するブラウザのヘルプページを参照してください。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">ドキュメントの表記規則</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-custom-resources-lambda.html">AWS Lambda-backed カスタムリソース</div><div id="next" class="next-link" accesskey="n" href="./cfn-lambda-function-code-cfnresponsemodule.html">cfn-response モジュール</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">このページは役に立ちましたか? - はい</div><div class="content"><p>ページが役に立ったことをお知らせいただき、ありがとうございます。</p><p>お時間がある場合は、何が良かったかお知らせください。今後の参考にさせていただきます。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">このページは役に立ちましたか? - いいえ</div><div class="content"><p>このページは修正が必要なことをお知らせいただき、ありがとうございます。ご期待に沿うことができず申し訳ありません。</p><p>お時間がある場合は、ドキュメントを改善する方法についてお知らせください。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>