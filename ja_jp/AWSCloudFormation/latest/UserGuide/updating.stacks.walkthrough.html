<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="ja-JP"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>チュートリアル: スタックの更新 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="updating.stacks.walkthrough" /><meta name="default_state" content="updating.stacks.walkthrough" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="description" content="実行中のスタックを AWS CloudFormation を使って更新するシンプルな進行過程について説明します。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="ユーザーガイド" /><meta name="abstract" content="このユーザーガイドでは、AWS CloudFormation を使用して、予測かつ再現可能な方法で、AWS インフラストラクチャのデプロイを作成して管理します。" /><meta name="guide-locale" content="ja_jp" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="ユーザーガイド" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="ユーザーガイド" /><meta id="panorama-serviceConsolePage" value="チュートリアル: スタックの更新" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>チュートリアル: スタックの更新 - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,リソースのプロビジョニング,リソース構成,インフラストラクチャ管理,CloudFormer,CloudFormation スタック,CloudFormation StackSet,CloudFormation テンプレート,変更セット" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "ユーザーガイド",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "AWS CloudFormation の開始方法",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/GettingStarted.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "チュートリアル: スタックの更新",
        "item" : "https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/GettingStarted.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">ドキュメント</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">ユーザーガイド</a></div><div id="page-toc-src"><a href="#updating.simple.application">単純なアプリケーション</a><a href="#updating.create.initial.stack">初期スタックの作成</a><a href="#update.application">アプリケーションの更新</a><a href="#update.walkthrough.changing.resource.properties">リソースのプロパティの変更</a><a href="#update.walkthrough.adding.properties">リソースのプロパティの追加</a><a href="#update.walkthrough.change.resources">スタックのリソースの変更</a><a href="#update.walkthrough.impact">アベイラビリティーと影響に関する検討事項</a><a href="#update.walkthrough.related">関連リソース</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="updating.stacks.walkthrough">チュートリアル: スタックの更新</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>AWS CloudFormation では、既存のスタックのリソースのプロパティを更新できます。単純な構成の変更 (CloudWatch アラームのしきい値を変更するなど) から、もっと複雑な変更 (Amazon EC2 インスタンスで実行されている Amazon マシンイメージ (AMI) を更新するなど) まで、変更は多岐にわたります。テンプレート内の AWS リソースは、その多くが更新に対応しているため、継続的に機能を拡充していくことが可能です。</p><p>このセクションでは、実行されているスタックのアップデートのシンプルな進行過程について説明します。テンプレートを使用して、実行中のソフトウェアのバージョン管理と同様に、AWS インフラストラクチャの構成にもバージョン管理システムを使用できることを説明します。以下の手順について説明します。</p><div class="orderedlist">
     
     
     
     
     
     
  <ol><li>
      <p><a href="#updating.create.initial.stack">初期スタックの作成</a> - 基本の Amazon Linux AMI を使用してスタックを作成し、AWS CloudFormation ヘルパースクリプトを使用して Apache Web Server と単純な PHP ウェブアプリケーションをインストールします。</p>
    </li><li>
      <p><a href="#update.application">アプリケーションの更新</a> - アプリケーション内のファイルのいずれかを更新し、CloudFormation を使用してソフトウェアをデプロイします。</p>
    </li><li>
      <p> <a href="#update.walkthrough.instance.type">インスタンスタイプのアップデート</a> - 基盤となる Amazon EC2 インスタンスのインスタンスタイプを変更します。</p>
    </li><li>
      <p> <a href="#update.walkthrough.ami">Amazon EC2 インスタンス上の AMI の更新</a> - スタック内の Amazon EC2 インスタンスの Amazon マシンイメージ (AMI) を変更します。</p>
    </li><li>
      <p><a href="#update.walkthrough.security.group">インスタンスへのキーペアの追加</a> - インスタンスに Amazon EC2 キーペアを追加し、セキュリティグループを更新して、インスタンスへの SSH アクセスを可能にします。</p>
    </li><li>
      <p><a href="#update.walkthrough.change.resources">スタックのリソースの変更</a> - テンプレートを更新することでスタックのリソースを追加および削除し、自動スケーリングされ、負荷分散されるアプリケーションに変換します。</p>
    </li></ol></div>
    <h2 id="updating.simple.application">単純なアプリケーション</h2>

    <p>まず、このセクション全体で使用するスタックを作成します。Apache Web Server でホストされ Amazon Linux AMI 上で実行される単一のインスタンス PHP ウェブアプリケーションを起動する単純なテンプレートが用意されています。</p>
    <p>Apache Web Server、PHP、および単純な PHP アプリケーションはすべて、Amazon Linux AMI にデフォルトでインストールされている CloudFormation ヘルパースクリプトによってインストールされます。以下のテンプレートスニペットには、インストールするパッケージとファイルを記述するメタデータが表示されています。この場合は、Amazon Linux AMI の Yum リポジトリからの Apache Web Server と PHP 実行環境です。またこのスニペットには、Apache Web Server の実行を確認する Service セクションが含まれています。Amazon EC2 インスタンス定義の Properties セクションでは、UserData プロパティに、パッケージとファイルをインストールするための cfn-init を呼び出す CloudInit スクリプトが含まれています。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
  "WebServerInstance": <span>{</span>
    "Type" : "AWS::EC2::Instance",
    "Metadata" : <span>{</span>
      "AWS::CloudFormation::Init" : <span>{</span>
        "config" : <span>{</span>
          "packages" : <span>{</span>
            "yum" : <span>{</span>
              "httpd"             : [],
              "php"               : []
            }
          },

          "files" : <span>{</span>

            "/var/www/html/index.php" : <span>{</span>
              "content" : <span>{</span> "Fn::Join" : ["", [
                "&lt;?php\n",
                "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                "echo '&lt;p&gt;", <span>{</span> "Ref" : "WelcomeMessage" }, "&lt;/p&gt;';\n",
                "?&gt;\n"
              ]]},
              "mode"    : "000644",
              "owner"   : "apache",
              "group"   : "apache"
            },
          },

          :

          "services" : <span>{</span>
            "sysvinit" : <span>{</span>
              "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" }
            }
          }
        }
      }
    },

    "Properties": <span>{</span>
      :
      "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
        "#!/bin/bash\n",
        "yum install -y aws-cfn-bootstrap\n",

        :

        "# Install the files and packages from the metadata\n",
        "/opt/aws/bin/cfn-init -v ",
        "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
        "         --resource WebServerInstance ",
        "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n", 
        :
      ]]}}
    }
  },     </code></pre>
    <p>アプリケーション自体は 2 行の「Hello World」サンプルで、その全体がテンプレート内で定義されています。実際のアプリケーションでは、ファイルは Amazon S3、GitHub、その他のリポジトリに格納され、テンプレートから参照されます。CloudFormation はパッケージ (RPM や RubyGems など) をダウンロードし、個別のファイルを参照して <code>.zip</code> や <code>.tar</code> ファイルを解凍することで、Amazon EC2 インスタンス上にアプリケーションの中間生成物を作成することができます。</p>
    <p>テンプレートは cfn-hup デーモンを有効化して構成し、Amazon EC2 インスタンスのメタデータ内で定義された構成への変更をリッスンします。cfn-hup デーモンを使用することで、Apache や PHP のバージョンなどのアプリケーションソフトウェアをアップデートしたり、または AWS CloudFormation から PHP アプリケーションファイル自体を更新したりすることができます。テンプレートの同じ Amazon EC2 リソースから取り出した以下のスニペットには、メタデータへの変更が検出されたときにソフトウェアをアップデートする cfn-init を呼び出す cfn-hup を設定するために必要な部分が示されています。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
  "WebServerInstance": <span>{</span>
    "Type" : "AWS::EC2::Instance",
    "Metadata" : <span>{</span>
      "AWS::CloudFormation::Init" : <span>{</span>
        "config" : <span>{</span>

            :

          "files" : <span>{</span>

            :

            "/etc/cfn/cfn-hup.conf" : <span>{</span>
              "content" : <span>{</span> "Fn::Join" : ["", [
                "[main]\n",
                "stack=", <span>{</span> "Ref" : "AWS::StackName" }, "\n",
                "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
              ]]},
              "mode"    : "000400",
              "owner"   : "root",
              "group"   : "root"
            },

            "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
              "content": <span>{</span> "Fn::Join" : ["", [
                "[cfn-auto-reloader-hook]\n",
                "triggers=post.update\n",
                "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r WebServerInstance ",
                " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",  
                "runas=root\n"
              ]]}
            }
          },
          :
    },

    "Properties": <span>{</span>

         :

      "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [

        :

        "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
        "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

        :
      ]]}}
    }
  },     </code></pre>
    <p>最後に Amazon EC2 セキュリティグループを作成すれば、スタックの完成です。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Sample Template: Sample template that can be used to test EC2 updates. **WARNING** This template creates an Amazon Ec2 Instance. You will be billed for the AWS resources used if you create a stack from this template.",
  
  "Parameters" : <span>{</span>
          
    "InstanceType" : <span>{</span>
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small",
      "AllowedValues" : [ 
        "t1.micro", 
        "t2.nano", 
        "t2.micro", 
        "t2.small", 
        "t2.medium", 
        "t2.large", 
        "m1.small", 
        "m1.medium", 
        "m1.large", 
        "m1.xlarge", 
        "m2.xlarge", 
        "m2.2xlarge", 
        "m2.4xlarge", 
        "m3.medium", 
        "m3.large", 
        "m3.xlarge", 
        "m3.2xlarge", 
        "m4.large", 
        "m4.xlarge", 
        "m4.2xlarge", 
        "m4.4xlarge", 
        "m4.10xlarge", 
        "c1.medium", 
        "c1.xlarge", 
        "c3.large", 
        "c3.xlarge", 
        "c3.2xlarge", 
        "c3.4xlarge", 
        "c3.8xlarge", 
        "c4.large", 
        "c4.xlarge", 
        "c4.2xlarge", 
        "c4.4xlarge", 
        "c4.8xlarge", 
        "g2.2xlarge", 
        "g2.8xlarge", 
        "r3.large", 
        "r3.xlarge", 
        "r3.2xlarge", 
        "r3.4xlarge", 
        "r3.8xlarge", 
        "i2.xlarge", 
        "i2.2xlarge", 
        "i2.4xlarge", 
        "i2.8xlarge", 
        "d2.xlarge", 
        "d2.2xlarge", 
        "d2.4xlarge", 
        "d2.8xlarge", 
        "hi1.4xlarge", 
        "hs1.8xlarge", 
        "cr1.8xlarge", 
        "cc2.8xlarge", 
        "cg1.4xlarge"
      ],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    }
  },
    
  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },

    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }
  },
    
  "Resources" : <span>{</span>   

    "WebServerInstance": <span>{</span>  
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []
              }
            },

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },


              "/etc/cfn/cfn-hup.conf" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", <span>{</span> "Ref" : "AWS::StackId" }, "\n",
                  "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
                "content": <span>{</span> "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r WebServerInstance ",
                                                   " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]}
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
        "ImageId" : <span>{</span> "Fn::FindInMap" : [ "AWSRegionArch2AMI", <span>{</span> "Ref" : "AWS::Region" },
                          <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] } ] },
        "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
        "SecurityGroups" : [ <span>{</span>"Ref" : "WebServerSecurityGroup"} ],
        "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
             "#!/bin/bash -xe\n",
             "yum install -y aws-cfn-bootstrap\n",

             "# Install the files and packages from the metadata\n",
             "/opt/aws/bin/cfn-init -v ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerInstance ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n",

             "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
             "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerInstance ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"
        ]]}}        
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT5M"
        }
      }
    },

    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"}
        ]
      }      
    }          
  },
  
  "Outputs" : <span>{</span>
    "WebsiteURL" : <span>{</span>
      "Description" : "Application URL",
      "Value" : <span>{</span> "Fn::Join" : ["", ["http://", <span>{</span> "Fn::GetAtt" : [ "WebServerInstance", "PublicDnsName" ]}]] }
    }
  }
}</code></pre>
    <p>この例では単一の Amazon EC2 インスタンスを使用しますが、Elastic Load Balancing や Amazon EC2 Auto Scaling グループを利用する複雑なソリューションで同じ仕組みを利用して、一連のアプリケーションサーバーを管理することもできます。ただし Auto Scaling グループについては注意すべき点があります。詳細については、「<a href="#updating.autoscaling">Auto Scaling グループの更新</a>」を参照してください。</p>
   
    <h2 id="updating.create.initial.stack">初期スタックの作成</h2>
    

    <p>この例の目的上、AWS Management Console を使用して、サンプルテンプレートから初期スタックを作成します。</p>
    <div class="awsdocs-note awsdocs-warning"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>警告</h6></div><div class="awsdocs-note-text"><p>この手順が完了すると、ライブ AWS サービスがデプロイされます。それらのサービスが実行されている間は、標準使用料が課金されます。</p></div></div>
    <div class="procedure"><h6>AWS Management Consoleからスタックを作成するには</h6><ol><li>
        <p>前のテンプレートをコピーし、お使いのシステムのローカルにテキストファイルとして保存します。このファイルは後続の手順で必要となるため、保存場所をメモしておいてください。</p>
      </li><li>
        <p>[<a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>] で CloudFormation コンソールにログインします。</p>
      </li><li>
        <p>[<b>Create New Stack</b>] を選択します。</p>
      </li><li>
        <p>[<b>新しいスタックの作成</b>] ウィザードの [<b>テンプレートの選択</b>] 画面で、[<b>名前</b>] フィールドに <code class="userinput">UpdateTutorial</code> と入力します。同じページで [<b>Upload a template to Amazon S3</b>] (テンプレートを Amazon S3 にアップロード) を選択し、最初の手順でダウンロードしたファイルを参照して、[<b>Next</b>] (次へ) を選択します。</p>
      </li><li>
        <p>[<b>Specify Parameters (パラメータを指定)</b>] 画面の [<b>Instance Type (インスタンスタイプ)</b>] ボックスに <code class="userinput">t1.micro</code> と入力します。次いで、<b>[次へ]</b> を選択します。</p>
      </li><li>
        <p>[<b>Options</b>] (オプション) 画面で、[<b>Next</b>] (次へ) を選択します。</p>
      </li><li>
        <p>[<b>Review</b>] (確認) 画面で、意図したとおりの設定になっていることを確認し、[<b>Create</b>] (作成) を選択します。</p>
      </li></ol></div>
    <p>スタックのステータスが [CREATE_COMPLETE] に変更された後、出力タブに、あなたのウェブサイトの URL が表示されます。WebsiteURL 出力の値を選択した場合、新しい PHP アプリケーションが実行されていることを確認できます。</p>
   
    <h2 id="update.application">アプリケーションの更新</h2>
    

    <p>スタックをデプロイしたので、今度はアプリケーションを更新してみましょう。アプリケーションによって出力されるテキストに簡単な変更を加えます。以下のテンプレートスニペットに示したように、index.php ファイルに echo コマンドを追加します。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"WebServerInstance": <span>{</span>
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
              :

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  <code class="replaceable">"echo '&lt;p&gt;Updated version via UpdateStack&lt;/p&gt;';\n ",</code>
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },

              :

      }
    },</code></pre>
    <p>テキストエディタを使用して、ローカルに保存したテンプレートファイルを手動で編集します。</p>
    <p>次にスタックを更新します。</p>
    
    <div class="procedure"><h6>AWS Management Consoleからスタックを更新するには</h6><ol><li>
        <p><a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> で、AWS CloudFormation コンソールにログインします。</p>
      </li><li>
        <p>AWS CloudFormation ダッシュボードで、以前作成したスタックを選択し、[<b>Update Stack</b>] (スタックの更新) を選択します。</p>
      </li><li>
        <p>[<b>Update Stack</b>] (スタックの更新) ウィザードの [<b>Select Template</b>] (テンプレートの選択) 画面で [<b>Upload a template to Amazon S3</b>] (テンプレートを Amazon S3 にアップロード) を選択し、修正したテンプレートを選択して、[<b>Next</b>] (次へ) を選択します。</p>
      </li><li>
        <p>[<b>Options</b>] (オプション) 画面で、[<b>Next</b>] (次へ) を選択します。</p>
      </li><li>
        <p>スタックポリシーはないので [<b>Next</b>] (次へ) を選択します。オーバーライド​ポリシーを使用せずにすべてのリソースを更新できます。</p>
      </li><li>
        <p>[<b>Review</b>] (確認) 画面で、すべての設定が意図したとおりになっていることを確認し、[<b>Update</b>] (更新) を選択します。</p>
      </li></ol></div>
    <p>AWS Management Consoleからスタックを更新した場合、[<b>Update Stack (スタックの更新)</b>] ウィザードの [<b>パラメータ</b>] ページに、初期スタックの作成に使用したパラメータが既に設定されていることがわかります。<code class="code">aws cloudformation update-stack</code> コマンドを使用する場合、最初にスタックを作成するときに使用したパラメーターに対して必ず同じ値を入力してください。</p>
    <p>スタックの状態が UPDATE_COMPLETE になったら、WebsiteURL の出力値を再度選択して、アプリケーションに対する変更が反映されていることを確認できます。デフォルトでは、cfn-hup デーモンが 15 分間隔で実行されます。スタックが更新されてからアプリケーションが変更されるまでに最大 15 分程度かかる場合があります。</p>
    <p>更新された一連のリソースを確認するには、AWS CloudFormation コンソールを使用します。[<b>イベント</b>] タブでスタックイベントに注目してください。この場合は、Amazon EC2 インスタンスのメタデータ WebServerInstance が更新されます。また AWS CloudFormation によって他のリソース (<code class="code">WebServerSecurityGroup</code>) も再評価され、ほかに変更がないことが確認されます。他のスタックリソースは一切変更されていません。AWS CloudFormation によって更新されるスタック内のリソースは、そのスタックに対する変更の影響を受けるリソースだけです。そうした変更には、プロパティやメタデータの変更など直接的なものもあれば、Ref、GetAtt など、組み込みテンプレート関数を介したデータフローや依存関係に起因するものもあります。</p>
    <p>単純なアップデート例で必要なプロセスを紹介しましたが、Amazon EC2 インスタンスにデプロイするファイルやパッケージに対し、もっと複雑な変更を行うこともできます。たとえば、インスタンスに MySQL を追加しなければならなくなったとします。MySQL の PHP サポートも必要です。そのための作業は単に、追加サービスと併せて、必要なパッケージとファイルを構成に追加するだけです。そのうえでスタックを更新して変更をデプロイすることになります。次のテンプレートスニペットでは、変更箇所を赤色で示しています。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerInstance": <span>{</span>
      "Type" : "AWS::EC2::Instance",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []<code class="replaceable">,
                "php-mysql"         : [],
                "mysql-server"      : [],
                "mysql-libs"        : [],
                "mysql"             : []</code>
              }
            },

            :

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]},
                <code class="replaceable">"mysqld"   : <span>{</span> "enabled" : "true", "ensureRunning" : "true" }</code>
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
           :
      }
    }</code></pre>
    <p>CloudFormation のメタデータを更新して、アプリケーションで使用するパッケージを新しいバージョンに更新できます。これまでの例では、各パッケージのバージョンプロパティが空になっています。この場合、cfn-init によって最新バージョンのパッケージがインストールされます。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">     "packages" : <span>{</span>
       "yum" : <span>{</span>
         "httpd"             : [],
         "php"               : []
      }</code></pre>
    <p>必要であれば、パッケージのバージョン文字列を指定することもできます。以降のスタック更新要求でバージョン文字列を変更した場合、その新しいバージョンのパッケージがデプロイされます。以下に示したのは、RubyGems パッケージのバージョン番号を使用した例です。バージョニングをサポートするパッケージはすべて、特定のバージョンを持つことができます。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "packages" : <span>{</span>
    "rubygems" : <span>{</span>
      "mysql"           : [],
      "rubygems-update" : ["1.6.2"],
      "rake"            : ["0.8.7"],
      "rails"           : ["2.3.11"]
    }
    }</code></pre>
     
      <h3 id="updating.autoscaling">Auto Scaling グループの更新</h3>

      <p>テンプレートで Amazon EC2 インスタンスリソースではなく Auto Scaling グループを使用している場合も、アプリケーションを更新する方法はまったく同じですが、AWS CloudFormation には、Auto Scaling グループ内の Amazon EC2 インスタンス間で同期やシリアル化を行う手段が用意されていません。各ホスト上の cfn-hup デーモンは個別に実行され、独自のスケジュールでアプリケーションを更新します。インスタンス上の構成を cfn-hup を使用して更新する場合、各インスタンスが独自のスケジュールで cfn-hup フックを実行します。スタック内のインスタンス間の調整機能はありません。開発者は次の点を考慮する必要があります。</p>
      <div class="itemizedlist">
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p>cfn-hup による変更が、Auto Scaling グループ内のすべての Amazon EC2 インスタンスで同時に実行された場合、更新中はサービスが利用できなくなることがあります。</p>
        </li><li class="listitem">
          <p>cfn-hup による変更がそれぞれ異なるタイミングで実行された場合、古いバージョンと新しいバージョンのソフトウェアが同時に実行される可能性があります。</p>
        </li></ul></div>
      <p>これらの問題を回避するには、Auto Scaling グループのインスタンスでローリング更新を強制することを検討してください。詳細については、「<a href="./aws-attribute-updatepolicy.html">UpdatePolicy 属性</a>」を参照してください。</p>
     
   
    <h2 id="update.walkthrough.changing.resource.properties">リソースのプロパティの変更</h2>
    

    <p>AWS CloudFormation では、スタック内の既存のリソースのプロパティを変更することができます。次のセクションでは、特定の問題を解決するための各種のアップデートについて説明します。ただし、スタック内のアップデートをサポートするリソースのすべてのプロパティは、必要に応じて編集することができます。</p>
     
      <h3 id="update.walkthrough.instance.type">インスタンスタイプのアップデート</h3>

      <p>ここまでで構築したスタックは、t1.micro Amazon EC2 インスタンスを使用します。例として、新しく作成したウェブサイトに、t1.micro インスタンスで処理できる以上のトラフィックが発生しているとします。このため、m1.small Amazon EC2 インスタンスタイプに移行する必要が生じました。インスタンスタイプのアーキテクチャーが変わると、異なる AMI でインスタンスが作成されます。テンプレート内でマッピングを調べると、t1.micro と m1.small は両方とも同じアーキテクチャーで、同じ Amazon Linux AMI を使用していることがわかります。</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },
    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }</code></pre>
      <p>前のセクションで編集したテンプレートを使用して、インスタンスタイプを変更しましょう。InstanceType はテンプレートへの入力パラメータであるため、テンプレートを変更する必要はありません。Stack Update ウィザードの [Specify Parameters] (パラメータを指定) ページでパラメータの値を変更できます。</p>
      <div class="procedure"><h6>AWS Management Consoleからスタックを更新するには</h6><ol><li>
          <p><a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> で、AWS CloudFormation コンソールにログインします。</p>
        </li><li>
          <p>CloudFormation ダッシュボードで、以前作成したスタックを選択し、[<b>Update Stack</b>] (スタックの更新) を選択します。</p>
        </li><li>
          <p>[<b>Update Stack</b>] (スタックの更新) ウィザードの [<b>Select Template</b>] (テンプレートの選択) 画面で [<b>Use current template</b>] (現在のテンプレートの使用) を選択して、[<b>Next</b>] (次へ) を選択します。</p>
          <p>[詳細の指定] ページの [<b>パラメータを指定</b>] セクションに、初期スタックを作成した際に使用したパラメータがあらかじめ入力された状態で表示されます。</p>
        </li><li>
          <p>[<b>InstanceType</b>] テキストボックスの値を <code class="code">t1.micro</code> から <code class="code">m1.small</code> に変更します。<b>[次へ]</b> を選択します。</p>
        </li><li>
          <p>[<b>Options</b>] (オプション) 画面で、[<b>Next</b>] (次へ) を選択します。</p>
        </li><li>
          <p>スタックポリシーはないので [<b>Next</b>] (次へ) を選択します。オーバーライド​ポリシーを使用せずにすべてのリソースを更新できます。</p>
        </li><li>
          <p>[<b>Review</b>] (確認) 画面で、すべての設定が意図したとおりになっていることを確認し、[<b>Update</b>] (更新) を選択します。</p>
        </li></ol></div>
      <p>インスタンスを起動および停止することで、EBS-backed Amazon EC2 インスタンスのインスタンスタイプを動的に変更できます。AWS CloudFormation は、インスタンスタイプを更新してインスタンスを再起動することによって変更を最適化しようとします。そのため、インスタンス ID は変更されません。ただしインスタンスが再開されると、インスタンスのパブリック IP アドレスは変更されます。変更後に Elastic IP アドレスが正しくバインドされるよう、AWS CloudFormation は Elastic IP アドレスも更新します。AWS CloudFormation コンソールの [Events] タブで変更を見ることができます。</p>
      <p>AWS Management Console からインスタンスタイプを調べるには、Amazon EC2 コンソールを開き、インスタンスを探します。</p>
     
     
      <h3 id="update.walkthrough.ami">Amazon EC2 インスタンス上の AMI の更新</h3>

      <p>今度は、インスタンス上で実行されている Amazon マシンイメージ (AMI) の変更方法について見ていきます。AMI の変更を開始するにあたり、ここではまず、新しい Amazon EC2 インスタンスタイプ (HVM64 インスタンスタイプである t2.medium など) を使用するようにスタックを更新します。</p>
      <p>前のセクションと同様、既存のテンプレートを使用して、サンプルスタックで使用されているインスタンスタイプを変更します。Stack Update ウィザードの [Specify Parameters] ページで、[ Instance Type] の値を変更します。</p>
      <p>このケースでは、単純にインスタンスの開始と停止によって AMI を変更することはできません。このような変更は、AWS CloudFormation によって不変のリソースプロパティに対する変更とみなされます。不変のプロパティに変更を加える場合、AWS CloudFormation は、代替リソース (このケースでは、新しい AMI を実行する新しい Amazon EC2 インスタンス) を起動する必要があります。</p>
      <p>新しいインスタンスが実行状態になった後、AWS CloudFormation は、スタック内の他のリソースが新しいリソースを指し示すように更新します。新しいリソースがすべて作成されると、古いリソースは削除されます。このプロセスを UPDATE_CLEANUP といいます。更新後、スタック内のインスタンスの ID とアプリケーション URL が変わっています。Event テーブル内のイベントには、"Requested update has a change to an immutable property and hence creating a new physical resource" という説明が表示され、リソースが置き換えられたことがわかります。</p>
      <p>更新対象の AMI に組み込むアプリケーションコードを記述した場合、同じスタック更新メカニズムを使用して AMI を更新し、新しいアプリケーションをロードすることができます。</p>
      <div class="procedure"><h6>スタック上のインスタンスの AMI を更新するには</h6><ol><li>
          <p>アプリケーションまたはオペレーティング システムの変更を含んだ新しい AMI を作成します。詳細については、「Linux インスタンス用 Amazon EC2 ユーザーガイド」の「<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami.html">Creating your own AMIs</a>」(独自の AMI の作成) を参照してください。</p>
        </li><li>
          <p>テンプレートに新しい AMI ID を追加します。</p>
        </li><li>
          <p>AWS Management Console (「<a href="#update.application">アプリケーションの更新</a>」を参照) から、または AWS コマンド <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html"><code class="code">aws cloudformation update-stack</code></a> を使用してスタックを更新します。</p>
        </li></ol></div>
      <p>スタックが更新されると、AMI ID が変更されたことを CloudFormation が検出し、先ほどと同じようにスタックの更新を開始します。</p>
     
     
      <h3 id="update.walkthrough.launch.config">Auto Scaling グループに必要な Amazon EC2 起動構成の更新</h3>

      <p>Amazon EC2 インスタンスではなく Auto Scaling グループを使用している場合、実行中のインスタンスを更新する手順が若干異なります。Auto Scaling リソースでは、Amazon EC2 インスタンスの構成 (インスタンスタイプ、AMI ID など) が Auto Scaling 起動構成にカプセル化されています。起動構成の変更方法は、前のセクションで説明した Amazon EC2 インスタンスリソースに対する変更と同じです。ただし、起動構成を変更しても、Auto Scaling グループ内の実行中の Amazon EC2 インスタンスにはいずれも、その変更が反映されません。更新した起動構成が適用されるのは、更新後に作成された新しいインスタンスのみです。</p>
      <p>起動構成の変更を Auto Scaling グループ内のすべてのインスタンスに伝達する場合には、更新の属性を使用できます。詳細については、「<a href="./aws-attribute-updatepolicy.html">UpdatePolicy 属性</a>」を参照してください。</p>
     
   
    <h2 id="update.walkthrough.adding.properties">リソースのプロパティの追加</h2>
    

    <p>ここまでで、テンプレート内でリソースの既存のプロパティを変更する方法を見てきました。テンプレート内で元々指定されていなかったプロパティを追加することもできます。これについて学ぶため、Amazon EC2 キーペアを既存の EC2 インスタンスに追加し、Amazon EC2 Security Group でポート 22 を開きます。これにより、Secure Shell (SSH) を使用してインスタンスにアクセスできるようになります。</p>
     
      <h3 id="update.walkthrough.security.group">インスタンスへのキーペアの追加</h3>

      <div class="procedure"><h6>既存の Amazon EC2 インスタンスに SSH アクセスを追加するには</h6><ol><li>
          <p>既存の Amazon EC2 キーペアおよび SSH ロケーションの名前を渡すため、テンプレートに 2 つのパラメーターを追加します。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">  "Parameters" : <span>{</span>

    "KeyName" : <span>{</span>
      "Description" : "Name of an existing Amazon EC2 key pair for SSH access",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "SSHLocation" : <span>{</span>
      "Description" : " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})/(\\d<span>{</span>1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    }  
    :
  },
</code></pre>
        </li><li>
          <p>Amazon EC2 インスタンスに KeyName プロパティを追加します。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">          "WebServerInstance": <span>{</span>
          "Type" : "AWS::EC2::Instance",
          :
          "Properties": <span>{</span>
          :
         <code class="replaceable"> "KeyName" : <span>{</span> "Ref" : "KeyName" },</code>
          :
          }
          },
</code></pre>
        </li><li>
          <p>Amazon EC2 セキュリティグループの Ingress ルールに、ポート 22 と SSH ロケーションを追加します。</p>
          <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP and SSH",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" :  "0.0.0.0/0"}
        ]
      }
    },    </code></pre>
        </li><li>
          <p>AWS Management Console (「<a href="#update.application">アプリケーションの更新</a>」を参照) から、または AWS コマンド <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/update-stack.html"><code class="code">aws cloudformation update-stack</code></a> を使用してスタックを更新します。</p>
        </li></ol></div>
     
   
    <h2 id="update.walkthrough.change.resources">スタックのリソースの変更</h2>
    

    <p>アプリケーションのニーズは時とともに変化するため、AWS CloudFormation は、スタックを構成するリソースセットの変更を許可します。これを説明するため、「<a href="#update.walkthrough.adding.properties">リソースのプロパティの追加</a>」の単一インスタンスアプリケーションを例に取り、スタックを更新することで、自動スケーリングされ負荷分散されるアプリケーションに変換します。</p>
    <p>このテンプレートは、Elastic IP アドレスを使用して、シンプルな単一インスタンスの PHP アプリケーションを作成するものです。ここでは、更新の際にリソースを変更することで、自動スケーリングされ負荷分散される、可用性の高いアプリケーションに変換します。</p>
    <div class="procedure"><ol><li>
        <p>Elastic Load Balancing リソースを追加します。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "ElasticLoadBalancer" : <span>{</span>
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : <span>{</span>
        "CrossZone" : "true",
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LBCookieStickinessPolicy" : [ <span>{</span>
          "PolicyName" : "CookieBasedPolicy",
          "CookieExpirationPeriod" : "30"
        } ],
        "Listeners" : [ <span>{</span>
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP",
          "PolicyNames" : [ "CookieBasedPolicy" ]
        } ],
        "HealthCheck" : <span>{</span>
          "Target" : "HTTP:80/",
          "HealthyThreshold" : "2",
          "UnhealthyThreshold" : "5",
          "Interval" : "10",
          "Timeout" : "5"
        }
      }
    }</code></pre>
      </li><li>
        <p>テンプレート内の EC2 インスタンスを Auto Scaling Launch Configuration に変換します。プロパティは同一ですので、タイプの名前を変更するだけです。これまでの名前:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
<code class="replaceable">"WebServerInstance"</code>: <span>{</span>
  "Type" : <code class="replaceable">"AWS::EC2::Instance"</code>,</code></pre>
        <p>変更先:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
<code class="replaceable">"LaunchConfig"</code>: <span>{</span>
  "Type" : <code class="replaceable">"AWS::AutoScaling::LaunchConfiguration"</code>,</code></pre>
        <p>テンプレート内で明確にするため、リソースの名前を <em>WebServerInstance</em> から <em>LaunchConfig</em> に変更してあります。このため、cfn-init および cfn-hup が参照するリソース名を更新する必要があります (WebServerInstance を探して LaunchConfig に変更。cfn-signal を除く)。cfn-signal の場合、次のスニペットに示すように、インスタンスではなく、Auto Scaling グループ (WebServerGroup) に対してシグナルを送信する必要があります。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="text ">             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource <code class="replaceable">WebServerGroup</code> ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"</code></pre>
      </li><li>
        <p>Auto Scaling グループリソースを追加します。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerGroup" : <span>{</span>
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : <span>{</span>
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LaunchConfigurationName" : <span>{</span> "Ref" : "LaunchConfig" },
        "MinSize" : "1",
        "DesiredCapacity" : "1",
        "MaxSize" : "5",
        "LoadBalancerNames" : [ <span>{</span> "Ref" : "ElasticLoadBalancer" } ]
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT15M"
        }
      },
      "UpdatePolicy": <span>{</span>
        "AutoScalingRollingUpdate": <span>{</span>
          "MinInstancesInService": "1",
          "MaxBatchSize": "1",
          "PauseTime" : "PT15M",
          "WaitOnResourceSignals": "true"
        }
      }
    }</code></pre>
      </li><li>
        <p>トラフィックを、ロードバランサーからのインスタンスに絞るよう、Security Group 定義を更新します。</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80 locked down to the ELB and SSH access",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "SourceSecurityGroupOwnerId" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.OwnerAlias"]},
"SourceSecurityGroupName" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.GroupName"]}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}}
        ]
      }
    }</code></pre>
      </li><li>
        <p>Elastic Load Balancing の DNS Name をアプリケーションの場所として返すために Outputs を更新します。更新前:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
"WebsiteURL" : <span>{</span>
  "Value" : <span>{</span> "Fn::Join" : ["", ["http://", 
      <span>{</span> "Fn::GetAtt" : [ "<code class="replaceable">WebServerInstance</code>", "<code class="replaceable">PublicDnsName</code>" ]}]]},
  "Description" : "Application URL"
}              </code></pre>
        <p>変更先:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">
"WebsiteURL" : <span>{</span>
  "Value" : <span>{</span> "Fn::Join" : ["", ["http://", 
      <span>{</span> "Fn::GetAtt" : [ "<code class="replaceable">ElasticLoadBalancer</code>", "<code class="replaceable">DNSName</code>" ]}]]},
  "Description" : "Application URL"
}              </code></pre>
      </li></ol></div>
    <p>参考のために、完成したテンプレートを以下に示します。このテンプレートを使用してスタックを更新すると、単純な単一インスタンスのアプリケーションが、自動スケーリングされ、負荷分散される、可用性の高い、Multi-AZ のアプリケーションに変換されます。更新の必要があるリソースのみが変更されますので、このアプリケーション用に格納されたデータが存在する場合、それらのデータは変更されません。これで、ニーズが変化したときにも、AWS CloudFormation を使用してスタックを拡大することができます。</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Sample Template: Sample template that can be used to test EC2 updates. **WARNING** This template creates an Amazon Ec2 Instance. You will be billed for the AWS resources used if you create a stack from this template.",
  
  "Parameters" : <span>{</span>
  
    "KeyName": <span>{</span>
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
    },

    "SSHLocation" : <span>{</span>
      "Description" : " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})\\.(\\d<span>{</span>1,3})/(\\d<span>{</span>1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    
    "InstanceType" : <span>{</span>
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small",
      "AllowedValues" : [ 
        "t1.micro", 
        "t2.nano", 
        "t2.micro", 
        "t2.small", 
        "t2.medium", 
        "t2.large", 
        "m1.small", 
        "m1.medium", 
        "m1.large", 
        "m1.xlarge", 
        "m2.xlarge", 
        "m2.2xlarge", 
        "m2.4xlarge", 
        "m3.medium", 
        "m3.large", 
        "m3.xlarge", 
        "m3.2xlarge", 
        "m4.large", 
        "m4.xlarge", 
        "m4.2xlarge", 
        "m4.4xlarge", 
        "m4.10xlarge", 
        "c1.medium", 
        "c1.xlarge", 
        "c3.large", 
        "c3.xlarge", 
        "c3.2xlarge", 
        "c3.4xlarge", 
        "c3.8xlarge", 
        "c4.large", 
        "c4.xlarge", 
        "c4.2xlarge", 
        "c4.4xlarge", 
        "c4.8xlarge", 
        "g2.2xlarge", 
        "g2.8xlarge", 
        "r3.large", 
        "r3.xlarge", 
        "r3.2xlarge", 
        "r3.4xlarge", 
        "r3.8xlarge", 
        "i2.xlarge", 
        "i2.2xlarge", 
        "i2.4xlarge", 
        "i2.8xlarge", 
        "d2.xlarge", 
        "d2.2xlarge", 
        "d2.4xlarge", 
        "d2.8xlarge", 
        "hi1.4xlarge", 
        "hs1.8xlarge", 
        "cr1.8xlarge", 
        "cc2.8xlarge", 
        "cg1.4xlarge"
      ],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    }
  },
  
  "Mappings" : <span>{</span>
    "AWSInstanceType2Arch" : <span>{</span>
      "t1.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.nano"     : <span>{</span> "Arch" : "HVM64"  },
      "t2.micro"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.small"    : <span>{</span> "Arch" : "HVM64"  },
      "t2.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "t2.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.small"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m1.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m3.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "m4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "m4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "m4.10xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "c1.medium"   : <span>{</span> "Arch" : "HVM64"  },
      "c1.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.large"    : <span>{</span> "Arch" : "HVM64"  },
      "c4.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "c4.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "c4.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "g2.2xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "g2.8xlarge"  : <span>{</span> "Arch" : "HVMG2"  },
      "r3.large"    : <span>{</span> "Arch" : "HVM64"  },
      "r3.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "r3.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "r3.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "i2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "i2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.xlarge"   : <span>{</span> "Arch" : "HVM64"  },
      "d2.2xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.4xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "d2.8xlarge"  : <span>{</span> "Arch" : "HVM64"  },
      "hi1.4xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "hs1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cr1.8xlarge" : <span>{</span> "Arch" : "HVM64"  },
      "cc2.8xlarge" : <span>{</span> "Arch" : "HVM64"  }
    },
    "AWSRegionArch2AMI" : <span>{</span>
      "us-east-1"        : <span>{</span>"HVM64" : "ami-0ff8a91507f77f867", "HVMG2" : "ami-0a584ac55a7631c0c"},
      "us-west-2"        : <span>{</span>"HVM64" : "ami-a0cfeed8", "HVMG2" : "ami-0e09505bc235aa82d"},
      "us-west-1"        : <span>{</span>"HVM64" : "ami-0bdb828fd58c52235", "HVMG2" : "ami-066ee5fd4a9ef77f1"},
      "eu-west-1"        : <span>{</span>"HVM64" : "ami-047bb4163c506cd98", "HVMG2" : "ami-0a7c483d527806435"},
      "eu-west-2"        : <span>{</span>"HVM64" : "ami-f976839e", "HVMG2" : "NOT_SUPPORTED"},
      "eu-west-3"        : <span>{</span>"HVM64" : "ami-0ebc281c20e89ba4b", "HVMG2" : "NOT_SUPPORTED"},
      "eu-central-1"     : <span>{</span>"HVM64" : "ami-0233214e13e500f77", "HVMG2" : "ami-06223d46a6d0661c7"},
      "ap-northeast-1"   : <span>{</span>"HVM64" : "ami-06cd52961ce9f0d85", "HVMG2" : "ami-053cdd503598e4a9d"},
      "ap-northeast-2"   : <span>{</span>"HVM64" : "ami-0a10b2721688ce9d2", "HVMG2" : "NOT_SUPPORTED"},
      "ap-northeast-3"   : <span>{</span>"HVM64" : "ami-0d98120a9fb693f07", "HVMG2" : "NOT_SUPPORTED"},
      "ap-southeast-1"   : <span>{</span>"HVM64" : "ami-08569b978cc4dfa10", "HVMG2" : "ami-0be9df32ae9f92309"},
      "ap-southeast-2"   : <span>{</span>"HVM64" : "ami-09b42976632b27e9b", "HVMG2" : "ami-0a9ce9fecc3d1daf8"},
      "ap-south-1"       : <span>{</span>"HVM64" : "ami-0912f71e06545ad88", "HVMG2" : "ami-097b15e89dbdcfcf4"},
      "us-east-2"        : <span>{</span>"HVM64" : "ami-0b59bfac6be064b78", "HVMG2" : "NOT_SUPPORTED"},
      "ca-central-1"     : <span>{</span>"HVM64" : "ami-0b18956f", "HVMG2" : "NOT_SUPPORTED"},
      "sa-east-1"        : <span>{</span>"HVM64" : "ami-07b14488da8ea02a0", "HVMG2" : "NOT_SUPPORTED"},
      "cn-north-1"       : <span>{</span>"HVM64" : "ami-0a4eaf6c4454eda75", "HVMG2" : "NOT_SUPPORTED"},
      "cn-northwest-1"   : <span>{</span>"HVM64" : "ami-6b6a7d09", "HVMG2" : "NOT_SUPPORTED"}
    }
  },
    
  "Resources" : <span>{</span>   
  
    "ElasticLoadBalancer" : <span>{</span>
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : <span>{</span>
        "CrossZone" : "true",
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LBCookieStickinessPolicy" : [ <span>{</span>
          "PolicyName" : "CookieBasedPolicy",
          "CookieExpirationPeriod" : "30"
        } ],
        "Listeners" : [ <span>{</span>
          "LoadBalancerPort" : "80",
          "InstancePort" : "80",
          "Protocol" : "HTTP",
          "PolicyNames" : [ "CookieBasedPolicy" ]
        } ],
        "HealthCheck" : <span>{</span>
          "Target" : "HTTP:80/",
          "HealthyThreshold" : "2",
          "UnhealthyThreshold" : "5",
          "Interval" : "10",
          "Timeout" : "5"
        }
      }
    },
    
    "WebServerGroup" : <span>{</span>
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : <span>{</span>
        "AvailabilityZones" : <span>{</span> "Fn::GetAZs" : "" },
        "LaunchConfigurationName" : <span>{</span> "Ref" : "LaunchConfig" },
        "MinSize" : "1",
        "DesiredCapacity" : "1",
        "MaxSize" : "5",
        "LoadBalancerNames" : [ <span>{</span> "Ref" : "ElasticLoadBalancer" } ]
      },
      "CreationPolicy" : <span>{</span>
        "ResourceSignal" : <span>{</span>
          "Timeout" : "PT15M"
        }
      },
      "UpdatePolicy": <span>{</span>
        "AutoScalingRollingUpdate": <span>{</span>
          "MinInstancesInService": "1",
          "MaxBatchSize": "1",
          "PauseTime" : "PT15M",
          "WaitOnResourceSignals": "true"
        }
      }
    },
    
    "LaunchConfig": <span>{</span>  
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Metadata" : <span>{</span>
        "Comment" : "Install a simple PHP application",
        "AWS::CloudFormation::Init" : <span>{</span>
          "config" : <span>{</span>
            "packages" : <span>{</span>
              "yum" : <span>{</span>
                "httpd"             : [],
                "php"               : []
              }
            },

            "files" : <span>{</span>

              "/var/www/html/index.php" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "&lt;?php\n",
                  "echo '&lt;h1&gt;AWS CloudFormation sample PHP application&lt;/h1&gt;';\n",
                  "echo 'Updated version via UpdateStack';\n ",
                  "?&gt;\n"
                ]]},
                "mode"    : "000644",
                "owner"   : "apache",
                "group"   : "apache"
              },


              "/etc/cfn/cfn-hup.conf" : <span>{</span>
                "content" : <span>{</span> "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", <span>{</span> "Ref" : "AWS::StackId" }, "\n",
                  "region=", <span>{</span> "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : <span>{</span>
                "content": <span>{</span> "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -s ", <span>{</span> "Ref" : "AWS::StackId" }, " -r LaunchConfig ",
                                                   " --region     ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : <span>{</span>
              "sysvinit" : <span>{</span>
                "httpd"    : <span>{</span> "enabled" : "true", "ensureRunning" : "true" },
                "cfn-hup" : <span>{</span> "enabled" : "true", "ensureRunning" : "true",
                    "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]}
              }
            }
          }
        }
      },

      "Properties": <span>{</span>
        "ImageId" : <span>{</span> "Fn::FindInMap" : [ "AWSRegionArch2AMI", <span>{</span> "Ref" : "AWS::Region" },
                          <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] } ] },
        "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
        "KeyName"        : <span>{</span> "Ref" : "KeyName" },
        "SecurityGroups" : [ <span>{</span>"Ref" : "WebServerSecurityGroup"} ],
        "UserData"       : <span>{</span> "Fn::Base64" : <span>{</span> "Fn::Join" : ["", [
             "#!/bin/bash -xe\n",
             "yum install -y aws-cfn-bootstrap\n",

             "# Install the files and packages from the metadata\n",
             "/opt/aws/bin/cfn-init -v ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource LaunchConfig ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n",
             
             "# Start up the cfn-hup daemon to listen for changes to the Web Server metadata\n",
             "/opt/aws/bin/cfn-hup || error_exit 'Failed to start cfn-hup'\n",  

             "# Signal the status from cfn-init\n",
             "/opt/aws/bin/cfn-signal -e $? ",
             "         --stack ", <span>{</span> "Ref" : "AWS::StackName" },
             "         --resource WebServerGroup ",
             "         --region ", <span>{</span> "Ref" : "AWS::Region" }, "\n"
        ]]}}        
      }
    },

    "WebServerSecurityGroup" : <span>{</span>
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : <span>{</span>
        "GroupDescription" : "Enable HTTP access via port 80 locked down to the ELB and SSH access",
        "SecurityGroupIngress" : [
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "SourceSecurityGroupOwnerId" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.OwnerAlias"]},"SourceSecurityGroupName" : <span>{</span>"Fn::GetAtt" : ["ElasticLoadBalancer", "SourceSecurityGroup.GroupName"]}},
          <span>{</span>"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : <span>{</span> "Ref" : "SSHLocation"}}
        ]
      }
    }          
  },
  
  "Outputs" : <span>{</span>
    "WebsiteURL" : <span>{</span>
      "Description" : "Application URL",
      "Value" : <span>{</span> "Fn::Join" : ["", ["http://", <span>{</span> "Fn::GetAtt" : [ "ElasticLoadBalancer", "DNSName" ]}]] }
    }
  }
}</code></pre>
   
    <h2 id="update.walkthrough.impact">アベイラビリティーと影響に関する検討事項</h2>

    <p>プロパティによって、スタック内のリソースに異なる影響が及ぼされます。CloudFormation を使用してあらゆるプロパティを更新できますが、変更を加える前に、以下の点について検討する必要があります。</p>
    <div class="orderedlist">
       
       
    <ol><li>
        <p>アップデートによって、リソース自体にどのような影響が与えられるか。たとえば、アラームのしきい値を変更すると、アップデート中にアラームが非アクティブになります。既に説明したように、インスタンスタイプを変更するには、インスタンスをいったん停止して再開する必要があります。AWS CloudFormation は、基盤となるリソースの更新または変更アクションを使用してリソースに変更を加えます。アップデートの影響を理解するには、特定のリソースのドキュメントを参照してください。</p>
      </li><li>
        <p>変更は可変か不変か。Amazon EC2 インスタンスでの AMI の変更など、リソースプロパティへの変更のタイプによっては、基盤となるサービスにサポートされていない場合があります。可変の変更の場合、CloudFormation は、基盤となるリソースの Update または Modify タイプの API を使用します。不変のプロパティの変更の場合、CloudFormation は、アップデートされたプロパティを使用して新しいリソースを作成し、古いリソースを削除する前にそれらをスタックにリンクします。CloudFormation はスタックリソースのダウンタイムを削減しようとしますが、リソースは複数のステップが必要な処理であり、ある程度の時間がかかります。スタックの再構成中、アプリケーションは完全には機能しません。たとえば、要求への応答や、データベースへのアクセスができない可能性があります。</p>
      </li></ol></div>
   
    <h2 id="update.walkthrough.related">関連リソース</h2>

    <p>CloudFormation を使用してアプリケーションを開始する方法と、Puppet や Opscode Chef のようなその他の構成やデプロイメントサービスと統合する方法については、以下のホワイトペーパーをご参照ください。</p>
    <div class="itemizedlist">
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/BoostrappingApplicationsWithAWSCloudFormation.pdf" rel="noopener noreferrer" target="_blank"><span>AWS CloudFormation によるアプリケーションのブートストラップ</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/IntegratingAWSCloudFormationWithOpscodeChef.pdf" rel="noopener noreferrer" target="_blank"><span>AWS CloudFormation と Opscode Chef の統合</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li><li class="listitem">
        <p><a href="https://s3.amazonaws.com/cloudformation-examples/IntegratingAWSCloudFormationWithPuppet.pdf" rel="noopener noreferrer" target="_blank"><span>AWS CloudFormation と Puppet の統合</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
      </li></ul></div>
    <p>このセクションを通じて使用したテンプレートは、「Hello World」PHP アプリケーションです。テンプレートライブラリには、 Amazon ElastiCache キャッシュクラスターの構成の変更に対応するために cfn- hup と cfn-init を使用して PHP アプリケーションを ElasticCache と統合する方法 (すべて Update Stack により実行可能) を示した、Amazon ElastiCache サンプルテンプレートも含まれています。</p>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>ブラウザで JavaScript が無効になっているか、使用できません。</strong></p><p>AWS ドキュメントを使用するには、JavaScript を有効にする必要があります。手順については、使用するブラウザのヘルプページを参照してください。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">ドキュメントの表記規則</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./gettingstarted.templatebasics.html">テンプレートの基礎に関する説明</div><div id="next" class="next-link" accesskey="n" href="./security.html">セキュリティ</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">このページは役に立ちましたか? - はい</div><div class="content"><p>ページが役に立ったことをお知らせいただき、ありがとうございます。</p><p>お時間がある場合は、何が良かったかお知らせください。今後の参考にさせていただきます。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">このページは役に立ちましたか? - いいえ</div><div class="content"><p>このページは修正が必要なことをお知らせいただき、ありがとうございます。ご期待に沿うことができず申し訳ありません。</p><p>お時間がある場合は、ドキュメントを改善する方法についてお知らせください。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/updating.stacks.walkthrough.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>