<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="ja-JP"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CREATE EXTERNAL FUNCTION - Amazon Redshift</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="r_CREATE_EXTERNAL_FUNCTION" /><meta name="default_state" content="r_CREATE_EXTERNAL_FUNCTION" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="description" content="Amazon Redshift 用の AWS Lambda に基づいてスカラーユーザー定義関数 (UDF) を作成します。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon Redshift" /><meta name="guide" content="データベース開発者ガイド" /><meta name="abstract" content="エンタープライズレベル、ペタバイト規模、フルマネージドのデータウェアハウスサービス、Amazon Redshift を使用してデータウェアハウスを作成および管理できます。" /><meta name="guide-locale" content="ja_jp" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="x-default" /><meta name="feedback-item" content="Redshift" /><meta name="this_doc_product" content="Amazon Redshift" /><meta name="this_doc_guide" content="データベース開発者ガイド" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'redshift'}"></script><meta id="panorama-serviceSubSection" value="データベース開発者ガイド" /><meta id="panorama-serviceConsolePage" value="CREATE EXTERNAL FUNCTION" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>CREATE EXTERNAL FUNCTION - Amazon Redshift</title><meta name="pdf" content="redshift-dg.pdf#r_CREATE_EXTERNAL_FUNCTION" /><meta name="rss" content="Dochistory.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=155" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="keywords" content="Amazon Redshift,AWS Redshift,Redshift,Redshift Spectrum,クラスター,データウェアハウス,開発者,サンプルデータ,データベース,データベース開発者,HLL" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon Redshift",
        "item" : "https://docs.aws.amazon.com/redshift/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "データベース開発者ガイド",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "SQL リファレンス",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/cm_chap_SQLCommandRef.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "SQL コマンド",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/c_SQL_commands.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "CREATE EXTERNAL FUNCTION",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/c_SQL_commands.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="redshift-dg.pdf#r_CREATE_EXTERNAL_FUNCTION" target="_blank" rel="noopener noreferrer" title="PDF を開く"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">ドキュメント</a><a href="/redshift/index.html">Amazon Redshift</a><a href="welcome.html">データベース開発者ガイド</a></div><div id="page-toc-src"><a href="#r_CREATE_EXTERNAL_FUNCTION-privileges">必要な権限</a><a href="#r_CREATE_EXTERNAL_FUNCTION-synopsis">構文</a><a href="#r_CREATE_EXTERNAL_FUNCTION-parameters">パラメータ</a><a href="#r_CREATE_FUNCTION-usage-notes">使用に関する注意事項</a><a href="#r_CREATE_FUNCTION-examples">例</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="r_CREATE_EXTERNAL_FUNCTION">CREATE EXTERNAL FUNCTION</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Amazon Redshift 用の AWS Lambda に基づいてスカラーユーザー定義関数 (UDF) を作成します。Lambda のユーザー定義関数の詳細については、<a href="./udf-creating-a-lambda-sql-udf.html">スカラー Lambda UDF の作成</a>を参照してください。</p>
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-privileges">必要な権限</h2>
         <p>以下に、CREATE EXTERNAL FUNCTION に必要な権限を示します。</p>
         <div class="itemizedlist">
             
             
         <ul class="itemizedlist"><li class="listitem"><p>スーパーユーザー</p></li><li class="listitem"><p>CREATE [もしくは REPLACE ] EXTERNAL FUNCTION の権限を持つユーザー</p></li></ul></div>
       
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-synopsis">構文</h2>

         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">CREATE [ OR REPLACE ] EXTERNAL FUNCTION <em>external_fn_name</em> ( [<em>data_type</em>] [, ...] )
RETURNS <em>data_type</em>
<span>{</span> VOLATILE | STABLE }
LAMBDA <em>'lambda_fn_name'</em>
IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS アカウント-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’
RETRY_TIMEOUT <em>milliseconds</em>
MAX_BATCH_ROWS count
MAX_BATCH_SIZE size [ KB | MB ];</code></pre>

         
         
         <p>次は、Amazon Redshift での機械学習向けの構文です。モデル固有のパラメータの詳細については、「<a href="./r_GRANT.html#r_GRANT-parameters">パラメータ</a>」を参照してください。</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">CREATE [ OR REPLACE ] EXTERNAL FUNCTION <em>external_fn_name</em> ( [<em>data_type</em>] [, ...] )
RETURNS <em>data_type</em>
<span>{</span> VOLATILE | STABLE }
SAGEMAKER<em>'endpoint_name'</em>
IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS アカウント-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’ };</code></pre>


       
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-parameters">パラメータ</h2>


         <div class="variablelist">
             
             
             
             
            
             
          

             
            
         

             

             
             
          
         <dl>
               <dt><span class="term">OR REPLACE</span></dt>
               <dd>
                  <p>その関数の名前、入力引数のデータ型、あるいは<em>署名</em>が既存の関数と同じである場合に既存の関数を置き換えることを指定する句。同一のデータタイプセットを定義する新しい関数によってのみ既存の関数を置き換えることができます。関数の置き換えは、スーパーユーザーのみが行うことができます。</p>
                  <p>すでに存在するの関数と同じ名前と入力引数のデータタイプで、異なる署名の関数を定義する場合は、新しい関数を作成することになります。つまり、関数名はオーバーロードされます。詳細については、「<a href="./udf-naming-udfs.html#udf-naming-overloading-function-names">関数名の多重定義</a>」を参照してください。</p>
               </dd>
             
               <dt><span class="term"><em>external_fn_name</em></span></dt>
               <dd>
                  <p>外部関数の名前。スキーマ名を指定すると (myschema.myfunction など)、指定したスキーマを使用して関数が作成されます。指定しない場合、現在のスキーマに関数が作成されます。有効な名前の詳細については、「<a href="./r_names.html">名前と識別子</a>」を参照してください。</p>
                  <p>すべての UDF 名の前に <code class="code">f_</code> を付けることをお勧めします。Amazon Redshift は、UDF 名の <code class="code">f_</code> プレフィックスを予約します。<code class="code">f_</code> プレフィックスを使用することで、UDF 名が現在または将来の Amazon Redshift の組み込み SQL 関数名と競合しないようにすることができます。詳細については、「<a href="./udf-naming-udfs.html">UDF の命名</a>」を参照してください。</p>
               </dd>
             
               <dt><span class="term"><em>data_type</em></span></dt>
               <dd>
                  <p>入力引数のデータタイプ。詳細については、「<a href="./c_Supported_data_types.html">データ型</a>」を参照してください。</p>
               </dd>
             
               <dt><span class="term">RETURNS <em>data_type</em></span></dt>
               <dd>
                  <p>関数によって返される値のデータ型。RETURNS データ型には、Amazon Redshift のすべての標準データ型を使用できます。詳細については、「<a href="./udf-data-types.html">Python UDF データ型</a>」を参照してください。</p>
               </dd>
             
               <dt><span class="term">VOLATILE | STABLE</span></dt>
               <dd>
                  <p>関数の変動率についてのクエリオプティマイザを報告します。</p>
                  <p>関数の最適な変動率の分類を厳正に設定してラベルを付けることで、最高の最適化が得られます。厳正度の順に、低度の厳正度から変動率を分類すると、以下のようになります。</p>
                  <div class="itemizedlist">
                       
                      
                  <ul class="itemizedlist"><li class="listitem">
                        <p>VOLATILE</p>
                     </li><li class="listitem">
                        <p>STABLE</p>
                     </li></ul></div>
                  <p>VOLATILE</p>
                  <p>同じ引数が入っている場合、単一のステートメントに含まれる行であっても、関数は連続の呼び出しに異なる結果を返すことがあります。クエリオプティマイザは、変動的な関数の動作について想定することはできません。変動的な関数を使用するクエリは、入力ごとに関数を再評価する必要があります。</p>
                  <p>STABLE</p>
                  <p>引数が同じである場合、単一のステートメント内で処理される連続的な呼び出しに対して関数が同じ結果を返すことが保証されます。異なるステートメントから呼び出された場合、関数が異なる結果を返すことがあります。このカテゴリにより、オプティマイザは 1 つのステートメント内で関数が呼び出される回数を減らすことができます。</p>
                  <p>選択した厳密さが関数に対して有効でない場合、オプティマイザは、この厳密さに基づく一部の呼び出しをスキップするリスクがあることに注意してください。そのため、結果セットが不正確になる場合があります。</p>
                  <p>IMMUTABLE 句は、現在 Lambda UDF ではサポートされていません。</p>
                  

               </dd>
             
               <dt><span class="term">LAMBDA <em>'lambda_fn_name'</em></span></dt>
               <dd>
                  <p> Amazon Redshift が呼び出す関数の名前。</p>
                  <p>AWS Lambda 関数を作成する手順については、<em>AWS Lambdaデベロッパーガイド</em>の「<a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html">コンソールで Lambda 関数を作成する</a>」を参照してください。</p>
                 <p>Lambda 関数に必要なアクセス許可の詳細については、<em>AWS Lambdaデベロッパーガイド</em>の「<a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-permissions.html">AWS Lambda アクセス許可</a>」を参照してください。</p>

               </dd>
             
               <dt><span class="term">IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS アカウント-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’ </span></dt>
               <dd>
                  <p>デフォルトキーワードを使用して、CREATE EXTERNAL FUNCTION コマンドの実行時にデフォルトとして設定され、クラスターに関連付けられた IAM ロールの使用を、Amazon Redshift に指示します。</p>
                  <p>クラスターが認証と承認に使用する IAM ロールの Amazon リソースネーム (ARN) を使用します。CREATE EXTERNAL FUNCTION コマンドは、この IAM ロールを介して Lambda 関数を呼び出すことが許可されています。クラスターに Lambda 関数を呼び出す権限を持つ既存の IAM ロールがある場合は、ロールの ARN に置き換えることができます。詳細については、「<a href="./udf-creating-a-lambda-sql-udf.html#udf-lambda-authorization">Lambda UDF の認可パラメータの設定</a>」を参照してください。</p>
                  <p>以下に、IAM_ROLE パラメータの構文を示します。</p>
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">IAM_ROLE 'arn:aws:iam::<em>aws-account-id</em>:role/<em>role-name</em>'</code></pre>
               </dd>
             
               <dt><span class="term">RETRY_TIMEOUT <em>milliseconds</em> </span></dt>
               <dd>
                  <p>再試行バックオフの遅延に対して Amazon Redshift が使用する合計時間 (ミリ秒)。</p>
                  <p>失敗したクエリをすぐに再試行する代わりに、Amazon Redshift はバックオフを実行し、再試行の間に一定の時間待機します。その後、Amazon Redshift は、すべての遅延の合計が指定した RETRY_TIMEOUT 値以上になるまで、失敗したクエリを再実行するためのリクエストを再試行します。デフォルト値は 20,000 ミリ秒です。</p>
                  <p>Lambda 関数が呼び出されると、Amazon Redshift は、<code class="code">TooManyRequestsException</code>、<code class="code">EC2ThrottledException</code>、<code class="code">ServiceException</code> などのエラーを受け取ったクエリを再試行します。</p>
                  <p>RETRY_TIMEOUT パラメータを 0 ミリ秒に設定して、Lambda UDF の再試行を防ぐことができます。</p>
               </dd>
             
               <dt><span class="term">MAX_BATCH_ROWS <em>count</em></span></dt>
               <dd>
                  <p> Amazon Redshift が 1 回の Lambda 呼び出しに対して 1 回のバッチリクエストで送信する最大行数。</p>
                  <p> このパラメータの最小値は 1 です。最大値は INT_MAX または 2,147,483,647 です。</p>
                  <p> このパラメータはオプションです。デフォルト値は INT _MAX または 2,147,483,647 です。</p>
               </dd>
             
            <dt><span class="term">MAX_BATCH_SIZE <em>size</em> [ KB | MB ] </span></dt>
            <dd>
               <p> Amazon Redshift が 1 回の Lambda 呼び出しに対して 1 回のバッチリクエストで送信するデータペイロードの最大サイズ。</p>
               <p> このパラメータの最小値は 1 KB です。最大値は 5 MB です。</p>
               <p> このパラメータのデフォルト値は 5 MB です。</p>
               <p> KB と MB はオプションです。測定単位を設定しない場合、Amazon Redshift はデフォルトで KB を使用します。</p>
            </dd>
         </dl></div>
       
         <h2 id="r_CREATE_FUNCTION-usage-notes">使用に関する注意事項</h2>
         <p>Lambda UDF を作成するときは、次の点を考慮してください。</p>
         <div class="itemizedlist">
             
             
         <ul class="itemizedlist"><li class="listitem"><p>入力引数に対する Lambda 関数呼び出しの順序は、固定も保証もされていません。クラスター設定によっては、クエリを実行するインスタンス間で順序が異なる場合があります。</p></li><li class="listitem"><p>関数が入力引数ごとに 1 回だけ適用されるという保証はありません。Amazon Redshift と AWS Lambda とのやり取りにより、同じ入力に対して呼び出しが繰り返される可能性があります。</p></li></ul></div>
       
         <h2 id="r_CREATE_FUNCTION-examples">例</h2>
         <p>以下は、スカラー Lambda ユーザー定義関数 (UDF) の使用例を示します。</p>
          
            <h3 id="r_CREATE_FUNCTION-lambda-example-node">Node.js Lambda 関数を使用したスカラー Lambda UDF の例</h3>
            <p>次の例では、入力引数として 2 つの整数を受け取る <code class="code">exfunc_sum</code> という外部関数を作成します。この関数は、合計を整数出力として返します。呼び出される Lambda 関数の名前は <code class="code">lambda_sum</code> です。この Lambda 関数に使用される言語は Node.js 12.x です。IAM ロールを必ず指定してください。この例では、IAM ロールとして <code class="code">'arn:aws:iam::123456789012:user/johndoe'</code> を使用しています。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE EXTERNAL FUNCTION exfunc_sum(INT,INT)
RETURNS INT
VOLATILE
LAMBDA 'lambda_sum'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test';</code></pre>
            <p>Lambda 関数はリクエストペイロードを受け取り、各行を繰り返して処理します。単一の行ですべての値が加算されて、その行の合計が計算され、応答配列に保存されます。結果配列の行数は、リクエストペイロードで受信した行数と似ています。</p>
            <p>JSON 応答ペイロードは、外部関数によって認識されるために、['results' (結果)] フィールドに結果データを持っている必要があります。Lambda 関数に送信されるリクエストの引数フィールドには、データペイロードが含まれます。バッチリクエストの場合、データペイロードに複数の行が存在する可能性があります。次の Lambda 関数は、リクエストデータペイロードのすべての行を繰り返し処理します。また、単一の行内のすべての値を個別に繰り返します。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">exports.handler = async (event) =&gt; <span>{</span>
    // The 'arguments' field in the request sent to the Lambda function contains the data payload.
    var t1 = event['arguments'];

    // 'len(t1)' represents the number of rows in the request payload.
    // The number of results in the response payload should be the same as the number of rows received.
    const resp = new Array(t1.length);

    // Iterating over all the rows in the request payload.
    for (const [i, x] of t1.entries())
    <span>{</span>
        var sum = 0;
        // Iterating over all the values in a single row.
        for (const y of x) <span>{</span>
            sum = sum + y;
        }
        resp[i] = sum;
    }
    // The 'results' field should contain the results of the lambda call.
    const response = <span>{</span>
        results: resp
    };
    return JSON.stringify(response);
};</code></pre>
            <p>次の例では、リテラル値を使用して外部関数を呼び出します。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_sum(1,2);
exfunc_sum
------------
 3
(1 row)</code></pre>
            <p>次の例では、整数データ型の 2 つの列 c1 と c2 を持つ t_sum というテーブルを作成し、2 行のデータを挿入します。次に、このテーブルの列名を渡すことにより、外部の関数が呼び出されます。2 つのテーブル行は、リクエストペイロードのバッチリクエストで単一の Lambda 呼び出しとして送信されます。</p>
            
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE TABLE t_sum(c1 int, c2 int);
INSERT INTO t_sum VALUES (4,5), (6,7);
SELECT exfunc_sum(c1,c2) FROM t_sum;
 exfunc_sum
---------------
 9
 13
(2 rows)</code></pre>
          

         
          
            <h3 id="r_CREATE_FUNCTION-lambda-example-retry">RETRY_TIMEOUT 属性を使用したスカラー Lambda UDF の例</h3>
            <p>次のセクションでは、Lambda UDF で RETRY_TIMEOUT 属性を使用する方法の例を見つけることができます。</p>
            <p>AWS Lambda 関数には、関数ごとに設定する同時実行数についての制限があります。同時実行数の制限に関する詳細については、「<em>AWS Lambda デベロッパーガイド</em>」の「<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html">Lambda の予約済み同時実行数の管理</a>」と、AWS コンピューティングブログの記事「<a href="https://aws.amazon.com/blogs/compute/managing-aws-lambda-function-concurrency" rel="noopener noreferrer" target="_blank"><span>AWS Lambda 関数の同時実行数の管理</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>」を参照してください。</p>
            <p>Lambda UDF によって処理されるリクエストの数が同時実行制限を超えると、新しいリクエストは <code class="code">TooManyRequestsException</code> エラーを受け取ります。Lambda UDF は、Lambda 関数に送信されるリクエスト間のすべての遅延の合計が、設定した RETRY_TIMEOUT 値以上になるまで、このエラーを再試行します。デフォルトの RETRY_TIMEOUT 値は 20,000 ミリ秒です。</p>
              <p>次の例では、<code class="code">exfunc_sleep_3</code> という名前の Lambda 関数を使用します。この関数は、リクエストペイロードを取り込み、各行を繰り返し処理し、入力を大文字に変換します。その後、3 秒間スリープし、結果を返します。この Lambda 関数に使用される言語は Python 3.8 です。</p>
            <p>結果配列の行数は、リクエストペイロードで受信した行数と似ています。JSON 応答ペイロードは、外部関数によって認識されるために、<code class="code">results</code> フィールドに結果データを持っている必要があります。Lambda 関数に送信されるリクエストの <code class="code">arguments</code> フィールドには、データペイロードが含まれています。バッチリクエストの場合、データペイロードに複数の行が表示されることがあります。</p>
              <p>この関数の同時実行制限は、RETRY_TIMEOUT 属性の使用法を示すために、予約済み同時実行で特に 1 に設定されています。属性が 1 に設定されている場合、Lambda 関数は一度に 1 つのリクエストしか処理できません。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">import json
import time
def lambda_handler(event, context):
    t1 = event['arguments']
    # 'len(t1)' represents the number of rows in the request payload.
    # The number of results in the response payload should be the same as the number of rows received.
    resp = [None]*len(t1)

    # Iterating over all rows in the request payload.
    for i, x in enumerate(t1):
        # Iterating over all the values in a single row.
        for j, y in enumerate(x):
            resp[i] = y.upper()

    time.sleep(3)
    ret = dict()
    ret['results'] = resp
    ret_json = json.dumps(ret)
    return ret_json</code></pre>
            <p>次に、RETRY_TIMEOUT 属性の追加例を 2 つ示します。それぞれ単一の Lambda UDF を呼び出します。Lambda UDF を呼び出す間、各例は同じ SQL クエリを実行して、2 つの同時実行データベースセッションから同時に Lambda UDF を呼び出します。Lambda UDF を呼び出す最初のクエリが UDF によって処理されている場合、2 番目のクエリは <code class="code">TooManyRequestsException</code> エラーを受け取ります。この結果は、UDF で予約された同時実行を特別に 1 に設定したために発生します。Lambda 関数の予約済み同時実行を設定する方法については、<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html#configuration-concurrency-reservedconfiguration-concurrency-reserved">予約済み同時実行数の設定</a>を参照してください。</p>


            

            <p>次の最初の例では、Lambda UDF の RETRY_TIMEOUT 属性を 0 ミリ秒に設定します。Lambda リクエストが Lambda 関数から例外を受け取った場合、Amazon Redshift は再試行を行いません。この結果は、RETRY_TIMEOUT 属性が 0 に設定されているために発生します。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE OR REPLACE EXTERNAL FUNCTION exfunc_upper(varchar)
RETURNS varchar
VOLATILE
LAMBDA 'exfunc_sleep_3'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'
RETRY_TIMEOUT 0;</code></pre>
            <p>RETRY_TIMEOUT を 0 に設定すると、別々のデータベースセッションから次の 2 つのクエリを実行して、異なる結果を確認できます。</p>
            <p>Lambda UDF を使用する最初の SQL クエリが正常に実行されます。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
 --------------
 VARCHAR
(1 row)</code></pre>
            <p>別のデータベースセッションから同時に実行される 2 番目のクエリは、<code class="code">TooManyRequestsException</code> エラーを受け取ります。</p>
                  
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
ERROR:  Rate Exceeded.; Exception: TooManyRequestsException; ShouldRetry: 1
DETAIL:
-----------------------------------------------
error:  Rate Exceeded.; Exception: TooManyRequestsException; ShouldRetry: 1
code:      32103
context:query:     0
location:  exfunc_client.cpp:102
process:   padbmaster [pid=26384]
-----------------------------------------------</code></pre>

                  <p>次の 2 番目の例では、Lambda UDF の RETRY_TIMEOUT 属性を 3,000 ミリ秒に設定します。2 番目のクエリが同時に実行された場合でも、Lambda UDF は遅延の合計が 3,000 ミリ秒になるまで再試行します。したがって、両方のクエリが正常に実行されます。</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE OR REPLACE EXTERNAL FUNCTION exfunc_upper(varchar)
RETURNS varchar
VOLATILE
LAMBDA 'exfunc_sleep_3'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'
RETRY_TIMEOUT 3000;</code></pre>
                  <p>RETRY_TIMEOUT を 3,000 ミリ秒に設定すると、別々のデータベースセッションから次の 2 つのクエリを実行して、同じ結果を確認できます。</p>
                  <p>Lambda UDF を実行する最初の SQL クエリが正常に実行されます。</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
 --------------
 VARCHAR
(1 row)</code></pre>
                  <p>2 番目のクエリは同時に実行され、Lambda UDF は遅延の合計が 3,000 ミリ秒になるまで再試行します。</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
--------------
 VARCHAR
(1 row)</code></pre>

          

          
            <h3 id="r_CREATE_FUNCTION-lambda-example-python">Python Lambda 関数を使用したスカラー Lambda UDF の例</h3>
            <p>次の例では、<code class="code">exfunc_multiplication</code> という名前の外部関数を作成します。この関数は、数値を乗算して整数を返します。この例では、Lambda 応答に success フィールドと <code class="code">error_msg</code> フィールドが組み込まれています。乗算結果に整数オーバーフローがあり、<code class="code">error_msg</code> メッセージが <code class="code">Integer multiplication overflow</code> に設定されている場合、成功フィールドは false に設定されます。<code class="code">exfunc_multiplication</code> 関数は、入力引数として 3 つの整数を取り、その合計を整数出力として返します。</p>
            <p>呼び出される Lambda 関数の名前は <code class="code">lambda_multiplication</code> です。この Lambda 関数に使用される言語は Python 3.8 です。IAM ロールを必ず指定してください。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE EXTERNAL FUNCTION exfunc_multiplication(int, int, int)
RETURNS INT
VOLATILE
LAMBDA 'lambda_multiplication'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'; </code></pre>
            <p>Lambda 関数はリクエストペイロードを受け取り、各行を繰り返して処理します。1 つの行ですべての値が乗算され、その行の結果が計算されます。この結果は、応答リストに保存されます。この例では、デフォルトで true に設定されているブールの成功値を使用します。行の乗算結果に整数オーバーフローがある場合、成功値は false に設定されます。その後、反復ループが中断されます。</p>
            <p>応答ペイロードの作成中に、成功値が false の場合、次の Lambda 関数がペイロードに <code class="code">error_msg</code> フィールドを追加します。また、エラーメッセージを <code class="code">Integer multiplication overflow</code> に設定します。成功値が true の場合、結果データが結果フィールドに追加されます。結果配列の行数は、存在する場合、リクエストペイロードで受信した行数と似ています。</p>
            <p>Lambda 関数に送信されるリクエストの引数フィールドには、データペイロードが含まれます。バッチリクエストの場合、データペイロードに複数の行が存在する可能性があります。次の Lambda 関数は、リクエストデータペイロードのすべての行を繰り返し処理し、1 つの行内のすべての値を個別に繰り返し処理します。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">import json
def lambda_handler(event, context):
    t1 = event['arguments']
    # 'len(t1)' represents the number of rows in the request payload.
    # The number of results in the response payload should be the same as the number of rows received.
    resp = [None]*len(t1)

    # By default success is set to 'True'.
    success = True
    # Iterating over all rows in the request payload.
    for i, x in enumerate(t1):
        mul = 1
        # Iterating over all the values in a single row.
        for j, y in enumerate(x):
            mul = mul*y

        # Check integer overflow.
        if (mul &gt;= 9223372036854775807 or mul &lt;= -9223372036854775808):
            success = False
            break
        else:
            resp[i] = mul
    ret = dict()
    ret['success'] = success
    if not success:
        ret['error_msg'] = "Integer multiplication overflow"
    else:
        ret['results'] = resp
    ret_json = json.dumps(ret)

    return ret_json</code></pre>

            <p>次の例では、リテラル値を使用して外部関数を呼び出します。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">SELECT exfunc_multiplication(8, 9, 2);
  exfunc_multiplication
---------------------------
          144
(1 row)</code></pre>

            <p>次の例では、整数データ型の 3 つの列 c1、c2、および c3 を持つ t_multi という名前のテーブルを作成します。外部関数は、このテーブルの列名を渡すことによって呼び出されます。データは、エラーがどのように伝播されるかを示す整数オーバーフローを引き起こすような方法で挿入されます。</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE TABLE t_multi (c1 int, c2 int, c3 int);
INSERT INTO t_multi VALUES (2147483647, 2147483647, 4);
SELECT exfunc_multiplication(c1, c2, c3) FROM t_multi;
DETAIL:
  -----------------------------------------------
  error:  Integer multiplication overflow
  code:      32004context:
  context:
  query:     38
  location:  exfunc_data.cpp:276
  process:   query2_16_38 [pid=30494]
  -----------------------------------------------</code></pre>
          




         
      <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>ブラウザで JavaScript が無効になっているか、使用できません。</strong></p><p>AWS ドキュメントを使用するには、JavaScript を有効にする必要があります。手順については、使用するブラウザのヘルプページを参照してください。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">ドキュメントの表記規則</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./r_CREATE_DATASHARE.html">CREATE DATASHARE</div><div id="next" class="next-link" accesskey="n" href="./r_CREATE_EXTERNAL_SCHEMA.html">CREATE EXTERNAL SCHEMA</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">このページは役に立ちましたか? - はい</div><div class="content"><p>ページが役に立ったことをお知らせいただき、ありがとうございます。</p><p>お時間がある場合は、何が良かったかお知らせください。今後の参考にさせていただきます。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">このページは役に立ちましたか? - いいえ</div><div class="content"><p>このページは修正が必要なことをお知らせいただき、ありがとうございます。ご期待に沿うことができず申し訳ありません。</p><p>お時間がある場合は、ドキュメントを改善する方法についてお知らせください。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>