<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="ja-JP"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>WITH 句 - Amazon Redshift</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="r_WITH_clause" /><meta name="default_state" content="r_WITH_clause" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" /><meta name="description" content="1 つ以上のサブクエリを定義します。WITH 句は、クエリ内の SELECT リストに先行するオプション句です。" /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon Redshift" /><meta name="guide" content="データベース開発者ガイド" /><meta name="abstract" content="エンタープライズレベル、ペタバイト規模、フルマネージドのデータウェアハウスサービス、Amazon Redshift を使用してデータウェアハウスを作成および管理できます。" /><meta name="guide-locale" content="ja_jp" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_WITH_clause.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_WITH_clause.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_WITH_clause.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_WITH_clause.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_WITH_clause.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_WITH_clause.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_WITH_clause.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_WITH_clause.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_WITH_clause.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_WITH_clause.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_WITH_clause.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_WITH_clause.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_WITH_clause.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_WITH_clause.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_WITH_clause.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_WITH_clause.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/r_WITH_clause.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/redshift/latest/dg/r_WITH_clause.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_WITH_clause.html" hreflang="x-default" /><meta name="feedback-item" content="Redshift" /><meta name="this_doc_product" content="Amazon Redshift" /><meta name="this_doc_guide" content="データベース開発者ガイド" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'redshift'}"></script><meta id="panorama-serviceSubSection" value="データベース開発者ガイド" /><meta id="panorama-serviceConsolePage" value="WITH 句" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>WITH 句 - Amazon Redshift</title><meta name="pdf" content="redshift-dg.pdf#r_WITH_clause" /><meta name="rss" content="Dochistory.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=155" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html" /><meta name="keywords" content="Amazon Redshift,AWS Redshift,Redshift,Redshift Spectrum,クラスター,データウェアハウス,開発者,サンプルデータ,データベース,データベース開発者,HLL" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon Redshift",
        "item" : "https://docs.aws.amazon.com/redshift/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "データベース開発者ガイド",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "SQL リファレンス",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/cm_chap_SQLCommandRef.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "SQL コマンド",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/c_SQL_commands.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "SELECT",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_SELECT_synopsis.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "WITH 句",
        "item" : "https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_SELECT_synopsis.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="redshift-dg.pdf#r_WITH_clause" target="_blank" rel="noopener noreferrer" title="PDF を開く"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">ドキュメント</a><a href="/redshift/index.html">Amazon Redshift</a><a href="welcome.html">データベース開発者ガイド</a></div><div id="page-toc-src"><a href="#r_WITH_clause-synopsis">構文</a><a href="#r_WITH_clause-parameters">パラメータ</a><a href="#r_WITH_clause-usage-notes">使用に関する注意事項</a><a href="#r_WITH_clause-recursive-cte">再帰的な CTE</a><a href="#r_WITH_clause-examples">例</a><a href="#r_WITH_clause-recursive-cte-example">例: 再帰的な CTE</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="r_WITH_clause">WITH 句</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>WITH 句は、クエリ内の SELECT リストに先行するオプション句です。WITH 句は、1 つまたは複数の <em>common_table_expressions</em> を定義します。各共通テーブル式 (CTE) は、ビュー定義に似ている一時テーブルを定義します。これらの一時テーブルは、FROM 句で参照できます。それらは、所属するクエリが実行されている間にのみ使用されます。WITH 句内の各 CTE は、テーブル名、列名のオプションリスト、およびテーブルに対して評価を実行するクエリ表現 (SELECT ステートメント) を指定します。一時テーブル名を定義しているのと同じクエリ式の FROM 句で一時テーブル名を参照すると、CTE は再帰的になります。</p><p>WITH 句のサブクエリは、単一のクエリ実行中に、使用可能なテーブルを効率的に定義します。SELECT ステートメントの本文内でサブクエリを使用することで、すべてのケースで同じ結果を実現できますが、WITH 句のサブクエリの方が、読み書きが簡単になることがあります。可能な場合は、複数回参照される、WITH 句のサブクエリは、一般的な副次式として最適化されます。つまり、一度 WITH サブクエリを評価すると、その結果を再利用することができるということです。(一般的な副次式は、WITH 句内で定義される副次式に制限されない点に注意してください。)</p>
            <h2 id="r_WITH_clause-synopsis">構文</h2>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">[ WITH [RECURSIVE] <em>common_table_expression</em> [, <em>common_table_expression</em> , ...] ]</code></pre>
            <p>ここで、<em>common_table_expression</em> は、非再帰的または再帰的のいずれかになります。非再帰形式は次のとおりです。</p>

            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><em>CTE_table_name</em> [ ( <em>column_name</em> [, ...] ) ] AS ( <em>query</em> )</code></pre>



            <p>以下は、<em>common_table_expression</em> の再帰形式です。</p>


            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><em>CTE_table_name</em> (<em>column_name</em> [, ...] ) AS ( <em>recursive_query</em> )
</code></pre>
          
            <h2 id="r_WITH_clause-parameters">パラメータ</h2>
            <div class="variablelist">
                
                
                
                
                

                
            <dl>
                  <dt><span class="term"> RECURSIVE </span></dt>
                  <dd>
                     <p>クエリを再帰的な CTE として識別するキーワード。WITH 句で定義された <em>common_table_expression</em> が再帰的である場合、このキーワードは必須です。WITH 句に複数の再帰的な CTE が含まれている場合でも、WITH キーワードの直後に RECURSIVE キーワードを指定できるのは 1 回だけです。一般に、再帰的な CTE は、2 つの部分で構成される UNION ALL サブクエリです。</p>

                  </dd>
                
                  <dt><span class="term"> <em>common_table_expression</em> </span></dt>
                  <dd>
                     <p><a href="./r_FROM_clause30.html">FROM 句</a> で参照できる一時テーブルを定義し、それが属するクエリの実行中にのみ使用されます。</p>

                  </dd>
                
                  <dt><span class="term"> <em>CTE_table_name</em> </span></dt>
                  <dd>
                     <p>WITH 句のサブクエリの結果を定義する一時テーブルの一意な名前。単一の WITH 句内で重複する名前を使用することはできません。各サブクエリには、<a href="./r_FROM_clause30.html">FROM 句</a>で参照可能なテーブル名を付ける必要があります。</p>

                  </dd>
                
                  <dt><span class="term"> <em>column_name</em> </span></dt>
                  <dd>
                     <p> WITH 句サブクエリの出力列名を、カンマで区切ったリスト。指定された列名の数は、サブクエリで定義した列数以下でなければなりません。非再帰的な CTE の場合、<em>column_name</em> 句はオプションです。再帰的な CTE の場合、<em>column_name</em> リストが必要です。</p>
                  </dd>
                
                  <dt><span class="term"> <em>query</em> </span></dt>
                  <dd>
                     <p> Amazon Redshift がサポートする任意の SELECT クエリ。「<a href="./r_SELECT_synopsis.html">SELECT</a>」を参照してください。</p>
                  </dd>
                
                  <dt><span class="term"> <em>recursive_query</em> </span></dt>
                  <dd>
                     <p>2 つの SELECT サブクエリから構成される UNION ALL クエリ。</p>
                     <div class="itemizedlist">
                         
                         
                     <ul class="itemizedlist"><li class="listitem"><p>最初の SELECT サブクエリには、同じ <em>CTE_table_name</em> への再帰リファレンスがありません。再帰の最初のシードである結果セットを返します。この部分は、初期メンバーまたはシードメンバーと呼ばれます。</p></li><li class="listitem"><p>2 番目の SELECT サブクエリは、FROM 句で同じ <em>CTE_table_name</em> を参照します。これは、再帰メンバーと呼びます。<em>recursive_query</em> には、<em>recursive_query</em> を終了するための WHERE 条件が含まれています。</p></li></ul></div>

                  </dd>
               </dl></div>
          
            <h2 id="r_WITH_clause-usage-notes">使用に関する注意事項</h2>

            <p>次の SQL ステートメントで WITH 句を使用できます。</p>
            <div class="itemizedlist">
                
                
                
                
                
                
                
                
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>SELECT </p>
               </li><li class="listitem">
                  <p>SELECT INTO</p>
               </li><li class="listitem">
                  <p>CREATE TABLE AS</p>
               </li><li class="listitem">
                  <p>CREATE VIEW</p>
               </li><li class="listitem">
                  <p>DECLARE</p>
               </li><li class="listitem">
                  <p>EXPLAIN</p>
               </li><li class="listitem">
                  <p>INSERT INTO...SELECT </p>
               </li><li class="listitem">
                  <p>PREPARE</p>
               </li><li class="listitem">
                  <p>UPDATE (WHERE 句のサブクエリ内。サブクエリで再帰的な CTE を定義することはできません。再帰的な CTE は、UPDATE 句の前に配置する必要があります)。</p>
               </li><li class="listitem">
                  <p>DELETE</p>
               </li></ul></div>
            <p>WITH 句を含んでいるクエリの FROM 句が、WITH 句によって定義されたテーブルを参照していない場合、含まれている WITH 句は無視された上でクエリは通常どおり実行されます。</p>
            <p>WITH 句のサブクエリで定義されたテーブルは、WITH 句が開始した SELECT クエリの範囲でのみ参照可能です。例えば、このようなテーブルは、SELECT リスト、WHERE 句、または HAVING 句内のサブクエリの FROM 句で参照できます。サブクエリ内で WITH 句を使用し、メインクエリまたは別のサブクエリの FROM 句でそのテーブルを参照することはできません。このクエリパターンを使用すると、WITH 句のテーブルに対して、<code class="code">relation table_name doesn't exist</code>という形式のエラーメッセージが発生します。</p>
            <p>WITH 句のサブクエリ内で、別の WITH 句を指定することはできません。</p>
            <p>WITH 句のサブクエリによって定義されたテーブルに対して、前方参照を作成することはできません。例えば次のクエリでは、テーブル W1 の定義内でテーブル W2 への前方参照を設定しているため、エラーが帰されます。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">with w1 as (select * from w2), w2 as (select * from w1)
select * from sales;
ERROR:  relation "w2" does not exist</code></pre>
            <p>WITH 句のサブクエリは、SELECT INTO ステートメントを構成できません。しかし、SELECT INTO ステートメント内で WITH 句を使用することは可能です。</p>
          
            <h2 id="r_WITH_clause-recursive-cte">再帰的なテーブル共通式 </h2>

            <p>再帰<em>共通テーブル式 (CTE)</em> はそれ自体を参照する CTE です。再帰的な CTE は、従業員とマネージャー間のレポート関係を示す組織図などの階層データのクエリに役立ちます。「<a href="#r_WITH_clause-recursive-cte-example">例: 再帰的な CTE</a>」を参照してください。</p>
            <p>もう 1 つの一般的な用途は、製品が多くのコンポーネントで構成され、各コンポーネント自体も他のコンポーネントまたはサブアセンブリで構成されている場合のマルチレベルの部品表です。</p>
            <p>再帰クエリの 2 番目の SELECT サブクエリに WHERE 句を含めることで、再帰の深さを制限する必要があります。例については、「<a href="#r_WITH_clause-recursive-cte-example">例: 再帰的な CTE</a>」を参照してください。この制限を行わない場合は、次のようなエラーが発生する可能性があります。</p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem"><p><code class="code">Recursive CTE out of working buffers.</code></p></li><li class="listitem"><p><code class="code">Exceeded recursive CTE max rows limit, please add correct CTE termination predicates or change the max_recursion_rows parameter.</code></p></li></ul></div>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>注記</h6></div><div class="awsdocs-note-text"><p><code class="code">max_recursion_rows</code> は、無限再帰ループを防ぐために再帰 CTE が返すことができる最大行数を設定するパラメータです。これをデフォルトよりも大きな値に変更しないことをお勧めします。これにより、クエリの無限再帰の問題がクラスター内で過剰なスペースを占有することを防ぎます。</p></div></div>
            <p> 再帰的な CTE の結果に対するソート順と制限を指定できます。再帰的な CTE の最終結果に、group by オプションと distinct オプションを含めることができます。</p>
            <p>サブクエリ内で、WITH RECURSIVE 句を指定することはできません。<em>recursive_query</em> メンバーには、order by 句または limit 句を含めることはできません。</p>

          
            <h2 id="r_WITH_clause-examples">例</h2>
            <p>次の例では、WITH 句を含む最もシンプルなケースを示します。VENUECOPY という名前の WITH クエリは、VENUE テーブルからすべての行を選択します。次にメインクエリでは、VENUECOPY からすべての行を選択します。VENUECOPY テーブルは、このクエリの有効期間中だけ存在します。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">with venuecopy as (select * from venue)
select * from venuecopy order by 1 limit 10;</code></pre>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class=""> venueid |         venuename          |    venuecity    | venuestate | venueseats
---------+----------------------------+-----------------+------------+------------
1 | Toyota Park                | Bridgeview      | IL         |          0
2 | Columbus Crew Stadium      | Columbus        | OH         |          0
3 | RFK Stadium                | Washington      | DC         |          0
4 | CommunityAmerica Ballpark  | Kansas City     | KS         |          0
5 | Gillette Stadium           | Foxborough      | MA         |      68756
6 | New York Giants Stadium    | East Rutherford | NJ         |      80242
7 | BMO Field                  | Toronto         | ON         |          0
8 | The Home Depot Center      | Carson          | CA         |          0
9 | Dick's Sporting Goods Park | Commerce City   | CO         |          0
v     10 | Pizza Hut Park             | Frisco          | TX         |          0
(10 rows)</code></pre>
            <p>次の例では、VENUE_SALES と TOP_VENUES という名前の 2 つのテーブルを生成する WITH 句を示します。2 番目の WITH 句テーブルは最初のテーブルから選択します。次に、メインクエリブロックの WHERE 句には、TOP_VENUES テーブルを制約するサブクエリが含まれています。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">with venue_sales as
(select venuename, venuecity, sum(pricepaid) as venuename_sales
from sales, venue, event
where venue.venueid=event.venueid and event.eventid=sales.eventid
group by venuename, venuecity),

top_venues as
(select venuename
from venue_sales
where venuename_sales &gt; 800000)

select venuename, venuecity, venuestate,
sum(qtysold) as venue_qty,
sum(pricepaid) as venue_sales
from sales, venue, event
where venue.venueid=event.venueid and event.eventid=sales.eventid
and venuename in(select venuename from top_venues)
group by venuename, venuecity, venuestate
order by venuename;</code></pre>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">        venuename       |   venuecity   | venuestate | venue_qty | venue_sales
------------------------+---------------+------------+-----------+-------------
August Wilson Theatre   | New York City | NY         |      3187 |  1032156.00
Biltmore Theatre        | New York City | NY         |      2629 |   828981.00
Charles Playhouse       | Boston        | MA         |      2502 |   857031.00
Ethel Barrymore Theatre | New York City | NY         |      2828 |   891172.00
Eugene O'Neill Theatre  | New York City | NY         |      2488 |   828950.00
Greek Theatre           | Los Angeles   | CA         |      2445 |   838918.00
Helen Hayes Theatre     | New York City | NY         |      2948 |   978765.00
Hilton Theatre          | New York City | NY         |      2999 |   885686.00
Imperial Theatre        | New York City | NY         |      2702 |   877993.00
Lunt-Fontanne Theatre   | New York City | NY         |      3326 |  1115182.00
Majestic Theatre        | New York City | NY         |      2549 |   894275.00
Nederlander Theatre     | New York City | NY         |      2934 |   936312.00
Pasadena Playhouse      | Pasadena      | CA         |      2739 |   820435.00
Winter Garden Theatre   | New York City | NY         |      2838 |   939257.00
(14 rows)</code></pre>
            <p>次の 2 つの例は、WITH 句サブクエリに基づいた、テーブル参照の範囲に関するルールをデモンストレーションしています。最初のクエリは実行されますが、2 番目のクエリは予想どおりのエラーが発生して失敗します。最初のクエリには、メインクエリの SELECT リスト内に WITH 句サブクエリが存在します。WITH 句によって定義されるテーブル (HOLIDAYS) は、SELECT リストのサブクエリの FROM 句で参照されます。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">select caldate, sum(pricepaid) as daysales,
(with <b>holidays</b> as (select * from date where holiday ='t')
select sum(pricepaid)
from sales join <b>holidays</b> on sales.dateid=<b>holidays</b>.dateid
where caldate='2008-12-25') as dec25sales
from sales join date on sales.dateid=date.dateid
where caldate in('2008-12-25','2008-12-31')
group by caldate
order by caldate;

caldate   | daysales | dec25sales
-----------+----------+------------
2008-12-25 | 70402.00 |   70402.00
2008-12-31 | 12678.00 |   70402.00
(2 rows)</code></pre>
            <p>2 番目のクエリは SELECT リストのサブクエリ内だけでなく、メインクエリ内の HOLIDAYS テーブルを参照しようとしたため、失敗しました。メインクエリの参照は範囲外です。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">select caldate, sum(pricepaid) as daysales,
(with <b>holidays</b> as (select * from date where holiday ='t')
select sum(pricepaid)
from sales join <b>holidays</b> on sales.dateid=<b>holidays</b>.dateid
where caldate='2008-12-25') as dec25sales
from sales join <b>holidays</b> on sales.dateid=<b>holidays</b>.dateid
where caldate in('2008-12-25','2008-12-31')
group by caldate
order by caldate;

ERROR:  relation "holidays" does not exist</code></pre>
            
          
            <h2 id="r_WITH_clause-recursive-cte-example">例: 再帰的な CTE</h2>
            <p>次に示すのは、John に直接的または間接的に報告する従業員を返す再帰的な CTE の例です。再帰クエリには、再帰の深さを 4 レベル未満に制限する WHERE 句が含まれています。</p>

            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="sql ">--create and populate the sample table
  create table employee (
  id int,
  name varchar (20),
  manager_id int
  );
  
  insert into employee(id, name, manager_id)  values
(100, 'Carlos', null),
(101, 'John', 100),
(102, 'Jorge', 101),
(103, 'Kwaku', 101),
(110, 'Liu', 101),
(106, 'Mateo', 102),
(110, 'Nikki', 103),
(104, 'Paulo', 103),
(105, 'Richard', 103),
(120, 'Saanvi', 104),
(200, 'Shirley', 104),
(201, 'Sofía', 102),
(205, 'Zhang', 104);
  
--run the recursive query
  with recursive john_org(id, name, manager_id, level) as
( select id, name, manager_id, 1 as level
  from employee
  where name = 'John'
  union all
  select e.id, e.name, e.manager_id, level + 1 as next_level
  from employee e, john_org j
  where e.manager_id = j.id and level &lt; 4
  )
 select distinct id, name, manager_id from john_org order by manager_id;</code></pre>
            <p>以下は、クエリの結果です。</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="コピー"><awsui-icon name="copy"></awsui-icon></div></div><code class="">    id        name      manager_id
  ------+-----------+--------------
   101    John           100
   102    Jorge          101
   103    Kwaku          101
   110    Liu            101
   201    Sofía          102
   106    Mateo          102
   110    Nikki          103
   104    Paulo          103
   105    Richard        103
   120    Saanvi         104
   200    Shirley        104
   205    Zhang          104</code></pre>
            <p>以下は、John が所属する部門の組織図です。</p>
            <div class="mediaobject">
                
                  <img src="images/org-chart.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="John が所属する部門の組織図。" style="max-width:100%" />
                
                
            </div>



         <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="警告" /> <strong>ブラウザで JavaScript が無効になっているか、使用できません。</strong></p><p>AWS ドキュメントを使用するには、JavaScript を有効にする必要があります。手順については、使用するブラウザのヘルプページを参照してください。</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">ドキュメントの表記規則</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./r_SELECT_synopsis.html">SELECT</div><div id="next" class="next-link" accesskey="n" href="./r_SELECT_list.html">SELECT リスト</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">このページは役に立ちましたか? - はい</div><div class="content"><p>ページが役に立ったことをお知らせいただき、ありがとうございます。</p><p>お時間がある場合は、何が良かったかお知らせください。今後の参考にさせていただきます。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">このページは役に立ちましたか? - いいえ</div><div class="content"><p>このページは修正が必要なことをお知らせいただき、ありがとうございます。ご期待に沿うことができず申し訳ありません。</p><p>お時間がある場合は、ドキュメントを改善する方法についてお知らせください。</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="フィードバック" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_WITH_clause.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>