<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="fr-FR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Procédure : recherche des ID d'Amazon Machine Image - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><meta name="default_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="description" content="Utilisez AWS Lambda et une ressource personnalisée pour rechercher dynamiquement les ID d'AMI." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="Guide de l'utilisateur" /><meta name="abstract" content="Créez et gérez des déploiements AWS d'infrastructure de manière prévisible et répétée à l'aide de ce AWS CloudFormation guide de l'utilisateur." /><meta name="guide-locale" content="fr_fr" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="Guide de l'utilisateur" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="Guide de l'utilisateur" /><meta id="panorama-serviceConsolePage" value="Procédure : recherche des ID d'Amazon Machine Image" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Procédure : recherche des ID d'Amazon Machine Image - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,provisionnement des ressources,configuration des ressources,gestion de l'infrastructure,CloudFormer,CloudFormation pile,CloudFormation stackset,CloudFormation modèle,jeu de modifications" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Guide de l'utilisateur",
        "item" : "https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Utilisation des modèles AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Ressources personnalisées",
        "item" : "https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-custom-resources.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Ressources personnalisées basées sur AWS Lambda",
        "item" : "https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Procédure : recherche des ID d'Amazon Machine Image",
        "item" : "https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">Guide de l'utilisateur</a></div><div id="page-toc-src"><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Étape 1 : Téléchargement et enregistrement de l'exemple de package dans Amazon S3</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Étape 2 : Création de la pile</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Étape 3 : Nettoyer les ressources</a><a href="#w9aac23c26c16b7c29">Informations connexes</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><awsui-alert class="awsdocs-page-banner awsui-util-mb-l"><p>Les traductions sont fournies par des outils de traduction automatique. En cas de conflit entre le contenu d'une traduction et celui de la version originale en anglais, la version anglaise prévaudra.</p></awsui-alert><h1 class="topictitle" id="walkthrough-custom-resources-lambda-lookup-amiids">Procédure : recherche des ID d'Amazon Machine Image</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Les modèles AWS CloudFormation qui déclarent une instance Amazon Elastic Compute Cloud (Amazon EC2) doivent aussi spécifier un ID d'Amazon Machine Image (AMI), qui comprend un système d'exploitation, ainsi que d'autres logiciels et informations de configuration utilisés pour lancer l'instance. L'ID d'AMI correct dépend du type d'instance et de la région dans laquelle vous lancez la pile. Par ailleurs, ces ID peuvent changer régulièrement, notamment lorsqu'une AMI reçoit des mises à jour logicielles.</p><p>Généralement, vous pouvez mapper les ID d'AMI avec des régions et des types d'instance spécifiques. Pour mettre à jour les ID, vous devez les modifier manuellement dans chacun de vos modèles. Vous pouvez tirer parti des ressources personnalisées et d'AWS Lambda (Lambda) pour créer une fonction qui obtient les ID des dernières images AMI pour la région et le type d'instance que vous utilisez. De cette manière, vous n'avez pas à gérer les mappages.</p><p>Cette procédure détaillée vous montre comment créer une ressource personnalisée et y associer une fonction Lambda pour rechercher les ID d'AMI. Notez que vous devez au préalable savoir à quoi servent les ressources personnalisées et Lambda. Pour plus d'informations, veuillez consulter la <a href="./template-custom-resources.html">Ressources personnalisées</a> le <a href="https://docs.aws.amazon.com/lambda/latest/dg/">Guide du développeur AWS Lambda</a>.</p><p>Présentation de la procédure</p><p>Dans cette procédure, vous créez une pile avec une ressource personnalisée, une fonction Lambda et une instance EC2. Un exemple de code et un exemple de modèle sont mis à votre disposition pour créer la pile.</p><p>L'exemple de modèle utilise le type de ressource personnalisée à appeler et envoie les valeurs d'entrée à la fonction Lambda. Lorsque vous utilisez ce modèle, AWS CloudFormation appelle la fonction et lui envoie des informations, telles que le type de requête, les données d'entrée et une URL Amazon Simple Storage Service (Amazon S3) pré-signée. Cette fonction utilise ces informations pour rechercher l'ID d'AMI, puis envoie une réponse à l'URL pré-signée.</p><p>Une fois qu'AWS CloudFormation obtient une réponse à l'emplacement de l'URL pré-signée, il procède à la création de la pile. Quand AWS CloudFormation crée l'instance, il utilise la réponse de la fonction Lambda pour spécifier l'ID d'AMI de l'instance.</p><p>La liste suivante résume le processus. Vous avez besoin des autorisations AWS Identity and Access Management (IAM) pour utiliser tous les services correspondants (Lambda, Amazon EC2, et AWS CloudFormation par exemple).</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>AWS CloudFormation est un service gratuit. Cependant, les ressources AWS que vous incluez dans vos piles, telles que la fonction Lambda et l'instance EC2, vous sont facturées au taux en vigueur pour chaque ressource. Pour plus d'informations sur la tarification AWS, veuillez consulter la page de détails de chaque produit à l'adresse <a href="https://aws.amazon.com/" rel="noopener noreferrer" target="_blank"><span>http://aws.amazon.com</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p></div></div><div class="orderedlist">
     
     
     
  <ol><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Enregistrez l'exemple de package Lambda dans un compartiment Amazon Simple Storage Service (Amazon S3).</a></p>
      <p>Cet exemple de package contient tout ce dont vous avez besoin pour créer la fonction Lambda. Vous devez l'enregistrer dans un compartiment situé dans la région dans laquelle vous allez créer la pile.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Utilisez l'exemple de modèle pour créer une pile.</a></p>
      <p>Cette pile illustre comment vous associez la fonction Lambda à une ressource personnalisée et comment utiliser les résultats de cette fonction pour spécifier un ID d'AMI. Elle crée également un rôle IAM (rôle d'exécution) qu'Lambda utilise pour effectuer des appels à Amazon EC2.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Supprimer la pile.</a></p>
      <p>Supprimez la pile pour nettoyer toutes les ressources que vous y avez créées et pour éviter d'être facturé pour des ressources que vous n'utilisez pas.</p>
    </li></ol></div><h2 id="walkthrough-custom-resources-lambda-lookup-amiids-savesample">Étape 1 : Téléchargement et enregistrement de l'exemple de package dans Amazon S3</h2>
    
    <p>Lorsque vous créez une pile avec une fonction Lambda, vous devez spécifier l'emplacement du compartiment Amazon S3 qui contient le code source de la fonction. Ce compartiment doit être dans la même région que celle dans laquelle vous créerez la pile.</p>
    <p>Cette procédure fournit un exemple de package (un fichier <code>.zip</code>) requis pour créer la fonction Lambda. Un package Lambda contient le code source de la fonction et les bibliothèques requises. Dans cette procédure, la fonction n'a pas besoin de bibliothèques supplémentaires.</p>
    <p>La fonction utilise l'architecture d'une instance et la région en tant qu'entrées fournies par une demande de ressource personnalisée AWS CloudFormation, et renvoie le dernier ID d'AMI à une URL Amazon S3 pré-signée.</p>
    <div class="procedure"><h6>Pour télécharger et enregistrer le package dans Amazon S3</h6><ol><li>
        <p>Téléchargez l'exemple de package Amazon S3. Lorsque vous enregistrez le fichier, utilisez le même nom de fichier que l'exemple, <code>amilookup.zip</code> ou <code>amilookup-win.zip</code>.</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Recherche d'ID d'AMI Linux</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          
            <dt><b><span class="term">Recherche d'ID d'AMI Windows</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Ouvrez la console Amazon S3 à l'adresse <a href="https://console.aws.amazon.com/s3/home" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/s3/home</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Sélectionnez ou créez un compartiment qui se trouve dans la même région que celle dans laquelle vous créerez la pile AWS CloudFormation. Notez le nom du compartiment.</p>
        <p>Vous enregistrerez l'exemple de package dans ce compartiment. Pour plus d'informations sur la création d'un compartiment, veuillez consulter la rubrique <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/CreatingaBucket.html">Création d'un compartiment</a> dans le <em>Guide de l'utilisateur Amazon Simple Storage Service</em>.</p>
      </li><li>
        <p>Importez l'exemple de package dans le compartiment que vous avez sélectionné ou créé.</p>
        <p>Pour plus d'informations sur le chargement d'objets, veuillez consulter la rubrique <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/UploadingObjectsintoAmazonS3.html">Chargement d'objets</a> dans le <em>Guide de l'utilisateur Amazon Simple Storage Service</em>.</p>
      </li></ol></div>
    <p>Maintenant que le package se trouve dans Amazon S3, vous pouvez spécifier son emplacement dans la déclaration de ressource Lambda du modèle AWS CloudFormation. L'étape suivante montre comment déclarer la fonction et l'appeler à l'aide d'une ressource personnalisée. Vous découvrirez également comment utiliser les résultats de la fonction pour spécifier l'ID d'AMI d'une instance EC2.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Étape 2 : Création de la pile</h2>
    
    <p>Pour créer l'exemple de pile Amazon EC2, utilisez un exemple de modèle qui inclut une fonction Lambda, un rôle d'exécution IAM, une ressource personnalisée qui appelle la fonction et une instance EC2 qui exploite les résultats de cette fonction.</p>
    <p>Au cours de la création de la pile, la ressource personnalisée appelle la fonction Lambda et attend que cette dernière envoie une réponse à l'URL Amazon S3 pré-signée. Dans la réponse, la fonction renvoie l'ID de la dernière AMI qui correspond au type d'instance EC2 et à la région dans laquelle vous créez l'instance. Les données issues de la réponse de la fonction sont stockées en tant qu'attribut de la ressource personnalisée, lequel permet de spécifier l'ID d'AMI de l'instance EC2.</p>
    <p>Les extraits suivants mettent en avant les parties pertinentes de l'exemple de modèle afin de vous aider à comprendre comment associer une fonction Lambda à une ressource personnalisée et comment utiliser la réponse de cette fonction.</p>
    <p>Pour afficher l'exemple de modèle complet, consultez :</p>
    <div class="variablelist">
       
       
    <dl>
        <dt><b><span class="term">Modèle Linux</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMI LookupSample .template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      
        <dt><b><span class="term">Modèle Windows</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMI LookupSample -win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      </dl></div>
    <p>Extraits du modèle de pile</p>
    <p>Pour créer la fonction Lambda, vous déclarez la ressource <code class="code">AWS::Lambda::Function</code>, qui nécessite le code source de la fonction, le nom de gestionnaire, l'environnement d'exécution et l'ARN du rôle d'exécution.</p>
    <div class="example"><h6>Exemple Syntaxe JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfoFunction": <span>{</span>
  "Type": "AWS::Lambda::Function",
  "Properties": <span>{</span>
    "Code": <span>{</span>
      "S3Bucket": <span>{</span> "Ref": "S3Bucket" },
      "S3Key": <span>{</span> "Ref": "S3Key" }
    },
    "Handler": <span>{</span> "Fn::Join" : [ "", [<span>{</span> "Ref": "ModuleName" },".handler"] ] },
    "Runtime": "nodejs18.x",
    "Timeout": "30",
    "Role": <span>{</span> "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Exemple Syntaxe YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfoFunction:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      S3Bucket: !Ref S3Bucket
      S3Key: !Ref S3Key
    Handler: !Sub "$<span>{</span>ModuleName}.handler"
    Runtime: nodejs18.x
    Timeout: 30
    Role: !GetAtt LambdaExecutionRole.Arn</code></pre></div></div>
    <p>La propriété <code class="code">Code</code> spécifie l'emplacement Amazon S3 (nom du compartiment et nom de fichier) dans lequel vous avez chargé l'exemple de package. L'exemple de modèle utilise des paramètres d'entrée (<code class="code">"Ref":
        "S3Bucket"</code> et <code class="code">"Ref": "S3Key"</code>) pour définir les noms de compartiment et de fichier. Vous pouvez ainsi définir ces noms lorsque vous créez la pile. De même, le nom du gestionnaire, qui correspond au nom du fichier source (le  JavaScript  fichier) dans le <code>.zip</code> package, utilise également un paramètre d'entrée (<code class="code">"Ref":
        "ModuleName"</code>). Le fichier source étant du  JavaScript  code, le runtime est spécifié sous la forme<code class="code">nodejs18.x</code>.</p>
    <p>Dans cette procédure, le délai d'exécution de la fonction dépasse la valeur par défaut (<code class="code">3</code> secondes). Le délai d'expiration est donc remplacé par <code class="code">30</code> secondes. Si vous ne spécifiez pas un délai suffisamment long, la fonction Lambda risque d'expirer avant qu'elle n'ait eu le temps de se terminer, et la création de la pile échouera.</p>
    <p>Le rôle d'exécution, qui est déclaré ailleurs dans le modèle, a été spécifié à l'aide de la fonction intrinsèque <code class="code">Fn::GetAtt</code> dans la propriété <code class="code">Role</code>. Ce rôle d'exécution accorde à la fonction Lambda l'autorisation d'envoyer des journaux à AWS et d'appeler l'API EC2 <code class="code">DescribeImages</code>. L'extrait suivant présente le rôle et la politique qui accordent l'autorisation appropriée :</p>
    <div class="example"><h6>Exemple Syntaxe JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"LambdaExecutionRole": <span>{</span>
  "Type": "AWS::IAM::Role",
  "Properties": <span>{</span>
    "AssumeRolePolicyDocument": <span>{</span>
      "Version": "2012-10-17",
      "Statement": [<span>{</span>
        "Effect": "Allow",
        "Principal": <span>{</span>"Service": ["lambda.amazonaws.com"]},
        "Action": ["sts:AssumeRole"]
      }]
    },
    "Path": "/",
    "Policies": [<span>{</span>
      "PolicyName": "root",
      "PolicyDocument": <span>{</span>
        "Version": "2012-10-17",
        "Statement": [<span>{</span>
          "Effect": "Allow",
          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
          "Resource": "arn:aws:logs:*:*:*"
        },
        <span>{</span>
          "Effect": "Allow",
          "Action": ["ec2:DescribeImages"],
          "Resource": "*"
        }]
      }
    }]
  }
}</code></pre></div></div>
    <div class="example"><h6>Exemple Syntaxe YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
      - Effect: Allow
        Principal:
          Service:
          - lambda.amazonaws.com
        Action:
        - sts:AssumeRole
    Path: "/"
    Policies:
    - PolicyName: root
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - ec2:DescribeImages
          Resource: "*"</code></pre></div></div>
    <p>Pour les modèles Linux et Windows, la ressource personnalisée appelle la fonction Lambda qui lui est associée. Pour associer une fonction à une ressource personnalisée, vous spécifiez l'Amazon Resource Name (ARN) de la fonction pour la propriété <code class="code">ServiceToken</code>, à l'aide de la fonction intrinsèque <code class="code">Fn::GetAtt</code>. AWS CloudFormation envoie les propriétés supplémentaires qui sont incluses dans la déclaration de ressource personnalisée, comme <code class="code">Region</code> et <code class="code">Architecture</code>, à la fonction Lambda comme entrées. La fonction Lambda détermine les noms et les valeurs corrects de ces propriétés d'entrée.</p>
    <div class="example"><h6>Exemple Syntaxe JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "Architecture": <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Exemple Syntaxe YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    Architecture:
      Fn::FindInMap:
      - AWSInstanceType2Arch
      - !Ref InstanceType
      - Arch</code></pre></div></div>
    <p>Pour Windows, la ressource personnalisée fournit la version Windows à la fonction Lambda au lieu de l'architecture de l'instance.</p>
    <div class="example"><h6>Exemple Syntaxe JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "OSName": <span>{</span> "Ref": "WindowsVersion" }
  }
}</code></pre></div></div>
    <div class="example"><h6>Exemple Syntaxe YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    OSName: !Ref "WindowsVersion"</code></pre></div></div>
    <p>Quand AWS CloudFormation appelle la fonction Lambda, celle-ci appelle l'API EC2 <code class="code">DescribeImages</code> à l'aide de la région et de l'architecture d'instance ou du nom du système d'exploitation pour filtrer la liste d'images. Ensuite, la fonction trie la liste d'images par date et renvoie l'ID de la dernière AMI.</p>
    <p>Lorsqu'elle renvoie l'ID de la dernière image AMI, la fonction envoie l'ID à une URL pré-signée dans la propriété <code class="code">Data</code> de l'<a href="./crpg-ref-responses.html">objet de réponse</a>. Les données sont structurées sous forme de paire nom-valeur, comme illustré dans l'exemple suivant :</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Data": <span>{</span> 
  "Id": "ami-43795473"
}</code></pre>
    <p>L'extrait suivant montre comment obtenir les données issues d'une fonction Lambda. Il utilise la fonction intrinsèque <code class="code">Fn::GetAtt</code>, en fournissant le nom de la ressource personnalisée et le nom d'attribut de la valeur que vous souhaitez récupérer. Dans cette procédure, le nom de ressource personnalisée est <code class="code">AMIInfo</code>, tandis que le nom d'attribut est <code class="code">Id</code>.</p>
    <div class="example"><h6>Exemple Syntaxe JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"SampleInstance": <span>{</span>  
  "Type": "AWS::EC2::Instance",
  "Properties": <span>{</span>
    "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
    "ImageId": <span>{</span> "Fn::GetAtt": [ "AMIInfo", "Id" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Exemple Syntaxe YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Texte"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">SampleInstance:
  Type: AWS::EC2::Instance
  Properties:
    InstanceType: !Ref InstanceType
    ImageId: !GetAtt AMIInfo.Id</code></pre></div></div>
    <p>Maintenant que vous comprenez ce que fait le modèle, utilisez l'exemple de modèle pour créer une pile.</p>
    <div class="procedure"><h6>Pour créer la pile</h6><ol><li>
        <p>Ouvrez la AWS CloudFormation console à l'<a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>adresse https://console.aws.amazon.com/cloudformation/</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Sélectionnez <b>Créer une pile</b>.</p>
      </li><li>
        <p>Dans la section <b>Modèle</b>, choisissez <b>Spécifier une URL de modèle Amazon S3</b>, puis copiez et collez l'URL suivante dans la zone de texte :</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Modèle Linux</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          
            <dt><b><span class="term">Modèle Windows</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Choisissez <b>Suivant</b>.</p>
      </li><li>
        <p>Dans le champ <b>Nom de la pile</b>, tapez <code class="userinput">SampleEC2Instance</code>.</p>
      </li><li>
        <p>Dans la section <b>Paramètres</b>, spécifiez le nom du compartiment Amazon S3 que vous avez créé, puis choisissez <b>Suivant</b>.</p>
        <p>Les valeurs par défaut des autres paramètres sont les mêmes noms que ceux qui sont utilisés dans l'exemple de package <code>.zip</code>.</p>
      </li><li>
        <p>Dans cette procédure détaillée, vous n'avez pas besoin d'ajouter des balises ni de spécifier des paramètres avancés. Dès lors, cliquez sur <b>Suivant</b>.</p>
      </li><li>
        <p>Assurez-vous que le nom de la pile et l'URL du modèle sont corrects, puis sélectionnez <b>Créer</b>.</p>
      </li></ol></div>
    <p>La création de la pile par AWS CloudFormation peut durer plusieurs minutes. Pour surveiller la progression, affichez les événements de la pile. Pour plus d’informations, consultez <a href="./cfn-console-view-stack-data-resources.html">Affichage des données et des ressources de la AWS CloudFormation pile sur AWS Management Console</a>.</p>
    <p>Si la création de la pile aboutit, toutes ses ressources, telles que la fonction Lambda, la ressource personnalisée et l'instance EC2, ont été créées. Vous avez utilisé avec succès une fonction Lambda et une ressource personnalisée pour spécifier l'ID d'AMI d'une instance EC2. Vous n'avez pas besoin de créer ni de gérer un mappage d'ID d'AMI dans ce modèle.</p>
    <p>Pour voir les ID d'AMI utilisés par AWS CloudFormation pour créer l'instance EC2, consultez les sorties de la pile.</p>
   <p><a href="https://console.aws.amazon.com/cloudwatch/home#logs:" rel="noopener noreferrer" target="_blank"><span>Si la fonction Lambda renvoie une erreur, consultez les journaux de la fonction dans la console Amazon  CloudWatch  Logs.</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> Le nom du flux de journaux est l'ID physique de la ressource personnalisée, qui se trouve dans les ressources de la pile. Pour plus d'informations, consultez la section <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#ViewingLogData">Affichage des données du journal</a> dans le <em>guide de  CloudWatch  l'utilisateur Amazon</em>.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Étape 3 : Nettoyer les ressources</h2>
    
    <p>Pour vous assurer que des services inutilisés ne vous sont pas facturés, supprimez la pile.</p>
    <div class="procedure"><h6>Pour supprimer la pile</h6><ol><li>
        <p>Dans la console AWS CloudFormation, choisissez la pile <b>SampleEC2Instance</b>.</p>
      </li><li>
        <p>Choisissez <b>Actions</b>, puis <b>Supprimer la pile</b>.</p>
      </li><li>
        <p>Dans le message de confirmation, choisissez <b>Oui, supprimer</b>.</p>
      </li></ol></div>
    <p>Toutes les ressources que vous avez créées seront supprimées.</p>
    <p>Maintenant que vous comprenez comment créer et utiliser les fonctions Lambda avec AWS CloudFormation, vous pouvez utiliser l'exemple de modèle et de code de cette procédure pour créer d'autres piles et fonctions.</p>
  <h2 id="w9aac23c26c16b7c29">Informations connexes</h2>
    
    <div class="itemizedlist">
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="./crpg-ref.html">Référence sur les ressources personnalisées AWS CloudFormation</a></p>
      </li></ul></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Avertissement" /> <strong>JavaScript est désactivé ou n'est pas disponible dans votre navigateur.</strong></p><p>Pour que vous puissiez utiliser la documentation AWS, Javascript doit être activé. Vous trouverez des instructions sur les pages d'aide de votre navigateur.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Conventions de rédaction</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-custom-resources-lambda.html">Ressources personnalisées basées sur AWS Lambda</div><div id="next" class="next-link" accesskey="n" href="./cfn-lambda-function-code-cfnresponsemodule.html">Module cfn-response</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Cette page vous a-t-elle été utile ? - Oui</div><div class="content"><p>Merci de nous avoir fait part de votre satisfaction.</p><p>Si vous avez quelques minutes à nous consacrer, merci de nous indiquer ce qui vous a plu afin que nous puissions nous améliorer davantage.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Commentaire" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Cette page vous a-t-elle été utile ? - Non</div><div class="content"><p>Merci de nous avoir avertis que cette page avait besoin d'être retravaillée. Nous sommes désolés de ne pas avoir répondu à vos attentes.</p><p>Si vous avez quelques minutes à nous consacrer, merci de nous indiquer comment nous pourrions améliorer cette documentation.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Commentaire" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>