<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>CREATE EXTERNAL FUNCTION - Amazon Redshift</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="r_CREATE_EXTERNAL_FUNCTION" /><meta name="default_state" content="r_CREATE_EXTERNAL_FUNCTION" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="description" content="Creates a scalar user-defined function (UDF) based on AWS Lambda for Amazon Redshift." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon Redshift" /><meta name="guide" content="Database Developer Guide" /><meta name="abstract" content="Create and manage a data warehouse with Amazon Redshift, an enterprise-level, petabyte scale, fully managed data warehousing service." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" hreflang="x-default" /><meta name="feedback-item" content="Redshift" /><meta name="this_doc_product" content="Amazon Redshift" /><meta name="this_doc_guide" content="Database Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'redshift'}"></script><meta id="panorama-serviceSubSection" value="Database Developer Guide" /><meta id="panorama-serviceConsolePage" value="CREATE EXTERNAL FUNCTION" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>CREATE EXTERNAL FUNCTION - Amazon Redshift</title><meta name="pdf" content="/pdfs/redshift/latest/dg/redshift-dg.pdf#r_CREATE_EXTERNAL_FUNCTION" /><meta name="rss" content="Dochistory.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=155" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html" /><meta name="keywords" content="Amazon Redshift,AWS Redshift,Redshift,Redshift Spectrum,cluster,data warehouse,developer,sample data,database,database developer,HLL" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon Redshift",
        "item" : "https://docs.aws.amazon.com/redshift/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Database Developer Guide",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "SQL reference",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/cm_chap_SQLCommandRef.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "SQL commands",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/c_SQL_commands.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "CREATE EXTERNAL FUNCTION",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/c_SQL_commands.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/redshift/latest/dg/redshift-dg.pdf#r_CREATE_EXTERNAL_FUNCTION" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/redshift/index.html">Amazon Redshift</a><a href="welcome.html">Database Developer Guide</a></div><div id="page-toc-src"><a href="#r_CREATE_EXTERNAL_FUNCTION-privileges">Required privileges</a><a href="#r_CREATE_EXTERNAL_FUNCTION-synopsis">Syntax</a><a href="#r_CREATE_EXTERNAL_FUNCTION-parameters">Parameters</a><a href="#r_CREATE_FUNCTION-usage-notes">Usage notes</a><a href="#r_CREATE_FUNCTION-examples">Examples</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="r_CREATE_EXTERNAL_FUNCTION">CREATE EXTERNAL FUNCTION</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Creates a scalar user-defined function (UDF) based on AWS Lambda for Amazon Redshift. For more information about Lambda user-defined functions, see <a href="./udf-creating-a-lambda-sql-udf.html">Creating a scalar Lambda UDF</a>.</p>
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-privileges">Required privileges</h2>
         <p>Following are required privileges for CREATE EXTERNAL FUNCTION:</p>
         <div class="itemizedlist">
             
             
         <ul class="itemizedlist"><li class="listitem"><p>Superuser</p></li><li class="listitem"><p>Users with the CREATE [ OR REPLACE ] EXTERNAL FUNCTION privilege</p></li></ul></div>
       
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-synopsis">Syntax</h2>

         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">CREATE [ OR REPLACE ] EXTERNAL FUNCTION <em>external_fn_name</em> ( [<em>data_type</em>] [, ...] )
RETURNS <em>data_type</em>
<span>{</span> VOLATILE | STABLE }
LAMBDA <em>'lambda_fn_name'</em>
IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS account-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’
RETRY_TIMEOUT <em>milliseconds</em>
MAX_BATCH_ROWS count
MAX_BATCH_SIZE size [ KB | MB ];</code></pre>

         
         
         <p>The following is the syntax for machine learning on Amazon Redshift. For information about the model-specific parameters, see <a href="./r_GRANT.html#r_GRANT-parameters">Parameters</a>.</p>
         <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">CREATE [ OR REPLACE ] EXTERNAL FUNCTION <em>external_fn_name</em> ( [<em>data_type</em>] [, ...] )
RETURNS <em>data_type</em>
<span>{</span> VOLATILE | STABLE }
SAGEMAKER<em>'endpoint_name'</em>
IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS account-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’ };</code></pre>


       
         <h2 id="r_CREATE_EXTERNAL_FUNCTION-parameters">Parameters</h2>


         <div class="variablelist">
             
             
             
             
            
             
          

             
            
         

             

             
             
          
         <dl>
               <dt><span class="term">OR REPLACE</span></dt>
               <dd>
                  <p>A clause that specifies that if a function with the same name and input
                     argument data types, or <em>signature</em>, as this one already
                     exists, the existing function is replaced. You can only replace a function with
                     a new function that defines an identical set of data types. You must be a
                     superuser to replace a function.</p>
                  <p>If you define a function with the same name as an existing function but a
                     different signature, you create a new function. In other words, the function
                     name is overloaded. For more information, see <a href="./udf-naming-udfs.html#udf-naming-overloading-function-names">Overloading function
               names</a>.</p>
               </dd>
             
               <dt><span class="term"><em>external_fn_name</em></span></dt>
               <dd>
                  <p>The name of the external function. If you specify a schema name (such as
                     myschema.myfunction), the function is created using the specified schema.
                     Otherwise, the function is created in the current schema. For more information
                     about valid names, see <a href="./r_names.html">Names and identifiers</a>. </p>
                  <p>We recommend that you prefix all UDF names with <code class="code">f_</code>. Amazon Redshift reserves the <code class="code">f_</code> prefix for UDF names. By using the
                        <code class="code">f_</code> prefix, you help ensure that your UDF name won't
                     conflict with any built-in SQL function names for Amazon Redshift now or in the
                     future. For more information, see <a href="./udf-naming-udfs.html">Naming UDFs</a>.</p>
               </dd>
             
               <dt><span class="term"><em>data_type</em></span></dt>
               <dd>
                  <p>The data type for the input arguments. For more information, see <a href="./c_Supported_data_types.html">Data types</a>.</p>
               </dd>
             
               <dt><span class="term">RETURNS <em>data_type</em></span></dt>
               <dd>
                  <p>The data type of the value returned by the function. The RETURNS data type
                     can be any standard Amazon Redshift data type. For more information, see <a href="./udf-data-types.html">Python UDF data types</a>.</p>
               </dd>
             
               <dt><span class="term">VOLATILE | STABLE</span></dt>
               <dd>
                  <p>Informs the query optimizer about the volatility of the function. </p>
                  <p>To get the best optimization, label your function with the strictest
                     volatility category that is valid for it. In order of strictness, beginning with the least strict,
                     the volatility categories are as follows:</p>
                  <div class="itemizedlist">
                       
                      
                  <ul class="itemizedlist"><li class="listitem">
                        <p>VOLATILE</p>
                     </li><li class="listitem">
                        <p>STABLE</p>
                     </li></ul></div>
                  <p>VOLATILE</p>
                  <p>Given the same arguments, the function can return different results 
                     on successive calls, even for the rows in a single statement. The query optimizer cannot make assumptions about the behavior 
                     of a volatile function. A query that uses a volatile function 
                     must reevaluate the function for every input.</p>
                  <p>STABLE</p>
                  <p>Given the same arguments, the function is guaranteed to return the same
                     results on successive calls processed within a single statement. The function can
                     return different results when called in different statements. This category
                     makes it so the optimizer can reduce the number of times the function is called within a single
                     statement.</p>
                  <p>Note that if the chosen strictness is not valid for the 
                     function, there is a risk that the optimizer might skip some 
                     calls based on this strictness. This can result in an incorrect result set.</p>
                  <p>The IMMUTABLE clause isn't currently supported for Lambda UDFs.</p>
                  

               </dd>
             
               <dt><span class="term">LAMBDA <em>'lambda_fn_name'</em>
               </span></dt>
               <dd>
                  <p> The name of the function that Amazon Redshift calls.</p>
                  <p>For steps to create an AWS Lambda function, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html">Create a Lambda function with the console</a> in the <em>AWS Lambda Developer Guide</em>.</p>
                 <p>For information regarding permissions required for the Lambda function, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-permissions.html">AWS Lambda permissions</a> in the <em>AWS Lambda Developer Guide</em>.</p>

               </dd>
             
               <dt><span class="term">IAM_ROLE <span>{</span> default | ‘arn:aws:iam::<code class="replaceable">&lt;AWS account-id&gt;</code>:role/<code class="replaceable">&lt;role-name&gt;</code>’
               </span></dt>
               <dd>
                  <p>Use the default keyword to have Amazon Redshift use the IAM role that is
                     set as default and associated with the cluster when the CREATE EXTERNAL
                     FUNCTION command runs.</p>
                  <p>Use the Amazon Resource Name (ARN) for an IAM role that your cluster uses
                     for authentication and authorization. The CREATE EXTERNAL FUNCTION command is
                     authorized to invoke Lambda functions through this IAM role. If your cluster has
                     an existing IAM role with permissions to invoke Lambda functions attached, you
                     can substitute your role's ARN. For more information, see <a href="./udf-creating-a-lambda-sql-udf.html#udf-lambda-authorization">Configuring the authorization parameter for
               Lambda UDFs</a>.</p>
                  <p>The following shows the syntax for the IAM_ROLE parameter.</p>
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">IAM_ROLE 'arn:aws:iam::<em>aws-account-id</em>:role/<em>role-name</em>'</code></pre>
               </dd>
             
               <dt><span class="term">RETRY_TIMEOUT <em>milliseconds</em>
               </span></dt>
               <dd>
                  <p>The amount of total time in milliseconds that Amazon Redshift uses for the delays
                     in retry backoffs. </p>
                  <p>Instead of retrying immediately for any failed queries, Amazon Redshift performs
                     backoffs and waits for a certain amount of time between retries. Then Amazon Redshift
                     retries the request to rerun the failed query until the sum of all the delays
                     is equal to or exceeds the RETRY_TIMEOUT value that you specified. The default
                     value is 20,000 milliseconds.</p>
                  <p>When a Lambda function is invoked, Amazon Redshift retries for queries that receive
                     errors such as <code class="code">TooManyRequestsException</code>,
                        <code class="code">EC2ThrottledException</code>, and <code class="code">ServiceException</code>. </p>
                  <p>You can set the RETRY_TIMEOUT parameter to 0 milliseconds to prevent any
                     retries for a Lambda UDF.</p>
               </dd>
             
               <dt><span class="term">MAX_BATCH_ROWS <em>count</em></span></dt>
               <dd>
                  <p>
                     The maximum number of rows that Amazon Redshift sends in a single batch request for a single lambda invocation.
                  </p>
                  <p>
                     This parameter's minimum value is 1. The maximum value is INT_MAX, or 2,147,483,647.
                  </p>
                  <p>
                     This parameter is optional. The default value is INT_MAX, or 2,147,483,647.
                  </p>
               </dd>
             
            <dt><span class="term">MAX_BATCH_SIZE <em>size</em> [ KB | MB ] </span></dt>
            <dd>
               <p>
                  The maximum size of the data payload that Amazon Redshift sends in a single batch request for a single lambda invocation.
               </p>
               <p>
                  This parameter's minimum value is 1 KB. The maximum value is 5 MB.
               </p>
               <p>
                  This parameter's default value is 5 MB.
               </p>
               <p>
                  KB and MB are optional. If you don't set the unit of measurement, Amazon Redshift defaults to using KB.
               </p>
            </dd>
         </dl></div>
       
         <h2 id="r_CREATE_FUNCTION-usage-notes">Usage notes</h2>
         <p>Consider the following when you create Lambda UDFs:
         </p>
         <div class="itemizedlist">
             
             
         <ul class="itemizedlist"><li class="listitem"><p>The order of Lambda function calls on the input arguments isn't fixed or guaranteed. It might vary between instances of running queries, 
               depending on the cluster configuration.</p></li><li class="listitem"><p>The functions are not guaranteed to be applied to each input argument once and only once. The interaction between Amazon Redshift and AWS Lambda might 
               lead to repetitive calls with the same inputs.</p></li></ul></div>
       
         <h2 id="r_CREATE_FUNCTION-examples">Examples</h2>
         <p>Following are examples of using scalar Lambda user-defined functions (UDFs).</p>
          
            <h3 id="r_CREATE_FUNCTION-lambda-example-node">Scalar Lambda UDF example
                  using a Node.js Lambda function</h3>
            <p>The following example creates an external function called
                  <code class="code">exfunc_sum</code> that takes two integers as input arguments. This
               function returns the sum as an integer output. The name of the Lambda function to be
               called is <code class="code">lambda_sum</code>. The language used for this Lambda function
               is Node.js 12.x. Make sure to specify the IAM role.
               The example uses <code class="code">'arn:aws:iam::123456789012:user/johndoe'</code> as the IAM role.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE EXTERNAL FUNCTION exfunc_sum(INT,INT)
RETURNS INT
VOLATILE
LAMBDA 'lambda_sum'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test';</code></pre>
            <p>The Lambda function takes in the request payload and iterates over each row. All
               the values in a single row are added to calculate the sum for that row, which is
               saved in the response array. The number of rows in the results array is similar to
               the number of rows received in the request payload. </p>
            <p>The JSON response payload must have the result data in the 'results'
               field for it to be recognized by the external function. The arguments field in the
               request sent to the Lambda function contains the data payload. There can be multiple
               rows in the data payload in case of a batch request. The following Lambda function
               iterates over all the rows in the request data payload. It also individually iterates
               over all the values within a single row.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">exports.handler = async (event) =&gt; <span>{</span>
    // The 'arguments' field in the request sent to the Lambda function contains the data payload.
    var t1 = event['arguments'];

    // 'len(t1)' represents the number of rows in the request payload.
    // The number of results in the response payload should be the same as the number of rows received.
    const resp = new Array(t1.length);

    // Iterating over all the rows in the request payload.
    for (const [i, x] of t1.entries())
    <span>{</span>
        var sum = 0;
        // Iterating over all the values in a single row.
        for (const y of x) <span>{</span>
            sum = sum + y;
        }
        resp[i] = sum;
    }
    // The 'results' field should contain the results of the lambda call.
    const response = <span>{</span>
        results: resp
    };
    return JSON.stringify(response);
};</code></pre>
            <p>The following example calls the external function with literal values.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_sum(1,2);
exfunc_sum
------------
 3
(1 row)</code></pre>
            <p>The following example creates a table called t_sum with two columns, c1 and c2, of
               the integer data type and inserts two rows of data. Then the external function is
               called by passing the column names of this table. The two table rows are sent in a
               batch request in request payload as a single Lambda invocation.</p>
            
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE TABLE t_sum(c1 int, c2 int);
INSERT INTO t_sum VALUES (4,5), (6,7);
SELECT exfunc_sum(c1,c2) FROM t_sum;
 exfunc_sum
---------------
 9
 13
(2 rows)</code></pre>
          

         
          
            <h3 id="r_CREATE_FUNCTION-lambda-example-retry">Scalar Lambda UDF example
                  using the RETRY_TIMEOUT attribute</h3>
            <p>In the following section, you can find an example of how to use the RETRY_TIMEOUT
               attribute in Lambda UDFs. </p>
            <p>AWS Lambda functions have concurrency limits that you can set for each function.
               For more information on concurrency limits, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html">Managing concurrency for a Lambda function</a> in
               the <em>AWS Lambda Developer Guide</em> and the
               post <a href="https://aws.amazon.com/blogs/compute/managing-aws-lambda-function-concurrency" rel="noopener noreferrer" target="_blank"><span>Managing AWS Lambda Function Concurrency</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the AWS Compute Blog. </p>
            <p>When the number of requests being served by a Lambda UDF exceeds the concurrency
               limits, the new requests receive the <code class="code">TooManyRequestsException</code> error. The
               Lambda UDF retries on this error until the sum of all the delays between the requests
               sent to the Lambda function is equal to or exceeds the RETRY_TIMEOUT value that you
               set. The default RETRY_TIMEOUT value is 20,000 milliseconds.</p>
              <p>The following example uses a Lambda function named <code class="code">exfunc_sleep_3</code>.
               This function takes in the request payload, iterates over each row, and converts the
               input to uppercase. It then sleeps for 3 seconds and returns the result. The language
               used for this Lambda function is Python 3.8. </p>
            <p>The number of rows in the results array is similar to the number of rows received
               in the request payload. The JSON response payload must have the result data in the
                  <code class="code">results</code> field for it to be recognized by the external function. The
                  <code class="code">arguments</code> field in the request sent to the Lambda function contains
               the data payload. In the case of a batch request, multiple rows can appear in the
               data payload.</p>
              <p>The concurrency limit for this function is specifically set to 1 in reserved
               concurrency to demonstrate the use of the RETRY_TIMEOUT attribute. When the attribute
               is set to 1, the Lambda function can only serve one request at a time.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">import json
import time
def lambda_handler(event, context):
    t1 = event['arguments']
    # 'len(t1)' represents the number of rows in the request payload.
    # The number of results in the response payload should be the same as the number of rows received.
    resp = [None]*len(t1)

    # Iterating over all rows in the request payload.
    for i, x in enumerate(t1):
        # Iterating over all the values in a single row.
        for j, y in enumerate(x):
            resp[i] = y.upper()

    time.sleep(3)
    ret = dict()
    ret['results'] = resp
    ret_json = json.dumps(ret)
    return ret_json</code></pre>
            <p>Following, two additional examples illustrate the RETRY_TIMEOUT attribute. They
               each invoke a single Lambda UDF. While invoking the Lambda UDF, each example runs the
               same SQL query to invoke the Lambda UDF from two concurrent database sessions at the
               same time. When first query that invokes the Lambda UDF is being served by the UDF,
               the second query receives the <code class="code">TooManyRequestsException</code> error. This
               result occurs because you specifically set the reserved concurrency in the UDF to 1.
               For information on how to set reserved concurrency for Lambda functions, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html#configuration-concurrency-reservedconfiguration-concurrency-reserved">Configuring reserved concurrency</a>.</p>


            

            <p>The first example, following, sets the RETRY_TIMEOUT attribute for the Lambda UDF
               to 0 milliseconds. If the Lambda request receives any exceptions from the Lambda
               function, Amazon Redshift doesn't make any retries. This result occurs because the
               RETRY_TIMEOUT attribute is set to 0.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE OR REPLACE EXTERNAL FUNCTION exfunc_upper(varchar)
RETURNS varchar
VOLATILE
LAMBDA 'exfunc_sleep_3'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'
RETRY_TIMEOUT 0;</code></pre>
            <p>With the RETRY_TIMEOUT set to 0, you can run the following two queries from
                     separate database sessions to see different results.</p>
            <p>The first SQL query that uses the Lambda UDF runs successfully.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
 --------------
 VARCHAR
(1 row)</code></pre>
            <p>The second query, which is run from a separate database session at the same time,
               receives the <code class="code">TooManyRequestsException</code> error.</p>
                  
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
ERROR:  Rate Exceeded.; Exception: TooManyRequestsException; ShouldRetry: 1
DETAIL:
-----------------------------------------------
error:  Rate Exceeded.; Exception: TooManyRequestsException; ShouldRetry: 1
code:      32103
context:query:     0
location:  exfunc_client.cpp:102
process:   padbmaster [pid=26384]
-----------------------------------------------</code></pre>

                  <p>The second example, following, sets the RETRY_TIMEOUT attribute for the
               Lambda UDF to 3,000 milliseconds. Even if the second query is run concurrently, the
               Lambda UDF retries until the total delays is 3,000 milliseconds. Thus, both queries
               run successfully.</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE OR REPLACE EXTERNAL FUNCTION exfunc_upper(varchar)
RETURNS varchar
VOLATILE
LAMBDA 'exfunc_sleep_3'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'
RETRY_TIMEOUT 3000;</code></pre>
                  <p>With the RETRY_TIMEOUT set to 3,000 milliseconds, you can run the following
                     two queries from separate database sessions to see the same results.</p>
                  <p>The first SQL query that runs the Lambda UDF runs successfully.</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
 --------------
 VARCHAR
(1 row)</code></pre>
                  <p>The second query runs concurrently, and the Lambda UDF retries until the
               total delay is 3,000 milliseconds.</p>
                  
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select exfunc_upper('Varchar');
 exfunc_upper
--------------
 VARCHAR
(1 row)</code></pre>

          

          
            <h3 id="r_CREATE_FUNCTION-lambda-example-python">Scalar Lambda UDF example
                  using a Python Lambda function</h3>
            <p>The following example creates an external function that is named
                  <code class="code">exfunc_multiplication</code> and that multiplies numbers and returns an
               integer. This example incorporates the success and <code class="code">error_msg</code> fields in
               the Lambda response. The success field is set to false when there is an integer
               overflow in the multiplication result, and the <code class="code">error_msg</code> message is set
               to <code class="code">Integer multiplication overflow</code>. The
                  <code class="code">exfunc_multiplication</code> function takes three integers as input
               arguments and returns the sum as an integer output. </p>
            <p>The name of the Lambda function that is called is
                  <code class="code">lambda_multiplication</code>. The language used for this Lambda function is
               Python 3.8. Make sure to specify the IAM role.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE EXTERNAL FUNCTION exfunc_multiplication(int, int, int)
RETURNS INT
VOLATILE
LAMBDA 'lambda_multiplication'
IAM_ROLE 'arn:aws:iam::123456789012:role/Redshift-Exfunc-Test'; </code></pre>
            <p>The Lambda function takes in the request payload and iterates over each row. All
               the values in a single row are multiplied to calculate the result for that row, which
               is saved in the response list. This example uses a Boolean success value that is set
               to true by default. If the multiplication result for a row has an integer overflow,
               then the success value is set to false. Then the iteration loop breaks. </p>
            <p>While creating the response payload, if the success value is false, the following
               Lambda function adds the <code class="code">error_msg</code> field in the payload. It also sets the
               error message to <code class="code">Integer multiplication overflow</code>. If the success value
               is true, then the result data is added in the results field. The number of rows in
               the results array, if any, is similar to the number of rows received in the request
               payload. </p>
            <p>The arguments field in the request sent to the Lambda function contains the data
               payload. There can be multiple rows in the data payload in case of a batch request.
               The following Lambda function iterates over all the rows in the request data payload
               and individually iterates over all the values within a single row. </p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">import json
def lambda_handler(event, context):
    t1 = event['arguments']
    # 'len(t1)' represents the number of rows in the request payload.
    # The number of results in the response payload should be the same as the number of rows received.
    resp = [None]*len(t1)

    # By default success is set to 'True'.
    success = True
    # Iterating over all rows in the request payload.
    for i, x in enumerate(t1):
        mul = 1
        # Iterating over all the values in a single row.
        for j, y in enumerate(x):
            mul = mul*y

        # Check integer overflow.
        if (mul &gt;= 9223372036854775807 or mul &lt;= -9223372036854775808):
            success = False
            break
        else:
            resp[i] = mul
    ret = dict()
    ret['success'] = success
    if not success:
        ret['error_msg'] = "Integer multiplication overflow"
    else:
        ret['results'] = resp
    ret_json = json.dumps(ret)

    return ret_json</code></pre>

            <p>The following example calls the external function with literal values.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">SELECT exfunc_multiplication(8, 9, 2);
  exfunc_multiplication
---------------------------
          144
(1 row)</code></pre>

            <p>The following example creates a table named t_multi with three
               columns, c1, c2, and c3, of the integer data type. The external function is called by
               passing the column names of this table. The data is inserted in such a way to cause
               integer overflow to show how the error is propagated.</p>
            
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">CREATE TABLE t_multi (c1 int, c2 int, c3 int);
INSERT INTO t_multi VALUES (2147483647, 2147483647, 4);
SELECT exfunc_multiplication(c1, c2, c3) FROM t_multi;
DETAIL:
  -----------------------------------------------
  error:  Integer multiplication overflow
  code:      32004context:
  context:
  query:     38
  location:  exfunc_data.cpp:276
  process:   query2_16_38 [pid=30494]
  -----------------------------------------------</code></pre>
          




         
      <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./r_CREATE_DATASHARE.html">CREATE DATASHARE</div><div id="next" class="next-link" accesskey="n" href="./r_CREATE_EXTERNAL_SCHEMA.html">CREATE EXTERNAL SCHEMA</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>