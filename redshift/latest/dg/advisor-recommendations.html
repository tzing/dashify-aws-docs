<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Amazon Redshift Advisor recommendations - Amazon Redshift</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="advisor-recommendations" /><meta name="default_state" content="advisor-recommendations" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/redshift/latest/dg/advisor-recommendations.html" /><meta name="description" content="Amazon Redshift Advisor offers recommendations about how to optimize your Amazon Redshift cluster to increase performance and save on operating costs. You can find explanations for each recommendation in the console, as described preceding. You can find further details on these recommendations in the following sections." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon Redshift" /><meta name="guide" content="Database Developer Guide" /><meta name="abstract" content="Create and manage a data warehouse with Amazon Redshift, an enterprise-level, petabyte scale, fully managed data warehousing service." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/redshift/latest/dg/advisor-recommendations.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/advisor-recommendations.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/redshift/latest/dg/advisor-recommendations.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/advisor-recommendations.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/redshift/latest/dg/advisor-recommendations.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/advisor-recommendations.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/advisor-recommendations.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/advisor-recommendations.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/redshift/latest/dg/advisor-recommendations.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/advisor-recommendations.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/redshift/latest/dg/advisor-recommendations.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/advisor-recommendations.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/redshift/latest/dg/advisor-recommendations.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/advisor-recommendations.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/advisor-recommendations.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/advisor-recommendations.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/redshift/latest/dg/advisor-recommendations.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/advisor-recommendations.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/redshift/latest/dg/advisor-recommendations.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/advisor-recommendations.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/redshift/latest/dg/advisor-recommendations.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/redshift/latest/dg/advisor-recommendations.html" hreflang="x-default" /><meta name="feedback-item" content="Redshift" /><meta name="this_doc_product" content="Amazon Redshift" /><meta name="this_doc_guide" content="Database Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'redshift'}"></script><meta id="panorama-serviceSubSection" value="Database Developer Guide" /><meta id="panorama-serviceConsolePage" value="Amazon Redshift Advisor recommendations" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Amazon Redshift Advisor recommendations - Amazon Redshift</title><meta name="pdf" content="/pdfs/redshift/latest/dg/redshift-dg.pdf#advisor-recommendations" /><meta name="rss" content="Dochistory.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=155" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/advisor-recommendations.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/advisor-recommendations.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/advisor-recommendations.html" /><meta name="keywords" content="Amazon Redshift,AWS Redshift,Redshift,Redshift Spectrum,cluster,data warehouse,developer,sample data,database,database developer,HLL" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon Redshift",
        "item" : "https://docs.aws.amazon.com/redshift/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Database Developer Guide",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Amazon Redshift best practices",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/best-practices.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Working with recommendations from Amazon Redshift Advisor",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/advisor.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Amazon Redshift Advisor recommendations",
        "item" : "https://docs.aws.amazon.com/redshift/latest/dg/advisor.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/redshift/latest/dg/redshift-dg.pdf#advisor-recommendations" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/redshift/index.html">Amazon Redshift</a><a href="welcome.html">Database Developer Guide</a></div><div id="page-toc-src"><a href="#cluster-compress-s3-recommendation">Compress Amazon S3 file objects
                  loaded by COPY</a><a href="#isolate-active-dbs-recommendation">Isolate multiple active
                  databases</a><a href="#reallocate-wlm-recommendation">Reallocate workload management (WLM)
                  memory</a><a href="#skip-compression-analysis-recommendation">Skip compression analysis
                  during COPY</a><a href="#split-s3-objects-recommendation">Split Amazon S3 objects loaded by
                  COPY</a><a href="#update-table-statistics-recommendation">Update table
                  statistics</a><a href="#enable-sqa-recommendation">Enable short query acceleration</a><a href="#alter-diststyle-distkey-recommendation">Alter distribution keys on
                  tables</a><a href="#alter-sortkey-recommendation">Alter sort keys on tables</a><a href="#alter-compression-encoding-recommendation">Alter compression encodings on columns</a><a href="#data-type-recommendation">Data type recommendations</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="advisor-recommendations">Amazon Redshift Advisor recommendations</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Amazon Redshift Advisor offers recommendations about how to optimize your Amazon Redshift cluster to
            increase performance and save on operating costs. You can find explanations for each
            recommendation in the console, as described preceding. You can find further details on
            these recommendations in the following sections. </p><div class="highlights" id="inline-topiclist"><h6>Topics</h6><ul><li><a href="#cluster-compress-s3-recommendation">Compress Amazon S3 file objects
                  loaded by COPY</a></li><li><a href="#isolate-active-dbs-recommendation">Isolate multiple active
                  databases</a></li><li><a href="#reallocate-wlm-recommendation">Reallocate workload management (WLM)
                  memory</a></li><li><a href="#skip-compression-analysis-recommendation">Skip compression analysis
                  during COPY</a></li><li><a href="#split-s3-objects-recommendation">Split Amazon S3 objects loaded by
                  COPY</a></li><li><a href="#update-table-statistics-recommendation">Update table
                  statistics</a></li><li><a href="#enable-sqa-recommendation">Enable short query acceleration</a></li><li><a href="#alter-diststyle-distkey-recommendation">Alter distribution keys on
                  tables</a></li><li><a href="#alter-sortkey-recommendation">Alter sort keys on tables</a></li><li><a href="#alter-compression-encoding-recommendation">Alter compression encodings on columns</a></li><li><a href="#data-type-recommendation">Data type recommendations</a></li></ul></div>
            <h2 id="cluster-compress-s3-recommendation">Compress Amazon S3 file objects
                  loaded by COPY</h2>
            <p>The COPY command takes advantage of the massively parallel processing (MPP)
               architecture in Amazon Redshift to read and load data in parallel. It can read files from Amazon S3,
               DynamoDB tables, and text output from one or more remote hosts. </p>
            <p>When loading large amounts of data, we strongly recommend using the COPY command
               to load compressed data files from S3. Compressing large datasets saves time
               uploading the files to Amazon S3. COPY can also speed up the load process by uncompressing
               the files as they are read. </p>
            <p><b>Analysis</b></p>
            <p>Long-running COPY commands that load large uncompressed datasets often have an
               opportunity for considerable performance improvement. The Advisor analysis identifies
               COPY commands that load large uncompressed datasets. In such a case, Advisor
               generates a recommendation to implement compression on the source files in Amazon S3. </p>


            <p><b>Recommendation</b></p>
            <p>Ensure that each COPY that loads a significant amount of data, or runs for a
               significant duration, ingests compressed data objects from Amazon S3. You can identify the
               COPY commands that load large uncompressed datasets from Amazon S3 by running the
               following SQL command as a superuser.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
SELECT
    wq.userid, query, exec_start_time AS starttime, COUNT(*) num_files,
    ROUND(MAX(wq.total_exec_time/1000000.0),2) execution_secs,
    ROUND(SUM(transfer_size)/(1024.0*1024.0),2) total_mb,
    SUBSTRING(querytxt,1,60) copy_sql
FROM stl_s3client s
JOIN stl_query q USING (query)
JOIN stl_wlm_query wq USING (query)
WHERE s.userid&gt;1 AND http_method = 'GET'
    AND POSITION('COPY ANALYZE' IN querytxt) = 0
    AND aborted = 0 AND final_state='Completed'
GROUP BY 1, 2, 3, 7
HAVING SUM(transfer_size) = SUM(data_size) 
AND SUM(transfer_size)/(1024*1024) &gt;= 5
ORDER BY 6 DESC, 5 DESC;         
          </code></pre>
            <p>If the staged data remains in Amazon S3 after you load it, which is common in data lake
               architectures, storing this data in a compressed form can reduce your storage costs. </p>
            <p><b>Implementation tips</b></p>

            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>The ideal object size is 1–128 MB after compression.</p>
               </li><li class="listitem">
                  <p>You can compress files with gzip, lzop, or bzip2 format.</p>
               </li></ul></div>

          
            <h2 id="isolate-active-dbs-recommendation">Isolate multiple active
                  databases</h2>
            <p>As a best practice, we recommend isolating databases in Amazon Redshift from one another.
               Queries run in a specific database and can't access data from any other database on
               the cluster. However, the queries that you run in all databases of a cluster share
               the same underlying cluster storage space and compute resources. When a single
               cluster contains multiple active databases, their workloads are usually
               unrelated.</p>
            <p><b>Analysis</b></p>
            <p>The Advisor analysis reviews all databases on the cluster for active workloads
               running at the same time. If there are active workloads running at the same time,
               Advisor generates a recommendation to consider migrating databases to separate Amazon Redshift
               clusters.</p>

            <p><b>Recommendation</b></p>
            <p>Consider moving each actively queried database to a separate dedicated cluster.
               Using a separate cluster can reduce resource contention and improve query
               performance. It can do so because it allows you to set the size for each cluster for
               the storage, cost, and performance needs of each workload. Also, unrelated workloads
               often benefit from different workload management configurations.</p>
            <p>To identify which databases are actively used, you can run this SQL command as a
               superuser.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
SELECT database,
  COUNT(*) as num_queries,
  AVG(DATEDIFF(sec,starttime,endtime)) avg_duration,
  MIN(starttime) as oldest_ts,
  MAX(endtime) as latest_ts
FROM stl_query
WHERE userid &gt; 1
GROUP BY database;            
         </code></pre>
            <p><b>Implementation tips</b></p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>Because a user must connect to each database specifically, and queries can
                     only access a single database, moving databases to separate clusters has
                     minimal impact for users.</p>
               </li><li class="listitem">
                  <p>One option to move a database is to take the following steps: </p>
                  <div class="orderedlist">
                      
                      
                      
                  <ol><li>
                        <p>Temporarily restore a snapshot of the current cluster to a cluster of
                           the same size.</p>
                     </li><li>
                        <p>Delete all databases from the new cluster except the target database
                           to be moved.</p>
                     </li><li>
                        <p>Resize the cluster to an appropriate node type and count for the
                           database's workload.</p>
                     </li></ol></div>

               </li></ul></div>
          
            <h2 id="reallocate-wlm-recommendation">Reallocate workload management (WLM)
                  memory</h2>
            <p>Amazon Redshift routes user queries to <a href="./cm-c-defining-query-queues.html">Implementing manual WLM</a> for processing. Workload management
               (WLM) defines how those queries are routed to the queues. Amazon Redshift allocates each queue a
               portion of the cluster's available memory. A queue's memory is divided among the
               queue's query slots. </p>
            <p>When a queue is configured with more slots than the workload requires, the memory
               allocated to these unused slots goes underutilized. Reducing the configured slots to
               match the peak workload requirements redistributes the underutilized memory to active
               slots, and can result in improved query performance. </p>
            <p><b>Analysis</b></p>
            <p>The Advisor analysis reviews workload concurrency requirements to identify query
               queues with unused slots. Advisor generates a recommendation to reduce the number of
               slots in a queue when it finds the following:</p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>A queue with slots that are completely inactive throughout the
                     analysis.</p>
               </li><li class="listitem">
                  <p>A queue with more than four slots that had at least two inactive slots
                     throughout the analysis.</p>
               </li></ul></div>

            <p><b>Recommendation</b></p>
            <p>Reducing the configured slots to match peak workload requirements redistributes
               underutilized memory to active slots. Consider reducing the configured slot count for
               queues where the slots have never been fully used. To identify these queues, you can
               compare the peak hourly slot requirements for each queue by running the following SQL
               command as a superuser.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
WITH
 generate_dt_series AS (select sysdate - (n * interval '5 second') as dt from (select row_number() over () as n from stl_scan limit 17280)),
 apex AS (
     SELECT iq.dt, iq.service_class, iq.num_query_tasks, count(iq.slot_count) as service_class_queries, sum(iq.slot_count) as service_class_slots
     FROM
         (select gds.dt, wq.service_class, wscc.num_query_tasks, wq.slot_count
         FROM stl_wlm_query wq
         JOIN stv_wlm_service_class_config wscc ON (wscc.service_class = wq.service_class AND wscc.service_class &gt; 5)
         JOIN generate_dt_series gds ON (wq.service_class_start_time &lt;= gds.dt AND wq.service_class_end_time &gt; gds.dt)
         WHERE wq.userid &gt; 1 AND wq.service_class &gt; 5) iq
     GROUP BY iq.dt, iq.service_class, iq.num_query_tasks),
     maxes as (SELECT apex.service_class, trunc(apex.dt) as d, date_part(h,apex.dt) as dt_h, max(service_class_slots) max_service_class_slots
                     from apex group by apex.service_class, apex.dt, date_part(h,apex.dt))
SELECT apex.service_class - 5 AS queue, apex.service_class, apex.num_query_tasks AS max_wlm_concurrency, maxes.d AS day, maxes.dt_h || ':00 - ' || maxes.dt_h || ':59' as hour, MAX(apex.service_class_slots) as max_service_class_slots
FROM apex
JOIN maxes ON (apex.service_class = maxes.service_class AND apex.service_class_slots = maxes.max_service_class_slots)
GROUP BY  apex.service_class, apex.num_query_tasks, maxes.d, maxes.dt_h
ORDER BY apex.service_class, maxes.d, maxes.dt_h;            
         </code></pre>
            <p>The <code class="code">max_service_class_slots</code> column represents the maximum number of
               WLM query slots in the query queue for that hour. If underutilized queues exist,
               implement the slot reduction optimization by <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/managing-parameter-groups-console.html#parameter-group-modify">modifying a parameter group</a>, as described in the <em>Amazon Redshift Management Guide.</em></p>
            <p><b>Implementation tips</b></p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>If your workload is highly variable in volume, make sure that the analysis
                     captured a peak utilization period. If it didn't, run the preceding SQL
                     repeatedly to monitor peak concurrency requirements. </p>
               </li><li class="listitem">
                  <p>For more details on interpreting the query results from the preceding SQL
                     code, see the <a href="https://github.com/awslabs/amazon-redshift-utils/blob/master/src/AdminScripts/wlm_apex_hourly.sql" rel="noopener noreferrer" target="_blank"><span>wlm_apex_hourly.sql script</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on GitHub.</p>
               </li></ul></div>

          
            <h2 id="skip-compression-analysis-recommendation">Skip compression analysis
                  during COPY</h2>
            <p>When you load data into an empty table with compression encoding declared with the
               COPY command, Amazon Redshift applies storage compression. This optimization ensures that data
               in your cluster is stored efficiently even when loaded by end users. The analysis
               required to apply compression can require significant time.</p>

            <p><b>Analysis</b></p>
            <p>The Advisor analysis checks for COPY operations that were delayed by automatic
               compression analysis. The analysis determines the compression encodings by sampling
               the data while it's being loaded. This sampling is similar to that performed by
               the <a href="./r_ANALYZE_COMPRESSION.html">ANALYZE COMPRESSION</a>
               command. </p>
            <p>When you load data as part of a structured process, such as in an overnight
               extract, transform, load (ETL) batch, you can define the compression beforehand. You
               can also optimize your table definitions to skip this phase permanently without any
               negative impacts.</p>
            <p><b>Recommendation</b></p>
            <p>To improve COPY responsiveness by skipping the compression analysis phase,
               implement either of the following two options:</p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>Use the column <code class="code">ENCODE</code> parameter when creating any tables that
                     you load using the COPY command.</p>
               </li><li class="listitem">
                  <p>Turn off compression altogether by supplying the <code class="code">COMPUPDATE OFF</code>
                     parameter in the COPY command.</p>
               </li></ul></div>
            <p>The best solution is generally to use column encoding during table creation,
               because this approach also maintains the benefit of storing compressed data on disk.
               You can use the ANALYZE COMPRESSION command to suggest compression encodings, but you
               must recreate the table to apply these encodings. To automate this process, you can
               use the AWS<a href="https://github.com/awslabs/amazon-redshift-utils/tree/master/src/ColumnEncodingUtility" rel="noopener noreferrer" target="_blank"><span>ColumnEncodingUtility</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, found on GitHub. </p>
            <p>To identify recent COPY operations that triggered automatic compression analysis,
               run the following SQL command.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
  WITH xids AS (
    SELECT xid FROM stl_query WHERE userid&gt;1 AND aborted=0 
    AND querytxt = 'analyze compression phase 1' GROUP BY xid
    INTERSECT SELECT xid FROM stl_commit_stats WHERE node=-1)
SELECT a.userid, a.query, a.xid, a.starttime, b.complyze_sec, 
    a.copy_sec, a.copy_sql
FROM (SELECT q.userid, q.query, q.xid, date_trunc('s',q.starttime) 
    starttime, substring(querytxt,1,100) as copy_sql, 
    ROUND(datediff(ms,starttime,endtime)::numeric / 1000.0, 2) copy_sec
    FROM stl_query q JOIN xids USING (xid)
    WHERE (querytxt ilike 'copy %from%' OR querytxt ilike '% copy %from%') 
    AND querytxt not like 'COPY ANALYZE %') a
LEFT JOIN (SELECT xid, 
    ROUND(sum(datediff(ms,starttime,endtime))::numeric / 1000.0,2) complyze_sec 
    FROM stl_query q JOIN xids USING (xid)
    WHERE (querytxt like 'COPY ANALYZE %' 
    OR querytxt like 'analyze compression phase %') 
    GROUP BY xid ) b ON a.xid = b.xid
WHERE b.complyze_sec IS NOT NULL ORDER BY a.copy_sql, a.starttime;
         </code></pre>
            <p><b>Implementation tips</b></p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>Ensure that all tables of significant size created during your ETL processes
                     (for example, staging tables and temporary tables) declare a compression
                     encoding for all columns except the first sort key.</p>
               </li><li class="listitem">
                  <p>Estimate the expected lifetime size of the table being loaded for each of
                     the COPY commands identified by the SQL command preceding. If you are confident
                     that the table will remain extremely small, turn off compression altogether with
                     the <code class="code">COMPUPDATE OFF</code> parameter. Otherwise, create the table with
                     explicit compression before loading it with the COPY command.</p>
               </li></ul></div>
          
            <h2 id="split-s3-objects-recommendation">Split Amazon S3 objects loaded by
                  COPY</h2>
            <p>The COPY command takes advantage of the massively parallel processing (MPP)
               architecture in Amazon Redshift to read and load data from files on Amazon S3. The COPY command loads
               the data in parallel from multiple files, dividing the workload among the nodes in
               your cluster. To achieve optimal throughput, we strongly recommend that you divide
               your data into multiple files to take advantage of parallel processing. </p>
            <p><b>Analysis</b></p>
            <p>The Advisor analysis identifies COPY commands that load large datasets contained
               in a small number of files staged in Amazon S3. Long-running COPY commands that load large
               datasets from a few files often have an opportunity for considerable performance
               improvement. When Advisor identifies that these COPY commands are taking a
               significant amount of time, it creates a recommendation to increase parallelism by
               splitting the data into additional files in Amazon S3. </p>
            <p><b>Recommendation</b></p>
            <p>In this case, we recommend the following actions, listed in priority order:</p>
            <div class="orderedlist">
                
                
                
            <ol><li>
                  <p>Optimize COPY commands that load fewer files than the number of cluster
                     nodes.</p>
               </li><li>
                  <p>Optimize COPY commands that load fewer files than the number of cluster
                     slices. </p>
               </li><li>
                  <p>Optimize COPY commands where the number of files is not a multiple of the
                     number of cluster slices.</p>
               </li></ol></div>
            <p>Certain COPY commands load a significant amount of data or run for a significant
               duration. For these commands, we recommend that you load a number of data objects
               from Amazon S3 that is equivalent to a multiple of the number of slices in the cluster. To
               identify how many S3 objects each COPY command has loaded, run the following SQL code
               as a superuser. </p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
SELECT
    query, COUNT(*) num_files,
    ROUND(MAX(wq.total_exec_time/1000000.0),2) execution_secs,
    ROUND(SUM(transfer_size)/(1024.0*1024.0),2) total_mb,
    SUBSTRING(querytxt,1,60) copy_sql
FROM stl_s3client s
JOIN stl_query q USING (query)
JOIN stl_wlm_query wq USING (query)
WHERE s.userid&gt;1 AND http_method = 'GET'
    AND POSITION('COPY ANALYZE' IN querytxt) = 0
    AND aborted = 0 AND final_state='Completed'
GROUP BY query, querytxt
HAVING (SUM(transfer_size)/(1024*1024))/COUNT(*) &gt;= 2
ORDER BY CASE
WHEN COUNT(*) &lt; (SELECT max(node)+1 FROM stv_slices) THEN 1
WHEN COUNT(*) &lt; (SELECT COUNT(*) FROM stv_slices WHERE node=0) THEN 2
ELSE 2+((COUNT(*) % (SELECT COUNT(*) FROM stv_slices))/(SELECT COUNT(*)::DECIMAL FROM stv_slices))
END, (SUM(transfer_size)/(1024.0*1024.0))/COUNT(*) DESC;   
            
         </code></pre>
            <p><b>Implementation tips</b></p>
            <div class="itemizedlist">
                
                
                
            <ul class="itemizedlist"><li class="listitem">
                  <p>The number of slices in a node depends on the node size of the cluster. For
                     more information about the number of slices in the various node types, see
                        <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-clusters.html#rs-about-clusters-and-nodes">Clusters and Nodes in Amazon Redshift</a> in the <em>Amazon Redshift Management Guide.</em>
                  </p>
               </li><li class="listitem">
                  <p>You can load multiple files by specifying a common prefix, or prefix key,
                     for the set, or by explicitly listing the files in a manifest file. For more
                     information about loading files, see <a href="./t_splitting-data-files.html">Loading data from compressed and uncompressed files</a>.</p>
               </li><li class="listitem">
                  <p>Amazon Redshift doesn't take file size into account when dividing the workload.
                     Split your load data files so that the files are about equal size, between 1 MB
                     and 1 GB after compression. </p>
               </li></ul></div>
          
            <h2 id="update-table-statistics-recommendation">Update table
                  statistics</h2>
            <p>Amazon Redshift uses a cost-based query optimizer to choose the optimum execution plan for
               queries. The cost estimates are based on table statistics gathered using the ANALYZE
               command. When statistics are out of date or missing, the database might choose a less
               efficient plan for query execution, especially for complex queries. Maintaining
               current statistics helps complex queries run in the shortest possible time. </p>
            <p><b>Analysis</b></p>
            <p>The Advisor analysis tracks tables whose statistics are out-of-date or missing. It
               reviews table access metadata associated with complex queries. If tables that are
               frequently accessed with complex patterns are missing statistics, Advisor creates a
                  <b>critical</b> recommendation to run ANALYZE. If tables
               that are frequently accessed with complex patterns have out-of-date statistics,
               Advisor creates a <b>suggested</b> recommendation to run
               ANALYZE.</p>

            <p><b>Recommendation</b></p>
            <p>Whenever table content changes significantly, update statistics with ANALYZE. We
               recommend running ANALYZE whenever a significant number of new data rows are loaded
               into an existing table with COPY or INSERT commands. We also recommend running
               ANALYZE whenever a significant number of rows are modified using UPDATE or DELETE
               commands. To identify tables with missing or out-of-date statistics, run the
               following SQL command as a superuser. The results are ordered from largest to
               smallest table. </p>
            <p>To identify tables with missing or out-of-date statistics, run the following SQL
               command as a superuser. The results are ordered from largest to smallest
               table.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">
SELECT
   ti.schema||'.'||ti."table" tablename,
   ti.size table_size_mb,
   ti.stats_off statistics_accuracy
 FROM svv_table_info ti
 WHERE ti.stats_off &gt; 5.00
 ORDER BY ti.size DESC;          
         </code></pre>
            <p><b>Implementation tips</b></p>
            
                  <p>The default ANALYZE threshold is 10 percent. This default means that the
                     ANALYZE command skips a given table if fewer than 10 percent of the table's rows have
               changed since the last ANALYZE. As a result, you might choose to issue ANALYZE
               commands at the end of each ETL process. Taking this approach means that ANALYZE is
               often skipped but also ensures that ANALYZE runs when needed.</p>
              
                  <p>ANALYZE statistics have the most impact for columns that are used in joins
                     (for example, <code class="code">JOIN tbl_a ON col_b</code>) or as predicates (for example,
                        <code class="code">WHERE col_b = 'xyz'</code>). By default, ANALYZE collects statistics
                     for all columns in the table specified. If needed, you can reduce the time
                     required to run ANALYZE by running ANALYZE only for the columns where it has
                     the most impact. You can run the following SQL command to identify columns used
                     as predicates. You can also let Amazon Redshift choose which columns to analyze by
                     specifying <code class="code">ANALYZE PREDICATE COLUMNS</code>. </p>
                  <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">WITH predicate_column_info as (
SELECT ns.nspname AS schema_name, c.relname AS table_name, a.attnum as col_num,  a.attname as col_name,
        CASE
            WHEN 10002 = s.stakind1 THEN array_to_string(stavalues1, '||') 
            WHEN 10002 = s.stakind2 THEN array_to_string(stavalues2, '||')
            WHEN 10002 = s.stakind3 THEN array_to_string(stavalues3, '||')
            WHEN 10002 = s.stakind4 THEN array_to_string(stavalues4, '||')
            ELSE NULL::varchar
        END AS pred_ts
   FROM pg_statistic s
   JOIN pg_class c ON c.oid = s.starelid
   JOIN pg_namespace ns ON c.relnamespace = ns.oid
   JOIN pg_attribute a ON c.oid = a.attrelid AND a.attnum = s.staattnum)
SELECT schema_name, table_name, col_num, col_name,
       pred_ts NOT LIKE '2000-01-01%' AS is_predicate,
       CASE WHEN pred_ts NOT LIKE '2000-01-01%' THEN (split_part(pred_ts, '||',1))::timestamp ELSE NULL::timestamp END as first_predicate_use,
       CASE WHEN pred_ts NOT LIKE '%||2000-01-01%' THEN (split_part(pred_ts, '||',2))::timestamp ELSE NULL::timestamp END as last_analyze
FROM predicate_column_info;</code></pre>
            <p>For more information, see <a href="./t_Analyzing_tables.html">Analyzing tables</a>.</p>
          
            <h2 id="enable-sqa-recommendation">Enable short query acceleration</h2>
            <p>Short query acceleration (SQA) prioritizes selected short-running queries ahead of
               longer-running queries. SQA runs short-running queries in a dedicated space, so
               that SQA queries aren't forced to wait in queues behind longer queries. SQA only
               prioritizes queries that are short-running and are in a user-defined queue. With SQA,
               short-running queries begin running more quickly and users see results sooner. </p>
            <p>If you turn on SQA, you can reduce or eliminate workload management (WLM) queues
               that are dedicated to running short queries. In addition, long-running queries
               don't need to contend with short queries for slots in a queue, so you can
               configure your WLM queues to use fewer query slots. When you use lower concurrency,
               query throughput is increased and overall system performance is improved for most
               workloads. For more information, see <a href="./wlm-short-query-acceleration.html">Working with short query
            acceleration</a>. </p>
            <p><b>Analysis</b></p>
            <p>Advisor checks for workload patterns and reports the number of recent queries
               where SQA would reduce latency and the daily queue time for SQA-eligible
               queries.</p>
            <p><b>Recommendation</b></p>
            <p>Modify the WLM configuration to turn on SQA. Amazon Redshift uses a machine learning
               algorithm to analyze each eligible query. Predictions improve as SQA learns from your
               query patterns. For more information, see <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/workload-mgmt-config.html">Configuring Workload
                  Management</a>. </p>
            <p>When you turn on SQA, WLM sets the maximum runtime for short queries to dynamic by
               default. We recommend keeping the dynamic setting for SQA maximum runtime. </p>
            <p><b>Implementation tips</b></p>
            <p>To check whether SQA is turned on, run the following query. If the query returns a
               row, then SQA is turned on.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">select * from stv_wlm_service_class_config 
where service_class = 14;</code></pre>
            <p>For more information, see <a href="./wlm-short-query-acceleration.html#wlm-monitoring-sqa">Monitoring SQA</a>. </p>
          
            <h2 id="alter-diststyle-distkey-recommendation">Alter distribution keys on
                  tables</h2>
            <p>Amazon Redshift distributes table rows throughout the cluster according to the table
               distribution style. Tables with KEY distribution require a column as the distribution
               key (DISTKEY). A table row is assigned to a node slice of a cluster based on its DISTKEY
               column value. </p>
            <p>An appropriate DISTKEY places a similar number of rows on each node slice and is frequently referenced in join conditions. 
               An optimized join occurs when tables are joined on their DISTKEY columns, accelerating query performance.</p>
            
            <p><b>Analysis</b></p>
            <p>Advisor analyzes your cluster’s workload to identify the most appropriate
               distribution key for the tables that can significantly benefit from a KEY
               distribution style. </p>
            
            <p><b>Recommendation</b></p>
            <p>Advisor provides <a href="./r_ALTER_TABLE.html">ALTER TABLE</a>
               statements that alter the DISTSTYLE and DISTKEY of a table based on its analysis. To
               realize a significant performance benefit, make sure to implement all SQL statements
               within a recommendation group. </p>
            <p>Redistributing a large table with ALTER TABLE consumes cluster resources and
               requires temporary table locks at various times. Implement each recommendation group
               when other cluster workload is light. For more details on optimizing table
               distribution properties, see the <a href="https://aws.amazon.com/blogs/big-data/amazon-redshift-engineerings-advanced-table-design-playbook-distribution-styles-and-distribution-keys/" rel="noopener noreferrer" target="_blank"><span>Amazon Redshift Engineering's Advanced Table Design Playbook: Distribution Styles and
                  Distribution Keys</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>. </p>        
            <p>For more information about ALTER DISTSYLE and DISTKEY, see  <a href="./r_ALTER_TABLE.html">ALTER TABLE</a>. </p>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you don't see a recommendation that doesn't necessarily mean that
                  the current distribution styles are the most appropriate. Advisor doesn't
                  provide recommendations when there isn't enough data or the expected benefit
                  of redistribution is small. </p><p>Advisor recommendations apply to a particular table and don't necessarily apply
                  to a table that contains a column with the same name. Tables that share a column
                  name can have different characteristics for those columns unless data inside the
                  tables is the same. </p><p>If you see recommendations for staging tables that are created or dropped by ETL jobs, modify 
                  your ETL processes to use the Advisor recommended distribution keys. </p></div></div>

          
            <h2 id="alter-sortkey-recommendation">Alter sort keys on tables</h2>
            <p>Amazon Redshift sorts table rows according to the table <a href="./t_Sorting_data.html">sort
                  key</a>. The sorting of table rows is based on the sort key column values. </p>
            <p>Sorting a table on an appropriate sort key can accelerate performance of queries,
               especially those with range-restricted predicates, by requiring fewer table blocks to
               be read from disk. </p>
            
            <p><b>Analysis</b></p>
            <p>Advisor analyzes your cluster's workload over several days to identify a
               beneficial sort key for your tables. </p>
            
            <p><b>Recommendation</b></p>
            <p>
               Advisor provides two groups of ALTER TABLE
               statements that alter the sort key of a table based on its analysis:
               </p>
            <div class="itemizedlist">
                
                
            <ul class="itemizedlist"><li class="listitem"><p>Statements that alter a table that currently doesn't have a sort key to add a COMPOUND sort
                     key.</p></li><li class="listitem"><p>Statements that alter a sort key from INTERLEAVED to COMPOUND or no sort key.</p>
                  <p>Using compound sort keys significantly reduces maintenance overhead. Tables
                     with compound sort keys don't need the expensive VACUUM REINDEX operations that
                     are necessary for interleaved sorts. In practice, compound sort keys are more
                     effective than interleaved sort keys for the vast majority of Amazon Redshift
                     workloads. However, if a table is small, it's more efficient not to have a sort
                     key to avoid sort key storage overhead.</p></li></ul></div>
            
            <p>When sorting a large table with the ALTER TABLE,  cluster resources are consumed
               and table locks are required at various times. Implement each recommendation when a
               cluster's workload is moderate. More details on optimizing table sort key
               configurations can be found in the <a href="https://aws.amazon.com/blogs/big-data/amazon-redshift-engineerings-advanced-table-design-playbook-compound-and-interleaved-sort-keys/" rel="noopener noreferrer" target="_blank"><span>Amazon Redshift Engineering's Advanced Table Design Playbook: Compound and Interleaved Sort
                  Keys</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>. </p>        
            <p>For more information about ALTER SORTKEY, see  <a href="./r_ALTER_TABLE.html">ALTER TABLE</a>. </p>
            
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you don't see a recommendation for a table, that doesn't necessarily mean that the current
                  configuration is the best. Advisor doesn't provide recommendations when there
                  isn't enough data or the expected benefit of sorting is small. </p><p>Advisor recommendations apply to a particular table and don’t necessarily apply
                  to a table that contains a column with the same name and data type. Tables that
                  share column names can have different recommendations based on the data in
                  the tables and the workload. </p></div></div>
            
          
            <h2 id="alter-compression-encoding-recommendation">Alter compression encodings on columns</h2>
            <p>Compression is a column-level operation that reduces the size of data when it's
               stored. Compression is used in Amazon Redshift to conserve storage space and improve query
               performance by reducing the amount of disk I/O. We recommend an optimal compression
               encoding for each column based on its data type and on query patterns. With optimal
               compression, queries can run more efficiently and the database can take up minimal
               storage space.
            
            </p>
            
            <p><b>Analysis</b></p>
            <p>Advisor performs analysis of your cluster's workload and database schema
               continually to identify the optimal compression encoding for each table
               column.</p>
            
            <p><b>Recommendation</b></p>
            <p>Advisor provides ALTER TABLE statements that change the compression encoding of particular columns, based on its analysis. </p>
            <p>Changing column compression encodings with <a href="./r_ALTER_TABLE.html">ALTER TABLE</a> consumes cluster 
               resources and requires table locks at various times. It's best to implement recommendations when the cluster workload is light.
            </p>
            <p>For reference, <a href="./r_ALTER_TABLE_examples_basic.html">ALTER TABLE examples</a> shows several statements that 
               change the encoding for a column.</p>        
            
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>Advisor doesn't provide recommendations when there
               isn't enough data or the expected benefit of changing the encoding is small.</p></div></div>
            
          
            <h2 id="data-type-recommendation">Data type recommendations</h2>
            <p>Amazon Redshift has a library of SQL data types for various use cases. These include integer 
               types like <code class="code">INT</code> and types to store characters, like <code class="code">VARCHAR</code>. Redshift stores types in an optimized way to provide fast access 
               and good query performance. Also, Redshift provides functions for specific types, which you can use to format or 
               perform calculations on query results.
            </p>
            
            <p><b>Analysis</b></p>
            <p>Advisor performs analysis of your cluster's workload and database schema 
               continually to identify columns that can benefit significantly from a data type change.</p>
            
            <p><b>Recommendation</b></p>
            
            <p>
               Advisor provides an <code class="code">ALTER TABLE</code> statement that adds a new column with the suggested data type.
               An accompanying <code class="code">UPDATE</code> statement copies data from the existing column to the new column. After you 
               create the new column and load the data, change your queries and ingestion scripts to access the new column. Then leverage 
               features and functions specialized to the new data type, found in <a href="./c_SQL_functions.html">SQL functions reference</a>.
            </p>
            <p>
               Copying existing data to the new column can take time. We recommend that you implement each advisor recommendation when the cluster’s workload is light. Reference the list of available data types at <a href="./c_Supported_data_types.html">Data types</a>.
            </p>
            <p>
               Note that Advisor doesn't provide recommendations when there
               isn't enough data or the expected benefit of changing the data type is small.
            </p>        
            
         <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./access-advisor.html">Viewing Advisor recommendations</div><div id="next" class="next-link" accesskey="n" href="./tutorials-redshift.html">Tutorials</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/advisor-recommendations.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Redshift&amp;topic_url=https://docs.aws.amazon.com/en_us/redshift/latest/dg/advisor-recommendations.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>