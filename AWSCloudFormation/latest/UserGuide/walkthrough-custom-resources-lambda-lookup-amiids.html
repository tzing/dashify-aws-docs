<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Walkthrough: Looking up Amazon Machine Image IDs - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><meta name="default_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="description" content="Use AWS Lambda and a custom resource to dynamically look up AMI IDs." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Walkthrough: Looking up Amazon Machine Image IDs" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Walkthrough: Looking up Amazon Machine Image IDs - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with AWS CloudFormation templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Custom resources",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "AWS Lambda-backed custom resources",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Walkthrough: Looking up Amazon Machine Image IDs",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Step 1: Downloading and saving the sample package in Amazon S3</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Step 2: Creating the stack</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Step 3: Clean up resources</a><a href="#w9aac23c26c16b7c29">Related information</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="walkthrough-custom-resources-lambda-lookup-amiids">Walkthrough: Looking up Amazon Machine Image IDs</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>AWS CloudFormation templates that declare an Amazon Elastic Compute Cloud (Amazon EC2) instance must also
    specify an Amazon Machine Image (AMI) ID, which includes an operating system
    and other software and configuration information used to launch the
    instance. The correct AMI ID depends on the instance type and region in
    which you're launching your stack. And IDs can change regularly, such as
    when an AMI is updated with software updates.</p><p>Normally, you might map AMI IDs to specific instance types and regions.
    To update the IDs, you manually change them in each of your templates. By
    using custom resources and AWS Lambda (Lambda), you can create a function that
    gets the IDs of the latest AMIs for the region and instance type that you're
    using so that you don't have to maintain mappings.</p><p>This walkthrough shows you how to create a custom resource and associate
    a Lambda function with it to look up AMI IDs. Note that the walkthrough
    assumes that you understand how to use custom resources and Lambda. For more
    information, see <a href="./template-custom-resources.html">Custom resources</a> or the <a href="https://docs.aws.amazon.com/lambda/latest/dg/">AWS Lambda Developer Guide</a>.</p><p>Walkthrough Overview</p><p>For this walkthrough, you'll create a stack with a custom resource, a Lambda function, and an
    EC2 instance. The walkthrough provides sample code and a sample template that you'll use to
    create the stack.</p><p>The sample template uses the custom resource type to invoke and send
    input values to the Lambda function. When you use the template, AWS CloudFormation invokes
    the function and sends information to it, such as the request type, input
    data, and a pre-signed Amazon Simple Storage Service (Amazon S3) URL. The function uses that
    information to look up the AMI ID, and then sends a response to the
    pre-signed URL.</p><p>After AWS CloudFormation gets a response in the pre-signed URL location, it proceeds
    with creating the stack. When AWS CloudFormation creates the instance, it uses the Lambda
    function's response to specify the instance's AMI ID.</p><p>The following list summarizes the process. You need AWS Identity and Access Management (IAM)
    permissions to use all the corresponding services, such as Lambda, Amazon EC2, and
    AWS CloudFormation.</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>AWS CloudFormation is a free service; however, you are charged for the AWS
      resources, such as the Lambda function and EC2 instance, that you include
      in your stacks at the current rate for each. For more information about
      AWS pricing, see the detail page for each product at <a href="http://aws.amazon.com" rel="noopener noreferrer" target="_blank"><span>http://aws.amazon.com</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p></div></div><div class="orderedlist">
     
     
     
  <ol><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Save the sample Lambda package in an Amazon Simple Storage Service (Amazon S3)
        bucket.</a></p>
      <p>The sample package contains everything that's required to create the
        Lambda function. You must save the package in a bucket that's in the same
        region in which you will create your stack.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Use the sample template to create a stack.</a></p>
      <p>The stack demonstrates how you associate the Lambda function with a
        custom resource and how to use the results from the function to specify
        an AMI ID. The stack also creates an IAM role (execution role), which
        Lambda uses to make calls to Amazon EC2.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Delete the stack.</a></p>
      <p>Delete the stack to clean up all the stack resources that you
        created so that you aren't charged for unnecessary resources.</p>
    </li></ol></div><h2 id="walkthrough-custom-resources-lambda-lookup-amiids-savesample">Step 1: Downloading and saving the sample package in Amazon S3</h2>
    
    <p>When you create a stack with a Lambda function, you must specify the
      location of the Amazon S3 bucket that contains the function's source code. The
      bucket must be in the same region in which you create your stack.</p>
    <p>This walkthrough provides a sample package (a
        <code>.zip</code> file) that's required to create the Lambda
      function. A Lambda package contains the source code for the function and
      required libraries. For this walkthrough, the function doesn't require
      additional libraries.</p>
    <p>The function takes an instance's architecture and region as inputs
      from an AWS CloudFormation custom resource request and returns the latest AMI ID to a
      pre-signed Amazon S3 URL.</p>
    <div class="procedure"><h6>To download and save the package in Amazon S3</h6><ol><li>
        <p>Download the sample package from Amazon S3. When you save the file, use
          the same file name as the sample, <code>amilookup.zip</code>
          or <code>amilookup-win.zip</code>.</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Look up Linux AMI IDs</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          
            <dt><b><span class="term">Look up Windows AMI IDs</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Open the Amazon S3 console at <a href="https://console.aws.amazon.com/s3/home" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/s3/home</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Choose or create a bucket that's located in the same region in
          which you'll create your AWS CloudFormation stack. Record the bucket name.</p>
        <p>You'll save the sample package in this bucket. For more
          information about creating a bucket, see <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/CreatingaBucket.html">Creating a bucket</a> in
          the <em>Amazon Simple Storage Service User Guide</em>.</p>
      </li><li>
        <p>Upload the sample package to the bucket that you chose or
          created.</p>
        <p>For more information about uploading objects, see <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/UploadingObjectsintoAmazonS3.html">Uploading
            objects</a> in the <em>Amazon Simple Storage Service User Guide</em>.</p>
      </li></ol></div>
    <p>With the package in Amazon S3, you can now specify its location in the
      Lambda resource declaration of the AWS CloudFormation template. The next step
      demonstrates how you declare the function and invoke it by using a custom
      resource. You'll also see how to use the results of the function to
      specify the AMI ID of an EC2 instance.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Step 2: Creating the stack</h2>
    
    <p>To create the sample Amazon EC2 stack, you'll use a sample template that
      includes a Lambda function, an IAM execution role, a custom resource that
      invokes the function, and an EC2 instance that uses the results from the
      function.</p>
    <p>During stack creation, the custom resource invokes the Lambda function
      and waits until the function sends a response to the pre-signed Amazon S3 URL.
      In the response, the function returns the ID of the latest AMI that
      corresponds to the EC2 instance type and region in which you are creating
      the instance. The data from the function's response is stored as an
      attribute of the custom resource, which is used to specify the AMI ID of
      the EC2 instance.</p>
    <p>The following snippets explain relevant parts of the sample template to help you
      understand how to associate a Lambda function with a custom resource and how to use the
      function's response.</p>
    <p>To view the entire sample
      template, see:</p>
    <div class="variablelist">
       
       
    <dl>
        <dt><b><span class="term">Linux template</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      
        <dt><b><span class="term">Windows template</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      </dl></div>
    <p>Stack Template Snippets</p>
    <p>To create the Lambda function, you declare the
        <code class="code">AWS::Lambda::Function</code> resource, which requires the
      function's source code, handler name, runtime environment, and execution
      role ARN.</p>
    <div class="example"><h6>Example JSON syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfoFunction": <span>{</span>
  "Type": "AWS::Lambda::Function",
  "Properties": <span>{</span>
    "Code": <span>{</span>
      "S3Bucket": <span>{</span> "Ref": "S3Bucket" },
      "S3Key": <span>{</span> "Ref": "S3Key" }
    },
    "Handler": <span>{</span> "Fn::Join" : [ "", [<span>{</span> "Ref": "ModuleName" },".handler"] ] },
    "Runtime": "nodejs18.x",
    "Timeout": "30",
    "Role": <span>{</span> "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Example YAML syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfoFunction:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      S3Bucket: !Ref S3Bucket
      S3Key: !Ref S3Key
    Handler: !Sub "$<span>{</span>ModuleName}.handler"
    Runtime: nodejs18.x
    Timeout: 30
    Role: !GetAtt LambdaExecutionRole.Arn</code></pre></div></div>
    <p>The <code class="code">Code</code> property specifies the Amazon S3 location (bucket name and file name)
      where you uploaded the sample package. The sample template uses input parameters (<code class="code">"Ref":
        "S3Bucket"</code> and <code class="code">"Ref": "S3Key"</code>) to set the bucket and file names so that
      you are able to specify the names when you create the stack. Similarly, the handler name,
      which corresponds to the name of the source file (the JavaScript file) in the
        <code>.zip</code> package, also uses an input parameter (<code class="code">"Ref":
        "ModuleName"</code>). Because the source file is JavaScript code, the runtime is specified
      as <code class="code">nodejs18.x</code>.</p>
    <p>For this walkthrough, the execution time for the function exceeds the
      default value of <code class="code">3</code> seconds, so the timeout is set to
        <code class="code">30</code> seconds. If you don't specify a sufficiently long
      timeout, Lambda might cause a timeout before the function can complete,
      causing stack creation to fail.</p>
    <p>The execution role, which is declared elsewhere in the template, is
      specified by using the <code class="code">Fn::GetAtt</code> intrinsic function in the
        <code class="code">Role</code> property. The execution role grants the Lambda function
      permission to send logs to AWS and to call the EC2
        <code class="code">DescribeImages</code> API. The following snippet shows the role
      and policy that grant the appropriate permission:</p>
    <div class="example"><h6>Example JSON syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"LambdaExecutionRole": <span>{</span>
  "Type": "AWS::IAM::Role",
  "Properties": <span>{</span>
    "AssumeRolePolicyDocument": <span>{</span>
      "Version": "2012-10-17",
      "Statement": [<span>{</span>
        "Effect": "Allow",
        "Principal": <span>{</span>"Service": ["lambda.amazonaws.com"]},
        "Action": ["sts:AssumeRole"]
      }]
    },
    "Path": "/",
    "Policies": [<span>{</span>
      "PolicyName": "root",
      "PolicyDocument": <span>{</span>
        "Version": "2012-10-17",
        "Statement": [<span>{</span>
          "Effect": "Allow",
          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
          "Resource": "arn:aws:logs:*:*:*"
        },
        <span>{</span>
          "Effect": "Allow",
          "Action": ["ec2:DescribeImages"],
          "Resource": "*"
        }]
      }
    }]
  }
}</code></pre></div></div>
    <div class="example"><h6>Example YAML syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
      - Effect: Allow
        Principal:
          Service:
          - lambda.amazonaws.com
        Action:
        - sts:AssumeRole
    Path: "/"
    Policies:
    - PolicyName: root
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - ec2:DescribeImages
          Resource: "*"</code></pre></div></div>
    <p>For both the Linux and Windows templates, the custom resource invokes
      the Lambda function that is associated with it. To associate a function
      with a custom resource, you specify the Amazon Resource Name (ARN) of the
      function for the <code class="code">ServiceToken</code> property, using the
        <code class="code">Fn::GetAtt</code> intrinsic function. AWS CloudFormation sends the
      additional properties that are included in the custom resource
      declaration, such as <code class="code">Region</code> and <code class="code">Architecture</code>, to
      the Lambda function as inputs. The Lambda function determines the correct
      names and values for these input properties.</p>
    <div class="example"><h6>Example JSON syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "Architecture": <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Example YAML syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    Architecture:
      Fn::FindInMap:
      - AWSInstanceType2Arch
      - !Ref InstanceType
      - Arch</code></pre></div></div>
    <p>For Windows, the custom resource provides the Windows version to the
      Lambda function instead of the instance's architecture.</p>
    <div class="example"><h6>Example JSON syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "OSName": <span>{</span> "Ref": "WindowsVersion" }
  }
}</code></pre></div></div>
    <div class="example"><h6>Example YAML syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    OSName: !Ref "WindowsVersion"</code></pre></div></div>
    <p>When AWS CloudFormation invokes the Lambda function, the function calls the EC2
        <code class="code">DescribeImages</code> API, using the region and instance
      architecture or the OS name to filter the list of images. Then the
      function sorts the list of images by date and returns the ID of the latest
      AMI.</p>
    <p>When returning the ID of the latest AMI, the function sends the ID to
      a pre-signed URL in the <code class="code">Data</code> property of the <a href="./crpg-ref-responses.html">response object</a>. The data is
      structured as a name-value pair, as shown in the following example:</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Data": <span>{</span> 
  "Id": "ami-43795473"
}</code></pre>
    <p>The following snippet shows how to get the data from a Lambda function.
      It uses the <code class="code">Fn::GetAtt</code> intrinsic function, providing the name
      of the custom resource and the attribute name of the value that you want
      to get. In this walkthrough, the custom resource name is
        <code class="code">AMIInfo</code> and the attribute name is <code class="code">Id</code>.</p>
    <div class="example"><h6>Example JSON syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"SampleInstance": <span>{</span>  
  "Type": "AWS::EC2::Instance",
  "Properties": <span>{</span>
    "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
    "ImageId": <span>{</span> "Fn::GetAtt": [ "AMIInfo", "Id" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>Example YAML syntax</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">SampleInstance:
  Type: AWS::EC2::Instance
  Properties:
    InstanceType: !Ref InstanceType
    ImageId: !GetAtt AMIInfo.Id</code></pre></div></div>
    <p>Now that you understand what the template does, use the sample
      template to create a stack.</p>
    <div class="procedure"><h6>To create the stack</h6><ol><li>
        <p>Open the AWS CloudFormation console at <a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation/</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Choose <b>Create Stack</b>.</p>
      </li><li>
        <p>In the <b>Template</b> section, choose
            <b>Specify an Amazon S3 template URL</b>, and then copy and
          paste the following URL in the text box:</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Linux template</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          
            <dt><b><span class="term">Windows template</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Choose <b>Next</b>.</p>
      </li><li>
        <p>In the <b>Stack name</b> field, type
            <code class="userinput">SampleEC2Instance</code>.</p>
      </li><li>
        <p>In the <b>Parameters</b> section, specify the name
          of the Amazon S3 bucket that you created, and then choose
            <b>Next</b>.</p>
        <p>The default values for the other parameters are the same names
          that are used in the sample <code>.zip</code> package.</p>
      </li><li>
        <p>For this walkthrough, you don't need to add tags or specify
          advanced settings, so choose <b>Next</b>.</p>
      </li><li>
        <p>Ensure that the stack name and template URL are correct, and then
          choose <b>Create</b>.</p>
      </li></ol></div>
    <p>It might take several minutes for AWS CloudFormation to create your stack. To
      monitor progress, view the stack events. For more information, see <a href="./cfn-console-view-stack-data-resources.html">Viewing AWS CloudFormation stack data and resources on the
   AWS Management Console</a>.</p>
    <p>If stack creation succeeds, all resources in the stack, such as the
      Lambda function, custom resource, and EC2 instance, were created. You
      successfully used a Lambda function and custom resource to specify the AMI
      ID of an EC2 instance. You don't need to create and maintain a mapping of
      AMI IDs in this template.</p>
    <p>To see which AMI ID AWS CloudFormation used to create the EC2 instance, view the
      stack outputs.</p>
   <p>If the Lambda function returns an error, view the function's logs in the Amazon CloudWatch Logs <a href="https://console.aws.amazon.com/cloudwatch/home#logs:" rel="noopener noreferrer" target="_blank"><span>console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>. The name of the log stream is the physical ID of
   the custom resource, which you can find by viewing the stack's resources. For more information, see <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#ViewingLogData">Viewing log data</a> in the <em>Amazon CloudWatch User Guide</em>.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Step 3: Clean up resources</h2>
    
    <p>To make sure that you are not charged for unwanted services, delete
      your stack.</p>
    <div class="procedure"><h6>To delete the stack</h6><ol><li>
        <p>From the AWS CloudFormation console, choose the
            <b>SampleEC2Instance</b> stack.</p>
      </li><li>
        <p>Choose <b>Actions</b> and then <b>Delete
            Stack</b>.</p>
      </li><li>
        <p>In the confirmation message, choose <b>Yes,
            Delete</b>.</p>
      </li></ol></div>
    <p>All the resources that you created are deleted.</p>
    <p>Now that you understand how to create and use Lambda functions with
      AWS CloudFormation, you can use the sample template and code from this walkthrough to
      build other stacks and functions.</p>
  <h2 id="w9aac23c26c16b7c29">Related information</h2>
    
    <div class="itemizedlist">
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="./crpg-ref.html">AWS CloudFormation Custom Resource
          Reference</a></p>
      </li></ul></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-custom-resources-lambda.html">AWS Lambda-backed custom resources</div><div id="next" class="next-link" accesskey="n" href="./cfn-lambda-function-code-cfnresponsemodule.html">cfn-response
      module</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>