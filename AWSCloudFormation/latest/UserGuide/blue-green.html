<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Perform ECS blue/green deployments through CodeDeploy using AWS CloudFormation - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="blue-green" /><meta name="default_state" content="blue-green" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="description" content="Use AWS CloudFormation templates to manage ECS blue/green deployments through AWS CodeDeploy." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Perform ECS blue/green deployments through CodeDeploy using AWS CloudFormation" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Perform ECS blue/green deployments through CodeDeploy using AWS CloudFormation - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with AWS CloudFormation templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Perform ECS blue/green deployments through CodeDeploy using AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#blue-green-required">Modeling your blue/green deployment using
                CloudFormation resources</a><a href="#blue-green-resources">Resource updates that trigger green
                deployments</a><a href="#blue-green-considerations">Considerations when managing ECS blue/green
                deployments using CloudFormation</a><a href="#blue-green-setup">Preparing your template to perform ECS blue/green
                deployments</a><a href="#blue-green-changesets">Reviewing the change sets for your blue/green
                deployment</a><a href="#blue-green-events">Viewing stack events for your blue/green
                deployment</a><a href="#blue-green-template-reference">Template reference</a><a href="#blue-green-iam">IAM permissions necessary for blue/green
                deployments</a><a href="#blue-green-template-example">Template example</a></div><div id="page-filters" style="display:none"><filter label="All" id="All"></filter><filter label="JSON" id="JSON"></filter><filter label="YAML" id="YAML"></filter></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="blue-green">Perform ECS blue/green deployments through CodeDeploy using AWS CloudFormation</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>You can use CloudFormation to perform ECS blue/green deployments through AWS CodeDeploy. Blue/green
        deployments are a safe deployment strategy provided by CodeDeploy for minimizing interruptions
        caused by changing application versions. This is accomplished by creating your new
        application environment, referred to as <em>green</em>, alongside your current
        application that's serving your live traffic, referred to as <em>blue</em>. This
        allows for a period of time for monitoring and testing of the green environment before your
        live traffic is routed from blue to green and subsequently turning off the blue
        resources.</p><p>When using CloudFormation to perform ECS blue/green deployments, you start by creating a stack
        template that defines the resources for both your blue and green application environments,
        including specifying the traffic routing and stabilization settings to use. Next, you create
        a stack from that template; this generates your blue (current) application. CloudFormation
        only creates the blue resources during stack creation. Resources for a green deployment
        aren't created until they're required.</p><p>Then, if in a future stack update you update the task definition or task set resources in
        your blue application, CloudFormation does the following:</p><div class="itemizedlist">
         
         
         
    <ul class="itemizedlist"><li class="listitem"><p>Generates all the necessary green
            application environment resources</p></li><li class="listitem"><p>Shifts the traffic based on the specified traffic routing parameters</p></li><li class="listitem"><p>Deletes the blue resources</p></li></ul></div><p>If an error occurs at any point before the green deployment is successful and finalized,
        CloudFormation rolls the stack back to its state before the entire green deployment was
        initiated.</p><p>To enable CloudFormation to perform blue/green deployments on a stack, include the
        following information in its stack template:</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem"><p>A <code class="code">Transform</code> section in your template that invokes the
                    <code class="code">AWS::CodeDeployBlueGreen</code> transform and a <code class="code">Hook</code> section
                that invokes the <code class="code">AWS::CodeDeploy::BlueGreen</code> hook.</p></li><li class="listitem"><p>At least one of the ECS resources that will trigger a blue/green deployment if replaced during a stack update.
    Currently, those resources are <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a>.</p></li></ul></div><p>Then, if you initiate a stack update that updates any properties of the above resources that requires
  CloudFormation to replace the resource, CloudFormation performs a blue/green deployment as described above. For more
  information on resource update behavior, see <a href="./using-cfn-updating-stacks-update-behaviors.html">Update behaviors of stack
         resources</a>.</p><p>In some cases, you'll want to set up your stack template to enable blue/green deployments
            <em>before</em> you create the stack. However, you can also add the ability
        to have CloudFormation perform blue/green deployments to an existing stack. To do so, add the
        necessary information to the stack's existing template.</p><p>In addition, we recommend you have CloudFormation generate a change set for the green deployment, before
  initiating the stack update. This enables you to review the actual changes that will be made to the stack. For more
  information, see <a href="./using-cfn-updating-stacks-changesets.html">Updating stacks using change sets</a>.</p>
        <h2 id="blue-green-required">Modeling your blue/green deployment using
                CloudFormation resources</h2>
        <p>In order to perform ECS blue/green deployment using CodeDeploy through CloudFormation, your template needs to
   include the resources that model your deployment, such as an Amazon ECS service and load balancer. For more details on
   what these resources represent, see <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployment-steps-ecs.html#deployment-steps-prerequisites-ecs">Before you begin an
   Amazon ECS deployment</a> in the <em>AWS CodeDeploy User Guide</em>.</p>
        <div class="table-container"><div class="table-contents"><table id="w1355aac23c32c23b5"><thead>
                    <tr>
                        <th>Requirement</th>
                        <th>Resource</th>
                        <th>Required/Optional</th>
                        <th>Triggers blue/green deployment if replaced</th>
                    </tr>
                </thead>
                    <tr>
                        <td tabindex="-1">Amazon ECS cluster</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-cluster.html"><code class="code">AWS::ECS::Cluster</code></a></td>
                        <td tabindex="-1">Optional. The default cluster can be used.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Amazon ECS service</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html"><code class="code">AWS::ECS::Service</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Application or Network Load Balancer</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-service-loadbalancer.html"><code class="code">AWS::ECS::Service
       LoadBalancer</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Production listener</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Test listener </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">Optional.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Two target groups</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html"><code class="code">AWS::ElasticLoadBalancingV2::TargetGroup</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Amazon ECS task definition </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">Yes</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Container for your Amazon ECS application</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-containerdefinitions.html#cfn-ecs-taskdefinition-containerdefinition-name.html"><code class="code">AWS::ECS::TaskDefinition ContainerDefinition Name</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Port for your replacement task set</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-portmapping.html#cfn-ecs-taskdefinition-portmapping-containerport"><code class="code">AWS::ECS::TaskDefinition PortMapping ContainerPort</code></a></td>
                        <td tabindex="-1">Required.</td>
                        <td tabindex="-1">No</td>
                    </tr>
                </table></div></div>
     
        <h2 id="blue-green-resources">Resource updates that trigger green
                deployments</h2>
        <p>If you perform a stack update that updates any property that requires <a href="./using-cfn-updating-stacks-update-behaviors.html">replacement</a> for the following ECS resources, CloudFormation
   initiates a green deployment:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></p></li><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a> </p></li></ul></div>
        
        <p>Updating properties in these resources that don't require resource replacement doesn't
            trigger a green deployment.</p>
        <p>You can't include updates to the above resources with updates to other resources in
            the same stack update. If you need to update resources in the list above in addition to
            other resources in the same stack, do one of the following:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Perform two separate stack update operations: one that includes only the updates to the above
                resources, and a separate stack update that includes changes to any other
                resources.</p></li><li class="listitem"><p>Remove the <code class="code">Transform</code> and <code class="code">Hook</code> sections from your template and then
                    perform the stack update. In this case, CloudFormation won't perform a green
                    deployment.</p></li></ul></div>
     
        <h2 id="blue-green-considerations">Considerations when managing ECS blue/green
                deployments using CloudFormation</h2>
        <p>You should consider the following when defining your blue/green deployment using
            CloudFormation:</p>
        <div class="itemizedlist">
             
             
             
             
             
             
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Only updates to certain resources will initiate a green deployment, as discussed in <a href="#blue-green-resources">Resource updates that trigger green
                deployments</a>.</p></li><li class="listitem"><p>You can't include updates to resources that initiate green deployments and updates to other resources in the same
     stack update, as discussed in <a href="#blue-green-resources">Resource updates that trigger green
                deployments</a>.</p></li><li class="listitem"><p>You can only specify a single ECS service as the deployment target.</p></li><li class="listitem"><p>Parameters whose values are obfuscated by CloudFormation can't be updated by the CodeDeploy service
                    during a green deployment, and will lead to an error and stack update failure.
                    These include:</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p>Parameters defined with the <code class="code">NoEcho</code> attribute.</p></li><li class="listitem"><p>Parameters that use dynamic references to retrieve their values from external services. For more information, see
       <a href="./dynamic-references.html">Using dynamic references to specify template
            values</a>.</p></li></ul></div>
            </li><li class="listitem"><p>To cancel a green deployment that's still in progress, cancel the stack update in CloudFormation, not CodeDeploy or ECS.
     For more information, see <a href="./using-cfn--stack-update-cancel.html">Canceling a stack update</a>. (After an update has finished, you can't cancel it. You can, however,
     update a stack again with any previous settings.)</p></li><li class="listitem"><p>Declaring <a href="./outputs-section-structure.html">Outputs</a> or using <a href="./intrinsic-function-reference-importvalue.html">Fn::ImportValue</a> to
     import values from other stacks isn't currently supported for templates defining blue/green ECS deployments.</p></li><li class="listitem"><p><a href="./resource-import.html">Bringing
   existing resources into CloudFormation management</a> isn't currently supported for templates defining
     blue/green ECS deployments.</p></li><li class="listitem"><p>You can't use the <code class="code">AWS::CodeDeploy::BlueGreen</code> hook in a template that includes
                    nested stack resources.</p></li><li class="listitem"><p>You can't use the <code class="code">AWS::CodeDeploy::BlueGreen</code> hook in a <a href="./using-cfn-nested-stacks.html">nested
     stack</a>.</p></li></ul></div>
        <p>For information on how using CloudFormation to perform your ECS blue/green deployments
            through CodeDeploy differs from a standard Amazon ECS deployment using just CodeDeploy,
            see <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployments-create-prerequisites.html">Differences between Amazon ECS Blue/Green deployments through CloudFormation
                and standard Amazon ECS deployments</a> in the <em>AWS CodeDeploy User
                Guide</em>.</p>
     
        <h2 id="blue-green-setup">Preparing your template to perform ECS blue/green
                deployments</h2>
        <p>To enable blue/green deployments on your stack, include the following sections in your
            stack template before performing a stack update.</p>
        <div class="itemizedlist">
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Add a reference to the <code class="code">AWS::CodeDeployBlueGreen</code> transform to your template:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],</code></pre>
</li><li class="listitem"><p>Add a <code class="code">Hook</code> section that invokes the <code class="code">AWS::CodeDeploy::BlueGreen</code> hook and specifies the properties for your deployment. Use the template reference below as a guide.</p></li><li class="listitem"><p>In the <code class="code">Resources</code> section, define the blue and green resources for your
                    deployment.</p></li></ul></div>
        <p>You can add these sections when you first create the template (that's, before creating
            the stack itself), or you can add them to an existing template before performing a stack
            update. If you specify the blue/green deployment for a new stack, CloudFormation only
            creates the blue resources during stack creation — resources for the green
            deployment aren't created until they're required during a stack update.</p>

     
        <h2 id="blue-green-changesets">Reviewing the change sets for your blue/green
                deployment</h2>
        <p>We strongly recommend that you create a change set before performing a stack update that will initiate a
   green deployment. This allows to see the actual changes that will be made to your stack before performing stack
   update. Be aware that resource changes may not be listed in the order in which they will be performed during the
   stack update. For more information, see <a href="./using-cfn-updating-stacks-changesets.html">Updating stacks using change sets</a>.</p>
     
        <h2 id="blue-green-events">Viewing stack events for your blue/green
                deployment</h2>
        <p>You can view the stack events generated at each step of the ECS deployment on the
   <b>Events</b> tab of the <b>Stack</b> page, and using the AWS CLI. For more information,
   see <a href="./using-cfn-updating-stacks-monitor-stack.html">Monitoring the progress of a stack update</a>.</p>
     
        <h2 id="blue-green-template-reference">Template reference</h2>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Hooks": <span>{</span>
  "Logical ID": <span>{</span>
    "Properties": <span>{</span>
      "TrafficRoutingConfig": <span>{</span>
        "Type": "Traffic routing type",
        "TimeBasedCanary": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        },
        "TimeBasedLinear": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        }
      },
      "AdditionalOptions": <span>{</span>"TerminationWaitTimeInMinutes": Integer},
      "LifecycleEventHooks": <span>{</span>
        "BeforeInstall": "FunctionName",
        "AfterInstall": "FunctionName",
        "AfterAllowTestTraffic": "FunctionName",
        "BeforeAllowTraffic": "FunctionName",
        "AfterAllowTraffic": "FunctionName"
      },
      "ServiceRole": "CodeDeployServiceRoleName",
      "Applications": [
        <span>{</span>
          "Target": <span>{</span>
            "Type": "AWS::ECS::Service",
            "LogicalID": "Resource Logical ID"
          },
          "ECSAttributes": <span>{</span>
            "TaskDefinitions": [
              "AWS::ECS::TaskDefinition Resource Logical ID (Blue)",
              "AWS::ECS::TaskDefinition Resource Logical ID (Green)"
            ],
            "TaskSets": [
              "AWS::ECS::TaskSet Resource Logical ID (Blue)",
              "AWS::ECS::TaskSet Resource Logical ID (Green)"
            ],
            "TrafficRouting": <span>{</span>
              "ProdTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Production)"
              },
              "TestTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Test)"
              },
              "TargetGroups": [
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Blue)",
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Green)"
              ]
            }
          }
        }
      ]
    },
    "Type": "AWS::CodeDeploy::BlueGreen"
  }
}</code></pre>
         
            <h3 id="blue-green-template-reference-props">Properties</h3>
            <div class="variablelist">
                 
                 
            <dl>
                    <dt><span class="term"><code class="code">Logical ID</code></span></dt>
                    <dd>
                        <p>The logical ID must be alphanumeric (A-Za-z0-9) and unique within the template.</p>
                        <p><em>Required</em>: Yes</p>
                        <div class="variablelist">
                             
                        <dl>
                                <dt><span class="term"><code class="code">Properties</code></span></dt>
                                <dd>
                                    <p>Properties of the hook.</p>
                                    <p><em>Required</em>: Yes</p>
                                    <div class="variablelist">
                                         
                                         
                                         
                                         
                                         
                                    <dl>
                                            <dt><span class="term"><code class="code">TrafficRoutingConfig</code></span></dt>
                                            <dd>
                                                <p>Traffic routing configuration settings.</p>
                                                <p><em>Required</em>: No</p>
                                                <p>The default configuration is time-based canary
                                                  traffic shifting, with a 15% step percentage and a
                                                  five minute bake time.</p>
                                                <div class="variablelist">
                                                    
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Type</code></span></dt>
                                                        <dd>
                                                            <p>The type of traffic shifting used by the deployment
                                                                configuration.</p>
                                                            <p>Valid values: AllAtOnce | TimeBasedCanary | TimeBasedLinear</p>
                                                            <p><em>Required</em>: Yes</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TimeBasedCanary</code></span></dt>
                                                                    <dd>
                                                                        <p>Specifies a
                                                  configuration that shifts traffic from one version
                                                  of the deployment to another in two
                                                  increments.</p>
                                                                        <p><em>Required</em>: Conditional: If you specify <code class="code">TimeBasedCanary</code> as the traffic routing type, you must include the <code class="code">TimeBasedCanary</code> parameter.</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>The percentage of traffic to shift in the first increment of a <code class="code">TimeBasedCanary</code> deployment. The step percentage must be 14% or greater.</p>
                                                                                    <p><em>Required</em>: No</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p>The number of minutes between the first and second traffic shifts of a <code class="code">TimeBasedCanary</code> deployment.</p>
                                                                                    <p><em>Required</em>: No</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TimeBasedLinear</code></span></dt>
                                                                    <dd>
                                                                        <p>Specifies a configuration that shifts traffic from one version of the deployment to another in equal increments, with an equal number of minutes between each increment.</p>
                                                                        <p><em>Required</em>: Conditional: If you specify <code class="code">TimeBasedLinear</code> as the traffic routing type, you must include the <code class="code">TimeBasedLinear</code> parameter.</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>The
                                                  percentage of traffic that's shifted at the start
                                                  of each increment of a
                                                  <code class="code">TimeBasedLinear</code> deployment. The step
                                                  percentage must be 14% or greater.</p>
                                                                                    <p><em>Required</em>: No</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p>The number of minutes between each incremental traffic shift of a <code class="code">TimeBasedLinear</code> deployment.</p>
                                                                                    <p><em>Required</em>: No</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">AdditionalOptions</code></span></dt>
                                            <dd>
                                                <p>Additional options for the blue/green
                                                  deployment.</p>
                                                <p><em>Required</em>: No</p>
                                                <div class="variablelist">
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">TerminationWaitTimeInMinutes</code></span></dt>
                                                        <dd>
                                                            <p>Specifies time to wait, in minutes, before terminating the blue resources.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">LifecycleEventHooks</code></span></dt>
                                            <dd>
                                                <p>Use lifecycle event hooks to specify a Lambda function that CodeDeploy can call to validate a deployment. You can use the same function or a different one for  deployment lifecyle events. Following completion of the validation tests, the Lambda AfterAllowTraffic function calls back CodeDeploy and delivers a result of <code class="code">Succeeded</code> or <code class="code">Failed</code>.</p>
                                                <p>For more information, see <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html">AppSpec 'hooks' section</a> in the <em>AWS CodeDeploy User Guide.</em></p>
                                                <p><em>Required</em>: No</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                     
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">BeforeInstall</code></span></dt>
                                                        <dd>
                                                            <p>Function to use to run tasks
                                                  before the replacement task set is created.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterInstall</code></span></dt>
                                                        <dd>
                                                            <p>Function to use to run tasks after
                                                  the replacement task set is created and one of the
                                                  target groups is associated with it.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTestTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Function to use to run tasks after
                                                  the test listener serves traffic to the
                                                  replacement task set.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">BeforeAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Function to use to run tasks after
                                                  the second target group is associated with the
                                                  replacement task set, but before traffic is
                                                  shifted to the replacement task set.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Function to use to run tasks after
                                                  the second target group serves traffic to the
                                                  replacement task set.</p>
                                                            <p><em>Required</em>: No</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">ServiceRole</code></span></dt>
                                            <dd>
                                                <p>The execution role for CloudFormation to use to perform the blue-green
             deployments. For a list of the necessary permissions, see <a href="#blue-green-iam">IAM permissions necessary for blue/green
                deployments</a>.</p>
                                                <p><em>Required</em>: Yes</p>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">Applications</code></span></dt>
                                            <dd>
                                                <p>Specifies properties of the Amazon ECS application.</p>
                                                <p><em>Required</em>: Yes</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Target</code></span></dt>
                                                        <dd>
                                                            <p></p>
                                                            <p><em>Required</em>: Yes</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                    <dd>
                                                                        <p>The type of the resource.</p>
                                                                        <p><em>Required</em>: Yes</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                    <dd>
                                                                        <p>The logical id of the resource.</p>
                                                                        <p><em>Required</em>: Yes</p>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">ECSAttributes</code></span></dt>
                                                        <dd>
                                                            <p>The resources that represent the various requirements of your Amazon ECS application deployment.</p>
                                                            <p><em>Required</em>: Yes</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TaskDefinitions</code></span></dt>
                                                                    <dd>
                                                                        <p>The logical ID of the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> resource to run the Docker container that contains
                   your Amazon ECS application.</p>
                                                                        <p><em>Required</em>: Yes</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TaskSets</code></span></dt>
                                                                    <dd>
                                                                        <p>The logical IDs of the <code class="code">AWS::ECS::TaskSet</code> resources to use as task sets for the application.</p>
                                                                        <p><em>Required</em>: Yes</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TrafficRouting</code></span></dt>
                                                                    <dd>
                                                                        <p>Specifies resources used for traffic routing.</p>
                                                                        <p><em>Required</em>: Yes</p>
                                                                        <div class="variablelist">
                                                                             
                                                                             
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">ProdTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>The listener to be used by your load balancer to direct traffic to your target groups.</p>
                                                                                    <p><em>Required</em>: Yes</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>The type of the resource. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>Required</em>: Yes</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>The logical ID of the resource.</p>
                                                                                                <p><em>Required</em>: Yes</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TestTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>The listener to be used by your load balancer to direct traffic to your target groups.</p>
                                                                                    <p><em>Required</em>: Yes</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>The type of the resource. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>Required</em>: Yes</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>The logical ID of the resource.</p>
                                                                                                <p><em>Required</em>: No</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TargetGroups</code></span></dt>
                                                                                <dd>
                                                                                    <p>Logical ID of resources to use as target groups to route traffic to the registered target.</p>
                                                                                    <p><em>Required</em>: Yes</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                        </dl></div>
                                </dd>
                            </dl></div>
                    </dd>
                    
                 
                    <dt><span class="term"><code class="code">Type</code></span></dt>
                    <dd>
                        <p>The type of hook. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                        <p><em>Required</em>: Yes</p>
                    </dd>
                </dl></div>
         
     
        <h2 id="blue-green-iam">IAM permissions necessary for blue/green
                deployments</h2>
        <p>In order for CloudFormation to successfully perform the blue-green deployments, you must have the following CodeDeploy permissions:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><code class="code">codedeploy:Get*</code></p></li><li class="listitem"><p><code class="code">codedeploy:CreateCloudFormationDeployment</code></p></li></ul></div>
        <p>For more information, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html">Actions, resources, and condition keys for CodeDeploy</a> in the <em>AWS Identity and Access Management User Guide</em>.</p>
     
        <h2 id="blue-green-template-example">Template example</h2>
        <p>The following example sets up an ECS blue/green deployment through CodeDeploy, with a traffic routing progress of 15 percent per step, with a stabilization period of 5 minutes between each step. Creating a stack with the template would provision the initial configuration of the deployment.</p>
        <p>If you then made any changes to properties in the <code class="code">"BlueTaskSet"</code> resource that require that
            resource be replaced, CloudFormation would then initiate a green deployment as part of the stack update.</p>
        <div id="JSON" name="JSON" class="section langfilter">
            <h3 id="blue-green-template-example.json">JSON</h3>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "Parameters": <span>{</span>
        "Vpc": <span>{</span>
            "Type": "AWS::EC2::VPC::Id"
        },
        "Subnet1": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        },
        "Subnet2": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        }
    },
    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],
    "Hooks": <span>{</span>
        "CodeDeployBlueGreenHook": <span>{</span>
            "Properties": <span>{</span>
                "TrafficRoutingConfig": <span>{</span>
                    "Type": "TimeBasedCanary",
                    "TimeBasedCanary": <span>{</span>
                        "StepPercentage": 15,
                        "BakeTimeMins": 5
                    }
                },
                "Applications": [
                    <span>{</span>
                        "Target": <span>{</span>
                            "Type": "AWS::ECS::Service",
                            "LogicalID": "ECSDemoService"
                        },
                        "ECSAttributes": <span>{</span>
                            "TaskDefinitions": [
                                "BlueTaskDefinition",
                                "GreenTaskDefinition"
                            ],
                            "TaskSets": [
                                "BlueTaskSet",
                                "GreenTaskSet"
                            ],
                            "TrafficRouting": <span>{</span>
                                "ProdTrafficRoute": <span>{</span>
                                    "Type": "AWS::ElasticLoadBalancingV2::Listener",
                                    "LogicalID": "ALBListenerProdTraffic"
                                },
                                "TargetGroups": [
                                    "ALBTargetGroupBlue",
                                    "ALBTargetGroupGreen"
                                ]
                            }
                        }
                    }
                ]
            },
            "Type": "AWS::CodeDeploy::BlueGreen"
        }
    },
    "Resources": <span>{</span>
        "ExampleSecurityGroup": <span>{</span>
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": <span>{</span>
                "GroupDescription": "Security group for ec2 access",
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 8080,
                        "ToPort": 8080,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "ALBTargetGroupBlue": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ALBTargetGroupGreen": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ExampleALB": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": <span>{</span>
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    <span>{</span>
                        "Ref": "ExampleSecurityGroup"
                    }
                ],
                "Subnets": [
                    <span>{</span>
                        "Ref": "Subnet1"
                    },
                    <span>{</span>
                        "Ref": "Subnet2"
                    }
                ],
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "Type": "application",
                "IpAddressType": "ipv4"
            }
        },
        "ALBListenerProdTraffic": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": <span>{</span>
                "DefaultActions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "LoadBalancerArn": <span>{</span>
                    "Ref": "ExampleALB"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ALBListenerProdRule": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": <span>{</span>
                "Actions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "Conditions": [
                    <span>{</span>
                        "Field": "http-header",
                        "HttpHeaderConfig": <span>{</span>
                            "HttpHeaderName": "User-Agent",
                            "Values": [
                                "Mozilla"
                            ]
                        }
                    }
                ],
                "ListenerArn": <span>{</span>
                    "Ref": "ALBListenerProdTraffic"
                },
                "Priority": 1
            }
        },
        "ECSTaskExecutionRole": <span>{</span>
            "Type": "AWS::IAM::Role",
            "Properties": <span>{</span>
                "AssumeRolePolicyDocument": <span>{</span>
                    "Version": "2012-10-17",
                    "Statement": [
                        <span>{</span>
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": <span>{</span>
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ]
            }
        },
        "BlueTaskDefinition": <span>{</span>
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": <span>{</span>
                "ExecutionRoleArn": <span>{</span>
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    <span>{</span>
                        "Name": "DemoApp",
                        "Image": "nginxdemos/hello:latest",
                        "Essential": true,
                        "PortMappings": [
                            <span>{</span>
                                "HostPort": 80,
                                "Protocol": "tcp",
                                "ContainerPort": 80
                            }
                        ]
                    }
                ],
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "NetworkMode": "awsvpc",
                "Cpu": "256",
                "Memory": "512",
                "Family": "ecs-demo"
            }
        },
        "ECSDemoCluster": <span>{</span>
            "Type": "AWS::ECS::Cluster",
            "Properties": <span>{</span>}
        },
        "ECSDemoService": <span>{</span>
            "Type": "AWS::ECS::Service",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "DesiredCount": 1,
                "DeploymentController": <span>{</span>
                    "Type": "EXTERNAL"
                }
            }
        },
        "BlueTaskSet": <span>{</span>
            "Type": "AWS::ECS::TaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "LaunchType": "FARGATE",
                "NetworkConfiguration": <span>{</span>
                    "AwsVpcConfiguration": <span>{</span>
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": [
                            <span>{</span>
                                "Ref": "ExampleSecurityGroup"
                            }
                        ],
                        "Subnets": [
                            <span>{</span>
                                "Ref": "Subnet1"
                            },
                            <span>{</span>
                                "Ref": "Subnet2"
                            }
                        ]
                    }
                },
                "PlatformVersion": "1.4.0",
                "Scale": <span>{</span>
                    "Unit": "PERCENT",
                    "Value": 100
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskDefinition": <span>{</span>
                    "Ref": "BlueTaskDefinition"
                },
                "LoadBalancers": [
                    <span>{</span>
                        "ContainerName": "DemoApp",
                        "ContainerPort": 80,
                        "TargetGroupArn": <span>{</span>
                            "Ref": "ALBTargetGroupBlue"
                        }
                    }
                ]
            }
        },
        "PrimaryTaskSet": <span>{</span>
            "Type": "AWS::ECS::PrimaryTaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskSetId": <span>{</span>
                    "Fn::GetAtt": [
                        "BlueTaskSet",
                        "Id"
                    ]
                }
            }
        }
    }
}</code></pre>

        </div>
        <div id="YAML" name="YAML" class="section langfilter">
            <h3 id="blue-green-template-example.yaml">YAML</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">Parameters:
  Vpc:
    Type: 'AWS::EC2::VPC::Id'
  Subnet1:
    Type: 'AWS::EC2::Subnet::Id'
  Subnet2:
    Type: 'AWS::EC2::Subnet::Id'
Transform:
  - 'AWS::CodeDeployBlueGreen'
Hooks:
  CodeDeployBlueGreenHook:
    Properties:
      TrafficRoutingConfig:
        Type: TimeBasedCanary
        TimeBasedCanary:
          StepPercentage: 15
          BakeTimeMins: 5
      Applications:
        - Target:
            Type: 'AWS::ECS::Service'
            LogicalID: ECSDemoService
          ECSAttributes:
            TaskDefinitions:
              - BlueTaskDefinition
              - GreenTaskDefinition
            TaskSets:
              - BlueTaskSet
              - GreenTaskSet
            TrafficRouting:
              ProdTrafficRoute:
                Type: 'AWS::ElasticLoadBalancingV2::Listener'
                LogicalID: ALBListenerProdTraffic
              TargetGroups:
                - ALBTargetGroupBlue
                - ALBTargetGroupGreen
    Type: 'AWS::CodeDeploy::BlueGreen'
Resources:
  ExampleSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Security group for ec2 access
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  ALBTargetGroupBlue:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ALBTargetGroupGreen:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ExampleALB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ExampleSecurityGroup
      Subnets:
        - !Ref Subnet1
        - !Ref Subnet2
      Tags:
        - Key: Group
          Value: Example
      Type: application
      IpAddressType: ipv4
  ALBListenerProdTraffic:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      LoadBalancerArn: !Ref ExampleALB
      Port: 80
      Protocol: HTTP
  ALBListenerProdRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Properties:
      Actions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: User-Agent
            Values:
              - Mozilla
      ListenerArn: !Ref ALBListenerProdTraffic
      Priority: 1
  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
  BlueTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ExecutionRoleArn: !GetAtt 
        - ECSTaskExecutionRole
        - Arn
      ContainerDefinitions:
        - Name: DemoApp
          Image: 'nginxdemos/hello:latest'
          Essential: true
          PortMappings:
            - HostPort: 80
              Protocol: tcp
              ContainerPort: 80
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: '256'
      Memory: '512'
      Family: ecs-demo
  ECSDemoCluster:
    Type: 'AWS::ECS::Cluster'
    Properties: <span>{</span>}
  ECSDemoService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref ECSDemoCluster
      DesiredCount: 1
      DeploymentController:
        Type: EXTERNAL
  BlueTaskSet:
    Type: 'AWS::ECS::TaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsVpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref ExampleSecurityGroup
          Subnets:
            - !Ref Subnet1
            - !Ref Subnet2
      PlatformVersion: 1.4.0
      Scale:
        Unit: PERCENT
        Value: 100
      Service: !Ref ECSDemoService
      TaskDefinition: !Ref BlueTaskDefinition
      LoadBalancers:
        - ContainerName: DemoApp
          ContainerPort: 80
          TargetGroupArn: !Ref ALBTargetGroupBlue
  PrimaryTaskSet:
    Type: 'AWS::ECS::PrimaryTaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      Service: !Ref ECSDemoService
      TaskSetId: !GetAtt 
        - BlueTaskSet
        - Id</code></pre>
        </div>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./modules.html">Using modules</div><div id="next" class="next-link" accesskey="n" href="./cfn-regexes.html">Using regular expressions</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>