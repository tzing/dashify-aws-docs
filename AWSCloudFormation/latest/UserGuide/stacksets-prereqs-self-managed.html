<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Grant self-managed permissions - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="stacksets-prereqs-self-managed" /><meta name="default_state" content="stacksets-prereqs-self-managed" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="description" content="With self-managed permissions, you create the AWS Identity and Access Management (IAM) roles required by StackSets to deploy across accounts and AWS Regions. These roles are necessary to establish a trusted relationship between the account you're administering the stack set from and the account you're deploying stack instances to. Using this permissions model, StackSets can deploy to any AWS account in which you have permissions to create an IAM role." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Grant self-managed permissions" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Grant self-managed permissions - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with AWS CloudFormation StackSets",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/what-is-cfnstacksets.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Prerequisites for stack set operations",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Grant self-managed permissions",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#prereqs-self-managed-permissions">Self-managed permissions</a><a href="#stacksets-prereqs-accountsetup">Set up basic permissions for stack
                    set operations</a><a href="#stacksets-prereqs-advanced-perms">Set up advanced permissions options
                    for stack set operations</a><a href="#confused-deputy-mitigation">Confused deputy prevention</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="stacksets-prereqs-self-managed">Grant self-managed permissions</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>With self-managed permissions, you create the AWS Identity and Access Management (IAM) roles required by
            StackSets to deploy across accounts and AWS Regions. These roles are
            necessary to establish a trusted relationship between the account you're administering
            the stack set from and the account you're deploying stack instances to. Using this
            permissions model, StackSets can deploy to any AWS account in which you
            have permissions to create an IAM role.</p><div class="highlights" id="inline-topiclist"><h6>Topics</h6><ul><li><a href="#prereqs-self-managed-permissions">Self-managed permissions</a></li><li><a href="#stacksets-prereqs-accountsetup">Set up basic permissions for stack
                    set operations</a></li><li><a href="#stacksets-prereqs-advanced-perms">Set up advanced permissions options
                    for stack set operations</a></li><li><a href="#confused-deputy-mitigation">Set up global keys to mitigate confused
                    deputy problems</a></li></ul></div>
            <h2 id="prereqs-self-managed-permissions">Self-managed permissions</h2>
            <p>To set up the required permissions for creating a <b>service-managed</b>
    stack set, see <a href="./stacksets-orgs-activate-trusted-access.html">Activate trusted access with
                AWS Organizations</a>.</p>
            <p>Before you create a stack set with <b>self-managed</b>
                permissions, you need to establish a trust relationship between the administrator
                and target accounts by creating IAM roles in each account.</p>
            <div class="orderedlist">
                 
                 
                 
            <ol><li>
                    <p>Determine which AWS account is the <em>administrator
                            account</em>.</p>
                    <p>Stack sets are created in this administrator account. A <em>target
                            account</em> is the account in which you create individual stacks
                        that belong to a stack set.</p>
                </li><li>
                    <p>Determine how you want to structure permissions for the stack sets.</p>
                    <p>The simplest (and most permissive) permissions configuration is where you
                        give <em>all</em> users and groups in the administrator account
                        the ability to create and update <em>all</em> the stack sets
                        managed through that account. If you need finer-grained control, you can set
                        up permissions to specify:</p>
                    <div class="itemizedlist">
                         
                         
                         
                    <ul class="itemizedlist"><li class="listitem">
                            <p>Which users and groups can perform stack set operations in which
                                target accounts.</p>
                        </li><li class="listitem">
                            <p>Which resources users and groups can include in their stack
                                sets.</p>
                        </li><li class="listitem">
                            <p>Which stack set operations specific users and groups can
                                perform.</p>
                        </li></ul></div>
                </li><li>
                    <p>Create the necessary IAM service roles in your administrator and target
                        accounts to define the permissions you want.</p>
                </li></ol></div>
         
            <h2 id="stacksets-prereqs-accountsetup">Set up basic permissions for stack
                    set operations</h2>
            <p>The simplest (and most permissive) permissions configuration is where you give
                    <em>all</em> users and groups in the administrator account the
                ability to create and update <em>all</em> the stack sets managed through
                that account. To do this, you create IAM service roles for your administrator and
                all target accounts. Anyone with permissions to the administrator account then has
                permissions to create, update, or delete any stacks in any of the target
                accounts.</p>
            <p>Your administrator account and target accounts must have service roles configured
                that create a trust relationship between the accounts, and grant the target accounts
                permission to create and manage the resources described in your template.</p>
            <p>If you structure your permissions this way, users don't pass an administrator role
                when creating or updating stack sets.</p>
            <div class="mediaobject">
                 
                    <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_master_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                    Set up a trust relationship between the administrator account and the&#xA;                        target accounts. Any user in the administrator account can then create any&#xA;                        stack set.&#xA;                " style="max-width:100%" />
                 
                 
            </div>
            <div class="procedure"><h6>Set up permissions for all users of
                    the administrator account to perform stack set operations in all target
                    accounts</h6><ol><li>
                    <p>In the administrator account, create an IAM role named
       <b>AWSCloudFormationStackSetAdministrationRole</b>. You
      can do this by creating a stack from the following AWS CloudFormation template, available online at <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
      The role created by this template enables the following policy on your administrator account.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                    <p>The following trust relationship is created by the preceding
                        template.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>Be aware that to deploy stack instances into a target account that resides
                        in a Region that's disabled by default, you will also need to include the
                        regional service principal for that Region. Each Region that's disabled by
                        default will have its own regional service principal.</p>
                    <p>For more information on regional endpoints, including a list of endpoints,
                        see <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">Regional
                            endpoints</a> in the <em>AWS General Reference
                            Guide</em>.</p>
                    <p>The following example includes the regional service principal
                            (<code class="code">cloudformation.ap-east-1.amazonaws.com</code>) for the
                        Asia Pacific (Hong Kong) Region, a Region which is disabled by default.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "cloudformation.ap-east-1.amazonaws.com"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>For more information, see <a href="./stacksets-prereqs.html#stacksets-opt-in-regions">Performing stack set operations involving regions that are disabled by
    default</a>.</p>
                </li><li>
                    <p>In each target account, create a service role named
                            <b>AWSCloudFormationStackSetExecutionRole</b> that trusts
                        the administrator account. The role must have this exact name. You can do
                        this by creating a stack from the following AWS CloudFormation template, available online
                        at <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                        When you use this template, you are prompted to provide the name of the
                        administrator account with which your target account must have a trust
                        relationship.</p>
                    <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>Be aware that this template grants administrator access. After you use
                            the template to create a target account execution role, you must scope
                            the permissions in the policy statement to the types of resources that
                            you are creating by using StackSets.</p></div></div>
                    <p>The target account service role requires permissions to perform any
                        operations that are specified in your AWS CloudFormation template. For example, if your
                        template is creating an S3 bucket, then you need permissions to create new
                        objects for S3. Your target account always needs full AWS CloudFormation permissions,
                        which include permissions to create, update, delete, and describe stacks.
                        The role created by this template enables the following policy on a target
                        account.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": "*",
      "Resource": "*"
    }
  ]
}</code></pre>
                    <p>You must add the S3 service action and resources to
                            <code class="code">AWSCloudFormationStackSetExecutionRole</code> policy statement for
                        each target account for StackSets to work. StackSets uses these
                        permissions to notify the stack instance state in the target accounts and in
                        the administrator account.</p>
                    <p>To create stacks in target accounts that use resources from services other
                        than CloudFormation, you must add those service actions and resources to the
                            <code class="code">AWSCloudFormationStackSetExecutionRole</code> policy statement for
                        each target account. The following example shows a policy statement with the
                        required permissions for StackSets.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
         "cloudformation:*",
         "s3:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                    <p>The following trust relationship is created by the template. The
                        administrator account's ID is shown as
                            <code class="replaceable">admin_account_id</code>.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:root"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                    <p>You can configure the trust relationship of an existing target account
                        execution role to trust a specific role in the administrator account. If you
                        delete the role in the administrator account, and create a new one to
                        replace it, you must configure your target account trust relationships with
                        the new administrator account role, represented by
                            <code class="replaceable">admin_account_id</code> in the preceding
                        example.</p>
                </li></ol></div>
         
            <h2 id="stacksets-prereqs-advanced-perms">Set up advanced permissions options
                    for stack set operations</h2>
            <p>If you require finer-grained control over the stack sets that users and groups are
                creating through a single administrator account, you can use IAM roles to
                specify:</p>
            <div class="itemizedlist">
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p>Which users and groups can perform stack set operations in which target
                        accounts.</p>
                </li><li class="listitem">
                    <p>Which resources users and groups can include in their stack sets.</p>
                </li><li class="listitem">
                    <p>Which stack set operations specific users and groups can perform.</p>
                </li></ul></div>
             
                <h3 id="stacksets-prereqs-multiadmin">Set up permissions to control
                        target account access</h3>
                <p>Use customized administrator roles to control which users and groups can
                    perform stack set operations in which target accounts. You might want to control
                    which users of the administrator account can perform stack set operations in
                    which target accounts. To do this, you create a trust relationship between each
                    target account and a specific customized administration role, rather than
                    creating the <b>AWSCloudFormationStackSetAdministrationRole</b>
                    service role in the administrator account itself. You then activate specific
                    users and groups to use the customized administration role when performing stack
                    set operations in a specific target account.</p>
                <p>For example, you can create Role A and Role B within your administrator
                    account. You can give Role A permissions to access target account 1 through
                    account 8. You can give Role B permissions to access target account 9 through
                    account 16.</p>
                <div class="mediaobject">
                     
                        <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_admin_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                         Set up a trust relationship between a customized administrator role&#xA;                            and the target accounts. The user then passes that role when creating&#xA;                            the stack set.&#xA;                    " style="max-width:100%" />
                     
                     
                </div>
                <p>Setting up the necessary permissions involves defining a customized
                    administrator role, creating a service role for the target account, and granting
                    users permission to pass the customized administrator role when performing stack
                    set operations.</p>
                <p>In general, here's how it works once you have the necessary permissions in
                    place: When creating a stack set, the user must specify a customized
                    administrator. The user must have permission to pass the role to AWS CloudFormation. In
                    addition, the customized administrator role must have a trust relationship with
                    the target accounts specified for the stack set. AWS CloudFormation creates the stack set and
                    associates the customized administrator role with it. When updating a stack set,
                    the user must explicitly specify a customized administrator role, even if it's
                    the same customized administrator role used with this stack set previously.
                    AWS CloudFormation uses that role to update the stack, subject to the requirements
                    above.</p>
                <div class="procedure"><h6>Set up permissions for which
                        users and groups can perform stack set operations in specific target
                        accounts</h6><ol><li>
                        <p>For each stack set, create a customized administrator role with
                            permissions to assume the
                                <b>AWSCloudFormationStackSetExecutionRole</b> service
                            role in the target accounts.</p>
                        <p>Create an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html">IAM service role</a> with a custom name, using the following
                            permissions policy:</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::<code class="replaceable">target_account_id</code>:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                        <p>Or, if you want to specify all target accounts, use the following
                            permissions policy:</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::<code class="replaceable">*</code>:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre>
                        <p>You must provide the following trust policy when you create the role
                            to define the trust relationship:</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span> 
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
        "Service": "cloudformation.amazonaws.com" 
      }, 
      "Action": "sts:AssumeRole" 
    } 
  ] 
}</code></pre>
                        <p>Be aware that to deploy stack instances into a target account that
                            resides in a Region that's disabled by default, you will also need to
                            include the regional service principal for that Region. Each Region
                            that's unavailable by default will have its own regional service
                            principal.</p>
                        <p>For more information on regional endpoints, including a list of
                            endpoints, see <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">Regional
                                endpoints</a> in the <em>AWS General Reference
                                Guide</em>.</p>
                        <p>The following example includes the regional service principal
                                (<code class="code">cloudformation.ap-east-1.amazonaws.com</code>) for the
                            Asia Pacific (Hong Kong) Region, a Region which is disabled by default.</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "cloudformation.ap-east-1.amazonaws.com"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                        <p>For more information, see <a href="./stacksets-prereqs.html#stacksets-opt-in-regions">Performing stack set operations involving regions that are disabled by
    default</a>.</p>
                    </li><li>
                        <p>In each target account, create a service role named
                                <b>AWSCloudFormationStackSetExecutionRole</b> that
                            trusts the customized administration role you want to use with this
                            account.</p>
                        <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>You must scope the permissions in the policy statement to the
                                types of resources that you are creating by using StackSets.</p></div></div>
                        <p>The target account service role requires permissions to perform any
                            operations that are specified in your AWS CloudFormation template. For example, if
                            your template is creating an S3 bucket, then you need permissions to
                            create new objects in S3. Your target account always needs full AWS CloudFormation
                            permissions, which include permissions to create, update, delete, and
                            describe stacks.</p>
                        <p>The following example shows a policy statement with the
                                <em>minimum</em> permissions for StackSets to work. To
                            create stacks in target accounts that use resources from services other
                            than AWS CloudFormation, you must add those service actions and resources to the
                                <b>AWSCloudFormationStackSetExecutionRole</b>
                            permissions policy statement for each target account.</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*",
        "s3:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                        <p>You must provide the following trust policy when you create the role
                            to define the trust relationship:</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre>
                    </li><li>
                        <p>Allow users to pass the customized administrator role when performing
                            stack set operations.</p>
                        <p>Attach an IAM permissions policy to users or groups that allows them
                            to pass the appropriate customized administrator role when creating or
                            updating specific stack sets. For more information, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html">Granting a user
                                permissions to pass a role to an AWS service</a>. In the
                            example below, <code class="replaceable">customized_admin_role</code> refers
                            to the administrator role the user needs to pass.</p>

                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "iam:GetRole",
        "iam:PassRole"
      ],
      "Resource": "arn:aws:iam::*:role/<code class="replaceable">customized_admin_role</code>"
    }
  ]
}</code></pre>
                    </li></ol></div>
             
             
                <h3 id="stacksets-prereqs-executionrole">Set up permissions to control
                        stack resource inclusion</h3>
                <p>Use customized execution roles to control which stack resources users and
                    groups can include in their stack sets. For example, you might want to set up a
                    group that can only include Amazon S3-related resources in the stack sets they
                    create, while another team can only include DynamoDB resources. To do this, you
                    create a trust relationship between the customized administrator role for each
                    group and a customized execution role for each set of resources. The customized
                    execution role defines which stack resources can be included in stack sets. The
                    customized administrator role resides in the administrator account, while the
                    customized execution role resides in each target account in which you want to
                    create stack sets using the defined resources. You then activate specific users
                    and groups to use the customized administration role when performing stack set
                    operations.</p>
                <p>For example you can create customized administrator roles A, B, and C in the
                    administrator account. Users and groups with permission to use Role A can create
                    stack sets containing the stack resources specifically listed in customized
                    execution role X, but not those in roles Y or Z, or resource not included in any
                    execution role.</p>
                <div class="mediaobject">
                     
                        <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_admin_execution.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                        Set up a trust relationship between a customized administrator role&#xA;                            and a customized execution role in the target accounts. The user then&#xA;                            passes those roles when creating the stack set.&#xA;                    " style="max-width:100%" />
                     
                     
                </div>
                <p>When updating a stack set, the user must explicitly specify a customized
                    administrator role, even if it's the same customized administrator role used
                    with this stack set previously. AWS CloudFormation performs the update using the customized
                    administrator role specified, so long as the user has permissions to perform
                    operations on that stack set.</p>
                <p>Similarly, the user can also specify a customized execution role. If they
                    specify a customized execution role, AWS CloudFormation uses that role to update the stack,
                    subject to the requirements above. If the user doesn't specify a customized
                    execution role, AWS CloudFormation performs the update using the customized execution role
                    previously associated with the stack set, so long as the user has permissions to
                    perform operations on that stack set.</p>
                <div class="procedure"><h6>Set up permissions for which
                        resources users and groups can include in specific stack sets</h6><ol><li>
                        <p>In the target accounts in which you want to create your stack sets,
                            create a customized execution role that grants permissions to the
                            services and resources that you want users and groups to be able to
                            include in the stack sets.</p>
                        <p>The following example provides the minimum permissions for stack sets,
                            along with permission to create Amazon DynamoDB tables.</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*",
        "s3:*",
      ],
      "Resource": "*"
    },
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "dynamoDb:createTable"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                        <p>You must provide the following trust policy when you create the role
                            to define the trust relationship:</p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre>
                    </li><li>
                        <p>Create a customized administrator role in your administrator account,
                            as detailed in <a href="#stacksets-prereqs-multiadmin">Set up permissions to control
                        target account access</a>. Include a trust
                            relationship between the customized administrator role and the
                            customized execution roles which you want it to use.</p>
                        <p>The following example includes an <code class="code">sts::AssumeRole</code> policy
                            for both the <b>AWSCloudFormationStackSetExecutionRole</b>
                            defined for the target account, in addition to a customized execution
                            role.</p>
                    </li></ol></div>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
   "Statement": [
    <span>{</span>
      "Sid": "Stmt1487980684000",
      "Effect": "Allow",
      "Action": [
        "sts:AssumeRole" 
      ],
      "Resource": [ 
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole",
        "arn:aws:iam::*:role/<code class="replaceable">custom_execution_role</code>" 
      ]
    } 
  ]
}</code></pre>
             
             
                <h3 id="stacksets-prereqs-iam-actions">Set up permissions for specific
                        stack set operations</h3>
                <p>In addition, you can set up permissions for which user and groups can perform
                    specific stack set operations, such as creating, updating, or deleting stack
                    sets or stack instances. For more information, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscloudformation.html">Actions, resources, and
                        condition keys for AWS CloudFormation</a> in the
                        <em>IAM User Guide</em>.</p>
             
         
            <h2 id="confused-deputy-mitigation">Set up global keys to mitigate confused
                    deputy problems</h2>
            <p>The confused deputy problem is a security issue where an entity that doesn't have
                permission to perform an action can coerce a more-privileged entity to perform the
                action. In AWS, cross-service impersonation can result in the confused deputy
                problem. Cross-service impersonation can occur when one service (the
                    <em>calling service</em>) calls another service (the
                    <em>called service</em>). The calling service can be manipulated to
                use its permissions to act on another customer's resources in a way it shouldn't
                otherwise have permission to access. To prevent this, AWS provides tools that help
                you protect your data for all services with service principals that have been given
                access to resources in your account.</p>
            <p>We recommend using the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn"><code class="code">aws:SourceArn</code></a> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount"><code class="code">aws:SourceAccount</code></a> global condition context keys in
                resource policies to limit the permissions that AWS CloudFormation StackSets gives another service to the
                resource. If you use both global condition context keys, the
                    <code class="code">aws:SourceAccount</code> value and the account in the
                    <code class="code">aws:SourceArn</code> value must use the same account ID when used in the
                same policy statement.</p>

            <p>The most effective way to protect against the confused deputy problem is to use the
     <code class="code">aws:SourceArn</code> global condition context key with the full ARN of the resource. If you don't know the
    full ARN of the resource or if you are specifying multiple resources, use the <code class="code">aws:SourceArn</code> global
    context condition key with wildcards (<code class="code">*</code>) for the unknown portions of the ARN. For example,
      <code class="code">arn:aws:<code class="replaceable">cloudformation</code>::<code class="replaceable">123456789012</code>:*</code>.
    Whenever possible, use <code class="code">aws:SourceArn</code>, because it's more specific. Use <code class="code">aws:SourceAccount</code>
    only when you can't determine the correct ARN or ARN pattern.</p>


            <p>When StackSets assumes the <b>Administration</b> role in your
                    <b>administrator</b> account, StackSets populates your
                    <b>administrator</b> account ID and StackSets Amazon Resource
                Name (ARN). Therefore, you can define conditions for <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount">global keys</a>
                <code class="code">aws:SourceAccount</code> and <code class="code">aws:SourceArn</code> in the trust
                relationships to prevent <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html">confused deputy
                problems</a>. The following example shows how you can use the
                    <code class="code">aws:SourceArn</code> and <code class="code">aws:SourceAccount</code> global condition
                context keys in StackSets to prevent the confused deputy problem.</p>
            <div class="example"><h6>Example Global keys for
                        <code class="code">aws:SourceAccount</code> and <code class="code">aws:SourceArn</code></h6><div class="example-contents"><p>When using StackSets, define the global keys
                        <code class="code">aws:SourceAccount</code> and <code class="code">aws:SourceArn</code> in your
                        <code class="code">AWSCloudFormationStackSetAdministrationRole</code> trust policy to
                    prevent confused deputy problems.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>"
        },
        "StringLike": <span>{</span>
          "aws:SourceArn": "arn:aws:cloudformation:*:<code class="replaceable">111122223333</code>:stackset/*"
        }
      }
    }
  ]
}</code></pre></div></div>
            <div class="example"><h6>Example StackSets ARNs</h6><div class="example-contents"><p>Specify your associated StackSets ARNs for finer control.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>",
          "aws:SourceArn": [
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-1</code>",
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-2</code>",
          ]
        }
      }
    }
  ]
}</code></pre></div></div>
        <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./stacksets-prereqs.html">Prerequisites for stack set operations</div><div id="next" class="next-link" accesskey="n" href="./stacksets-orgs-activate-trusted-access.html">Activate trusted
                access with AWS Organizations</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>