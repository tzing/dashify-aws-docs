<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Using AWS CloudFormation macros to perform custom processing on templates - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="template-macros" /><meta name="default_state" content="template-macros" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="description" content="Use macros to perform custom processing on templates, from simple actions like find-and-replace operations to extensive transformations of entire templates." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Using AWS CloudFormation macros to perform custom processing on templates" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Using AWS CloudFormation macros to perform custom processing on templates - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with AWS CloudFormation templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Using AWS CloudFormation macros to perform custom processing on templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#template-macros-overview">How AWS CloudFormation macros work</a><a href="#template-macros-author">Creating an AWS CloudFormation macro definition</a><a href="#template-macros-use">Using AWS CloudFormation macros in your templates</a><a href="#template-macros-examples-list">Macro examples</a><a href="#template-macros-seealso">See also</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="template-macros">Using AWS CloudFormation macros to perform custom processing on
        templates</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Macros enable you to perform custom processing on templates, from simple actions like
        find-and-replace operations to extensive transformations of entire templates.</p><p>To get an idea of the breadth of possibilities, consider the <code class="code">AWS::Include</code> and
            <code class="code">AWS::Serverless</code> transforms, which are macros hosted by AWS CloudFormation:</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p><code class="code"><a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include transform</a></code> enables you to insert boilerplate template snippets into your
                templates.</p>
        </li><li class="listitem">
            <p><code class="code"><a href="./transform-aws-serverless.html">AWS::Serverless transform</a></code> takes an entire template
                written in the AWS Serverless Application Model (AWS SAM) syntax and transforms and expands it into a
                compliant AWS CloudFormation template. (For more information about serverless applications and
                AWS SAM, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/deploying-lambda-apps.html">Deploying Lambda-based applications</a> in the
                    <em>AWS Lambda Developer Guide</em>.)</p>
        </li></ul></div><h2 id="template-macros-overview">How AWS CloudFormation macros work</h2><p>There are two major steps to processing templates using macros:
            <em>creating</em> the macro itself, and then <em>using</em> the
        macro to perform processing on your templates.</p><p>To create a macro definition, you need to create the following:</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p>An AWS Lambda function to perform the template processing. This Lambda function
                accepts either a snippet or an entire template, and any additional parameters that
                you define. It returns the processed template snippet or the entire template as a
                response.</p>
        </li><li class="listitem">
            <p>A resource of type <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></code>, which enables users to call the
                Lambda function from within AWS CloudFormation templates. This resource specifies the ARN of the
                Lambda function to invoke for this macro, and additional optional properties to
                assist with debugging. To create this resource within an account, author a template
                that includes an <code class="code"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></code> resource, and then create either
                a stack or stack set with self-managed permissions from the template. AWS CloudFormation StackSets
                doesn't currently support creating or updating stack sets with service-managed
                permissions from templates that reference macros.</p>
        </li></ul></div><p>To use a macro, reference the macro in your template:</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem">
            <p>To process a section, or <em>snippet</em>, of a template, reference
                the macro in an <code class="code"><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></code> function
                located relative to the template content you want to transform. When using
                    <code class="code">Fn::Transform</code>, you can also pass any specified parameters it
                requires.</p>
        </li><li class="listitem">
            <p>To process an entire template, reference the macro in the <a href="./transform-section-structure.html">Transform</a> section of the template.</p>
        </li></ul></div><p>Next, you typically create a change set and then execute it. (Processing macros can add
        multiple resources that you might not be aware of. To ensure that you're aware of all of the
        changes introduced by macros, we strongly advise that you use change sets.) AWS CloudFormation passes the
        specified template content, along with any additional specified parameters, to the Lambda
        function specified in the macro resource. The Lambda function returns the processed template
        content, be it a snippet or an entire template.</p><p>After all macros in the template have been called, AWS CloudFormation generates a change set that
        includes the processed template content. After you review the change set, execute it to
        apply the changes.</p><div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>If your stack set template references one or more macros, you must create the stack set directly from the
   processed template, without first reviewing the resulting changes in a change set. To create or update the stack set
   directly, you must use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability. Before
   you create or update a stack set from a template that references macros directly, be sure that you know what
   processing the macros performs.</p></div></div><div class="mediaobject">
         
            
            <img src="/images/AWSCloudFormation/latest/UserGuide/images/template-macro-use.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;            Use the Fn::Transform intrinsic function or the&#xA;                    Transform section of the template, to pass the template contents&#xA;                and associated parameters to the macro's underlying Lambda function, which returns&#xA;                the processed template contents.&#xA;        " style="max-width:100%" />
         
         
    </div><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you are comfortable creating or updating a stack directly from a processed
            template, without first reviewing the proposed changes in a change set, you can do so by
            specifying the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability during a
                <code class="code">CreateStack</code> or <code class="code">UpdateStack</code> request. You should only create
            stacks directly from a template that references macros if you know what processing the
            macros performs.</p><p>For more information, see <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html">CreateStack</a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html">UpdateStack</a> in the
    <em>AWS CloudFormation API Reference</em>.</p></div></div><h2 id="template-macros-author">Creating an AWS CloudFormation macro definition</h2>
        <p>When you create a macro definition, the macro definition makes the underlying Lambda
            function available in the specified account so that AWS CloudFormation invokes it to process the
            templates.</p>
        
        <h3 id="template-macros-lambda-interface">AWS CloudFormation macro function interface</h3>
            <p>For macros, AWS CloudFormation invokes the underlying Lambda functions with the following event
                mapping. AWS CloudFormation sends its request in JSON format, and it expects the function
                response to be formatted as JSON too.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "region" : "<code class="replaceable">us-east-1</code>",
    "accountId" : "<code class="replaceable">$ACCOUNT_ID</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> },
    "transformId" : "<code class="replaceable">$TRANSFORM_ID</code>",
    "params" : <span>{</span> <code class="replaceable">...</code> },
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "templateParameterValues" : <span>{</span> <code class="replaceable">...</code> }
}</code></pre>

            <div class="itemizedlist">
                 
                 
                 
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><b>region</b></p>
                    <p>The Region in which the macro resides.</p>
                </li><li class="listitem"><p><b>accountId</b></p>
                    <p>The account ID of the account from which the macro is invoking the Lambda function.</p>
                </li><li class="listitem"><p><b>fragment</b></p>
                    <p>The template content available for custom processing, in JSON
                        format.</p>
                    <div class="itemizedlist">
                         
                         
                    <ul class="itemizedlist"><li class="listitem"><p>For macros included in the <code class="code">Transform</code> template section, this is the entire
                                template except for the <code class="code">Transform</code> section.</p></li><li class="listitem"><p>For macros included in an <code class="code">Fn::Transform</code> intrinsic function call, this includes
                                all sibling nodes (and their children) based on the location of the
                                intrinsic function within the template except for the
                                    <code class="code">Fn::Transform</code> function. For more information, see
                                    <a href="#template-macros-scope">AWS CloudFormation macro scope</a>.</p></li></ul></div>
                </li><li class="listitem"><p><b>transformId</b></p>
                    <p>The name of the macro invoking this function.</p>
                </li><li class="listitem"><p><b>params</b></p>
                    <p>For <code class="code">Fn::Transform</code> function calls, any specified parameters
                        for the function. AWS CloudFormation doesn't evaluate these parameters before passing
                        them to the function.</p>
                    <p>For macros included in the <code class="code">Transform</code> template section, this
                        section is empty.</p>
                </li><li class="listitem"><p><b>requestId</b></p>
                    <p>The ID of the request invoking this function.</p>
                </li><li class="listitem"><p><b>templateParameterValues</b></p>
                    <p>Any parameters specified in the <a href="./parameters-section-structure.html">Parameters</a> section of the template.
                        AWS CloudFormation evaluates these parameters before passing them to the function.</p>
                </li></ul></div>
            <p>AWS CloudFormation expects the underlying function to return a response in the following JSON format:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "status" : "<code class="replaceable">$STATUS</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> }
    "errorMessage": "optional error message for failures"
}</code></pre>
            <div class="itemizedlist">
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><b>requestId</b></p>
                    <p>The ID of the request invoking this function. This must match the request
                        ID provided by AWS CloudFormation when invoking the function.</p>
                </li><li class="listitem"><p><b>status</b></p>
                    <p>The status of the request (case-insensitive). Should be set to <code class="code">success</code>.
                        AWS CloudFormation treats any other response as a failure.</p>
                </li><li class="listitem"><p><b>fragment</b></p>
                    <p>The processed template content for AWS CloudFormation to include in the processed
                        template, including siblings. AWS CloudFormation replaces the template content that is
                        passed to the Lambda function with the template fragment it receives in the
                        Lambda response.</p>
                    <p>The processed template content must be valid JSON, and its inclusion in the processed template must result in a valid template.</p>
                    <p>If your function doesn't actually change the template content that AWS CloudFormation
                        passes to it, but you still need to include that content in the processed
                        template, your function needs to return that template content to AWS CloudFormation in
                        its response.</p>
                </li><li class="listitem">
                    <p><b>errorMessage</b></p>
                    <p>The error message that explains why the transform failed. CloudFormation
                        displays this error message in the <b>Events</b> pane of the
                            <b>Stack details</b> page for your stack.</p>
                    <p>For example, "Error creating change set: Transform <code class="replaceable">AWS account
                        account number</code>::<code class="replaceable">macro name</code>
                        failed with: <code class="replaceable">error message string</code>".</p>
                </li></ul></div>
            <p>For information about additional considerations when creating macros, see <a href="#template-macros-considerations">Considerations when creating AWS CloudFormation macro
                    definitions</a>.</p>
         
        
        <h3 id="template-macros-permissions">AWS CloudFormation macro account scope and permissions</h3>
            <p>You can use macros only in the account in which they were created as a resource.
                The name of the macro must be unique within a given account. However, you can make
                the same functionality available in multiple accounts by enabling cross-account
                access on the underlying Lambda function, and then creating macro definitions
                referencing that function in multiple accounts. In the example below, three accounts
                contain macro definitions that each point to the same Lambda function.</p>
            <div class="mediaobject">
                 
                    <img src="/images/AWSCloudFormation/latest/UserGuide/images/template-macro-accounts.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                    By allowing cross-account access on the Lambda function, AWS enables you&#xA;                        to create macros in multiple accounts that reference that function.&#xA;                " style="max-width:100%" />
                 
                 
            </div>
            <p>For more
                information, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/access-control-overview.html">Overview of
                    managing access permissions to your AWS Lambda resources</a> in the
                <em>AWS Lambda Developer Guide</em>.</p>
            <p>To create a macro definition, the user must have permissions to create a stack or
                stack set within the specified account.</p>
            <p>In order for AWS CloudFormation to successfully run a macro included in a template, the user
                must have <code class="code">Invoke</code> permissions for the underlying Lambda function. To
                prevent potential escalation of permissions, AWS CloudFormation impersonates the user while
                running the macro. For more information, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html">Lambda permissions model</a>
                in the <em>AWS Lambda Developer Guide</em> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_lambda.html">Actions and condition context keys for
                    AWS Lambda</a> in the <em>IAM User Guide</em>.</p>
            <p>The <a href="./transform-aws-serverless.html">AWS::Serverless transform</a> and <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include transform</a> transforms are macros hosted by AWS CloudFormation. No special permissions are necessary to
                use them, and they're available from within any account in AWS CloudFormation.</p>
          
        <h3 id="template-macros-debug">Debugging AWS CloudFormation macros</h3>
            <p>To aid in debugging, you can also specify the <code class="code">LogGroupName</code> and <code class="code">LogRoleArn</code> properties when creating the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a> resource type for your macro. These properties enable you to specify the CloudWatch log group to which AWS CloudFormation sends error logging information when invoking the macro's underlying AWS Lambda function, and the role AWS CloudFormation should assume when sending log entries to those logs.</p>
          
        <h3 id="template-macros-billing">Billing</h3>
            <p>When a macro runs, the owner of the Lambda function is billed for any charges
                related to the execution of that function.</p>
            <p>The <a href="./transform-aws-serverless.html">AWS::Serverless transform</a> and <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include transform</a> transforms are macros hosted by AWS CloudFormation. There is no charge for using them.</p>
         
        <h3 id="template-macros-considerations">Considerations when creating AWS CloudFormation macro
                    definitions</h3>
            <p>When creating macro definitions, keep the following in mind:</p>
            <div class="itemizedlist">
                 
                 
                 
                 
                
                 
                 
                 
                
                 
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p>Macros are supported only in AWS Regions where AWS Lambda is available. For a list of Regions
                        where Lambda is available, see <a href="https://docs.aws.amazon.com/general/latest/gr/lambda-service.html">AWS Lambda endpoints and quotas</a>.</p></li><li class="listitem"><p>Any processed template snippets must be valid JSON.</p></li><li class="listitem"><p>Any processed template snippets must pass validation checks for a create stack, update stack,
                        create stack set, or update stack set operation.</p></li><li class="listitem"><p>AWS CloudFormation resolves macros first, and then processes the template. The resulting template must be
                        valid JSON and must not exceed the template size limit.</p></li><li class="listitem"><p>Because of the order in which CloudFormation processes elements in a template, a macro can't
                        include modules in the processed template content it returns to CloudFormation.
                        For more information about modules, see <a href="https://docs.aws.amazon.com/cloudformation-cli/latest/userguide/modules.html">Developing
                            modules</a> in the <em>CloudFormation CLI User
                        Guide</em>.</p></li><li class="listitem"><p>When using the update rollback feature, AWS CloudFormation uses a copy of the original template. It rolls
                        back to the original template even if the included snippet was
                        changed.</p></li><li class="listitem"><p>Including macros within macros doesn't work because we don't process macros
                        iteratively.</p></li><li class="listitem"><p>The <code class="code">Fn::ImportValue</code> intrinsic function isn't currently supported in macros.</p></li><li class="listitem"><p>Intrinsic functions included in the template are evaluated after any macros. Therefore, the
                        processed template content your macro returns can include calls to intrinsic
                        functions, and they're evaluated as usual.</p></li><li class="listitem"><p>StackSets doesn't currently support creating or updating stack sets with service-managed
                        permissions from templates that reference AWS CloudFormation macros.</p></li><li class="listitem"><p>If your stack set template references one or more macros, you must create or update the stack set directly from
      the processed template, without first reviewing the resulting changes in a change set. To create or update the
      stack set directly, use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability.
      Processing macros can add multiple resources that you might not be aware of. Before you create or update a stack
      set from a template that references macros directly, be sure that you know what processing the macros
      performs.</p></li><li class="listitem">
                    
                    <p>Change sets don't currently support nested stacks. If you want to create or update a stack
      using a template that references macros <em>and</em> contains nested stacks, you must create or update
      the stack directly. To perform this, use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html"><code class="code">CreateStack</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html"><code class="code">UpdateStack</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability.</p>
                </li></ul></div>
         
        <div class="procedure"><h6>To create an AWS CloudFormation macro definition:</h6><ol><li>
                <p><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-app.html"> Build an AWS Lambda function</a>
                    that processes AWS CloudFormation templates.</p>
                <p>The Lambda function you build performs the processing of the template contents.
                    Your function can process any part of a template, up to the entire template. For
                    information about the event mapping to which your function must adhere, see
                        <a href="#template-macros-lambda-interface">AWS CloudFormation macro function interface</a>. For information about
                    additional considerations when creating macros, see <a href="#template-macros-considerations">Considerations when creating AWS CloudFormation macro
                    definitions</a>.</p>
            </li><li>
                <p><a href="./template-guide.html">Create a template</a> containing an <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a> resource type.</p>
                <div class="itemizedlist">
                     
                     
                <ul class="itemizedlist"><li class="listitem"><p>You must specify the <code class="code">Name</code> and <code class="code">FunctionName</code> properties. The <code class="code">FunctionName</code> property specifies the ARN of the Lambda function to invoke when AWS CloudFormation runs the macro.</p></li><li class="listitem"><p>To aid in debugging, you can also specify the <code class="code">LogGroupName</code> and
                                <code class="code">LogRoleArn</code> properties.</p></li></ul></div>
            </li><li>
                <p><a href="./cfn-console-create-stack.html">Create a stack</a> from the template containing the macro
                    in the desired account, or <a href="./stacksets-getting-started-create.html#stacksets-getting-started-create-self-managed">create a stack set
                        with self-managed permissions</a> from the template referencing the macro in the administrator account, then create stack instances in the desired target accounts.</p>
                <p>After AWS CloudFormation has successfully created stacks that contains the macro
                    definition, the macro is available for use within those accounts.</p>
            </li></ol></div>


    <h2 id="template-macros-use">Using AWS CloudFormation macros in your templates</h2>
        <p>After AWS CloudFormation has successfully created the stacks that contain the macro
            definition, the macro is available for use within those accounts. You use a macro by
            referencing it in a template, at the appropriate location relevant to the
            template contents you want to process.</p>
        <h3 id="template-macros-order">AWS CloudFormation macro evaluation order</h3>
            <p>You can reference multiple macros in a given template, including transforms hosted
                by AWS CloudFormation, such as <a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include transform</a> and <a href="./transform-aws-serverless.html">AWS::Serverless transform</a>.</p>
            <p>Macros are evaluated in order, based on their location in the template, from the
                most deeply nested outward to the most general. Macros at the same location in the
                template are evaluated serially based on the order in which they're listed.</p>
            <p>Transforms such as <code class="code">AWS::Include</code> and <code class="code">AWS::Transform</code> are
                treated the same as any other macros in terms of action order and scope.</p>
            <p>For example, in the template sample below, AWS CloudFormation evaluates the
                    <code class="code">PolicyAdder</code> macro first, because it's the most deeply-nested macro
                in the template. AWS CloudFormation then evaluates <code class="code">MyMacro</code> before evaluating
                    <code class="code">AWS::Serverless</code> because it's listed before
                    <code class="code">AWS::Serverless</code> in the <code class="code">Transform</code> section.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
 Transform: [MyMacro, AWS::Serverless]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: MyBucket
        Tags: [<span>{</span>"key":"value"}]
        'Fn::Transform':
          - Name: PolicyAdder
        CorsConfiguration:[]
    MyEc2Instance:
      Type: 'AWS::EC2::Instance'
      Properties:
        ImageID: "ami-123"</code></pre>
          
        
        <h3 id="template-macros-scope">AWS CloudFormation macro scope</h3>
            <p>Macros referenced in the <code class="code">Transform</code> section of a template can process
                the entire contents of that template.</p>
            <p>Macros referenced in an <code class="code">Fn::Transform</code> function can process the
                contents of any of the sibling elements (including children) of that
                    <code class="code">Fn::Transform</code> function in the template.</p>
            <p>For example, in the template sample below, <code class="code">AWS::Include</code> can process
                the <code class="code">MyBucket</code> properties, based on the location of the
                    <code class="code">Fn::Transform</code> function that contains it. <code class="code">MyMacro</code> can
                process the contents of the entire template because of its inclusion in the
                    <code class="code">Transform</code> section.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">
// Start of processable content for MyMacro
AWSTemplateFormatVersion: 2010-09-09 
 Transform: [MyMacro]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: 'AWS::S3::Bucket'  //Start of processable content for AWS::Include
      Properties:
        BucketName: MyBucket 
        Tags: [<span>{</span>"key":"value"}] 
        'Fn::Transform':
          - Name: 'AWS::Include'
              Parameters:
                Location: s3://<code class="replaceable">DOC-EXAMPLE-BUCKET</code>/MyFileName.yaml
        CorsConfiguration:[]   //End of processable content for AWS::Include
    MyEc2Instance:
      Type: 'AWS::EC2::Instance' 
      Properties:
        ImageID: "ami-123"
// End of processable content for MyMacro         </code></pre>
          
        
         
         <h3 id="template-macros-change-sets">Change sets and AWS CloudFormation macros</h3>
            <p>To create or update a stack using a template that references macros, you typically
                create a change set and then execute it. A change set describes the actions
                CloudFormation will take based on the processed template. Processing macros can add
                multiple resources that you might not be aware of. To ensure that you're aware of
                all the changes introduced by macros, we strongly suggest you use change sets. After
                you review the change set, you can execute it to actually apply the changes.</p>
            <p>A macro can add IAM resources to your template. For these resources, AWS CloudFormation
                requires you to <a href="./using-iam-template.html#using-iam-capabilities">acknowledge their
                    capabilities</a>. Because AWS CloudFormation can't know which resources are added
                before processing your template, you might need to acknowledge IAM
                capabilities when you create the change set, depending on whether the referenced
                macros contain IAM resources. That way, when you run the change set, AWS CloudFormation has
                the necessary capabilities to create IAM resources.</p>
            <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>If your stack set template references one or more macros, you must create the stack set directly
     from the processed template, without first reviewing the resulting changes in a change set. To create or update the
     stack set directly, you must use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability.
     Before you create or update a stack set from a template that references macros directly, be sure that you know what
     processing the macros performs.</p></div></div>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you are comfortable creating or updating a stack directly from a processed template, without
     first reviewing the proposed changes in a change set, you can do so by specifying the
      <code class="code">CAPABILITY_AUTO_EXPAND</code> capability during a <code class="code">CreateStack</code> or <code class="code">UpdateStack</code>
     request. You should only create stacks directly from a stack template that contains macros if you know what
     processing the macro performs. You can't use change sets with stack set macros; you must update your stack set
     directly.</p><p>For more information, see <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStack.html"><code class="code">CreateStack</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStack.html"><code class="code">UpdateStack</code></a> in the <em>AWS CloudFormation API Reference</em>.</p></div></div>
            <p>If you use the AWS CLI, you can use the <code class="code">package</code> and
                <code class="code">deploy</code> commands to reduce the number of steps for launching
                stacks from templates that reference macros. For more information, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/deploying-lambda-apps.html">Deploying Lambda-based
                    applications</a> in the <em>AWS Lambda Developer Guide</em>.</p>
         
   
        <h3 id="template-macros-template-stage">Template stage and CloudFormation macros</h3>
            <p>A template's <em>stage</em> indicates whether the template is the
                original user-submitted template or one in which AWS CloudFormation has processed the
                macros.</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p><code class="code">Original</code>: The template that the user originally submitted to create or update the
                        stack or stack set.</p></li><li class="listitem"><p><code class="code">Processed</code>: The template AWS CloudFormation used to create or update the stack or stack set after processing
                        any referenced macros. The processed template is formatted as JSON, even if
                        the original template was formatted as YAML.</p></li></ul></div>
            <p>Use the processed template for troubleshooting stack issues. If a template
                doesn't reference macros, the original and processed templates are
                identical.</p>
            <p>You can use the AWS CloudFormation <a href="./cfn-console-view-stack-data-resources.html">console</a> or <a href="./using-cfn-get-template.html">AWS CLI</a> to see the
                stage of a stack template.</p>
            <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>The maximum size for a processed stack template is 51,200 bytes when passed
                    directly into a <code class="code">CreateStack</code>, <code class="code">UpdateStack</code>, or
                        <code class="code">ValidateTemplate</code> request, or 1 MB when passed as an S3 object
                    using an Amazon S3 template URL. However, during processing CloudFormation updates the
                    temporary state of the template as it serially processes the macros contained in
                    the template. Because of this, the size of the template <em>during
                        processing</em> may temporarily exceed the allowed size of a
                    fully-processed template. CloudFormation allows some buffer for these in-process
                    templates. However, you should design your templates and macros keeping in mind
                    the maximum allowed size for a processed stack template.</p><p>If CloudFormation returns a <code class="code">Transformation data limit exceeded</code>
                    error while processing your template, your template has exceeded the maximum
                    template size CloudFormation allows during processing.</p><p>To resolve this issue, consider doing the following:</p><div class="itemizedlist">
                     
                     
                <ul class="itemizedlist"><li class="listitem"><p>Restructure your template into multiple templates to
                        avoid exceeding the maximum size for in-process templates. For example:</p>
                        <div class="itemizedlist">
                             
                             
                        <ul class="itemizedlist"><li class="listitem"><p>Use nested stack templates to encapsulate parts of the template. For more information, see <a href="./using-cfn-nested-stacks.html">Working with nested stacks</a>.</p></li><li class="listitem"><p>Create multiple stacks and use cross-stack references to exchange information between them. For more information, see <a href="./walkthrough-crossstackref.html">Walkthrough: Refer to resource outputs in another
    AWS CloudFormation stack</a>.</p></li></ul></div>
                    </li><li class="listitem"><p>Reduce the size of template fragment returned by a given macro. CloudFormation doesn't tamper with
                            the contents of fragments returned by macros.</p></li></ul></div></div></div>
         
        
        <div class="procedure"><h6>To use an AWS CloudFormation macro in your template</h6><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>In order for AWS CloudFormation to successfully run a macro referenced in a template, the user must have
                        <code class="code">Invoke</code> permissions for the underlying Lambda function. For more
                    information, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/access-control-overview.html">Overview
                        of managing access permissions to your AWS Lambda resources</a> in the
                        <em>AWS Lambda Developer Guide</em>.</p></div></div><ol><li>
                <p>Include a reference to the macro in the template.</p>
                <div class="itemizedlist">
                     
                      
                <ul class="itemizedlist"><li class="listitem">
                        <p>To process a template snippet, reference the macro in a <code class="code"><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></code>
                            function located relative to the template content you want to
                            process.</p>
                    </li><li class="listitem">
                        <p>To process the entire template, reference the macro in the <a href="./transform-section-structure.html">Transform</a> section of the
                            template.</p>
                    </li></ul></div>
            </li><li>
                <p><a href="./using-cfn-updating-stacks-changesets-create.html">Create a change set</a> using the template.</p>
                <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>If your stack set template references one or more macros, you must create the stack set
      directly from the processed template, without first reviewing the resulting changes in a change set. To create or
      update the stack set directly, you must use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability.
      Before you create or update a stack set from a template that references macros directly, be sure that you know
      what processing the macros performs.</p></div></div>
            </li><li>
                <p>Review and <a href="./using-cfn-updating-stacks-changesets-execute.html">run the change
                        set</a>.</p>
                <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>If your stack set template references one or more macros, you must create the stack set
      directly from the processed template, without first reviewing the resulting changes in a change set. To create or
      update the stack set directly, you must use the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_CreateStackSet.html"><code class="code">CreateStackSet</code></a> or <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_UpdateStackSet.html"><code class="code">UpdateStackSet</code></a> action and specify the <code class="code">CAPABILITY_AUTO_EXPAND</code> capability.
      Before you create or update a stack set from a template that references macros directly, be sure that you know
      what processing the macros performs.</p></div></div>
            </li></ol></div>

     
        <h2 id="template-macros-examples-list">Macro examples</h2>
        <p>In addition to the <a href="./macros-example.html">Macro example: Creating and using a macro</a>
            walkthrough in this guide, you can find example macros, including source code and
            templates, in the <a href="https://github.com/awslabs/aws-cloudformation-templates/tree/master/aws/services/CloudFormation/MacrosExamples/" rel="noopener noreferrer" target="_blank"><span>Macros examples</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> section of the <a href="https://github.com/awslabs" rel="noopener noreferrer" target="_blank"><span>Amazon Web Services - Labs</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> repo on GitHub. These examples are provided
            'as-is' for instructional purposes.</p>
    <h2 id="template-macros-seealso">See also</h2>
        <p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-macro.html">AWS::CloudFormation::Macro</a></p>

        <p><a href="./transform-section-structure.html">Transform</a></p>
        <p><a href="./intrinsic-function-reference-transform.html">Fn::Transform</a></p>
        
        <p><a href="./transform-aws-serverless.html">AWS::Serverless transform</a></p>
        <p><a href="./create-reusable-transform-function-snippets-and-add-to-your-template-with-aws-include-transform.html">AWS::Include transform</a></p>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./crpg-ref-requesttypes-update.html">Update</div><div id="next" class="next-link" accesskey="n" href="./macros-example.html">Macro example: Creating and using a macro</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>