<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Executar implantações azul/verde do ECS por meio do CodeDeploy usando o AWS CloudFormation - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="blue-green" /><meta name="default_state" content="blue-green" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="description" content="Usar modelos do AWS CloudFormation para gerenciar implantações azul/verde do ECS por meio do AWS CodeDeploy." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="Guia do usuário" /><meta name="abstract" content="Crie e gerencie implantações da infraestrutura da AWS de maneira previsível e que pode ser repetida usando o AWS CloudFormation com este Guia do usuário." /><meta name="guide-locale" content="pt_br" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="Guia do usuário" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="Guia do usuário" /><meta id="panorama-serviceConsolePage" value="Executar implantações azul/verde do ECS por meio do CodeDeploy usando o AWS CloudFormation" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Executar implantações azul/verde do ECS por meio do CodeDeploy usando o AWS CloudFormation - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,provisionamento de recursos,configuração de recursos,gerenciamento da infraestrutura,CloudFormer,Pilha do CloudFormation,Stackset do CloudFormation,Modelo do CloudFormation,conjunto de alterações" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Guia do usuário",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Trabalhar com modelos do AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Executar implantações azul/verde do ECS por meio do CodeDeploy usando o AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-guide.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentação</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">Guia do usuário</a></div><div id="page-toc-src"><a href="#blue-green-required">Modelar sua implantação azul/verde usando recursos do CloudFormation</a><a href="#blue-green-resources">Atualizações de recursos que acionam implantações verdes</a><a href="#blue-green-considerations">Considerações ao gerenciar implantações azul/verde do ECS usando o CloudFormation</a><a href="#blue-green-setup">Preparar seu modelo para executar implantações azul/verde do ECS</a><a href="#blue-green-changesets">Revisar os conjuntos de alterações para a implantação azul/verde</a><a href="#blue-green-events">Visualizar eventos da pilha para sua implantação azul/verde</a><a href="#blue-green-template-reference">Referência do modelo</a><a href="#blue-green-iam">Permissões do IAM necessárias para implantações azul/verde</a><a href="#blue-green-template-example">Exemplo de modelo</a></div><div id="page-filters" style="display:none"><filter label="All" id="All"></filter><filter label="JSON" id="JSON"></filter><filter label="YAML" id="YAML"></filter></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="blue-green">Executar implantações azul/verde do ECS por meio do CodeDeploy usando o AWS CloudFormation</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>É possível usar o CloudFormation para executar implantações azul/verde do ECS por meio do AWS CodeDeploy. As implantações azul/verde são uma estratégia de implantação segura fornecida pelo  CodeDeploy para minimizar interrupções causadas pela alteração das versões da aplicação. Isso é realizado por meio da criação de seu novo ambiente de aplicativo, chamado de <em>verde</em>, junto com seu aplicativo atual que está veiculando seu tráfego dinâmico, chamado de <em>azul</em>. Isso permite um período para o monitoramento e o teste do ambiente verde antes que o tráfego dinâmico seja roteado de azul para verde e, posteriormente, desative os recursos azuis.</p><p>Ao usar o CloudFormation para executar implantações azul/verde do ECS, você começa criando um modelo de pilha que define os recursos para seus ambientes de aplicativo azul e verde, incluindo a especificação das configurações de roteamento de tráfego e de estabilização a serem usadas. Depois, você cria uma pilha a partir desse modelo, o que gera sua aplicação azul (atual). O CloudFormation cria somente os recursos azuis durante a criação da pilha. Os recursos para uma implantação verde não são criados até que sejam necessários.</p><p>Depois, se em uma futura atualização de pilha você atualizar os recursos de definição de tarefa ou do conjunto de tarefas no aplicativo azul, o CloudFormation fará o seguinte:</p><div class="itemizedlist">
         
         
         
    <ul class="itemizedlist"><li class="listitem"><p>Gerará todos os recursos de ambiente do aplicativo verde necessários</p></li><li class="listitem"><p>Deslocará o tráfego com base nos parâmetros de roteamento de tráfego especificados</p></li><li class="listitem"><p>Excluirá os recursos azuis</p></li></ul></div><p>Se ocorrer um erro em qualquer ponto antes da implantação verde ser finalizada com êxito, o CloudFormation reverterá a pilha para seu estado anterior ao início de toda a implantação verde.</p><p>Para permitir que o CloudFormation execute implantações azul/verde em uma pilha, inclua as seguintes informações no modelo de pilha:</p><div class="itemizedlist">
         
         
    <ul class="itemizedlist"><li class="listitem"><p>Uma seção do <code class="code">Transform</code> em seu modelo que invoque a transformação <code class="code">AWS::CodeDeployBlueGreen</code>, e uma seção <code class="code">Hook</code> que invoque o hook <code class="code">AWS::CodeDeploy::BlueGreen</code>.</p></li><li class="listitem"><p>Pelo menos um dos recursos do ECS que acionará uma implantação azul/verde se for substituído durante uma atualização de pilha. Atualmente, esses recursos são <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> e <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a>.</p></li></ul></div><p>Depois, se você iniciar uma atualização de pilha que atualize qualquer propriedade dos recursos acima que exijam que o CloudFormation substitua o recurso, o CloudFormation executará uma implantação azul/verde conforme descrito acima. Para obter mais informações sobre o comportamento de atualização de recurso, consulte <a href="./using-cfn-updating-stacks-update-behaviors.html">Atualizar comportamentos de recursos da pilha</a>.</p><p>Em alguns casos, será melhor configurar seu modelo de pilha para habilitar implantações azul/verde <em>antes</em> de criar a pilha. No entanto, também é possível adicionar a possibilidade de fazer com que o CloudFormation execute implantações azul/verde em uma pilha existente. Para fazer isso, adicione as informações necessárias ao modelo existente da pilha.</p><p>Além disso, recomendamos que o CloudFormation gere um conjunto de alterações para a implantação verde, antes de iniciar a atualização da pilha. Isso permite que você revise as alterações que serão feitas na pilha. Para ter mais informações, consulte <a href="./using-cfn-updating-stacks-changesets.html">Atualizar pilhas usando conjuntos de alterações</a>.</p>
        <h2 id="blue-green-required">Modelar sua implantação azul/verde usando recursos do CloudFormation</h2>
        <p>Para executar a implantação azul/verde do ECS usando CodeDeploy por meio do CloudFormation, o modelo deve incluir os recursos que modelam sua implantação, como um serviço do Amazon ECS e um balanceador de carga. Para mais detalhes sobre o que esses recursos representam, consulte <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployment-steps-ecs.html#deployment-steps-prerequisites-ecs">Antes de iniciar uma implantação do Amazon ECS</a> no <em>AWS CodeDeployGuia do usuário</em>.</p>
        <div class="table-container"><div class="table-contents"><table id="w1348aac17c33c25b5"><thead>
                    <tr>
                        <th>Requisito</th>
                        <th>Recurso</th>
                        <th>Obrigatório/opcional</th>
                        <th>Aciona a implantação azul/verde se substituído</th>
                    </tr>
                </thead>
                    <tr>
                        <td tabindex="-1">Cluster do Amazon ECS</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-cluster.html"><code class="code">AWS::ECS::Cluster</code></a></td>
                        <td tabindex="-1">Opcional. O cluster padrão pode ser usado.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Serviço do Amazon ECS</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html"><code class="code">AWS::ECS::Service</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Application ou Network Load Balancer</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-service-loadbalancer.html"><code class="code">AWS::ECS::Service
       LoadBalancer</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Listener de produção</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Listener de teste </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html"><code class="code">AWS::ElasticLoadBalancingV2::Listener</code></a></td>
                        <td tabindex="-1">Opcional.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Dois grupos de destino</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html"><code class="code">AWS::ElasticLoadBalancingV2::TargetGroup</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Definição de tarefa do Amazon ECS </td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Sim</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Contêiner para seu aplicativo do Amazon ECS</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-containerdefinitions.html#cfn-ecs-taskdefinition-containerdefinition-name.html"><code class="code">AWS::ECS::TaskDefinition ContainerDefinition Name</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                    <tr>
                        <td tabindex="-1">Porta para o conjunto de tarefas de substituição</td>
                        <td tabindex="-1"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-portmapping.html#cfn-ecs-taskdefinition-portmapping-containerport"><code class="code">AWS::ECS::TaskDefinition PortMapping ContainerPort</code></a></td>
                        <td tabindex="-1">Obrigatório.</td>
                        <td tabindex="-1">Não</td>
                    </tr>
                </table></div></div>
     
        <h2 id="blue-green-resources">Atualizações de recursos que acionam implantações verdes</h2>
        <p>Se você executar uma atualização de pilha que atualize qualquer propriedade que exija <a href="./using-cfn-updating-stacks-update-behaviors.html">substituição</a> dos seguintes recursos do ECS, o CloudFormation iniciará uma implantação verde:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a></p></li><li class="listitem"><p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskset.html"><code class="code">AWS::ECS::TaskSet</code></a> </p></li></ul></div>
        
        <p>Atualizar propriedades nesses recursos que não exigem substituição de recursos não aciona uma implantação verde.</p>
        <p>Não é possível incluir atualizações para os recursos acima com atualizações para outros recursos na mesma atualização de pilha. Se for necessário atualizar recursos na lista acima, bem como outros recursos na mesma pilha, siga um destes procedimentos:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Execute duas operações de atualização de pilha separadas: uma que inclua somente as atualizações para os recursos acima e uma atualização de pilha separada que inclua alterações em quaisquer outros recursos.</p></li><li class="listitem"><p>Remova as seções <code class="code">Hook</code> e <code class="code">Transform</code> do modelo e execute a atualização da pilha. Neste caso, o CloudFormation não executará uma implantação verde.</p></li></ul></div>
     
        <h2 id="blue-green-considerations">Considerações ao gerenciar implantações azul/verde do ECS usando o CloudFormation</h2>
        <p>Considere o seguinte ao definir sua implantação azul/verde usando o CloudFormation:</p>
        <div class="itemizedlist">
             
             
             
             
             
             
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Somente atualizações de determinados recursos acionarão uma implantação verde, conforme discutido em <a href="#blue-green-resources">Atualizações de recursos que acionam implantações verdes</a>.</p></li><li class="listitem"><p>Não é possível incluir atualizações de recursos que acionam implantações verdes e atualizações de outros recursos na mesma atualização de pilha, conforme discutido em <a href="#blue-green-resources">Atualizações de recursos que acionam implantações verdes</a>.</p></li><li class="listitem"><p>Só é possível especificar um único serviço do ECS como o destino de implantação.</p></li><li class="listitem"><p>Os parâmetros que tenham valores ofuscados pelo CloudFormation não poderão ser atualizados pelo serviço CodeDeploy durante uma implantação verde, e causarão um erro e uma falha na atualização da pilha. Isso inclui:</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem"><p>Parâmetros definidos com o atributo <code class="code">NoEcho</code>.</p></li><li class="listitem"><p>Parâmetros que usam referências dinâmicas para recuperar seus valores de serviços externos. Para ter mais informações, consulte <a href="./dynamic-references.html">Usar referências dinâmicas para especificar valores de modelos</a>.</p></li></ul></div>
            </li><li class="listitem"><p>Para cancelar uma implantação verde que ainda está em andamento, cancele a atualização da pilha no CloudFormation, e não no CodeDeploy ou ECS. Para ter mais informações, consulte <a href="./using-cfn--stack-update-cancel.html">Cancelar uma atualização de pilha</a>. (Após a conclusão de uma atualização, não será possível cancelá-la. Porém, é possível atualizar uma pilha novamente com as configurações anteriores.)</p></li><li class="listitem"><p>No momento, não há suporte à declaração de <a href="./outputs-section-structure.html">Outputs</a> ou ao uso de para importar valores de outras pilhas para modelos que definem implantações azul/verde do ECS.</p></li><li class="listitem"><p>No momento, não há suporte a modelos que definem implantações azul/verde do ECS.</p></li><li class="listitem"><p>Não é possível usar o hook <code class="code">AWS::CodeDeploy::BlueGreen</code> em um modelo que inclua recursos de pilha aninhados.</p></li><li class="listitem"><p>Não é possível usar o hook <code class="code">AWS::CodeDeploy::BlueGreen</code> em uma <a href="./using-cfn-nested-stacks.html">pilha aninhada</a>.</p></li></ul></div>
        <p>Para obter informações sobre como o uso do CloudFormation para executar suas implantações do ECS azul/verde por meio de CodeDeploy difere de uma implantação padrão do Amazon ECS usando apenas CodeDeploy, consulte <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/deployments-create-prerequisites.html">Diferenças entre implantações azul/verde do Amazon ECS por meio do CloudFormation e implantações padrão do Amazon ECS</a>, no <em>Guia do usuário do AWS CodeDeploy</em>.</p>
     
        <h2 id="blue-green-setup">Preparar seu modelo para executar implantações azul/verde do ECS</h2>
        <p>Para permitir implantações azul/verde em sua pilha, inclua as seções a seguir no modelo de pilha antes de executar uma atualização dela.</p>
        <div class="itemizedlist">
             
             
             
        <ul class="itemizedlist"><li class="listitem"><p>Adicione uma referência à transformação <code class="code">AWS::CodeDeployBlueGreen</code> ao modelo:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],</code></pre>
</li><li class="listitem"><p>Adicione uma seção <code class="code">Hook</code> que invoque o hook <code class="code">AWS::CodeDeploy::BlueGreen</code> e especifique as propriedades para a implantação. Use a referência do modelo abaixo como guia.</p></li><li class="listitem"><p>Na seção <code class="code">Resources</code>, defina os recursos azuis e verdes para a implantação.</p></li></ul></div>
        <p>É possível adicionar essas seções ao criar o modelo pela primeira vez (ou seja, antes de criar a pilha) ou adicioná-las a um modelo existente antes de executar uma atualização de pilha. Se você especificar a implantação azul/verde para uma nova pilha, o CloudFormation criará somente os recursos azuis durante a criação. Os recursos para a implantação verde não serão criados até que sejam necessários durante uma atualização da pilha.</p>

     
        <h2 id="blue-green-changesets">Revisar os conjuntos de alterações para a implantação azul/verde</h2>
        <p>É altamente recomendável que você crie um conjunto de alterações antes de executar uma atualização de pilha que iniciará uma implantação verde. Isso permite que você veja as alterações que serão feitas antes de executar a atualização da pilha. Esteja ciente de que as alterações de recursos podem não ser listadas na ordem em que serão executadas durante a atualização da pilha. Para ter mais informações, consulte <a href="./using-cfn-updating-stacks-changesets.html">Atualizar pilhas usando conjuntos de alterações</a>.</p>
     
        <h2 id="blue-green-events">Visualizar eventos da pilha para sua implantação azul/verde</h2>
        <p>É possível visualizar os eventos da pilha gerados em cada etapa da implantação do ECS na guia <b>Events</b> (Eventos) da página <b>Stack</b> (Pilha) e usando a AWS CLI. Para ter mais informações, consulte <a href="./using-cfn-updating-stacks-monitor-stack.html">Monitorar o progresso da atualização de uma pilha</a>.</p>
     
        <h2 id="blue-green-template-reference">Referência do modelo</h2>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Hooks": <span>{</span>
  "Logical ID": <span>{</span>
    "Properties": <span>{</span>
      "TrafficRoutingConfig": <span>{</span>
        "Type": "Traffic routing type",
        "TimeBasedCanary": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        },
        "TimeBasedLinear": <span>{</span>
          "StepPercentage": Integer,
          "BakeTimeMins": Integer
        }
      },
      "AdditionalOptions": <span>{</span>"TerminationWaitTimeInMinutes": Integer},
      "LifecycleEventHooks": <span>{</span>
        "BeforeInstall": "FunctionName",
        "AfterInstall": "FunctionName",
        "AfterAllowTestTraffic": "FunctionName",
        "BeforeAllowTraffic": "FunctionName",
        "AfterAllowTraffic": "FunctionName"
      },
      "ServiceRole": "CodeDeployServiceRoleName",
      "Applications": [
        <span>{</span>
          "Target": <span>{</span>
            "Type": "AWS::ECS::Service",
            "LogicalID": "Resource Logical ID"
          },
          "ECSAttributes": <span>{</span>
            "TaskDefinitions": [
              "AWS::ECS::TaskDefinition Resource Logical ID (Blue)",
              "AWS::ECS::TaskDefinition Resource Logical ID (Green)"
            ],
            "TaskSets": [
              "AWS::ECS::TaskSet Resource Logical ID (Blue)",
              "AWS::ECS::TaskSet Resource Logical ID (Green)"
            ],
            "TrafficRouting": <span>{</span>
              "ProdTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Production)"
              },
              "TestTrafficRoute": <span>{</span>
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "LogicalID": "Resource Logical ID (Test)"
              },
              "TargetGroups": [
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Blue)",
                "AWS::ElasticLoadBalancingV2::TargetGroup Resource Logical ID (Green)"
              ]
            }
          }
        }
      ]
    },
    "Type": "AWS::CodeDeploy::BlueGreen"
  }
}</code></pre>
         
            <h3 id="blue-green-template-reference-props">Propriedades</h3>
            <div class="variablelist">
                 
                 
            <dl>
                    <dt><span class="term"><code class="code">Logical ID</code></span></dt>
                    <dd>
                        <p>O ID lógico deve ser alfanumérico (A-Z a-z 0-9) e exclusivo no modelo.</p>
                        <p><em>Obrigatório</em>: Sim</p>
                        <div class="variablelist">
                             
                        <dl>
                                <dt><span class="term"><code class="code">Properties</code></span></dt>
                                <dd>
                                    <p>Propriedades do hook.</p>
                                    <p><em>Obrigatório</em>: Sim</p>
                                    <div class="variablelist">
                                         
                                         
                                         
                                         
                                         
                                    <dl>
                                            <dt><span class="term"><code class="code">TrafficRoutingConfig</code></span></dt>
                                            <dd>
                                                <p>Definição das configurações de roteamento de tráfego.</p>
                                                <p><em>Obrigatório</em>: não</p>
                                                <p>A configuração padrão é o deslocamento de tráfego canário baseado em tempo, com uma porcentagem de 15% de etapa e um tempo de incorporação de cinco minutos.</p>
                                                <div class="variablelist">
                                                    
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Type</code></span></dt>
                                                        <dd>
                                                            <p>O tipo de deslocamento de tráfego usado pela configuração de implantação.</p>
                                                            <p>Valores válidos: AllAtOnce | TimeBasedCanary | TimeBasedLinear</p>
                                                            <p><em>Obrigatório</em>: Sim</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TimeBasedCanary</code></span></dt>
                                                                    <dd>
                                                                        <p>Especifica uma configuração que desloca o tráfego de uma versão da implantação para outra em incrementos de dois.</p>
                                                                        <p><em>Necessário</em>: Condicional: se você especificar <code class="code">TimeBasedCanary</code> como o tipo de roteamento de tráfego, deverá incluir o parâmetro <code class="code">TimeBasedCanary</code>.</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>A porcentagem de tráfego a ser deslocado no primeiro incremento de uma implantação <code class="code">TimeBasedCanary</code>. A porcentagem da etapa deve ser 14% ou maior.</p>
                                                                                    <p><em>Obrigatório</em>: não</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p>O número de minutos entre o primeiro e o segundo deslocamento de tráfego de uma implantação <code class="code">TimeBasedCanary</code>.</p>
                                                                                    <p><em>Obrigatório</em>: não</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TimeBasedLinear</code></span></dt>
                                                                    <dd>
                                                                        <p>Especifica uma configuração que desloca o tráfego de uma versão da implantação para outra em incrementos iguais, com um número igual de minutos entre cada incremento.</p>
                                                                        <p><em>Necessário</em>: Condicional: se você especificar <code class="code">TimeBasedLinear</code> como o tipo de roteamento de tráfego, deverá incluir o parâmetro <code class="code">TimeBasedLinear</code>.</p>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">StepPercentage</code></span></dt>
                                                                                <dd>
                                                                                    <p>A porcentagem de tráfego deslocado no início de cada incremento de uma implantação <code class="code">TimeBasedLinear</code>. A porcentagem da etapa deve ser 14% ou maior.</p>
                                                                                    <p><em>Obrigatório</em>: não</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                        <div class="variablelist">
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">BakeTimeMins</code></span></dt>
                                                                                <dd>
                                                                                    <p>O número de minutos entre cada deslocamento de tráfego incremental de uma implantação <code class="code">TimeBasedLinear</code>.</p>
                                                                                    <p><em>Obrigatório</em>: não</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">AdditionalOptions</code></span></dt>
                                            <dd>
                                                <p>Opções adicionais para a implantação azul/verde.</p>
                                                <p><em>Obrigatório</em>: não</p>
                                                <div class="variablelist">
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">TerminationWaitTimeInMinutes</code></span></dt>
                                                        <dd>
                                                            <p>Especifica o tempo de espera, em minutos, antes de encerrar os recursos azuis.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">LifecycleEventHooks</code></span></dt>
                                            <dd>
                                                <p>Use hooks de eventos de ciclo de vida para especificar uma função do Lambda que o CodeDeploy possa chamar para validar uma implantação. É possível usar a mesma função ou uma diferente para os eventos de ciclo de vida de implantação. Após a conclusão dos testes de validação, a função AfterAllowTraffic do Lambda chama de volta o CodeDeploy e entrega um resultado de <code class="code">Succeeded</code> ou <code class="code">Failed</code>. </p>
                                                <p>Para mais informações, consulte a <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html">seção “Hooks” do AppSpec</a> no <em>Guia do usuário do AWS CodeDeploy.</em></p>
                                                <p><em>Obrigatório</em>: não</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                     
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">BeforeInstall</code></span></dt>
                                                        <dd>
                                                            <p>Função a ser usada para executar tarefas antes que o conjunto de tarefas de substituição seja criado.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterInstall</code></span></dt>
                                                        <dd>
                                                            <p>Função a ser usada para executar tarefas depois que o conjunto de tarefas de substituição for criado e um dos grupos de destino for associado a ele.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTestTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Função a ser usada para executar tarefas depois que o listener de teste distribuir o tráfego para o conjunto de tarefas de substituição.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">BeforeAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Função a ser usada para executar tarefas depois que o segundo grupo de destino for associado ao conjunto de tarefas de substituição, mas antes que o tráfego seja deslocado para o conjunto de tarefas de substituição.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">AfterAllowTraffic</code></span></dt>
                                                        <dd>
                                                            <p>Função a ser usada para executar tarefas depois que o segundo grupo de destino distribuir o tráfego para o conjunto de tarefas de substituição.</p>
                                                            <p><em>Obrigatório</em>: não</p>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">ServiceRole</code></span></dt>
                                            <dd>
                                                <p>A função de execução a ser usada pelo CloudFormation para executar as implantações azul/verde. Para obter uma lista das permissões necessárias, consulte <a href="#blue-green-iam">Permissões do IAM necessárias para implantações azul/verde</a>.</p>
                                                <p><em>Obrigatório</em>: Sim</p>
                                            </dd>
                                         
                                            <dt><span class="term"><code class="code">Applications</code></span></dt>
                                            <dd>
                                                <p>Especifica as propriedades do aplicativo do Amazon ECS.</p>
                                                <p><em>Obrigatório</em>: Sim</p>
                                                <div class="variablelist">
                                                     
                                                     
                                                <dl>
                                                        <dt><span class="term"><code class="code">Target</code></span></dt>
                                                        <dd>
                                                            <p></p>
                                                            <p><em>Obrigatório</em>: Sim</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                    <dd>
                                                                        <p>O tipo de recurso.</p>
                                                                        <p><em>Obrigatório</em>: Sim</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                    <dd>
                                                                        <p>O ID lógico do recurso.</p>
                                                                        <p><em>Obrigatório</em>: Sim</p>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                     
                                                        <dt><span class="term"><code class="code">ECSAttributes</code></span></dt>
                                                        <dd>
                                                            <p>Os recursos que representam os vários requisitos de sua implantação de aplicativos do Amazon ECS.</p>
                                                            <p><em>Obrigatório</em>: Sim</p>
                                                            <div class="variablelist">
                                                                 
                                                                 
                                                                 
                                                            <dl>
                                                                    <dt><span class="term"><code class="code">TaskDefinitions</code></span></dt>
                                                                    <dd>
                                                                        <p>O ID lógico do <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-taskdefinition.html"><code class="code">AWS::ECS::TaskDefinition</code></a> recurso para executar o contêiner do Docker que contém seu aplicativo do Amazon ECS.</p>
                                                                        <p><em>Obrigatório</em>: Sim</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TaskSets</code></span></dt>
                                                                    <dd>
                                                                        <p>Os IDs lógicos dos recursos <code class="code">AWS::ECS::TaskSet</code> a serem usados como conjuntos de tarefas para o aplicativo.</p>
                                                                        <p><em>Obrigatório</em>: Sim</p>
                                                                    </dd>
                                                                 
                                                                    <dt><span class="term"><code class="code">TrafficRouting</code></span></dt>
                                                                    <dd>
                                                                        <p>Especifica os recursos usados para roteamento de tráfego.</p>
                                                                        <p><em>Obrigatório</em>: Sim</p>
                                                                        <div class="variablelist">
                                                                             
                                                                             
                                                                             
                                                                        <dl>
                                                                                <dt><span class="term"><code class="code">ProdTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>O listener é usado pelo load balancer para direcionar o tráfego para seus grupos de destino.</p>
                                                                                    <p><em>Obrigatório</em>: Sim</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>O tipo do recurso. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>Obrigatório</em>: Sim</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>O ID lógico do recurso.</p>
                                                                                                <p><em>Obrigatório</em>: Sim</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TestTrafficRoute</code></span></dt>
                                                                                <dd>
                                                                                    <p>O listener é usado pelo load balancer para direcionar o tráfego para seus grupos de destino.</p>
                                                                                    <p><em>Obrigatório</em>: Sim</p>
                                                                                    <div class="variablelist">
                                                                                         
                                                                                         
                                                                                    <dl>
                                                                                            <dt><span class="term"><code class="code">Type</code></span></dt>
                                                                                            <dd>
                                                                                                <p>O tipo do recurso. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                                                                                                <p><em>Obrigatório</em>: Sim</p>
                                                                                            </dd>
                                                                                         
                                                                                            <dt><span class="term"><code class="code">LogicalID</code></span></dt>
                                                                                            <dd>
                                                                                                <p>O ID lógico do recurso.</p>
                                                                                                <p><em>Obrigatório</em>: não</p>
                                                                                            </dd>
                                                                                        </dl></div>
                                                                                </dd>
                                                                             
                                                                                <dt><span class="term"><code class="code">TargetGroups</code></span></dt>
                                                                                <dd>
                                                                                    <p>ID lógico dos recursos a serem usados como grupos de destino para rotear o tráfego para o destino registrado.</p>
                                                                                    <p><em>Obrigatório</em>: Sim</p>
                                                                                </dd>
                                                                            </dl></div>
                                                                    </dd>
                                                                </dl></div>
                                                        </dd>
                                                    </dl></div>
                                            </dd>
                                        </dl></div>
                                </dd>
                            </dl></div>
                    </dd>
                    
                 
                    <dt><span class="term"><code class="code">Type</code></span></dt>
                    <dd>
                        <p>O tipo do hook. <code class="code">AWS::ElasticLoadBalancingV2::Listener</code></p>
                        <p><em>Obrigatório</em>: Sim</p>
                    </dd>
                </dl></div>
         
     
        <h2 id="blue-green-iam">Permissões do IAM necessárias para implantações azul/verde</h2>
        <p>Para que o CloudFormation execute com sucesso as implantações azul/verde, você deve ter as seguintes permissões do CodeDeploy:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem"><p><code class="code">codedeploy:Get*</code></p></li><li class="listitem"><p><code class="code">codedeploy:CreateCloudFormationDeployment</code></p></li></ul></div>
        <p>Para mais informações, consulte <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html">Ações, recursos e chaves de condição para o CodeDeploy</a>, no <em>Guia do usuário do AWS Identity and Access Management</em>.</p>
     
        <h2 id="blue-green-template-example">Exemplo de modelo</h2>
        <p>O exemplo a seguir configura uma implantação azul/verde do ECS por meio do CodeDeploy, com um progresso de roteamento de tráfego de 15% por etapa, com um período de estabilização de 5 minutos entre cada etapa. Criar uma pilha com o modelo provisiona a configuração inicial da implantação.</p>
        <p>Se você fez alguma alteração nas propriedades do recurso <code class="code">"BlueTaskSet"</code> que exija que esse recurso seja substituído, o CloudFormation inicializará uma implantação verde como parte da atualização da pilha.</p>
        <div id="JSON" name="JSON" class="section langfilter">
            <h3 id="blue-green-template-example.json">JSON</h3>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "Parameters": <span>{</span>
        "Vpc": <span>{</span>
            "Type": "AWS::EC2::VPC::Id"
        },
        "Subnet1": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        },
        "Subnet2": <span>{</span>
            "Type": "AWS::EC2::Subnet::Id"
        }
    },
    "Transform": [
        "AWS::CodeDeployBlueGreen"
    ],
    "Hooks": <span>{</span>
        "CodeDeployBlueGreenHook": <span>{</span>
            "Properties": <span>{</span>
                "TrafficRoutingConfig": <span>{</span>
                    "Type": "TimeBasedCanary",
                    "TimeBasedCanary": <span>{</span>
                        "StepPercentage": 15,
                        "BakeTimeMins": 5
                    }
                },
                "Applications": [
                    <span>{</span>
                        "Target": <span>{</span>
                            "Type": "AWS::ECS::Service",
                            "LogicalID": "ECSDemoService"
                        },
                        "ECSAttributes": <span>{</span>
                            "TaskDefinitions": [
                                "BlueTaskDefinition",
                                "GreenTaskDefinition"
                            ],
                            "TaskSets": [
                                "BlueTaskSet",
                                "GreenTaskSet"
                            ],
                            "TrafficRouting": <span>{</span>
                                "ProdTrafficRoute": <span>{</span>
                                    "Type": "AWS::ElasticLoadBalancingV2::Listener",
                                    "LogicalID": "ALBListenerProdTraffic"
                                },
                                "TargetGroups": [
                                    "ALBTargetGroupBlue",
                                    "ALBTargetGroupGreen"
                                ]
                            }
                        }
                    }
                ]
            },
            "Type": "AWS::CodeDeploy::BlueGreen"
        }
    },
    "Resources": <span>{</span>
        "ExampleSecurityGroup": <span>{</span>
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": <span>{</span>
                "GroupDescription": "Security group for ec2 access",
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 8080,
                        "ToPort": 8080,
                        "CidrIp": "0.0.0.0/0"
                    },
                    <span>{</span>
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "ALBTargetGroupBlue": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ALBTargetGroupGreen": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": <span>{</span>
                "HealthCheckIntervalSeconds": 5,
                "HealthCheckPath": "/",
                "HealthCheckPort": "80",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 2,
                "HealthyThresholdCount": 2,
                "Matcher": <span>{</span>
                    "HttpCode": "200"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "TargetType": "ip",
                "UnhealthyThresholdCount": 4,
                "VpcId": <span>{</span>
                    "Ref": "Vpc"
                }
            }
        },
        "ExampleALB": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": <span>{</span>
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    <span>{</span>
                        "Ref": "ExampleSecurityGroup"
                    }
                ],
                "Subnets": [
                    <span>{</span>
                        "Ref": "Subnet1"
                    },
                    <span>{</span>
                        "Ref": "Subnet2"
                    }
                ],
                "Tags": [
                    <span>{</span>
                        "Key": "Group",
                        "Value": "Example"
                    }
                ],
                "Type": "application",
                "IpAddressType": "ipv4"
            }
        },
        "ALBListenerProdTraffic": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": <span>{</span>
                "DefaultActions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "LoadBalancerArn": <span>{</span>
                    "Ref": "ExampleALB"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ALBListenerProdRule": <span>{</span>
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": <span>{</span>
                "Actions": [
                    <span>{</span>
                        "Type": "forward",
                        "ForwardConfig": <span>{</span>
                            "TargetGroups": [
                                <span>{</span>
                                    "TargetGroupArn": <span>{</span>
                                        "Ref": "ALBTargetGroupBlue"
                                    },
                                    "Weight": 1
                                }
                            ]
                        }
                    }
                ],
                "Conditions": [
                    <span>{</span>
                        "Field": "http-header",
                        "HttpHeaderConfig": <span>{</span>
                            "HttpHeaderName": "User-Agent",
                            "Values": [
                                "Mozilla"
                            ]
                        }
                    }
                ],
                "ListenerArn": <span>{</span>
                    "Ref": "ALBListenerProdTraffic"
                },
                "Priority": 1
            }
        },
        "ECSTaskExecutionRole": <span>{</span>
            "Type": "AWS::IAM::Role",
            "Properties": <span>{</span>
                "AssumeRolePolicyDocument": <span>{</span>
                    "Version": "2012-10-17",
                    "Statement": [
                        <span>{</span>
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": <span>{</span>
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ]
            }
        },
        "BlueTaskDefinition": <span>{</span>
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": <span>{</span>
                "ExecutionRoleArn": <span>{</span>
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    <span>{</span>
                        "Name": "DemoApp",
                        "Image": "nginxdemos/hello:latest",
                        "Essential": true,
                        "PortMappings": [
                            <span>{</span>
                                "HostPort": 80,
                                "Protocol": "tcp",
                                "ContainerPort": 80
                            }
                        ]
                    }
                ],
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "NetworkMode": "awsvpc",
                "Cpu": "256",
                "Memory": "512",
                "Family": "ecs-demo"
            }
        },
        "ECSDemoCluster": <span>{</span>
            "Type": "AWS::ECS::Cluster",
            "Properties": <span>{</span>}
        },
        "ECSDemoService": <span>{</span>
            "Type": "AWS::ECS::Service",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "DesiredCount": 1,
                "DeploymentController": <span>{</span>
                    "Type": "EXTERNAL"
                }
            }
        },
        "BlueTaskSet": <span>{</span>
            "Type": "AWS::ECS::TaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "LaunchType": "FARGATE",
                "NetworkConfiguration": <span>{</span>
                    "AwsVpcConfiguration": <span>{</span>
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": [
                            <span>{</span>
                                "Ref": "ExampleSecurityGroup"
                            }
                        ],
                        "Subnets": [
                            <span>{</span>
                                "Ref": "Subnet1"
                            },
                            <span>{</span>
                                "Ref": "Subnet2"
                            }
                        ]
                    }
                },
                "PlatformVersion": "1.4.0",
                "Scale": <span>{</span>
                    "Unit": "PERCENT",
                    "Value": 100
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskDefinition": <span>{</span>
                    "Ref": "BlueTaskDefinition"
                },
                "LoadBalancers": [
                    <span>{</span>
                        "ContainerName": "DemoApp",
                        "ContainerPort": 80,
                        "TargetGroupArn": <span>{</span>
                            "Ref": "ALBTargetGroupBlue"
                        }
                    }
                ]
            }
        },
        "PrimaryTaskSet": <span>{</span>
            "Type": "AWS::ECS::PrimaryTaskSet",
            "Properties": <span>{</span>
                "Cluster": <span>{</span>
                    "Ref": "ECSDemoCluster"
                },
                "Service": <span>{</span>
                    "Ref": "ECSDemoService"
                },
                "TaskSetId": <span>{</span>
                    "Fn::GetAtt": [
                        "BlueTaskSet",
                        "Id"
                    ]
                }
            }
        }
    }
}</code></pre>

        </div>
        <div id="YAML" name="YAML" class="section langfilter">
            <h3 id="blue-green-template-example.yaml">YAML</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">Parameters:
  Vpc:
    Type: 'AWS::EC2::VPC::Id'
  Subnet1:
    Type: 'AWS::EC2::Subnet::Id'
  Subnet2:
    Type: 'AWS::EC2::Subnet::Id'
Transform:
  - 'AWS::CodeDeployBlueGreen'
Hooks:
  CodeDeployBlueGreenHook:
    Properties:
      TrafficRoutingConfig:
        Type: TimeBasedCanary
        TimeBasedCanary:
          StepPercentage: 15
          BakeTimeMins: 5
      Applications:
        - Target:
            Type: 'AWS::ECS::Service'
            LogicalID: ECSDemoService
          ECSAttributes:
            TaskDefinitions:
              - BlueTaskDefinition
              - GreenTaskDefinition
            TaskSets:
              - BlueTaskSet
              - GreenTaskSet
            TrafficRouting:
              ProdTrafficRoute:
                Type: 'AWS::ElasticLoadBalancingV2::Listener'
                LogicalID: ALBListenerProdTraffic
              TargetGroups:
                - ALBTargetGroupBlue
                - ALBTargetGroupGreen
    Type: 'AWS::CodeDeploy::BlueGreen'
Resources:
  ExampleSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Security group for ec2 access
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  ALBTargetGroupBlue:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ALBTargetGroupGreen:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Group
          Value: Example
      TargetType: ip
      UnhealthyThresholdCount: 4
      VpcId: !Ref Vpc
  ExampleALB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ExampleSecurityGroup
      Subnets:
        - !Ref Subnet1
        - !Ref Subnet2
      Tags:
        - Key: Group
          Value: Example
      Type: application
      IpAddressType: ipv4
  ALBListenerProdTraffic:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      LoadBalancerArn: !Ref ExampleALB
      Port: 80
      Protocol: HTTP
  ALBListenerProdRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Properties:
      Actions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !Ref ALBTargetGroupBlue
                Weight: 1
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: User-Agent
            Values:
              - Mozilla
      ListenerArn: !Ref ALBListenerProdTraffic
      Priority: 1
  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
  BlueTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ExecutionRoleArn: !GetAtt 
        - ECSTaskExecutionRole
        - Arn
      ContainerDefinitions:
        - Name: DemoApp
          Image: 'nginxdemos/hello:latest'
          Essential: true
          PortMappings:
            - HostPort: 80
              Protocol: tcp
              ContainerPort: 80
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: '256'
      Memory: '512'
      Family: ecs-demo
  ECSDemoCluster:
    Type: 'AWS::ECS::Cluster'
    Properties: <span>{</span>}
  ECSDemoService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref ECSDemoCluster
      DesiredCount: 1
      DeploymentController:
        Type: EXTERNAL
  BlueTaskSet:
    Type: 'AWS::ECS::TaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsVpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref ExampleSecurityGroup
          Subnets:
            - !Ref Subnet1
            - !Ref Subnet2
      PlatformVersion: 1.4.0
      Scale:
        Unit: PERCENT
        Value: 100
      Service: !Ref ECSDemoService
      TaskDefinition: !Ref BlueTaskDefinition
      LoadBalancers:
        - ContainerName: DemoApp
          ContainerPort: 80
          TargetGroupArn: !Ref ALBTargetGroupBlue
  PrimaryTaskSet:
    Type: 'AWS::ECS::PrimaryTaskSet'
    Properties:
      Cluster: !Ref ECSDemoCluster
      Service: !Ref ECSDemoService
      TaskSetId: !GetAtt 
        - BlueTaskSet
        - Id</code></pre>
        </div>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Atenção" /> <strong>O Javascript está desativado ou não está disponível no seu navegador.</strong></p><p>Para usar a documentação da AWS, o Javascript deve estar ativado. Consulte as páginas de Ajuda do navegador para obter instruções.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Convenções do documento</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./modules.html">Como usar módulos</div><div id="next" class="next-link" accesskey="n" href="./cfn-regexes.html">Usar expressões regulares</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Essa página foi útil? - Sim</div><div class="content"><p>Obrigado por nos informar que estamos fazendo um bom trabalho!</p><p>Se tiver tempo, conte-nos sobre o que você gostou para que possamos melhorar ainda mais.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Essa página foi útil? - Não</div><div class="content"><p>Obrigado por nos informar que precisamos melhorar a página. Lamentamos ter decepcionado você.</p><p>Se tiver tempo, conte-nos como podemos melhorar a documentação.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/blue-green.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>