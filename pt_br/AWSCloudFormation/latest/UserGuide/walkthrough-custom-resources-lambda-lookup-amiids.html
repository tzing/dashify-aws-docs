<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Demonstração: Pesquisar IDs de imagem de máquina da Amazon - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><meta name="default_state" content="walkthrough-custom-resources-lambda-lookup-amiids" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="description" content="Use AWS Lambda e um recurso personalizado para pesquisar dinamicamente IDs de AMI." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="Guia do usuário" /><meta name="abstract" content="Crie e gerencie implantações da infraestrutura da AWS de maneira previsível e que pode ser repetida usando o AWS CloudFormation com este Guia do usuário." /><meta name="guide-locale" content="pt_br" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="Guia do usuário" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="Guia do usuário" /><meta id="panorama-serviceConsolePage" value="Demonstração: Pesquisar IDs de imagem de máquina da Amazon" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Demonstração: Pesquisar IDs de imagem de máquina da Amazon - AWS CloudFormation</title><meta name="rss" content="aws-cloudformation-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=92" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,provisionamento de recursos,configuração de recursos,gerenciamento da infraestrutura,CloudFormer,Pilha do CloudFormation,Stackset do CloudFormation,Modelo do CloudFormation,conjunto de alterações" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Guia do usuário",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Trabalhar com modelos do AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Recursos personalizados",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-custom-resources.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Recursos personalizados com suporte do AWS Lambda",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Demonstração: Pesquisar IDs de imagem de máquina da Amazon",
        "item" : "https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-custom-resources-lambda.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentação</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">Guia do usuário</a></div><div id="page-toc-src"><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Etapa 1: Fazer download e salvar o pacote de exemplo no Amazon S3</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Etapa 2: Criar a pilha</a><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Etapa 3: Limpar os recursos</a><a href="#w9aac23c26c16b7c29">Informações relacionadas</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="walkthrough-custom-resources-lambda-lookup-amiids">Demonstração: Pesquisar IDs de imagem de máquina da Amazon</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>Os modelos do AWS CloudFormation que declaram uma instância do Amazon Elastic Compute Cloud (Amazon EC2) também devem especificar um ID da Imagem de máquina da Amazon (AMI), que inclui um sistema operacional e outras informações de configuração e software usadas para iniciar a instância. O ID da AMI correto depende do tipo de instância e da região em que a pilha é iniciada. E os IDs podem ser alterados regularmente, como quando ocorrem atualizações de software de uma AMI.</p><p>Normalmente, você pode mapear IDs de AMI para os tipos de instância e regiões específicos. Para atualizar os IDs, altere-os manualmente em cada um dos modelos. Ao usar recursos personalizados e o AWS Lambda (Lambda), você pode criar uma função que obtém os IDs de AMIs mais recentes para a região e o tipo de instância que estão em uso, de modo que não precise manter mapeamentos.</p><p>Esta descrição mostra como criar um recurso personalizado e associar uma função Lambda a ele para pesquisar IDs de AMI. Observe que a descrição pressupõe que você compreende o uso de recursos personalizados e Lambda. Para saber mais, consulte <a href="./template-custom-resources.html">Recursos personalizados</a> ou o <a href="https://docs.aws.amazon.com/lambda/latest/dg/">Guia do Desenvolvedor do AWS Lambda</a>.</p><p>Visão geral da descrição</p><p>Para esta descrição, crie uma pilha com um recurso personalizado, uma função Lambda e uma instância EC2. A descrição fornece um código de exemplo e um modelo de amostra que será usado para criar a pilha.</p><p>O modelo de amostra usa o tipo de recursos personalizado para invocar e enviar valores de entrada para a função Lambda. Quando você usa o modelo, o AWS CloudFormation invoca a função e envia informações a ela, como o tipo de solicitação, dados de entrada e um URL pré-assinado do Amazon Simple Storage Service (Amazon S3). A função usa essas informações para pesquisar o ID da AMI e, em seguida, envia uma resposta para o pre-signed URL.</p><p>Após o AWS CloudFormation obter uma resposta no pre-signed URL local, ele prossegue com a criação da pilha. Quando o AWS CloudFormation cria a instância, ele usa a resposta da função do Lambda para especificar o ID da AMI da instância.</p><p>A lista a seguir resume o processo. São necessárias permissões do AWS Identity and Access Management (IAM) para usar todos os serviços correspondentes, como o Lambda, o Amazon EC2 e o AWS CloudFormation.</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>nota</h6></div><div class="awsdocs-note-text"><p>O AWS CloudFormation é um serviço gratuito; no entanto, existe uma cobrança para os recursos da AWS, como a função do Lambda e a instância do EC2, que são incluídos nas pilhas na taxa atual de cada um deles. Para obter mais informações sobre o preço da AWS, consulte a página de detalhes de cada produto em <a href="https://aws.amazon.com/" rel="noopener noreferrer" target="_blank"><span>http://aws.amazon.com</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p></div></div><div class="orderedlist">
     
     
     
  <ol><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-savesample">Salve o pacote de amostra do Lambda em um bucket do Amazon Simple Storage Service (Amazon S3).</a></p>
      <p>O pacote de amostra contém tudo o que é necessário para criar a função Lambda. Salve o pacote em um bucket que está na mesma região em que a pilha for criada.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Use o modelo de amostra para criar uma pilha.</a></p>
      <p>A pilha demonstra como associar a função Lambda a um recurso personalizado e como usar os resultados da função para especificar um ID da AMI. A pilha também cria uma função IAM (função de execução), que o Lambda usa para fazer chamadas para o Amazon EC2.</p>
    </li><li>
      <p><a href="#walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Exclua a pilha.</a></p>
      <p>Exclua a pilha para limpar todos os recursos de pilha criados; assim, você não será cobrado por recursos desnecessários.</p>
    </li></ol></div><h2 id="walkthrough-custom-resources-lambda-lookup-amiids-savesample">Etapa 1: Fazer download e salvar o pacote de exemplo no Amazon S3</h2>
    
    <p>Quando você criar uma pilha com uma função Lambda, especifique o local do bucket do Amazon S3 que contém o código-fonte da função. O bucket deve estar na mesma região em que a pilha foi criada.</p>
    <p>Esta descrição oferece um pacote de amostra (um arquivo <code>.zip</code>) necessário para criar a função Lambda. Um pacote do Lambda contém o código-fonte para a função e as bibliotecas necessárias. Para esta descrição, a função não exige bibliotecas adicionais.</p>
    <p>A função usa uma arquitetura de instância e a região como entradas de uma solicitação de recurso personalizado do AWS CloudFormation e retorna o ID da AMI mais recente para um URL pré-assinado do Amazon S3.</p>
    <div class="procedure"><h6>Para fazer download e salvar o pacote no Amazon S3</h6><ol><li>
        <p>Faça download do pacote de amostra do Amazon S3. Quando você salvar o arquivo, use o mesmo nome de arquivo que a amostra, <code>amilookup.zip</code> ou <code>amilookup-win.zip</code>.</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Pesquisar IDs de AMI do Linux</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          
            <dt><b><span class="term">Pesquisar IDs de AMI do Windows</span></b></dt>
            <dd>
              <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/amilookup-win.zip</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Abra o console do Amazon S3 em <a href="https://console.aws.amazon.com/s3/home" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/s3/home</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Escolha ou crie um bucket que esteja localizado na mesma região em que a pilha do AWS CloudFormation será criada. Registre o nome do bucket.</p>
        <p>Salve o pacote de amostra neste bucket. Para obter mais informações sobre como criar um bucket, consulte <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/CreatingaBucket.html">Criar um bucket</a>, no <em>Guia do usuário do Amazon Simple Storage Service</em>.</p>
      </li><li>
        <p>Faça upload do pacote de amostra no bucket que você escolheu ou criou.</p>
        <p>Para obter mais informações sobre o upload de objetos, consulte <a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/UploadingObjectsintoAmazonS3.html">Carregar objetos</a>, no <em>Guia do usuário do Amazon Simple Storage Service</em>.</p>
      </li></ol></div>
    <p>Com o pacote no Amazon S3, agora você pode especificar seu local na declaração do recurso Lambda do modelo do AWS CloudFormation. A próxima etapa demonstra como declarar a função e invocá-la usando um recurso personalizado. Veja também como usar os resultados da função para especificar o ID da AMI de uma instância EC2.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-createstack">Etapa 2: Criar a pilha</h2>
    
    <p>Para criar a pilha do Amazon EC2 de amostra, use um modelo de amostra que inclui uma função Lambda, uma função de execução IAM, um recurso personalizado que invoca a função e uma instância do EC2 que usa os resultados da função.</p>
    <p>Durante a criação da pilha, o recurso personalizado invoca a função Lambda e espera ela enviar uma resposta para o pre-signed URL do Amazon S3. Em resposta, a função retorna o ID da AMI mais recente que corresponde ao tipo de instância EC2 e a região em que a instância está sendo criada. Os dados de resposta da função são armazenados como um atributo do recurso personalizado, que é usado para especificar o ID da AMI da instância EC2.</p>
    <p>Os seguintes trechos explicam relevantes partes do modelo de amostra para ajudá-lo a entender como associar uma função Lambda a um recurso personalizado e como usar a resposta da função.</p>
    <p>Para visualizar todo o modelo de amostra, consulte:</p>
    <div class="variablelist">
       
       
    <dl>
        <dt><b><span class="term">Modelo do Linux</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      
        <dt><b><span class="term">Modelo do Windows</span></b></dt>
        <dd>
          <p><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></p>
        </dd>
      </dl></div>
    <p>Trechos do modelo da pilha</p>
    <p>Para criar a função Lambda, declare o recurso <code class="code">AWS::Lambda::Function</code>, que requer o código-fonte da função, o nome do manipulador, o ambiente do runtime e a função de execução do Nome de região da Amazon (ARN).</p>
    <div class="example"><h6>exemplo Sintaxe do JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfoFunction": <span>{</span>
  "Type": "AWS::Lambda::Function",
  "Properties": <span>{</span>
    "Code": <span>{</span>
      "S3Bucket": <span>{</span> "Ref": "S3Bucket" },
      "S3Key": <span>{</span> "Ref": "S3Key" }
    },
    "Handler": <span>{</span> "Fn::Join" : [ "", [<span>{</span> "Ref": "ModuleName" },".handler"] ] },
    "Runtime": "nodejs18.x",
    "Timeout": "30",
    "Role": <span>{</span> "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] }
  }
}</code></pre></div></div>
    <div class="example"><h6>exemplo Sintaxe do YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfoFunction:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      S3Bucket: !Ref S3Bucket
      S3Key: !Ref S3Key
    Handler: !Sub "$<span>{</span>ModuleName}.handler"
    Runtime: nodejs18.x
    Timeout: 30
    Role: !GetAtt LambdaExecutionRole.Arn</code></pre></div></div>
    <p>A propriedade <code class="code">Code</code> especifica o local do Amazon S3 (nome do bucket e nome de arquivo) onde você fez upload do pacote de amostra. O modelo de amostra usa parâmetros de entrada (<code class="code">"Ref":
        "S3Bucket"</code> e <code class="code">"Ref": "S3Key"</code>) para definir o bucket e nomes de arquivos para que você possa especificar os nomes quando criar a pilha. Da mesma forma, o nome do manipulador, que corresponde ao nome do arquivo de origem (o arquivo JavaScript) no pacote <code>.zip</code>, também usa um parâmetro de entrada (<code class="code">"Ref":
        "ModuleName"</code>). Como o arquivo de origem é código JavaScript, o runtime é especificado como <code class="code">nodejs18.x</code>.</p>
    <p>Para esta descrição, o tempo de execução para a função excede o valor padrão de <code class="code">3</code> segundos, de modo que o timeout é definido em <code class="code">30</code> segundos. Se você não especificar um timeout suficientemente longo, o Lambda poderá atingi-lo antes de a função ser concluída e fazer com que a criação da pilha falhe.</p>
    <p>A função de execução, que é declarada em outro lugar no modelo, é especificada com o uso da função intrínseca <code class="code">Fn::GetAtt</code> na propriedade <code class="code">Role</code>. A função de execução concede permissão à função do Lambda para enviar logs à AWS e chamar a API <code class="code">DescribeImages</code> do EC2. O seguinte trecho mostra a função e a política que concede a permissão apropriada:</p>
    <div class="example"><h6>exemplo Sintaxe do JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"LambdaExecutionRole": <span>{</span>
  "Type": "AWS::IAM::Role",
  "Properties": <span>{</span>
    "AssumeRolePolicyDocument": <span>{</span>
      "Version": "2012-10-17",
      "Statement": [<span>{</span>
        "Effect": "Allow",
        "Principal": <span>{</span>"Service": ["lambda.amazonaws.com"]},
        "Action": ["sts:AssumeRole"]
      }]
    },
    "Path": "/",
    "Policies": [<span>{</span>
      "PolicyName": "root",
      "PolicyDocument": <span>{</span>
        "Version": "2012-10-17",
        "Statement": [<span>{</span>
          "Effect": "Allow",
          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
          "Resource": "arn:aws:logs:*:*:*"
        },
        <span>{</span>
          "Effect": "Allow",
          "Action": ["ec2:DescribeImages"],
          "Resource": "*"
        }]
      }
    }]
  }
}</code></pre></div></div>
    <div class="example"><h6>exemplo Sintaxe do YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">LambdaExecutionRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
      - Effect: Allow
        Principal:
          Service:
          - lambda.amazonaws.com
        Action:
        - sts:AssumeRole
    Path: "/"
    Policies:
    - PolicyName: root
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*
        - Effect: Allow
          Action:
          - ec2:DescribeImages
          Resource: "*"</code></pre></div></div>
    <p>Para os modelos Linux e Windows, o recurso personalizado invoca a função Lambda associada a ele. Para associar uma função a um recurso personalizado, especifique o Nome de recurso da Amazon (ARN) da função para a propriedade <code class="code">ServiceToken</code>, usando a função intrínseca <code class="code">Fn::GetAtt</code>. O AWS CloudFormation envia as propriedades adicionais que estão incluídas na declaração de recurso personalizada, como <code class="code">Region</code> e <code class="code">Architecture</code>, para a função do Lambda como entradas. A função Lambda determina os nomes e valores corretos para essas propriedades de entrada.</p>
    <div class="example"><h6>exemplo Sintaxe do JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "Architecture": <span>{</span> "Fn::FindInMap" : [ "AWSInstanceType2Arch", <span>{</span> "Ref" : "InstanceType" }, "Arch" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>exemplo Sintaxe do YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    Architecture:
      Fn::FindInMap:
      - AWSInstanceType2Arch
      - !Ref InstanceType
      - Arch</code></pre></div></div>
    <p>Para o Windows, o recurso personalizado fornece a versão do Windows à função Lambda, em vez da arquitetura da instância.</p>
    <div class="example"><h6>exemplo Sintaxe do JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"AMIInfo": <span>{</span>
  "Type": "Custom::AMIInfo",
  "Properties": <span>{</span>
    "ServiceToken": <span>{</span> "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
    "Region": <span>{</span> "Ref": "AWS::Region" },
    "OSName": <span>{</span> "Ref": "WindowsVersion" }
  }
}</code></pre></div></div>
    <div class="example"><h6>exemplo Sintaxe do YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">AMIInfo:
  Type: Custom::AMIInfo
  Properties:
    ServiceToken: !GetAtt AMIInfoFunction.Arn
    Region: !Ref "AWS::Region"
    OSName: !Ref "WindowsVersion"</code></pre></div></div>
    <p>Quando o AWS CloudFormation invoca a função do Lambda, a função invoca a API <code class="code">DescribeImages</code> do EC2, usando a região e arquitetura de instância ou o nome de sistema para filtrar a lista de imagens. Em seguida, a função classifica a lista de imagens por data e retorna o ID da AMI mais recente.</p>
    <p>Ao retornar o ID da AMI mais recente, a função envia o ID para um pre-signed URL na propriedade <code class="code">Data</code> do <a href="./crpg-ref-responses.html">objeto de resposta</a>. Os dados são estruturados como um par nome-valor, como mostrado no exemplo a seguir:</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"Data": <span>{</span> 
  "Id": "ami-43795473"
}</code></pre>
    <p>O seguinte trecho mostra como obter os dados de uma função Lambda. Ele usa a função intrínseca <code class="code">Fn::GetAtt</code>, fornecendo o nome do recurso personalizado e o nome de atributo do valor a ser obtido. Nessas descrição, o nome do recurso personalizado é <code class="code">AMIInfo</code> e o nome do atributo é <code class="code">Id</code>.</p>
    <div class="example"><h6>exemplo Sintaxe do JSON</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">"SampleInstance": <span>{</span>  
  "Type": "AWS::EC2::Instance",
  "Properties": <span>{</span>
    "InstanceType"   : <span>{</span> "Ref" : "InstanceType" },
    "ImageId": <span>{</span> "Fn::GetAtt": [ "AMIInfo", "Id" ] }
  }
}</code></pre></div></div>
    <div class="example"><h6>exemplo Sintaxe do YAML</h6><div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copiar"><awsui-icon name="copy"></awsui-icon></div></div><code class="yaml ">SampleInstance:
  Type: AWS::EC2::Instance
  Properties:
    InstanceType: !Ref InstanceType
    ImageId: !GetAtt AMIInfo.Id</code></pre></div></div>
    <p>Agora que você compreende o que o modelo faz, use o modelo de amostra para criar uma pilha.</p>
    <div class="procedure"><h6>Para criar a pilha </h6><ol><li>
        <p>Abra o console do AWS CloudFormation em <a href="https://console.aws.amazon.com/cloudformation/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/cloudformation/</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>
      </li><li>
        <p>Selecione <b>Create Stack</b> (Criar pilha).</p>
      </li><li>
        <p>Na seção <b>Template (Modelo)</b>, selecione <b>Specify an Amazon S3 template URL (Especificar um URL de modelo do &amp;S3;)</b> e, em seguida, copie e cole o seguinte URL na caixa de texto:</p>
        <div class="variablelist">
           
           
        <dl>
            <dt><b><span class="term">Modelo do Linux</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          
            <dt><b><span class="term">Modelo do Windows</span></b></dt>
            <dd>
              <p><code class="code"><a href="https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-examples/lambda/LambdaAMILookupSample-win.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a></code></p>
            </dd>
          </dl></div>
      </li><li>
        <p>Escolha <b>Próximo</b>.</p>
      </li><li>
        <p>No campo <b>Stack name (Nome da pilha)</b>, digite <code class="userinput">SampleEC2Instance</code>.</p>
      </li><li>
        <p>Na seção <b>Parameters (Parâmetros)</b>, especifique o nome do bucket do Amazon S3 que você criou e, em seguida, escolha <b>Next (Próximo)</b>.</p>
        <p>Os valores padrão dos outros parâmetros são os mesmos nomes usados no pacote <code>.zip</code> de amostra.</p>
      </li><li>
        <p>Para esta demonstração, você não precisa adicionar tags ou especificar configurações avançadas, portanto escolha <b>Próximo</b>.</p>
      </li><li>
        <p>Certifique-se de que o nome da pilha e o modelo de URL estão corretos e, em seguida, escolha <b>Criar</b>.</p>
      </li></ol></div>
    <p>Pode levar vários minutos para o AWS CloudFormation criar sua pilha. Para monitorar o progresso, visualize os eventos da pilha. Para ter mais informações, consulte <a href="./cfn-console-view-stack-data-resources.html">Visualizar dados e recursos da pilha do AWS CloudFormation no AWS Management Console</a>.</p>
    <p>Se a criação da pilha for bem-sucedida, todos os recursos na pilha, como a função Lambda, o recurso personalizado e a instância EC2, terão sido criados. Você usou com êxito uma função Lambda e um recurso personalizado para especificar o ID da AMI e uma instância EC2. Não é preciso criar e manter um mapeamento de IDs de AMI neste modelo.</p>
    <p>Para ver qual ID da AMI o AWS CloudFormation usou para criar a instância EC2, visualize as saídas da pilha.</p>
   <p>Se a função Lambda retornar um erro, visualize os logs da função no <a href="https://console.aws.amazon.com/cloudwatch/home#logs:" rel="noopener noreferrer" target="_blank"><span>console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> do Amazon CloudWatch Logs. O nome do stream de logs é o ID físico do recurso personalizado, que pode ser encontrado visualizando os recursos da pilha. Para obter mais informações, consulte <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html#ViewingLogData">Visualizar dados de log</a>, no <em>Guia do usuário do Amazon CloudWatch</em>.</p>
   
   <h2 id="walkthrough-custom-resources-lambda-lookup-amiids-createfunction-cleanup">Etapa 3: Limpar os recursos</h2>
    
    <p>Para ter certeza de que você não será cobrado por serviços indesejados, exclua a pilha.</p>
    <div class="procedure"><h6>Para excluir a pilha</h6><ol><li>
        <p>No console do AWS CloudFormation, escolha a pilha <b>SampleEC2Instance</b>.</p>
      </li><li>
        <p>Escolha <b>Ações</b> e, em seguida, <b>Excluir pilha</b>.</p>
      </li><li>
        <p>Na mensagem de confirmação, escolha <b>Sim, excluir</b>.</p>
      </li></ol></div>
    <p>Todos os recursos que você criou serão excluídos.</p>
    <p>Agora que você compreende como criar e usar as funções do Lambda com o AWS CloudFormation, use o modelo de amostra e o código desta descrição para criar outras pilhas e funções.</p>
  <h2 id="w9aac23c26c16b7c29">Informações relacionadas</h2>
    
    <div class="itemizedlist">
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="./crpg-ref.html">Referência de recursos personalizados do AWS CloudFormation</a></p>
      </li></ul></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Atenção" /> <strong>O Javascript está desativado ou não está disponível no seu navegador.</strong></p><p>Para usar a documentação da AWS, o Javascript deve estar ativado. Consulte as páginas de Ajuda do navegador para obter instruções.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Convenções do documento</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-custom-resources-lambda.html">Recursos personalizados com suporte do AWS Lambda</div><div id="next" class="next-link" accesskey="n" href="./cfn-lambda-function-code-cfnresponsemodule.html">Módulo cfn-response</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Essa página foi útil? - Sim</div><div class="content"><p>Obrigado por nos informar que estamos fazendo um bom trabalho!</p><p>Se tiver tempo, conte-nos sobre o que você gostou para que possamos melhorar ainda mais.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Essa página foi útil? - Não</div><div class="content"><p>Obrigado por nos informar que precisamos melhorar a página. Lamentamos ter decepcionado você.</p><p>Se tiver tempo, conte-nos como podemos melhorar a documentação.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/walkthrough-custom-resources-lambda-lookup-amiids.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>